<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>kubelet volume manager源码分析 - 斌哥的小站|Binge Blog</title><meta name=Description content="k8s1.20 kubelet的volume manager源码分析"><meta property="og:title" content="kubelet volume manager源码分析"><meta property="og:description" content="k8s1.20 kubelet的volume manager源码分析"><meta property="og:type" content="article"><meta property="og:url" content="http://bingerambo.com/posts/2021/02/kubelet-volume-manager%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><meta property="og:image" content="http://bingerambo.com/logo.png"><meta property="article:published_time" content="2021-02-25T08:43:17+08:00"><meta property="article:modified_time" content="2021-02-25T08:43:17+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://bingerambo.com/logo.png"><meta name=twitter:title content="kubelet volume manager源码分析"><meta name=twitter:description content="k8s1.20 kubelet的volume manager源码分析"><meta name=application-name content="Binge Blog"><meta name=apple-mobile-web-app-title content="Binge Blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=http://bingerambo.com/posts/2021/02/kubelet-volume-manager%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/><link rel=prev href=http://bingerambo.com/posts/2021/02/k8s-dynamic-provisioning-and-storage-%E4%BB%8B%E7%BB%8D/><link rel=next href=http://bingerambo.com/posts/2021/02/k8s%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"kubelet volume manager源码分析","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/bingerambo.com\/posts\/2021\/02\/kubelet-volume-manager%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90\/"},"image":["http:\/\/bingerambo.com\/images\/Apple-Devices-Preview.png"],"genre":"posts","keywords":"K8S","wordcount":10913,"url":"http:\/\/bingerambo.com\/posts\/2021\/02\/kubelet-volume-manager%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90\/","datePublished":"2021-02-25T08:43:17+08:00","dateModified":"2021-02-25T08:43:17+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"xxxx","logo":"http:\/\/bingerambo.com\/images\/avatar.png"},"author":{"@type":"Person","name":"Binge"},"description":"k8s1.20 kubelet的volume manager源码分析"}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="斌哥的小站|Binge Blog"><span class=header-title-pre><i class="fas fa-biking fa-fw"></i></span>Binge Blog</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/><i class="fas fa-fw fa-archive"></i>文章 </a><a class=menu-item href=/tags/><i class="fas fa-fw fa-tag"></i>标签 </a><a class=menu-item href=/categories/><i class="fas fa-fw fa-th"></i>分类 </a><a class=menu-item href=/timeline/><i class="fas fa-cog fa-spin"></i>随记 </a><a class=menu-item href=/about/><i class="fas fa-fw fa-at"></i>关于 </a><a class=menu-item href=/search/><i class="fas fa-fw fa-search"></i>搜索 </a><a class=menu-item href=/friend/ title=Friend><i class="fas fa fa-user"></i>友链 </a><a class=menu-item href=https://github.com/bingerambo title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><a class=menu-item href=/><i class="fas fa fa-eye"></i><span id=busuanzi_value_site_uv></span></a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="斌哥的小站|Binge Blog"><span class=header-title-pre><i class="fas fa-biking fa-fw"></i></span>Binge Blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/><i class="fas fa-fw fa-archive"></i>文章</a><a class=menu-item href=/tags/><i class="fas fa-fw fa-tag"></i>标签</a><a class=menu-item href=/categories/><i class="fas fa-fw fa-th"></i>分类</a><a class=menu-item href=/timeline/><i class="fas fa-cog fa-spin"></i>随记</a><a class=menu-item href=/about/><i class="fas fa-fw fa-at"></i>关于</a><a class=menu-item href=/search/><i class="fas fa-fw fa-search"></i>搜索</a><a class=menu-item href=/friend/ title=Friend><i class="fas fa fa-user"></i>友链</a><a class=menu-item href=https://github.com/bingerambo title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><a class=menu-item href=/><i class="fas fa fa-eye"></i><span id=busuanzi_value_site_uv></span></a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">kubelet volume manager源码分析</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=http://bingerambo.com title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw"></i>Binge</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/k8s/><i class="far fa-folder fa-fw"></i>K8S</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2021-02-25>2021-02-25</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 10913 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 22 分钟&nbsp;
<i class="fa fa-eye fa-fw"></i>&nbsp;本文总阅读量 <span id=busuanzi_value_page_pv></span>次&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#总体>总体</a><ul><li><a href=#volume模块图>volume模块图</a></li><li><a href=#volume-manager>volume manager</a></li><li><a href=#volumemanager接口说明>VolumeManager接口说明</a></li><li><a href=#volumemanager结构体>volumeManager结构体</a></li><li><a href=#desiredstateofworld-和-actualstateofworld>desiredStateOfWorld 和 actualStateOfWorld</a></li></ul></li><li><a href=#流程>流程</a><ul><li><a href=#新建>新建</a></li><li><a href=#启动>启动</a><ul><li><a href=#desiredstateofworldpopulator>desiredStateOfWorldPopulator</a><ul><li><a href=#findandaddnewpods>findAndAddNewPods</a></li><li><a href=#processpodvolumes>processPodVolumes</a></li><li><a href=#findandremovedeletedpods>findAndRemoveDeletedPods</a></li></ul></li><li><a href=#reconciler>reconciler</a><ul><li><a href=#主要流程>主要流程</a></li><li><a href=#cleanupmountpoint---docleanupmountpoint>CleanupMountPoint -> doCleanupMountPoint</a></li><li><a href=#mountvolumefunc>mountVolumeFunc</a></li><li><a href=#pendingoperations>pendingOperations</a></li><li><a href=#mountattachvolumes>mountAttachVolumes</a></li><li><a href=#mountvolume>MountVolume</a></li></ul></li></ul></li></ul></li><li><a href=#nfs的mount-setup>NFS的mount setup</a></li><li><a href=#kueblet-syncpod>Kueblet SyncPod</a><ul><li><a href=#syncpod上下文>SyncPod上下文</a></li><li><a href=#waitforattachandmount>WaitForAttachAndMount</a></li><li><a href=#verifyvolumesmountedfunc>verifyVolumesMountedFunc</a></li></ul></li><li><a href=#参考资料>参考资料</a></li></ul></nav></div></div><div class=content id=content><p>kubelet volume manager组件源码分析</p><ul><li>k8s版本：1.20.0</li></ul><h2 id=总体>总体</h2><h3 id=volume模块图>volume模块图</h3><p>kubelet调用VolumeManager，为pods准备存储设备，存储设备就绪会挂载存储设备到pod所在的节点上，并在容器启动的时候挂载在容器指定的目录中；同时，删除卸载不再使用的存储；
kubernetes采用Volume Plugins来实现存储卷的挂载等操作</p><img src=volume.png style=width:100%><h3 id=volume-manager>volume manager</h3><p>源码位置：kubernetes\pkg\kubelet\volumemanager</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-golang data-lang=golang><span class=kd>const</span> <span class=p>(</span>
    <span class=c1>// reconcilerLoopSleepPeriod is the amount of time the reconciler loop waits
</span><span class=c1></span>    <span class=c1>// between successive executions
</span><span class=c1></span>    <span class=nx>reconcilerLoopSleepPeriod</span> <span class=p>=</span> <span class=mi>100</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span>

    <span class=c1>// desiredStateOfWorldPopulatorLoopSleepPeriod is the amount of time the
</span><span class=c1></span>    <span class=c1>// DesiredStateOfWorldPopulator loop waits between successive executions
</span><span class=c1></span>    <span class=nx>desiredStateOfWorldPopulatorLoopSleepPeriod</span> <span class=p>=</span> <span class=mi>100</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span>

    <span class=c1>// desiredStateOfWorldPopulatorGetPodStatusRetryDuration is the amount of
</span><span class=c1></span>    <span class=c1>// time the DesiredStateOfWorldPopulator loop waits between successive pod
</span><span class=c1></span>    <span class=c1>// cleanup calls (to prevent calling containerruntime.GetPodStatus too
</span><span class=c1></span>    <span class=c1>// frequently).
</span><span class=c1></span>    <span class=nx>desiredStateOfWorldPopulatorGetPodStatusRetryDuration</span> <span class=p>=</span> <span class=mi>2</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span>

    <span class=c1>// podAttachAndMountTimeout is the maximum amount of time the
</span><span class=c1></span>    <span class=c1>// WaitForAttachAndMount call will wait for all volumes in the specified pod
</span><span class=c1></span>    <span class=c1>// to be attached and mounted. Even though cloud operations can take several
</span><span class=c1></span>    <span class=c1>// minutes to complete, we set the timeout to 2 minutes because kubelet
</span><span class=c1></span>    <span class=c1>// will retry in the next sync iteration. This frees the associated
</span><span class=c1></span>    <span class=c1>// goroutine of the pod to process newer updates if needed (e.g., a delete
</span><span class=c1></span>    <span class=c1>// request to the pod).
</span><span class=c1></span>    <span class=c1>// Value is slightly offset from 2 minutes to make timeouts due to this
</span><span class=c1></span>    <span class=c1>// constant recognizable.
</span><span class=c1></span>    <span class=nx>podAttachAndMountTimeout</span> <span class=p>=</span> <span class=mi>2</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Minute</span> <span class=o>+</span> <span class=mi>3</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span>

    <span class=c1>// podAttachAndMountRetryInterval is the amount of time the GetVolumesForPod
</span><span class=c1></span>    <span class=c1>// call waits before retrying
</span><span class=c1></span>    <span class=nx>podAttachAndMountRetryInterval</span> <span class=p>=</span> <span class=mi>300</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span>

    <span class=c1>// waitForAttachTimeout is the maximum amount of time a
</span><span class=c1></span>    <span class=c1>// operationexecutor.Mount call will wait for a volume to be attached.
</span><span class=c1></span>    <span class=c1>// Set to 10 minutes because we&#39;ve seen attach operations take several
</span><span class=c1></span>    <span class=c1>// minutes to complete for some volume plugins in some cases. While this
</span><span class=c1></span>    <span class=c1>// operation is waiting it only blocks other operations on the same device,
</span><span class=c1></span>    <span class=c1>// other devices are not affected.
</span><span class=c1></span>    <span class=nx>waitForAttachTimeout</span> <span class=p>=</span> <span class=mi>10</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Minute</span>
<span class=p>)</span>

<span class=c1>// VolumeManager runs a set of asynchronous loops that figure out which volumes
</span><span class=c1>// need to be attached/mounted/unmounted/detached based on the pods scheduled on
</span><span class=c1>// this node and makes it so.
</span><span class=c1></span><span class=kd>type</span> <span class=nx>VolumeManager</span> <span class=kd>interface</span> <span class=p>{</span>
    <span class=c1>// Starts the volume manager and all the asynchronous loops that it controls
</span><span class=c1></span>    <span class=nf>Run</span><span class=p>(</span><span class=nx>sourcesReady</span> <span class=nx>config</span><span class=p>.</span><span class=nx>SourcesReady</span><span class=p>,</span> <span class=nx>stopCh</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span>

    <span class=c1>// WaitForAttachAndMount processes the volumes referenced in the specified
</span><span class=c1></span>    <span class=c1>// pod and blocks until they are all attached and mounted (reflected in
</span><span class=c1></span>    <span class=c1>// actual state of the world).
</span><span class=c1></span>    <span class=c1>// An error is returned if all volumes are not attached and mounted within
</span><span class=c1></span>    <span class=c1>// the duration defined in podAttachAndMountTimeout.
</span><span class=c1></span>    <span class=nf>WaitForAttachAndMount</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=kt>error</span>

    <span class=c1>// GetMountedVolumesForPod returns a VolumeMap containing the volumes
</span><span class=c1></span>    <span class=c1>// referenced by the specified pod that are successfully attached and
</span><span class=c1></span>    <span class=c1>// mounted. The key in the map is the OuterVolumeSpecName (i.e.
</span><span class=c1></span>    <span class=c1>// pod.Spec.Volumes[x].Name). It returns an empty VolumeMap if pod has no
</span><span class=c1></span>    <span class=c1>// volumes.
</span><span class=c1></span>    <span class=nf>GetMountedVolumesForPod</span><span class=p>(</span><span class=nx>podName</span> <span class=nx>types</span><span class=p>.</span><span class=nx>UniquePodName</span><span class=p>)</span> <span class=nx>container</span><span class=p>.</span><span class=nx>VolumeMap</span>

    <span class=c1>// GetExtraSupplementalGroupsForPod returns a list of the extra
</span><span class=c1></span>    <span class=c1>// supplemental groups for the Pod. These extra supplemental groups come
</span><span class=c1></span>    <span class=c1>// from annotations on persistent volumes that the pod depends on.
</span><span class=c1></span>    <span class=nf>GetExtraSupplementalGroupsForPod</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=p>[]</span><span class=kt>int64</span>

    <span class=c1>// GetVolumesInUse returns a list of all volumes that implement the volume.Attacher
</span><span class=c1></span>    <span class=c1>// interface and are currently in use according to the actual and desired
</span><span class=c1></span>    <span class=c1>// state of the world caches. A volume is considered &#34;in use&#34; as soon as it
</span><span class=c1></span>    <span class=c1>// is added to the desired state of world, indicating it *should* be
</span><span class=c1></span>    <span class=c1>// attached to this node and remains &#34;in use&#34; until it is removed from both
</span><span class=c1></span>    <span class=c1>// the desired state of the world and the actual state of the world, or it
</span><span class=c1></span>    <span class=c1>// has been unmounted (as indicated in actual state of world).
</span><span class=c1></span>    <span class=nf>GetVolumesInUse</span><span class=p>()</span> <span class=p>[]</span><span class=nx>v1</span><span class=p>.</span><span class=nx>UniqueVolumeName</span>

    <span class=c1>// ReconcilerStatesHasBeenSynced returns true only after the actual states in reconciler
</span><span class=c1></span>    <span class=c1>// has been synced at least once after kubelet starts so that it is safe to update mounted
</span><span class=c1></span>    <span class=c1>// volume list retrieved from actual state.
</span><span class=c1></span>    <span class=nf>ReconcilerStatesHasBeenSynced</span><span class=p>()</span> <span class=kt>bool</span>

    <span class=c1>// VolumeIsAttached returns true if the given volume is attached to this
</span><span class=c1></span>    <span class=c1>// node.
</span><span class=c1></span>    <span class=nf>VolumeIsAttached</span><span class=p>(</span><span class=nx>volumeName</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>UniqueVolumeName</span><span class=p>)</span> <span class=kt>bool</span>

    <span class=c1>// Marks the specified volume as having successfully been reported as &#34;in
</span><span class=c1></span>    <span class=c1>// use&#34; in the nodes&#39;s volume status.
</span><span class=c1></span>    <span class=nf>MarkVolumesAsReportedInUse</span><span class=p>(</span><span class=nx>volumesReportedAsInUse</span> <span class=p>[]</span><span class=nx>v1</span><span class=p>.</span><span class=nx>UniqueVolumeName</span><span class=p>)</span>
<span class=p>}</span>



<span class=c1>// volumeManager implements the VolumeManager interface
</span><span class=c1></span><span class=kd>type</span> <span class=nx>volumeManager</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=c1>// kubeClient is the kube API client used by DesiredStateOfWorldPopulator to
</span><span class=c1></span>    <span class=c1>// communicate with the API server to fetch PV and PVC objects
</span><span class=c1></span>    <span class=nx>kubeClient</span> <span class=nx>clientset</span><span class=p>.</span><span class=nx>Interface</span>

    <span class=c1>// volumePluginMgr is the volume plugin manager used to access volume
</span><span class=c1></span>    <span class=c1>// plugins. It must be pre-initialized.
</span><span class=c1></span>    <span class=nx>volumePluginMgr</span> <span class=o>*</span><span class=nx>volume</span><span class=p>.</span><span class=nx>VolumePluginMgr</span>

    <span class=c1>// desiredStateOfWorld is a data structure containing the desired state of
</span><span class=c1></span>    <span class=c1>// the world according to the volume manager: i.e. what volumes should be
</span><span class=c1></span>    <span class=c1>// attached and which pods are referencing the volumes).
</span><span class=c1></span>    <span class=c1>// The data structure is populated by the desired state of the world
</span><span class=c1></span>    <span class=c1>// populator using the kubelet pod manager.
</span><span class=c1></span>    <span class=nx>desiredStateOfWorld</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>DesiredStateOfWorld</span>

    <span class=c1>// actualStateOfWorld is a data structure containing the actual state of
</span><span class=c1></span>    <span class=c1>// the world according to the manager: i.e. which volumes are attached to
</span><span class=c1></span>    <span class=c1>// this node and what pods the volumes are mounted to.
</span><span class=c1></span>    <span class=c1>// The data structure is populated upon successful completion of attach,
</span><span class=c1></span>    <span class=c1>// detach, mount, and unmount actions triggered by the reconciler.
</span><span class=c1></span>    <span class=nx>actualStateOfWorld</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>ActualStateOfWorld</span>

    <span class=c1>// operationExecutor is used to start asynchronous attach, detach, mount,
</span><span class=c1></span>    <span class=c1>// and unmount operations.
</span><span class=c1></span>    <span class=nx>operationExecutor</span> <span class=nx>operationexecutor</span><span class=p>.</span><span class=nx>OperationExecutor</span>

    <span class=c1>// reconciler runs an asynchronous periodic loop to reconcile the
</span><span class=c1></span>    <span class=c1>// desiredStateOfWorld with the actualStateOfWorld by triggering attach,
</span><span class=c1></span>    <span class=c1>// detach, mount, and unmount operations using the operationExecutor.
</span><span class=c1></span>    <span class=nx>reconciler</span> <span class=nx>reconciler</span><span class=p>.</span><span class=nx>Reconciler</span>

    <span class=c1>// desiredStateOfWorldPopulator runs an asynchronous periodic loop to
</span><span class=c1></span>    <span class=c1>// populate the desiredStateOfWorld using the kubelet PodManager.
</span><span class=c1></span>    <span class=nx>desiredStateOfWorldPopulator</span> <span class=nx>populator</span><span class=p>.</span><span class=nx>DesiredStateOfWorldPopulator</span>

    <span class=c1>// csiMigratedPluginManager keeps track of CSI migration status of plugins
</span><span class=c1></span>    <span class=nx>csiMigratedPluginManager</span> <span class=nx>csimigration</span><span class=p>.</span><span class=nx>PluginManager</span>

    <span class=c1>// intreeToCSITranslator translates in-tree volume specs to CSI
</span><span class=c1></span>    <span class=nx>intreeToCSITranslator</span> <span class=nx>csimigration</span><span class=p>.</span><span class=nx>InTreeToCSITranslator</span>
<span class=p>}</span>

</code></pre></td></tr></table></div></div><p>kubelet会调用VolumeManager，为pods准备存储设备，存储设备就绪会挂载存储设备到pod所在的节点上，并在容器启动的时候挂载在容器指定的目录中；同时，删除卸载不在使用的存储</p><h3 id=volumemanager接口说明>VolumeManager接口说明</h3><ul><li>运行在kubelet 里让存储Ready的部件，主要是mount/unmount（attach/detach可选）</li><li>pod调度到这个node上后才会有卷的相应操作，所以它的触发端是kubelet（严格讲是kubelet里的pod manager），根据Pod Manager里pod spec里申明的存储来触发卷的挂载操作</li><li>Kubelet会监听到调度到该节点上的pod声明，会把pod缓存到Pod Manager中，VolumeManager通过Pod Manager获取PV/PVC的状态，并进行分析出具体的attach/detach、mount/umount, 操作然后调用plugin进行相应的业务处理</li></ul><h3 id=volumemanager结构体>volumeManager结构体</h3><p>volumeManager结构体实现了VolumeManager接口，主要有两个需要注意：</p><ul><li>desiredStateOfWorld：预期状态，volume需要被attach，哪些pods引用这个volume</li><li>actualStateOfWorld：实际状态，volume已经被atttach哪个node，哪个pod mount volume</li></ul><h3 id=desiredstateofworld-和-actualstateofworld>desiredStateOfWorld 和 actualStateOfWorld</h3><ul><li><p>desiredStateOfWorld为理想的volume情况，它主要是根据podManger获取所有的Pod信息，从中提取Volume信息。</p></li><li><p>actualStateOfWorld则是实际的volume情况。</p></li><li><p>desiredStateOfWorldPopulator通过podManager去构建desiredStateOfWorld。</p></li><li><p>reconciler的工作主要是比较actualStateOfWorld和desiredStateOfWorld的差别，然后进行volume的创建、删除和修改，最后使二者达到一致。</p></li></ul><h2 id=流程>流程</h2><h3 id=新建>新建</h3><p>NewVolumeManager中主要构造了几个volume控制器</p><ul><li>volumePluginMgr 和 csiMigratedPluginManager</li><li>desiredStateOfWorldPopulator</li><li>reconciler</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-golang data-lang=golang><span class=c1>// NewMainKubelet instantiates a new Kubelet object along with all the required internal modules.
</span><span class=c1>// No initialization of Kubelet and its modules should happen here.
</span><span class=c1></span><span class=kd>func</span> <span class=nf>NewMainKubelet</span><span class=p>(){</span>

    <span class=c1>// ......
</span><span class=c1></span>
    <span class=c1>// setup volumeManager
</span><span class=c1></span>    <span class=nx>klet</span><span class=p>.</span><span class=nx>volumeManager</span> <span class=p>=</span> <span class=nx>volumemanager</span><span class=p>.</span><span class=nf>NewVolumeManager</span><span class=p>(</span>
        <span class=nx>kubeCfg</span><span class=p>.</span><span class=nx>EnableControllerAttachDetach</span><span class=p>,</span>
        <span class=nx>nodeName</span><span class=p>,</span>
        <span class=nx>klet</span><span class=p>.</span><span class=nx>podManager</span><span class=p>,</span>
        <span class=nx>klet</span><span class=p>.</span><span class=nx>statusManager</span><span class=p>,</span>
        <span class=nx>klet</span><span class=p>.</span><span class=nx>kubeClient</span><span class=p>,</span>
        <span class=nx>klet</span><span class=p>.</span><span class=nx>volumePluginMgr</span><span class=p>,</span>
        <span class=nx>klet</span><span class=p>.</span><span class=nx>containerRuntime</span><span class=p>,</span>
        <span class=nx>kubeDeps</span><span class=p>.</span><span class=nx>Mounter</span><span class=p>,</span>
        <span class=nx>kubeDeps</span><span class=p>.</span><span class=nx>HostUtil</span><span class=p>,</span>
        <span class=nx>klet</span><span class=p>.</span><span class=nf>getPodsDir</span><span class=p>(),</span>
        <span class=nx>kubeDeps</span><span class=p>.</span><span class=nx>Recorder</span><span class=p>,</span>
        <span class=nx>experimentalCheckNodeCapabilitiesBeforeMount</span><span class=p>,</span>
        <span class=nx>keepTerminatedPodVolumes</span><span class=p>,</span>
        <span class=nx>volumepathhandler</span><span class=p>.</span><span class=nf>NewBlockVolumePathHandler</span><span class=p>())</span>

    <span class=c1>// ......
</span><span class=c1></span><span class=p>}</span>


<span class=c1>// NewVolumeManager returns a new concrete instance implementing the
</span><span class=c1>// VolumeManager interface.
</span><span class=c1>//
</span><span class=c1>// kubeClient - kubeClient is the kube API client used by DesiredStateOfWorldPopulator
</span><span class=c1>//   to communicate with the API server to fetch PV and PVC objects
</span><span class=c1>// volumePluginMgr - the volume plugin manager used to access volume plugins.
</span><span class=c1>//   Must be pre-initialized.
</span><span class=c1></span><span class=kd>func</span> <span class=nf>NewVolumeManager</span><span class=p>(){</span>

    <span class=nx>vm</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>volumeManager</span><span class=p>{</span>
        <span class=nx>kubeClient</span><span class=p>:</span>          <span class=nx>kubeClient</span><span class=p>,</span>
        <span class=nx>volumePluginMgr</span><span class=p>:</span>     <span class=nx>volumePluginMgr</span><span class=p>,</span>
        <span class=nx>desiredStateOfWorld</span><span class=p>:</span> <span class=nx>cache</span><span class=p>.</span><span class=nf>NewDesiredStateOfWorld</span><span class=p>(</span><span class=nx>volumePluginMgr</span><span class=p>),</span>
        <span class=nx>actualStateOfWorld</span><span class=p>:</span>  <span class=nx>cache</span><span class=p>.</span><span class=nf>NewActualStateOfWorld</span><span class=p>(</span><span class=nx>nodeName</span><span class=p>,</span> <span class=nx>volumePluginMgr</span><span class=p>),</span>
        <span class=nx>operationExecutor</span><span class=p>:</span> <span class=nx>operationexecutor</span><span class=p>.</span><span class=nf>NewOperationExecutor</span><span class=p>(</span><span class=nx>operationexecutor</span><span class=p>.</span><span class=nf>NewOperationGenerator</span><span class=p>(</span>
            <span class=nx>kubeClient</span><span class=p>,</span>
            <span class=nx>volumePluginMgr</span><span class=p>,</span>
            <span class=nx>recorder</span><span class=p>,</span>
            <span class=nx>checkNodeCapabilitiesBeforeMount</span><span class=p>,</span>
            <span class=nx>blockVolumePathHandler</span><span class=p>)),</span>
    <span class=p>}</span>

    <span class=nx>intreeToCSITranslator</span> <span class=o>:=</span> <span class=nx>csitrans</span><span class=p>.</span><span class=nf>New</span><span class=p>()</span>
    <span class=nx>csiMigratedPluginManager</span> <span class=o>:=</span> <span class=nx>csimigration</span><span class=p>.</span><span class=nf>NewPluginManager</span><span class=p>(</span><span class=nx>intreeToCSITranslator</span><span class=p>)</span>

    <span class=nx>vm</span><span class=p>.</span><span class=nx>intreeToCSITranslator</span> <span class=p>=</span> <span class=nx>intreeToCSITranslator</span>
    <span class=nx>vm</span><span class=p>.</span><span class=nx>csiMigratedPluginManager</span> <span class=p>=</span> <span class=nx>csiMigratedPluginManager</span>
    <span class=nx>vm</span><span class=p>.</span><span class=nx>desiredStateOfWorldPopulator</span> <span class=p>=</span> <span class=nx>populator</span><span class=p>.</span><span class=nf>NewDesiredStateOfWorldPopulator</span><span class=p>(</span>
        <span class=nx>kubeClient</span><span class=p>,</span>
        <span class=nx>desiredStateOfWorldPopulatorLoopSleepPeriod</span><span class=p>,</span>
        <span class=nx>desiredStateOfWorldPopulatorGetPodStatusRetryDuration</span><span class=p>,</span>
        <span class=nx>podManager</span><span class=p>,</span>
        <span class=nx>podStatusProvider</span><span class=p>,</span>
        <span class=nx>vm</span><span class=p>.</span><span class=nx>desiredStateOfWorld</span><span class=p>,</span>
        <span class=nx>vm</span><span class=p>.</span><span class=nx>actualStateOfWorld</span><span class=p>,</span>
        <span class=nx>kubeContainerRuntime</span><span class=p>,</span>
        <span class=nx>keepTerminatedPodVolumes</span><span class=p>,</span>
        <span class=nx>csiMigratedPluginManager</span><span class=p>,</span>
        <span class=nx>intreeToCSITranslator</span><span class=p>,</span>
        <span class=nx>volumePluginMgr</span><span class=p>)</span>
    <span class=nx>vm</span><span class=p>.</span><span class=nx>reconciler</span> <span class=p>=</span> <span class=nx>reconciler</span><span class=p>.</span><span class=nf>NewReconciler</span><span class=p>(</span>
        <span class=nx>kubeClient</span><span class=p>,</span>
        <span class=nx>controllerAttachDetachEnabled</span><span class=p>,</span>
        <span class=nx>reconcilerLoopSleepPeriod</span><span class=p>,</span>
        <span class=nx>waitForAttachTimeout</span><span class=p>,</span>
        <span class=nx>nodeName</span><span class=p>,</span>
        <span class=nx>vm</span><span class=p>.</span><span class=nx>desiredStateOfWorld</span><span class=p>,</span>
        <span class=nx>vm</span><span class=p>.</span><span class=nx>actualStateOfWorld</span><span class=p>,</span>
        <span class=nx>vm</span><span class=p>.</span><span class=nx>desiredStateOfWorldPopulator</span><span class=p>.</span><span class=nx>HasAddedPods</span><span class=p>,</span>
        <span class=nx>vm</span><span class=p>.</span><span class=nx>operationExecutor</span><span class=p>,</span>
        <span class=nx>mounter</span><span class=p>,</span>
        <span class=nx>hostutil</span><span class=p>,</span>
        <span class=nx>volumePluginMgr</span><span class=p>,</span>
        <span class=nx>kubeletPodsDir</span><span class=p>)</span>

    <span class=k>return</span> <span class=nx>vm</span>
<span class=p>}</span>



<span class=c1>// NewDesiredStateOfWorldPopulator returns a new instance of
</span><span class=c1>// DesiredStateOfWorldPopulator.
</span><span class=c1>//
</span><span class=c1>// kubeClient - used to fetch PV and PVC objects from the API server
</span><span class=c1>// loopSleepDuration - the amount of time the populator loop sleeps between
</span><span class=c1>//     successive executions
</span><span class=c1>// podManager - the kubelet podManager that is the source of truth for the pods
</span><span class=c1>//     that exist on this host
</span><span class=c1>// desiredStateOfWorld - the cache to populate
</span><span class=c1></span><span class=kd>func</span> <span class=nf>NewDesiredStateOfWorldPopulator</span><span class=p>(</span>
    <span class=nx>kubeClient</span> <span class=nx>clientset</span><span class=p>.</span><span class=nx>Interface</span><span class=p>,</span>
    <span class=nx>loopSleepDuration</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>,</span>
    <span class=nx>getPodStatusRetryDuration</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>,</span>
    <span class=nx>podManager</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Manager</span><span class=p>,</span>
    <span class=nx>podStatusProvider</span> <span class=nx>status</span><span class=p>.</span><span class=nx>PodStatusProvider</span><span class=p>,</span>
    <span class=nx>desiredStateOfWorld</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>DesiredStateOfWorld</span><span class=p>,</span>
    <span class=nx>actualStateOfWorld</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>ActualStateOfWorld</span><span class=p>,</span>
    <span class=nx>kubeContainerRuntime</span> <span class=nx>kubecontainer</span><span class=p>.</span><span class=nx>Runtime</span><span class=p>,</span>
    <span class=nx>keepTerminatedPodVolumes</span> <span class=kt>bool</span><span class=p>,</span>
    <span class=nx>csiMigratedPluginManager</span> <span class=nx>csimigration</span><span class=p>.</span><span class=nx>PluginManager</span><span class=p>,</span>
    <span class=nx>intreeToCSITranslator</span> <span class=nx>csimigration</span><span class=p>.</span><span class=nx>InTreeToCSITranslator</span><span class=p>,</span>
    <span class=nx>volumePluginMgr</span> <span class=o>*</span><span class=nx>volume</span><span class=p>.</span><span class=nx>VolumePluginMgr</span><span class=p>)</span> <span class=nx>DesiredStateOfWorldPopulator</span> <span class=p>{</span>
    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>desiredStateOfWorldPopulator</span><span class=p>{</span>
        <span class=nx>kubeClient</span><span class=p>:</span>                <span class=nx>kubeClient</span><span class=p>,</span>
        <span class=nx>loopSleepDuration</span><span class=p>:</span>         <span class=nx>loopSleepDuration</span><span class=p>,</span>
        <span class=nx>getPodStatusRetryDuration</span><span class=p>:</span> <span class=nx>getPodStatusRetryDuration</span><span class=p>,</span>
        <span class=nx>podManager</span><span class=p>:</span>                <span class=nx>podManager</span><span class=p>,</span>
        <span class=nx>podStatusProvider</span><span class=p>:</span>         <span class=nx>podStatusProvider</span><span class=p>,</span>
        <span class=nx>desiredStateOfWorld</span><span class=p>:</span>       <span class=nx>desiredStateOfWorld</span><span class=p>,</span>
        <span class=nx>actualStateOfWorld</span><span class=p>:</span>        <span class=nx>actualStateOfWorld</span><span class=p>,</span>
        <span class=nx>pods</span><span class=p>:</span> <span class=nx>processedPods</span><span class=p>{</span>
            <span class=nx>processedPods</span><span class=p>:</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=nx>volumetypes</span><span class=p>.</span><span class=nx>UniquePodName</span><span class=p>]</span><span class=kt>bool</span><span class=p>)},</span>
        <span class=nx>kubeContainerRuntime</span><span class=p>:</span>     <span class=nx>kubeContainerRuntime</span><span class=p>,</span>
        <span class=nx>keepTerminatedPodVolumes</span><span class=p>:</span> <span class=nx>keepTerminatedPodVolumes</span><span class=p>,</span>
        <span class=nx>hasAddedPods</span><span class=p>:</span>             <span class=kc>false</span><span class=p>,</span>
        <span class=nx>hasAddedPodsLock</span><span class=p>:</span>         <span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span><span class=p>{},</span>
        <span class=nx>csiMigratedPluginManager</span><span class=p>:</span> <span class=nx>csiMigratedPluginManager</span><span class=p>,</span>
        <span class=nx>intreeToCSITranslator</span><span class=p>:</span>    <span class=nx>intreeToCSITranslator</span><span class=p>,</span>
        <span class=nx>volumePluginMgr</span><span class=p>:</span>          <span class=nx>volumePluginMgr</span><span class=p>,</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=kd>type</span> <span class=nx>desiredStateOfWorldPopulator</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>kubeClient</span>                <span class=nx>clientset</span><span class=p>.</span><span class=nx>Interface</span>
    <span class=nx>loopSleepDuration</span>         <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
    <span class=nx>getPodStatusRetryDuration</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
    <span class=nx>podManager</span>                <span class=nx>pod</span><span class=p>.</span><span class=nx>Manager</span>
    <span class=nx>podStatusProvider</span>         <span class=nx>status</span><span class=p>.</span><span class=nx>PodStatusProvider</span>
    <span class=nx>desiredStateOfWorld</span>       <span class=nx>cache</span><span class=p>.</span><span class=nx>DesiredStateOfWorld</span>
    <span class=nx>actualStateOfWorld</span>        <span class=nx>cache</span><span class=p>.</span><span class=nx>ActualStateOfWorld</span>
    <span class=nx>pods</span>                      <span class=nx>processedPods</span>
    <span class=nx>kubeContainerRuntime</span>      <span class=nx>kubecontainer</span><span class=p>.</span><span class=nx>Runtime</span>
    <span class=nx>timeOfLastGetPodStatus</span>    <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>
    <span class=nx>keepTerminatedPodVolumes</span>  <span class=kt>bool</span>
    <span class=nx>hasAddedPods</span>              <span class=kt>bool</span>
    <span class=nx>hasAddedPodsLock</span>          <span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span>
    <span class=nx>csiMigratedPluginManager</span>  <span class=nx>csimigration</span><span class=p>.</span><span class=nx>PluginManager</span>
    <span class=nx>intreeToCSITranslator</span>     <span class=nx>csimigration</span><span class=p>.</span><span class=nx>InTreeToCSITranslator</span>
    <span class=nx>volumePluginMgr</span>           <span class=o>*</span><span class=nx>volume</span><span class=p>.</span><span class=nx>VolumePluginMgr</span>
<span class=p>}</span>



<span class=c1>// NewReconciler returns a new instance of Reconciler.
</span><span class=c1>//
</span><span class=c1>// controllerAttachDetachEnabled - if true, indicates that the attach/detach
</span><span class=c1>//   controller is responsible for managing the attach/detach operations for
</span><span class=c1>//   this node, and therefore the volume manager should not
</span><span class=c1>// loopSleepDuration - the amount of time the reconciler loop sleeps between
</span><span class=c1>//   successive executions
</span><span class=c1>// waitForAttachTimeout - the amount of time the Mount function will wait for
</span><span class=c1>//   the volume to be attached
</span><span class=c1>// nodeName - the Name for this node, used by Attach and Detach methods
</span><span class=c1>// desiredStateOfWorld - cache containing the desired state of the world
</span><span class=c1>// actualStateOfWorld - cache containing the actual state of the world
</span><span class=c1>// populatorHasAddedPods - checker for whether the populator has finished
</span><span class=c1>//   adding pods to the desiredStateOfWorld cache at least once after sources
</span><span class=c1>//   are all ready (before sources are ready, pods are probably missing)
</span><span class=c1>// operationExecutor - used to trigger attach/detach/mount/unmount operations
</span><span class=c1>//   safely (prevents more than one operation from being triggered on the same
</span><span class=c1>//   volume)
</span><span class=c1>// mounter - mounter passed in from kubelet, passed down unmount path
</span><span class=c1>// hostutil - hostutil passed in from kubelet
</span><span class=c1>// volumePluginMgr - volume plugin manager passed from kubelet
</span><span class=c1></span><span class=kd>func</span> <span class=nf>NewReconciler</span><span class=p>(</span>
    <span class=nx>kubeClient</span> <span class=nx>clientset</span><span class=p>.</span><span class=nx>Interface</span><span class=p>,</span>
    <span class=nx>controllerAttachDetachEnabled</span> <span class=kt>bool</span><span class=p>,</span>
    <span class=nx>loopSleepDuration</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>,</span>
    <span class=nx>waitForAttachTimeout</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>,</span>
    <span class=nx>nodeName</span> <span class=nx>types</span><span class=p>.</span><span class=nx>NodeName</span><span class=p>,</span>
    <span class=nx>desiredStateOfWorld</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>DesiredStateOfWorld</span><span class=p>,</span>
    <span class=nx>actualStateOfWorld</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>ActualStateOfWorld</span><span class=p>,</span>
    <span class=nx>populatorHasAddedPods</span> <span class=kd>func</span><span class=p>()</span> <span class=kt>bool</span><span class=p>,</span>
    <span class=nx>operationExecutor</span> <span class=nx>operationexecutor</span><span class=p>.</span><span class=nx>OperationExecutor</span><span class=p>,</span>
    <span class=nx>mounter</span> <span class=nx>mount</span><span class=p>.</span><span class=nx>Interface</span><span class=p>,</span>
    <span class=nx>hostutil</span> <span class=nx>hostutil</span><span class=p>.</span><span class=nx>HostUtils</span><span class=p>,</span>
    <span class=nx>volumePluginMgr</span> <span class=o>*</span><span class=nx>volumepkg</span><span class=p>.</span><span class=nx>VolumePluginMgr</span><span class=p>,</span>
    <span class=nx>kubeletPodsDir</span> <span class=kt>string</span><span class=p>)</span> <span class=nx>Reconciler</span> <span class=p>{</span>
    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>reconciler</span><span class=p>{</span>
        <span class=nx>kubeClient</span><span class=p>:</span>                    <span class=nx>kubeClient</span><span class=p>,</span>
        <span class=nx>controllerAttachDetachEnabled</span><span class=p>:</span> <span class=nx>controllerAttachDetachEnabled</span><span class=p>,</span>
        <span class=nx>loopSleepDuration</span><span class=p>:</span>             <span class=nx>loopSleepDuration</span><span class=p>,</span>
        <span class=nx>waitForAttachTimeout</span><span class=p>:</span>          <span class=nx>waitForAttachTimeout</span><span class=p>,</span>
        <span class=nx>nodeName</span><span class=p>:</span>                      <span class=nx>nodeName</span><span class=p>,</span>
        <span class=nx>desiredStateOfWorld</span><span class=p>:</span>           <span class=nx>desiredStateOfWorld</span><span class=p>,</span>
        <span class=nx>actualStateOfWorld</span><span class=p>:</span>            <span class=nx>actualStateOfWorld</span><span class=p>,</span>
        <span class=nx>populatorHasAddedPods</span><span class=p>:</span>         <span class=nx>populatorHasAddedPods</span><span class=p>,</span>
        <span class=nx>operationExecutor</span><span class=p>:</span>             <span class=nx>operationExecutor</span><span class=p>,</span>
        <span class=nx>mounter</span><span class=p>:</span>                       <span class=nx>mounter</span><span class=p>,</span>
        <span class=nx>hostutil</span><span class=p>:</span>                      <span class=nx>hostutil</span><span class=p>,</span>
        <span class=nx>volumePluginMgr</span><span class=p>:</span>               <span class=nx>volumePluginMgr</span><span class=p>,</span>
        <span class=nx>kubeletPodsDir</span><span class=p>:</span>                <span class=nx>kubeletPodsDir</span><span class=p>,</span>
        <span class=nx>timeOfLastSync</span><span class=p>:</span>                <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{},</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=kd>type</span> <span class=nx>reconciler</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>kubeClient</span>                    <span class=nx>clientset</span><span class=p>.</span><span class=nx>Interface</span>
    <span class=nx>controllerAttachDetachEnabled</span> <span class=kt>bool</span>
    <span class=nx>loopSleepDuration</span>             <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
    <span class=nx>waitForAttachTimeout</span>          <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
    <span class=nx>nodeName</span>                      <span class=nx>types</span><span class=p>.</span><span class=nx>NodeName</span>
    <span class=nx>desiredStateOfWorld</span>           <span class=nx>cache</span><span class=p>.</span><span class=nx>DesiredStateOfWorld</span>
    <span class=nx>actualStateOfWorld</span>            <span class=nx>cache</span><span class=p>.</span><span class=nx>ActualStateOfWorld</span>
    <span class=nx>populatorHasAddedPods</span>         <span class=kd>func</span><span class=p>()</span> <span class=kt>bool</span>
    <span class=nx>operationExecutor</span>             <span class=nx>operationexecutor</span><span class=p>.</span><span class=nx>OperationExecutor</span>
    <span class=nx>mounter</span>                       <span class=nx>mount</span><span class=p>.</span><span class=nx>Interface</span>
    <span class=nx>hostutil</span>                      <span class=nx>hostutil</span><span class=p>.</span><span class=nx>HostUtils</span>
    <span class=nx>volumePluginMgr</span>               <span class=o>*</span><span class=nx>volumepkg</span><span class=p>.</span><span class=nx>VolumePluginMgr</span>
    <span class=nx>kubeletPodsDir</span>                <span class=kt>string</span>
    <span class=nx>timeOfLastSync</span>                <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><h3 id=启动>启动</h3><p>kl.volumeManager.Run</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-golang data-lang=golang><span class=c1>// Run starts the kubelet reacting to config updates
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>kl</span> <span class=o>*</span><span class=nx>Kubelet</span><span class=p>)</span> <span class=nf>Run</span><span class=p>(</span><span class=nx>updates</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=nx>kubetypes</span><span class=p>.</span><span class=nx>PodUpdate</span><span class=p>)</span> <span class=p>{</span>

    <span class=c1>// Start volume manager
</span><span class=c1></span>    <span class=k>go</span> <span class=nx>kl</span><span class=p>.</span><span class=nx>volumeManager</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nx>kl</span><span class=p>.</span><span class=nx>sourcesReady</span><span class=p>,</span> <span class=nx>wait</span><span class=p>.</span><span class=nx>NeverStop</span><span class=p>)</span>

    <span class=k>go</span> <span class=nx>wait</span><span class=p>.</span><span class=nf>Until</span><span class=p>(</span><span class=nx>kl</span><span class=p>.</span><span class=nx>updateRuntimeUp</span><span class=p>,</span> <span class=mi>5</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span> <span class=nx>wait</span><span class=p>.</span><span class=nx>NeverStop</span><span class=p>)</span>

    <span class=c1>// Set up iptables util rules
</span><span class=c1></span>    <span class=k>if</span> <span class=nx>kl</span><span class=p>.</span><span class=nx>makeIPTablesUtilChains</span> <span class=p>{</span>
        <span class=nx>kl</span><span class=p>.</span><span class=nf>initNetworkUtil</span><span class=p>()</span>
    <span class=p>}</span>

    <span class=c1>// Start a goroutine responsible for killing pods (that are not properly
</span><span class=c1></span>    <span class=c1>// handled by pod workers).
</span><span class=c1></span>    <span class=k>go</span> <span class=nx>wait</span><span class=p>.</span><span class=nf>Until</span><span class=p>(</span><span class=nx>kl</span><span class=p>.</span><span class=nx>podKiller</span><span class=p>.</span><span class=nx>PerformPodKillingWork</span><span class=p>,</span> <span class=mi>1</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span> <span class=nx>wait</span><span class=p>.</span><span class=nx>NeverStop</span><span class=p>)</span>

    <span class=c1>// Start component sync loops.
</span><span class=c1></span>    <span class=nx>kl</span><span class=p>.</span><span class=nx>statusManager</span><span class=p>.</span><span class=nf>Start</span><span class=p>()</span>
    <span class=nx>kl</span><span class=p>.</span><span class=nx>probeManager</span><span class=p>.</span><span class=nf>Start</span><span class=p>()</span>

    <span class=c1>// Start syncing RuntimeClasses if enabled.
</span><span class=c1></span>    <span class=k>if</span> <span class=nx>kl</span><span class=p>.</span><span class=nx>runtimeClassManager</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>kl</span><span class=p>.</span><span class=nx>runtimeClassManager</span><span class=p>.</span><span class=nf>Start</span><span class=p>(</span><span class=nx>wait</span><span class=p>.</span><span class=nx>NeverStop</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=c1>// Start the pod lifecycle event generator.
</span><span class=c1></span>    <span class=nx>kl</span><span class=p>.</span><span class=nx>pleg</span><span class=p>.</span><span class=nf>Start</span><span class=p>()</span>
    <span class=nx>kl</span><span class=p>.</span><span class=nf>syncLoop</span><span class=p>(</span><span class=nx>updates</span><span class=p>,</span> <span class=nx>kl</span><span class=p>)</span>
<span class=p>}</span>


<span class=kd>func</span> <span class=p>(</span><span class=nx>vm</span> <span class=o>*</span><span class=nx>volumeManager</span><span class=p>)</span> <span class=nf>Run</span><span class=p>(</span><span class=nx>sourcesReady</span> <span class=nx>config</span><span class=p>.</span><span class=nx>SourcesReady</span><span class=p>,</span> <span class=nx>stopCh</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span> <span class=p>{</span>
    <span class=k>defer</span> <span class=nx>runtime</span><span class=p>.</span><span class=nf>HandleCrash</span><span class=p>()</span>

    <span class=k>if</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>kubeClient</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=c1>// start informer for CSIDriver
</span><span class=c1></span>        <span class=k>go</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>volumePluginMgr</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nx>stopCh</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=k>go</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>desiredStateOfWorldPopulator</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nx>sourcesReady</span><span class=p>,</span> <span class=nx>stopCh</span><span class=p>)</span>
    <span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>2</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;The desired_state_of_world populator starts&#34;</span><span class=p>)</span>

    <span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Starting Kubelet Volume Manager&#34;</span><span class=p>)</span>
    <span class=k>go</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>reconciler</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nx>stopCh</span><span class=p>)</span>

    <span class=nx>metrics</span><span class=p>.</span><span class=nf>Register</span><span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>actualStateOfWorld</span><span class=p>,</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>desiredStateOfWorld</span><span class=p>,</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>volumePluginMgr</span><span class=p>)</span>

    <span class=o>&lt;-</span><span class=nx>stopCh</span>
    <span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Shutting down Kubelet Volume Manager&#34;</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>启动子模块有</p><ul><li>如果有volumePlugin（默认安装时没有插件），启动volumePluginMgr</li><li>启动 desiredStateOfWorldPopulator：从apiserver同步到的pod信息，更新DesiredStateOfWorld<ul><li>findAndAddNewPods()</li><li>findAndRemoveDeletedPods() 每隔dswp.getPodStatusRetryDuration时长，进行findAndRemoveDeletedPods()</li></ul></li><li>启动 reconciler：预期状态和实际状态的协调者，负责调整实际状态至预期状态</li></ul><h4 id=desiredstateofworldpopulator>desiredStateOfWorldPopulator</h4><p>通过populatorLoop()来更新DesiredStateOfWorld</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-golang data-lang=golang>
<span class=kd>func</span> <span class=p>(</span><span class=nx>dswp</span> <span class=o>*</span><span class=nx>desiredStateOfWorldPopulator</span><span class=p>)</span> <span class=nf>populatorLoop</span><span class=p>()</span> <span class=p>{</span>
    <span class=nx>dswp</span><span class=p>.</span><span class=nf>findAndAddNewPods</span><span class=p>()</span>

    <span class=c1>// findAndRemoveDeletedPods() calls out to the container runtime to
</span><span class=c1></span>    <span class=c1>// determine if the containers for a given pod are terminated. This is
</span><span class=c1></span>    <span class=c1>// an expensive operation, therefore we limit the rate that
</span><span class=c1></span>    <span class=c1>// findAndRemoveDeletedPods() is called independently of the main
</span><span class=c1></span>    <span class=c1>// populator loop.
</span><span class=c1></span>    <span class=k>if</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Since</span><span class=p>(</span><span class=nx>dswp</span><span class=p>.</span><span class=nx>timeOfLastGetPodStatus</span><span class=p>)</span> <span class=p>&lt;</span> <span class=nx>dswp</span><span class=p>.</span><span class=nx>getPodStatusRetryDuration</span> <span class=p>{</span>
        <span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>5</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span>
            <span class=s>&#34;Skipping findAndRemoveDeletedPods(). Not permitted until %v (getPodStatusRetryDuration %v).&#34;</span><span class=p>,</span>
            <span class=nx>dswp</span><span class=p>.</span><span class=nx>timeOfLastGetPodStatus</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>dswp</span><span class=p>.</span><span class=nx>getPodStatusRetryDuration</span><span class=p>),</span>
            <span class=nx>dswp</span><span class=p>.</span><span class=nx>getPodStatusRetryDuration</span><span class=p>)</span>

        <span class=k>return</span>
    <span class=p>}</span>

    <span class=nx>dswp</span><span class=p>.</span><span class=nf>findAndRemoveDeletedPods</span><span class=p>()</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><h5 id=findandaddnewpods>findAndAddNewPods</h5><ul><li>遍历pod manager中所有pod</li><li>过滤掉Terminated态的pod，进行processPodVolumes，把这些pod添加到desired state of world</li></ul><p>就是通过podManager获取所有的pods，然后调用processPodVolumes去更新desiredStateOfWorld。但是这样只能更新新增加的Pods的Volume信息。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-golang data-lang=golang>
<span class=c1>// Iterate through all pods and add to desired state of world if they don&#39;t
</span><span class=c1>// exist but should
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>dswp</span> <span class=o>*</span><span class=nx>desiredStateOfWorldPopulator</span><span class=p>)</span> <span class=nf>findAndAddNewPods</span><span class=p>()</span> <span class=p>{</span>
    <span class=c1>// Map unique pod name to outer volume name to MountedVolume.
</span><span class=c1></span>    <span class=nx>mountedVolumesForPod</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=nx>volumetypes</span><span class=p>.</span><span class=nx>UniquePodName</span><span class=p>]</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>cache</span><span class=p>.</span><span class=nx>MountedVolume</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>utilfeature</span><span class=p>.</span><span class=nx>DefaultFeatureGate</span><span class=p>.</span><span class=nf>Enabled</span><span class=p>(</span><span class=nx>features</span><span class=p>.</span><span class=nx>ExpandInUsePersistentVolumes</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>mountedVolume</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>dswp</span><span class=p>.</span><span class=nx>actualStateOfWorld</span><span class=p>.</span><span class=nf>GetMountedVolumes</span><span class=p>()</span> <span class=p>{</span>
            <span class=nx>mountedVolumes</span><span class=p>,</span> <span class=nx>exist</span> <span class=o>:=</span> <span class=nx>mountedVolumesForPod</span><span class=p>[</span><span class=nx>mountedVolume</span><span class=p>.</span><span class=nx>PodName</span><span class=p>]</span>
            <span class=k>if</span> <span class=p>!</span><span class=nx>exist</span> <span class=p>{</span>
                <span class=nx>mountedVolumes</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>cache</span><span class=p>.</span><span class=nx>MountedVolume</span><span class=p>)</span>
                <span class=nx>mountedVolumesForPod</span><span class=p>[</span><span class=nx>mountedVolume</span><span class=p>.</span><span class=nx>PodName</span><span class=p>]</span> <span class=p>=</span> <span class=nx>mountedVolumes</span>
            <span class=p>}</span>
            <span class=nx>mountedVolumes</span><span class=p>[</span><span class=nx>mountedVolume</span><span class=p>.</span><span class=nx>OuterVolumeSpecName</span><span class=p>]</span> <span class=p>=</span> <span class=nx>mountedVolume</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=nx>processedVolumesForFSResize</span> <span class=o>:=</span> <span class=nx>sets</span><span class=p>.</span><span class=nf>NewString</span><span class=p>()</span>
    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>dswp</span><span class=p>.</span><span class=nx>podManager</span><span class=p>.</span><span class=nf>GetPods</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>if</span> <span class=nx>dswp</span><span class=p>.</span><span class=nf>isPodTerminated</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// Do not (re)add volumes for terminated pods
</span><span class=c1></span>            <span class=k>continue</span>
        <span class=p>}</span>
        <span class=nx>dswp</span><span class=p>.</span><span class=nf>processPodVolumes</span><span class=p>(</span><span class=nx>pod</span><span class=p>,</span> <span class=nx>mountedVolumesForPod</span><span class=p>,</span> <span class=nx>processedVolumesForFSResize</span><span class=p>)</span>
    <span class=p>}</span>
<span class=p>}</span>

</code></pre></td></tr></table></div></div><h5 id=processpodvolumes>processPodVolumes</h5><p>更新desiredStateOfWorld</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-golang data-lang=golang>
<span class=c1>// processPodVolumes processes the volumes in the given pod and adds them to the
</span><span class=c1>// desired state of the world.
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>dswp</span> <span class=o>*</span><span class=nx>desiredStateOfWorldPopulator</span><span class=p>)</span> <span class=nf>processPodVolumes</span><span class=p>(</span>
    <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span>
    <span class=nx>mountedVolumesForPod</span> <span class=kd>map</span><span class=p>[</span><span class=nx>volumetypes</span><span class=p>.</span><span class=nx>UniquePodName</span><span class=p>]</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>cache</span><span class=p>.</span><span class=nx>MountedVolume</span><span class=p>,</span>
    <span class=nx>processedVolumesForFSResize</span> <span class=nx>sets</span><span class=p>.</span><span class=nx>String</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=nx>pod</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=k>return</span>
    <span class=p>}</span>

    <span class=nx>uniquePodName</span> <span class=o>:=</span> <span class=nx>util</span><span class=p>.</span><span class=nf>GetUniquePodName</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span>
    <span class=c1>// 如果先前在processedPods map中，表示无需处理，提前返回
</span><span class=c1></span>    <span class=k>if</span> <span class=nx>dswp</span><span class=p>.</span><span class=nf>podPreviouslyProcessed</span><span class=p>(</span><span class=nx>uniquePodName</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span>
    <span class=p>}</span>

    <span class=nx>allVolumesAdded</span> <span class=o>:=</span> <span class=kc>true</span>
    <span class=c1>// 获取 全部 容器的mount信息container.VolumeMounts
</span><span class=c1></span>    <span class=c1>// 对pod下所有container的volumeDevices与volumeMounts加入map中
</span><span class=c1></span>    <span class=nx>mounts</span><span class=p>,</span> <span class=nx>devices</span> <span class=o>:=</span> <span class=nx>util</span><span class=p>.</span><span class=nf>GetPodVolumeNames</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span>

    <span class=nx>expandInUsePV</span> <span class=o>:=</span> <span class=nx>utilfeature</span><span class=p>.</span><span class=nx>DefaultFeatureGate</span><span class=p>.</span><span class=nf>Enabled</span><span class=p>(</span><span class=nx>features</span><span class=p>.</span><span class=nx>ExpandInUsePersistentVolumes</span><span class=p>)</span>
    <span class=c1>// Process volume spec for each volume defined in pod
</span><span class=c1></span>    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>podVolume</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Volumes</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>!</span><span class=nx>mounts</span><span class=p>.</span><span class=nf>Has</span><span class=p>(</span><span class=nx>podVolume</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>devices</span><span class=p>.</span><span class=nf>Has</span><span class=p>(</span><span class=nx>podVolume</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// Volume is not used in the pod, ignore it.
</span><span class=c1></span>            <span class=c1>// pod中定义了pod.Spec.Volumes[x].name，但是容器没有挂载使用，则忽略
</span><span class=c1></span>            <span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Skipping unused volume %q for pod %q&#34;</span><span class=p>,</span> <span class=nx>podVolume</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>format</span><span class=p>.</span><span class=nf>Pod</span><span class=p>(</span><span class=nx>pod</span><span class=p>))</span>
            <span class=k>continue</span>
        <span class=p>}</span>
        <span class=c1>// createVolumeSpec创建并返回一个可变的volume.Spec的对象。如果需要，它可通过PVC的间接引用以获得PV对象。当无法获取卷时返回报错
</span><span class=c1></span>        <span class=nx>pvc</span><span class=p>,</span> <span class=nx>volumeSpec</span><span class=p>,</span> <span class=nx>volumeGidValue</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span>
            <span class=nx>dswp</span><span class=p>.</span><span class=nf>createVolumeSpec</span><span class=p>(</span><span class=nx>podVolume</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>mounts</span><span class=p>,</span> <span class=nx>devices</span><span class=p>)</span>
        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span>
                <span class=s>&#34;Error processing volume %q for pod %q: %v&#34;</span><span class=p>,</span>
                <span class=nx>podVolume</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span>
                <span class=nx>format</span><span class=p>.</span><span class=nf>Pod</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span>
                <span class=nx>err</span><span class=p>)</span>
            <span class=nx>dswp</span><span class=p>.</span><span class=nx>desiredStateOfWorld</span><span class=p>.</span><span class=nf>AddErrorToPod</span><span class=p>(</span><span class=nx>uniquePodName</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
            <span class=nx>allVolumesAdded</span> <span class=p>=</span> <span class=kc>false</span>
            <span class=k>continue</span>
        <span class=p>}</span>

        <span class=c1>// Add volume to desired state of world
</span><span class=c1></span>        <span class=c1>// 调用FindPluginBySpec函数根据volume.spec找到volume plugin
</span><span class=c1></span>        <span class=c1>//  isAttachableVolume函数，检查插件是否需要attach,不是所有的插件都需要实现AttachableVolumePlugin接口
</span><span class=c1></span>        <span class=c1>// 记录volume与pod之间的关系
</span><span class=c1></span>        <span class=c1>// 对pod name标记为已处理，actual_state_of_world标记重新挂载
</span><span class=c1></span>        <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>dswp</span><span class=p>.</span><span class=nx>desiredStateOfWorld</span><span class=p>.</span><span class=nf>AddPodToVolume</span><span class=p>(</span>
            <span class=nx>uniquePodName</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>volumeSpec</span><span class=p>,</span> <span class=nx>podVolume</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>volumeGidValue</span><span class=p>)</span>
        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span>
                <span class=s>&#34;Failed to add volume %s (specName: %s) for pod %q to desiredStateOfWorld: %v&#34;</span><span class=p>,</span>
                <span class=nx>podVolume</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span>
                <span class=nx>volumeSpec</span><span class=p>.</span><span class=nf>Name</span><span class=p>(),</span>
                <span class=nx>uniquePodName</span><span class=p>,</span>
                <span class=nx>err</span><span class=p>)</span>
            <span class=nx>dswp</span><span class=p>.</span><span class=nx>desiredStateOfWorld</span><span class=p>.</span><span class=nf>AddErrorToPod</span><span class=p>(</span><span class=nx>uniquePodName</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
            <span class=nx>allVolumesAdded</span> <span class=p>=</span> <span class=kc>false</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span>
                <span class=s>&#34;Added volume %q (volSpec=%q) for pod %q to desired state.&#34;</span><span class=p>,</span>
                <span class=nx>podVolume</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span>
                <span class=nx>volumeSpec</span><span class=p>.</span><span class=nf>Name</span><span class=p>(),</span>
                <span class=nx>uniquePodName</span><span class=p>)</span>
        <span class=p>}</span>
        <span class=c1>// 是否有卷容量调整操作, 实际上是比较 pvc.Status.Capacity 和 pvc.Spec.Capacity
</span><span class=c1></span>        <span class=c1>// pvc.Spec.Capacity &gt; pvc.Status.Capacity时，进行扩容处理
</span><span class=c1></span>        <span class=k>if</span> <span class=nx>expandInUsePV</span> <span class=p>{</span>
            <span class=nx>dswp</span><span class=p>.</span><span class=nf>checkVolumeFSResize</span><span class=p>(</span><span class=nx>pod</span><span class=p>,</span> <span class=nx>podVolume</span><span class=p>,</span> <span class=nx>pvc</span><span class=p>,</span> <span class=nx>volumeSpec</span><span class=p>,</span>
                <span class=nx>uniquePodName</span><span class=p>,</span> <span class=nx>mountedVolumesForPod</span><span class=p>,</span> <span class=nx>processedVolumesForFSResize</span><span class=p>)</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=c1>// some of the volume additions may have failed, should not mark this pod as fully processed
</span><span class=c1></span>    <span class=k>if</span> <span class=nx>allVolumesAdded</span> <span class=p>{</span>
        <span class=nx>dswp</span><span class=p>.</span><span class=nf>markPodProcessed</span><span class=p>(</span><span class=nx>uniquePodName</span><span class=p>)</span>
        <span class=c1>// New pod has been synced. Re-mount all volumes that need it
</span><span class=c1></span>        <span class=c1>// (e.g. DownwardAPI)
</span><span class=c1></span>        <span class=nx>dswp</span><span class=p>.</span><span class=nx>actualStateOfWorld</span><span class=p>.</span><span class=nf>MarkRemountRequired</span><span class=p>(</span><span class=nx>uniquePodName</span><span class=p>)</span>
        <span class=c1>// Remove any stored errors for the pod, everything went well in this processPodVolumes
</span><span class=c1></span>        <span class=nx>dswp</span><span class=p>.</span><span class=nx>desiredStateOfWorld</span><span class=p>.</span><span class=nf>PopPodErrors</span><span class=p>(</span><span class=nx>uniquePodName</span><span class=p>)</span>
    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>dswp</span><span class=p>.</span><span class=nf>podHasBeenSeenOnce</span><span class=p>(</span><span class=nx>uniquePodName</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// For the Pod which has been processed at least once, even though some volumes
</span><span class=c1></span>        <span class=c1>// may not have been reprocessed successfully this round, we still mark it as processed to avoid
</span><span class=c1></span>        <span class=c1>// processing it at a very high frequency. The pod will be reprocessed when volume manager calls
</span><span class=c1></span>        <span class=c1>// ReprocessPod() which is triggered by SyncPod.
</span><span class=c1></span>        <span class=nx>dswp</span><span class=p>.</span><span class=nf>markPodProcessed</span><span class=p>(</span><span class=nx>uniquePodName</span><span class=p>)</span>
    <span class=p>}</span>

<span class=p>}</span>

</code></pre></td></tr></table></div></div><h5 id=findandremovedeletedpods>findAndRemoveDeletedPods</h5><ul><li>由于findAndRemoveDeletedPods 代价比较高昂，因此会检查执行的间隔时间。</li><li>遍历desiredStateOfWorld.GetVolumesToMount()的挂载volumes，根据volumeToMount.Pod判断该Volume所属的Pod是否存在于podManager。<ul><li>如果存在podExists，则继续判断pod是否终止：如果pod为终止则忽略</li><li>根据containerRuntime进一步判断pod中的全部容器是否终止：如果该pod仍有容器未终止，则忽略</li><li>根据actualStateOfWorld.PodExistsInVolume判断：Actual state没有该pod的挂载volume，但pod manager仍有该pod，则忽略</li><li>删除管理器中该pod的该挂载卷：desiredStateOfWorld.DeletePodFromVolume(volumeToMount.PodName, volumeToMount.VolumeName)</li><li>删除管理器中该pod信息(desiredStateOfWorldPopulator.pods[volumeToMount.PodName])：deleteProcessedPod(volumeToMount.PodName)</li></ul></li></ul><p>简单说，对于pod manager已经不存在的pods，findAndRemoveDeletedPods会删除更新desiredStateOfWorld中这些pod和其volume记录</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-golang data-lang=golang><span class=c1>// Iterate through all pods in desired state of world, and remove if they no
</span><span class=c1>// longer exist
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>dswp</span> <span class=o>*</span><span class=nx>desiredStateOfWorldPopulator</span><span class=p>)</span> <span class=nf>findAndRemoveDeletedPods</span><span class=p>()</span> <span class=p>{</span>
    <span class=kd>var</span> <span class=nx>runningPods</span> <span class=p>[]</span><span class=o>*</span><span class=nx>kubecontainer</span><span class=p>.</span><span class=nx>Pod</span>

    <span class=nx>runningPodsFetched</span> <span class=o>:=</span> <span class=kc>false</span>
    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>volumeToMount</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>dswp</span><span class=p>.</span><span class=nx>desiredStateOfWorld</span><span class=p>.</span><span class=nf>GetVolumesToMount</span><span class=p>()</span> <span class=p>{</span>
        <span class=nx>pod</span><span class=p>,</span> <span class=nx>podExists</span> <span class=o>:=</span> <span class=nx>dswp</span><span class=p>.</span><span class=nx>podManager</span><span class=p>.</span><span class=nf>GetPodByUID</span><span class=p>(</span><span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>Pod</span><span class=p>.</span><span class=nx>UID</span><span class=p>)</span>
        <span class=k>if</span> <span class=nx>podExists</span> <span class=p>{</span>

            <span class=c1>// check if the attachability has changed for this volume
</span><span class=c1></span>            <span class=k>if</span> <span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>PluginIsAttachable</span> <span class=p>{</span>
                <span class=nx>attachableVolumePlugin</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>dswp</span><span class=p>.</span><span class=nx>volumePluginMgr</span><span class=p>.</span><span class=nf>FindAttachablePluginBySpec</span><span class=p>(</span><span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>VolumeSpec</span><span class=p>)</span>
                <span class=c1>// only this means the plugin is truly non-attachable
</span><span class=c1></span>                <span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>attachableVolumePlugin</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
                    <span class=c1>// It is not possible right now for a CSI plugin to be both attachable and non-deviceMountable
</span><span class=c1></span>                    <span class=c1>// So the uniqueVolumeName should remain the same after the attachability change
</span><span class=c1></span>                    <span class=nx>dswp</span><span class=p>.</span><span class=nx>desiredStateOfWorld</span><span class=p>.</span><span class=nf>MarkVolumeAttachability</span><span class=p>(</span><span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>VolumeName</span><span class=p>,</span> <span class=kc>false</span><span class=p>)</span>
                    <span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Volume %v changes from attachable to non-attachable.&#34;</span><span class=p>,</span> <span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>VolumeName</span><span class=p>)</span>
                    <span class=k>continue</span>
                <span class=p>}</span>
            <span class=p>}</span>

            <span class=c1>// Skip running pods
</span><span class=c1></span>            <span class=k>if</span> <span class=p>!</span><span class=nx>dswp</span><span class=p>.</span><span class=nf>isPodTerminated</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>continue</span>
            <span class=p>}</span>
            <span class=k>if</span> <span class=nx>dswp</span><span class=p>.</span><span class=nx>keepTerminatedPodVolumes</span> <span class=p>{</span>
                <span class=k>continue</span>
            <span class=p>}</span>
        <span class=p>}</span>

        <span class=c1>// Once a pod has been deleted from kubelet pod manager, do not delete
</span><span class=c1></span>        <span class=c1>// it immediately from volume manager. Instead, check the kubelet
</span><span class=c1></span>        <span class=c1>// containerRuntime to verify that all containers in the pod have been
</span><span class=c1></span>        <span class=c1>// terminated.
</span><span class=c1></span>        <span class=k>if</span> <span class=p>!</span><span class=nx>runningPodsFetched</span> <span class=p>{</span>
            <span class=kd>var</span> <span class=nx>getPodsErr</span> <span class=kt>error</span>
            <span class=nx>runningPods</span><span class=p>,</span> <span class=nx>getPodsErr</span> <span class=p>=</span> <span class=nx>dswp</span><span class=p>.</span><span class=nx>kubeContainerRuntime</span><span class=p>.</span><span class=nf>GetPods</span><span class=p>(</span><span class=kc>false</span><span class=p>)</span>
            <span class=k>if</span> <span class=nx>getPodsErr</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
                <span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span>
                    <span class=s>&#34;kubeContainerRuntime.findAndRemoveDeletedPods returned error %v.&#34;</span><span class=p>,</span>
                    <span class=nx>getPodsErr</span><span class=p>)</span>
                <span class=k>continue</span>
            <span class=p>}</span>

            <span class=nx>runningPodsFetched</span> <span class=p>=</span> <span class=kc>true</span>
            <span class=nx>dswp</span><span class=p>.</span><span class=nx>timeOfLastGetPodStatus</span> <span class=p>=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
        <span class=p>}</span>

        <span class=nx>runningContainers</span> <span class=o>:=</span> <span class=kc>false</span>
        <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>runningPod</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>runningPods</span> <span class=p>{</span>
            <span class=k>if</span> <span class=nx>runningPod</span><span class=p>.</span><span class=nx>ID</span> <span class=o>==</span> <span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>Pod</span><span class=p>.</span><span class=nx>UID</span> <span class=p>{</span>
                <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>runningPod</span><span class=p>.</span><span class=nx>Containers</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
                    <span class=nx>runningContainers</span> <span class=p>=</span> <span class=kc>true</span>
                <span class=p>}</span>

                <span class=k>break</span>
            <span class=p>}</span>
        <span class=p>}</span>

        <span class=k>if</span> <span class=nx>runningContainers</span> <span class=p>{</span>
            <span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span>
                <span class=s>&#34;Pod %q still has one or more containers in the non-exited state. Therefore, it will not be removed from desired state.&#34;</span><span class=p>,</span>
                <span class=nx>format</span><span class=p>.</span><span class=nf>Pod</span><span class=p>(</span><span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>Pod</span><span class=p>))</span>
            <span class=k>continue</span>
        <span class=p>}</span>
        <span class=nx>exists</span><span class=p>,</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>dswp</span><span class=p>.</span><span class=nx>actualStateOfWorld</span><span class=p>.</span><span class=nf>PodExistsInVolume</span><span class=p>(</span><span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>PodName</span><span class=p>,</span> <span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>VolumeName</span><span class=p>)</span>
        <span class=k>if</span> <span class=p>!</span><span class=nx>exists</span> <span class=o>&amp;&amp;</span> <span class=nx>podExists</span> <span class=p>{</span>
            <span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span>
                <span class=nx>volumeToMount</span><span class=p>.</span><span class=nf>GenerateMsgDetailed</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;Actual state has not yet has this volume mounted information and pod (%q) still exists in pod manager, skip removing volume from desired state&#34;</span><span class=p>,</span>
                    <span class=nx>format</span><span class=p>.</span><span class=nf>Pod</span><span class=p>(</span><span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)),</span> <span class=s>&#34;&#34;</span><span class=p>))</span>
            <span class=k>continue</span>
        <span class=p>}</span>
        <span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=nx>volumeToMount</span><span class=p>.</span><span class=nf>GenerateMsgDetailed</span><span class=p>(</span><span class=s>&#34;Removing volume from desired state&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>))</span>

        <span class=nx>dswp</span><span class=p>.</span><span class=nx>desiredStateOfWorld</span><span class=p>.</span><span class=nf>DeletePodFromVolume</span><span class=p>(</span>
            <span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>PodName</span><span class=p>,</span> <span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>VolumeName</span><span class=p>)</span>
        <span class=nx>dswp</span><span class=p>.</span><span class=nf>deleteProcessedPod</span><span class=p>(</span><span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>PodName</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=nx>podsWithError</span> <span class=o>:=</span> <span class=nx>dswp</span><span class=p>.</span><span class=nx>desiredStateOfWorld</span><span class=p>.</span><span class=nf>GetPodsWithErrors</span><span class=p>()</span>
    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>podName</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>podsWithError</span> <span class=p>{</span>
        <span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>podExists</span> <span class=o>:=</span> <span class=nx>dswp</span><span class=p>.</span><span class=nx>podManager</span><span class=p>.</span><span class=nf>GetPodByUID</span><span class=p>(</span><span class=nx>types</span><span class=p>.</span><span class=nf>UID</span><span class=p>(</span><span class=nx>podName</span><span class=p>));</span> <span class=p>!</span><span class=nx>podExists</span> <span class=p>{</span>
            <span class=nx>dswp</span><span class=p>.</span><span class=nx>desiredStateOfWorld</span><span class=p>.</span><span class=nf>PopPodErrors</span><span class=p>(</span><span class=nx>podName</span><span class=p>)</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>说明：</p><ul><li><p>假如runningPodsFetched不存在，并不会立即马上删除卷信息记录。而是调用dswp.kubeContainerRuntime.GetPods(false)抓取Pod信息，这里是调用kubeContainerRuntime的GetPods函数。因此获取的都是runningPods信息，即正在运行的Pod信息。由于一个volume可以属于多个Pod，而一个Pod可以包含多个container，每个container都可以使用volume，所以他要扫描该volume所属的Pod的container信息，确保没有container使用该volume，才会删除该volume。</p></li><li><p><strong>desiredStateOfWorld就构建出来了，这是理想的volume状态，这里并没有发生实际的volume的创建删除挂载卸载操作。实际的操作由reconciler.Run(sourcesReady, stopCh)完成。</strong></p></li></ul><h4 id=reconciler>reconciler</h4><p>reconciler 调谐器，即按desiredStateOfWorld来同步volume配置操作</p><h5 id=主要流程>主要流程</h5><ul><li><p>通过定时任务定期同步，reconcile就是一致性函数，保存desired和actual状态一致。</p></li><li><p>reconcile首先从actualStateOfWorld获取已经挂载的volume信息，然后查看该volume是否存在于desiredStateOfWorld,假如不存在就卸载。</p></li><li><p>接着从desiredStateOfWorld获取需要挂载的volumes。与actualStateOfWorld比较，假如没有挂载，则进行挂载。</p></li><li><p>这样存储就可以加载到主机attach，并挂载到容器目录mount。</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-golang data-lang=golang>
<span class=kd>func</span> <span class=p>(</span><span class=nx>rc</span> <span class=o>*</span><span class=nx>reconciler</span><span class=p>)</span> <span class=nf>Run</span><span class=p>(</span><span class=nx>stopCh</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span> <span class=p>{</span>
    <span class=nx>wait</span><span class=p>.</span><span class=nf>Until</span><span class=p>(</span><span class=nx>rc</span><span class=p>.</span><span class=nf>reconciliationLoopFunc</span><span class=p>(),</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>loopSleepDuration</span><span class=p>,</span> <span class=nx>stopCh</span><span class=p>)</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>rc</span> <span class=o>*</span><span class=nx>reconciler</span><span class=p>)</span> <span class=nf>reconciliationLoopFunc</span><span class=p>()</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>return</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
        <span class=nx>rc</span><span class=p>.</span><span class=nf>reconcile</span><span class=p>()</span>

        <span class=c1>// Sync the state with the reality once after all existing pods are added to the desired state from all sources.
</span><span class=c1></span>        <span class=c1>// Otherwise, the reconstruct process may clean up pods&#39; volumes that are still in use because
</span><span class=c1></span>        <span class=c1>// desired state of world does not contain a complete list of pods.
</span><span class=c1></span>        <span class=k>if</span> <span class=nx>rc</span><span class=p>.</span><span class=nf>populatorHasAddedPods</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>rc</span><span class=p>.</span><span class=nf>StatesHasBeenSynced</span><span class=p>()</span> <span class=p>{</span>
            <span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Reconciler: start to sync state&#34;</span><span class=p>)</span>
            <span class=nx>rc</span><span class=p>.</span><span class=nf>sync</span><span class=p>()</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>rc</span> <span class=o>*</span><span class=nx>reconciler</span><span class=p>)</span> <span class=nf>reconcile</span><span class=p>()</span> <span class=p>{</span>
    <span class=c1>// Unmounts are triggered before mounts so that a volume that was
</span><span class=c1></span>    <span class=c1>// referenced by a pod that was deleted and is now referenced by another
</span><span class=c1></span>    <span class=c1>// pod is unmounted from the first pod before being mounted to the new
</span><span class=c1></span>    <span class=c1>// pod.
</span><span class=c1></span>    <span class=nx>rc</span><span class=p>.</span><span class=nf>unmountVolumes</span><span class=p>()</span>

    <span class=c1>// Next we mount required volumes. This function could also trigger
</span><span class=c1></span>    <span class=c1>// attach if kubelet is responsible for attaching volumes.
</span><span class=c1></span>    <span class=c1>// If underlying PVC was resized while in-use then this function also handles volume
</span><span class=c1></span>    <span class=c1>// resizing.
</span><span class=c1></span>    <span class=nx>rc</span><span class=p>.</span><span class=nf>mountAttachVolumes</span><span class=p>()</span>

    <span class=c1>// Ensure devices that should be detached/unmounted are detached/unmounted.
</span><span class=c1></span>    <span class=nx>rc</span><span class=p>.</span><span class=nf>unmountDetachDevices</span><span class=p>()</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>rc</span> <span class=o>*</span><span class=nx>reconciler</span><span class=p>)</span> <span class=nf>unmountVolumes</span><span class=p>()</span> <span class=p>{</span>
    <span class=c1>// Ensure volumes that should be unmounted are unmounted.
</span><span class=c1></span>    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>mountedVolume</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>actualStateOfWorld</span><span class=p>.</span><span class=nf>GetAllMountedVolumes</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>!</span><span class=nx>rc</span><span class=p>.</span><span class=nx>desiredStateOfWorld</span><span class=p>.</span><span class=nf>PodExistsInVolume</span><span class=p>(</span><span class=nx>mountedVolume</span><span class=p>.</span><span class=nx>PodName</span><span class=p>,</span> <span class=nx>mountedVolume</span><span class=p>.</span><span class=nx>VolumeName</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// Volume is mounted, unmount it
</span><span class=c1></span>            <span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>5</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=nx>mountedVolume</span><span class=p>.</span><span class=nf>GenerateMsgDetailed</span><span class=p>(</span><span class=s>&#34;Starting operationExecutor.UnmountVolume&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>))</span>
            <span class=c1>// 此处UnmountVolume会根据具体的unmounter调用 CleanupMountPoint -&gt; doCleanupMountPoint ，进行挂载卸载和目录删除
</span><span class=c1></span>            <span class=c1>// 这里可能会出现 对于挂载目录卸载失败的情况（社区有关孤儿pod的bug讨论），此时，kubelet的pod清理工作线程无法进行该挂载目录的直接删除
</span><span class=c1></span>            <span class=nx>err</span> <span class=o>:=</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>operationExecutor</span><span class=p>.</span><span class=nf>UnmountVolume</span><span class=p>(</span>
                <span class=nx>mountedVolume</span><span class=p>.</span><span class=nx>MountedVolume</span><span class=p>,</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>actualStateOfWorld</span><span class=p>,</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>kubeletPodsDir</span><span class=p>)</span>
            <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span>
                <span class=p>!</span><span class=nx>nestedpendingoperations</span><span class=p>.</span><span class=nf>IsAlreadyExists</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
                <span class=p>!</span><span class=nx>exponentialbackoff</span><span class=p>.</span><span class=nf>IsExponentialBackoff</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
                <span class=c1>// Ignore nestedpendingoperations.IsAlreadyExists and exponentialbackoff.IsExponentialBackoff errors, they are expected.
</span><span class=c1></span>                <span class=c1>// Log all other errors.
</span><span class=c1></span>                <span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=nx>mountedVolume</span><span class=p>.</span><span class=nf>GenerateErrorDetailed</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;operationExecutor.UnmountVolume failed (controllerAttachDetachEnabled %v)&#34;</span><span class=p>,</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>controllerAttachDetachEnabled</span><span class=p>),</span> <span class=nx>err</span><span class=p>).</span><span class=nf>Error</span><span class=p>())</span>
            <span class=p>}</span>
            <span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
                <span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=nx>mountedVolume</span><span class=p>.</span><span class=nf>GenerateMsgDetailed</span><span class=p>(</span><span class=s>&#34;operationExecutor.UnmountVolume started&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>))</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>rc</span> <span class=o>*</span><span class=nx>reconciler</span><span class=p>)</span> <span class=nf>mountAttachVolumes</span><span class=p>()</span> <span class=p>{</span>
    <span class=c1>// Ensure volumes that should be attached/mounted are attached/mounted.
</span><span class=c1></span>    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>volumeToMount</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>desiredStateOfWorld</span><span class=p>.</span><span class=nf>GetVolumesToMount</span><span class=p>()</span> <span class=p>{</span>
        <span class=nx>volMounted</span><span class=p>,</span> <span class=nx>devicePath</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>actualStateOfWorld</span><span class=p>.</span><span class=nf>PodExistsInVolume</span><span class=p>(</span><span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>PodName</span><span class=p>,</span> <span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>VolumeName</span><span class=p>)</span>
        <span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>DevicePath</span> <span class=p>=</span> <span class=nx>devicePath</span>
        <span class=k>if</span> <span class=nx>cache</span><span class=p>.</span><span class=nf>IsVolumeNotAttachedError</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>if</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>controllerAttachDetachEnabled</span> <span class=o>||</span> <span class=p>!</span><span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>PluginIsAttachable</span> <span class=p>{</span>
                <span class=c1>// Volume is not attached (or doesn&#39;t implement attacher), kubelet attach is disabled, wait
</span><span class=c1></span>                <span class=c1>// for controller to finish attaching volume.
</span><span class=c1></span>                <span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>5</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=nx>volumeToMount</span><span class=p>.</span><span class=nf>GenerateMsgDetailed</span><span class=p>(</span><span class=s>&#34;Starting operationExecutor.VerifyControllerAttachedVolume&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>))</span>
                <span class=nx>err</span> <span class=o>:=</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>operationExecutor</span><span class=p>.</span><span class=nf>VerifyControllerAttachedVolume</span><span class=p>(</span>
                    <span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>VolumeToMount</span><span class=p>,</span>
                    <span class=nx>rc</span><span class=p>.</span><span class=nx>nodeName</span><span class=p>,</span>
                    <span class=nx>rc</span><span class=p>.</span><span class=nx>actualStateOfWorld</span><span class=p>)</span>
                <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span>
                    <span class=p>!</span><span class=nx>nestedpendingoperations</span><span class=p>.</span><span class=nf>IsAlreadyExists</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
                    <span class=p>!</span><span class=nx>exponentialbackoff</span><span class=p>.</span><span class=nf>IsExponentialBackoff</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
                    <span class=c1>// Ignore nestedpendingoperations.IsAlreadyExists and exponentialbackoff.IsExponentialBackoff errors, they are expected.
</span><span class=c1></span>                    <span class=c1>// Log all other errors.
</span><span class=c1></span>                    <span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=nx>volumeToMount</span><span class=p>.</span><span class=nf>GenerateErrorDetailed</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;operationExecutor.VerifyControllerAttachedVolume failed (controllerAttachDetachEnabled %v)&#34;</span><span class=p>,</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>controllerAttachDetachEnabled</span><span class=p>),</span> <span class=nx>err</span><span class=p>).</span><span class=nf>Error</span><span class=p>())</span>
                <span class=p>}</span>
                <span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
                    <span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=nx>volumeToMount</span><span class=p>.</span><span class=nf>GenerateMsgDetailed</span><span class=p>(</span><span class=s>&#34;operationExecutor.VerifyControllerAttachedVolume started&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>))</span>
                <span class=p>}</span>
            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                <span class=c1>// Volume is not attached to node, kubelet attach is enabled, volume implements an attacher,
</span><span class=c1></span>                <span class=c1>// so attach it
</span><span class=c1></span>                <span class=nx>volumeToAttach</span> <span class=o>:=</span> <span class=nx>operationexecutor</span><span class=p>.</span><span class=nx>VolumeToAttach</span><span class=p>{</span>
                    <span class=nx>VolumeName</span><span class=p>:</span> <span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>VolumeName</span><span class=p>,</span>
                    <span class=nx>VolumeSpec</span><span class=p>:</span> <span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>VolumeSpec</span><span class=p>,</span>
                    <span class=nx>NodeName</span><span class=p>:</span>   <span class=nx>rc</span><span class=p>.</span><span class=nx>nodeName</span><span class=p>,</span>
                <span class=p>}</span>
                <span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>5</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=nx>volumeToAttach</span><span class=p>.</span><span class=nf>GenerateMsgDetailed</span><span class=p>(</span><span class=s>&#34;Starting operationExecutor.AttachVolume&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>))</span>
                <span class=nx>err</span> <span class=o>:=</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>operationExecutor</span><span class=p>.</span><span class=nf>AttachVolume</span><span class=p>(</span><span class=nx>volumeToAttach</span><span class=p>,</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>actualStateOfWorld</span><span class=p>)</span>
                <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span>
                    <span class=p>!</span><span class=nx>nestedpendingoperations</span><span class=p>.</span><span class=nf>IsAlreadyExists</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
                    <span class=p>!</span><span class=nx>exponentialbackoff</span><span class=p>.</span><span class=nf>IsExponentialBackoff</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
                    <span class=c1>// Ignore nestedpendingoperations.IsAlreadyExists and exponentialbackoff.IsExponentialBackoff errors, they are expected.
</span><span class=c1></span>                    <span class=c1>// Log all other errors.
</span><span class=c1></span>                    <span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=nx>volumeToMount</span><span class=p>.</span><span class=nf>GenerateErrorDetailed</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;operationExecutor.AttachVolume failed (controllerAttachDetachEnabled %v)&#34;</span><span class=p>,</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>controllerAttachDetachEnabled</span><span class=p>),</span> <span class=nx>err</span><span class=p>).</span><span class=nf>Error</span><span class=p>())</span>
                <span class=p>}</span>
                <span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
                    <span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=nx>volumeToMount</span><span class=p>.</span><span class=nf>GenerateMsgDetailed</span><span class=p>(</span><span class=s>&#34;operationExecutor.AttachVolume started&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>))</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>!</span><span class=nx>volMounted</span> <span class=o>||</span> <span class=nx>cache</span><span class=p>.</span><span class=nf>IsRemountRequiredError</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// Volume is not mounted, or is already mounted, but requires remounting
</span><span class=c1></span>            <span class=nx>remountingLogStr</span> <span class=o>:=</span> <span class=s>&#34;&#34;</span>
            <span class=nx>isRemount</span> <span class=o>:=</span> <span class=nx>cache</span><span class=p>.</span><span class=nf>IsRemountRequiredError</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
            <span class=k>if</span> <span class=nx>isRemount</span> <span class=p>{</span>
                <span class=nx>remountingLogStr</span> <span class=p>=</span> <span class=s>&#34;Volume is already mounted to pod, but remount was requested.&#34;</span>
            <span class=p>}</span>
            <span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=nx>volumeToMount</span><span class=p>.</span><span class=nf>GenerateMsgDetailed</span><span class=p>(</span><span class=s>&#34;Starting operationExecutor.MountVolume&#34;</span><span class=p>,</span> <span class=nx>remountingLogStr</span><span class=p>))</span>
            <span class=nx>err</span> <span class=o>:=</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>operationExecutor</span><span class=p>.</span><span class=nf>MountVolume</span><span class=p>(</span>
                <span class=nx>rc</span><span class=p>.</span><span class=nx>waitForAttachTimeout</span><span class=p>,</span>
                <span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>VolumeToMount</span><span class=p>,</span>
                <span class=nx>rc</span><span class=p>.</span><span class=nx>actualStateOfWorld</span><span class=p>,</span>
                <span class=nx>isRemount</span><span class=p>)</span>
            <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span>
                <span class=p>!</span><span class=nx>nestedpendingoperations</span><span class=p>.</span><span class=nf>IsAlreadyExists</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
                <span class=p>!</span><span class=nx>exponentialbackoff</span><span class=p>.</span><span class=nf>IsExponentialBackoff</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
                <span class=c1>// Ignore nestedpendingoperations.IsAlreadyExists and exponentialbackoff.IsExponentialBackoff errors, they are expected.
</span><span class=c1></span>                <span class=c1>// Log all other errors.
</span><span class=c1></span>                <span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=nx>volumeToMount</span><span class=p>.</span><span class=nf>GenerateErrorDetailed</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;operationExecutor.MountVolume failed (controllerAttachDetachEnabled %v)&#34;</span><span class=p>,</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>controllerAttachDetachEnabled</span><span class=p>),</span> <span class=nx>err</span><span class=p>).</span><span class=nf>Error</span><span class=p>())</span>
            <span class=p>}</span>
            <span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
                <span class=k>if</span> <span class=nx>remountingLogStr</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
                    <span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>1</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=nx>volumeToMount</span><span class=p>.</span><span class=nf>GenerateMsgDetailed</span><span class=p>(</span><span class=s>&#34;operationExecutor.MountVolume started&#34;</span><span class=p>,</span> <span class=nx>remountingLogStr</span><span class=p>))</span>
                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                    <span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>5</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=nx>volumeToMount</span><span class=p>.</span><span class=nf>GenerateMsgDetailed</span><span class=p>(</span><span class=s>&#34;operationExecutor.MountVolume started&#34;</span><span class=p>,</span> <span class=nx>remountingLogStr</span><span class=p>))</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>cache</span><span class=p>.</span><span class=nf>IsFSResizeRequiredError</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
            <span class=nx>utilfeature</span><span class=p>.</span><span class=nx>DefaultFeatureGate</span><span class=p>.</span><span class=nf>Enabled</span><span class=p>(</span><span class=nx>features</span><span class=p>.</span><span class=nx>ExpandInUsePersistentVolumes</span><span class=p>)</span> <span class=p>{</span>
            <span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=nx>volumeToMount</span><span class=p>.</span><span class=nf>GenerateMsgDetailed</span><span class=p>(</span><span class=s>&#34;Starting operationExecutor.ExpandInUseVolume&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>))</span>
            <span class=nx>err</span> <span class=o>:=</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>operationExecutor</span><span class=p>.</span><span class=nf>ExpandInUseVolume</span><span class=p>(</span>
                <span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>VolumeToMount</span><span class=p>,</span>
                <span class=nx>rc</span><span class=p>.</span><span class=nx>actualStateOfWorld</span><span class=p>)</span>
            <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span>
                <span class=p>!</span><span class=nx>nestedpendingoperations</span><span class=p>.</span><span class=nf>IsAlreadyExists</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
                <span class=p>!</span><span class=nx>exponentialbackoff</span><span class=p>.</span><span class=nf>IsExponentialBackoff</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
                <span class=c1>// Ignore nestedpendingoperations.IsAlreadyExists and exponentialbackoff.IsExponentialBackoff errors, they are expected.
</span><span class=c1></span>                <span class=c1>// Log all other errors.
</span><span class=c1></span>                <span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=nx>volumeToMount</span><span class=p>.</span><span class=nf>GenerateErrorDetailed</span><span class=p>(</span><span class=s>&#34;operationExecutor.ExpandInUseVolume failed&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>).</span><span class=nf>Error</span><span class=p>())</span>
            <span class=p>}</span>
            <span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
                <span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=nx>volumeToMount</span><span class=p>.</span><span class=nf>GenerateMsgDetailed</span><span class=p>(</span><span class=s>&#34;operationExecutor.ExpandInUseVolume started&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>))</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>rc</span> <span class=o>*</span><span class=nx>reconciler</span><span class=p>)</span> <span class=nf>unmountDetachDevices</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>attachedVolume</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>actualStateOfWorld</span><span class=p>.</span><span class=nf>GetUnmountedVolumes</span><span class=p>()</span> <span class=p>{</span>
        <span class=c1>// Check IsOperationPending to avoid marking a volume as detached if it&#39;s in the process of mounting.
</span><span class=c1></span>        <span class=k>if</span> <span class=p>!</span><span class=nx>rc</span><span class=p>.</span><span class=nx>desiredStateOfWorld</span><span class=p>.</span><span class=nf>VolumeExists</span><span class=p>(</span><span class=nx>attachedVolume</span><span class=p>.</span><span class=nx>VolumeName</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
            <span class=p>!</span><span class=nx>rc</span><span class=p>.</span><span class=nx>operationExecutor</span><span class=p>.</span><span class=nf>IsOperationPending</span><span class=p>(</span><span class=nx>attachedVolume</span><span class=p>.</span><span class=nx>VolumeName</span><span class=p>,</span> <span class=nx>nestedpendingoperations</span><span class=p>.</span><span class=nx>EmptyUniquePodName</span><span class=p>,</span> <span class=nx>nestedpendingoperations</span><span class=p>.</span><span class=nx>EmptyNodeName</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>if</span> <span class=nx>attachedVolume</span><span class=p>.</span><span class=nf>DeviceMayBeMounted</span><span class=p>()</span> <span class=p>{</span>
                <span class=c1>// Volume is globally mounted to device, unmount it
</span><span class=c1></span>                <span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>5</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=nx>attachedVolume</span><span class=p>.</span><span class=nf>GenerateMsgDetailed</span><span class=p>(</span><span class=s>&#34;Starting operationExecutor.UnmountDevice&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>))</span>
                <span class=nx>err</span> <span class=o>:=</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>operationExecutor</span><span class=p>.</span><span class=nf>UnmountDevice</span><span class=p>(</span>
                    <span class=nx>attachedVolume</span><span class=p>.</span><span class=nx>AttachedVolume</span><span class=p>,</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>actualStateOfWorld</span><span class=p>,</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>hostutil</span><span class=p>)</span>
                <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span>
                    <span class=p>!</span><span class=nx>nestedpendingoperations</span><span class=p>.</span><span class=nf>IsAlreadyExists</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
                    <span class=p>!</span><span class=nx>exponentialbackoff</span><span class=p>.</span><span class=nf>IsExponentialBackoff</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
                    <span class=c1>// Ignore nestedpendingoperations.IsAlreadyExists and exponentialbackoff.IsExponentialBackoff errors, they are expected.
</span><span class=c1></span>                    <span class=c1>// Log all other errors.
</span><span class=c1></span>                    <span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=nx>attachedVolume</span><span class=p>.</span><span class=nf>GenerateErrorDetailed</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;operationExecutor.UnmountDevice failed (controllerAttachDetachEnabled %v)&#34;</span><span class=p>,</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>controllerAttachDetachEnabled</span><span class=p>),</span> <span class=nx>err</span><span class=p>).</span><span class=nf>Error</span><span class=p>())</span>
                <span class=p>}</span>
                <span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
                    <span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=nx>attachedVolume</span><span class=p>.</span><span class=nf>GenerateMsgDetailed</span><span class=p>(</span><span class=s>&#34;operationExecutor.UnmountDevice started&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>))</span>
                <span class=p>}</span>
            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                <span class=c1>// Volume is attached to node, detach it
</span><span class=c1></span>                <span class=c1>// Kubelet not responsible for detaching or this volume has a non-attachable volume plugin.
</span><span class=c1></span>                <span class=k>if</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>controllerAttachDetachEnabled</span> <span class=o>||</span> <span class=p>!</span><span class=nx>attachedVolume</span><span class=p>.</span><span class=nx>PluginIsAttachable</span> <span class=p>{</span>
                    <span class=nx>rc</span><span class=p>.</span><span class=nx>actualStateOfWorld</span><span class=p>.</span><span class=nf>MarkVolumeAsDetached</span><span class=p>(</span><span class=nx>attachedVolume</span><span class=p>.</span><span class=nx>VolumeName</span><span class=p>,</span> <span class=nx>attachedVolume</span><span class=p>.</span><span class=nx>NodeName</span><span class=p>)</span>
                    <span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=nx>attachedVolume</span><span class=p>.</span><span class=nf>GenerateMsgDetailed</span><span class=p>(</span><span class=s>&#34;Volume detached&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;DevicePath %q&#34;</span><span class=p>,</span> <span class=nx>attachedVolume</span><span class=p>.</span><span class=nx>DevicePath</span><span class=p>)))</span>
                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                    <span class=c1>// Only detach if kubelet detach is enabled
</span><span class=c1></span>                    <span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>5</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=nx>attachedVolume</span><span class=p>.</span><span class=nf>GenerateMsgDetailed</span><span class=p>(</span><span class=s>&#34;Starting operationExecutor.DetachVolume&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>))</span>
                    <span class=nx>err</span> <span class=o>:=</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>operationExecutor</span><span class=p>.</span><span class=nf>DetachVolume</span><span class=p>(</span>
                        <span class=nx>attachedVolume</span><span class=p>.</span><span class=nx>AttachedVolume</span><span class=p>,</span> <span class=kc>false</span> <span class=cm>/* verifySafeToDetach */</span><span class=p>,</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>actualStateOfWorld</span><span class=p>)</span>
                    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span>
                        <span class=p>!</span><span class=nx>nestedpendingoperations</span><span class=p>.</span><span class=nf>IsAlreadyExists</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
                        <span class=p>!</span><span class=nx>exponentialbackoff</span><span class=p>.</span><span class=nf>IsExponentialBackoff</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
                        <span class=c1>// Ignore nestedpendingoperations.IsAlreadyExists &amp;&amp; exponentialbackoff.IsExponentialBackoff errors, they are expected.
</span><span class=c1></span>                        <span class=c1>// Log all other errors.
</span><span class=c1></span>                        <span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=nx>attachedVolume</span><span class=p>.</span><span class=nf>GenerateErrorDetailed</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;operationExecutor.DetachVolume failed (controllerAttachDetachEnabled %v)&#34;</span><span class=p>,</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>controllerAttachDetachEnabled</span><span class=p>),</span> <span class=nx>err</span><span class=p>).</span><span class=nf>Error</span><span class=p>())</span>
                    <span class=p>}</span>
                    <span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
                        <span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=nx>attachedVolume</span><span class=p>.</span><span class=nf>GenerateMsgDetailed</span><span class=p>(</span><span class=s>&#34;operationExecutor.DetachVolume started&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>))</span>
                    <span class=p>}</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=c1>// sync process tries to observe the real world by scanning all pods&#39; volume directories from the disk.
</span><span class=c1>// If the actual and desired state of worlds are not consistent with the observed world, it means that some
</span><span class=c1>// mounted volumes are left out probably during kubelet restart. This process will reconstruct
</span><span class=c1>// the volumes and update the actual and desired states. For the volumes that cannot support reconstruction,
</span><span class=c1>// it will try to clean up the mount paths with operation executor.
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>rc</span> <span class=o>*</span><span class=nx>reconciler</span><span class=p>)</span> <span class=nf>sync</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>defer</span> <span class=nx>rc</span><span class=p>.</span><span class=nf>updateLastSyncTime</span><span class=p>()</span>
    <span class=nx>rc</span><span class=p>.</span><span class=nf>syncStates</span><span class=p>()</span>
<span class=p>}</span>

</code></pre></td></tr></table></div></div><h5 id=cleanupmountpoint---docleanupmountpoint>CleanupMountPoint -> doCleanupMountPoint</h5><p>具体volume卸载操作</p><ul><li>如果是挂载点，则先卸载mounter.Unmount(mountPath)</li><li>os.Remove(mountPath)</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>// CleanupMountPoint unmounts the given path and deletes the remaining directory
// if successful. If extensiveMountPointCheck is true IsNotMountPoint will be
// called instead of IsLikelyNotMountPoint. IsNotMountPoint is more expensive
// but properly handles bind mounts within the same fs.
func CleanupMountPoint(mountPath string, mounter Interface, extensiveMountPointCheck bool) error {
    pathExists, pathErr := PathExists(mountPath)
    if !pathExists {
        klog.Warningf(&#34;Warning: Unmount skipped because path does not exist: %v&#34;, mountPath)
        return nil
    }
    corruptedMnt := IsCorruptedMnt(pathErr)
    if pathErr != nil &amp;&amp; !corruptedMnt {
        return fmt.Errorf(&#34;Error checking path: %v&#34;, pathErr)
    }
    return doCleanupMountPoint(mountPath, mounter, extensiveMountPointCheck, corruptedMnt)
}

// doCleanupMountPoint unmounts the given path and
// deletes the remaining directory if successful.
// if extensiveMountPointCheck is true
// IsNotMountPoint will be called instead of IsLikelyNotMountPoint.
// IsNotMountPoint is more expensive but properly handles bind mounts within the same fs.
// if corruptedMnt is true, it means that the mountPath is a corrupted mountpoint, and the mount point check
// will be skipped
func doCleanupMountPoint(mountPath string, mounter Interface, extensiveMountPointCheck bool, corruptedMnt bool) error {
    var notMnt bool
    var err error
    if !corruptedMnt {
        if extensiveMountPointCheck {
            notMnt, err = IsNotMountPoint(mounter, mountPath)
        } else {
            notMnt, err = mounter.IsLikelyNotMountPoint(mountPath)
        }

        if err != nil {
            return err
        }

        if notMnt {
            klog.Warningf(&#34;Warning: %q is not a mountpoint, deleting&#34;, mountPath)
            return os.Remove(mountPath)
        }
    }

    // Unmount the mount path
    klog.V(4).Infof(&#34;%q is a mountpoint, unmounting&#34;, mountPath)
    if err := mounter.Unmount(mountPath); err != nil {
        return err
    }

    if extensiveMountPointCheck {
        notMnt, err = IsNotMountPoint(mounter, mountPath)
    } else {
        notMnt, err = mounter.IsLikelyNotMountPoint(mountPath)
    }
    if err != nil {
        return err
    }
    if notMnt {
        klog.V(4).Infof(&#34;%q is unmounted, deleting the directory&#34;, mountPath)
        return os.Remove(mountPath)
    }
    return fmt.Errorf(&#34;Failed to unmount path %v&#34;, mountPath)
}

</code></pre></td></tr></table></div></div><h5 id=mountvolumefunc>mountVolumeFunc</h5><p>执行plugin的SetUp方法，以及更新actual state of world</p><h5 id=pendingoperations>pendingOperations</h5><ul><li><p>根据pendingOperations: nestedpendingoperations.NewNestedPendingOperations，nestedPendingOperations实现了NestedPendingOperations接口，包括Run方法</p></li><li><p>路径 pkg/volume/util/nestedpendingoperations/nestedpendingoperations.go</p></li></ul><h5 id=mountattachvolumes>mountAttachVolumes</h5><p>处理分支：</p><ul><li>Volume is not attached (or doesn&rsquo;t implement attacher), kubelet attach is disabled, wait for controller to finish attaching volume.</li><li>Volume is not attached to node, kubelet attach is enabled, volume implements an attacher, so attach it</li><li>Volume is not mounted, or is already mounted, but requires remounting</li></ul><h5 id=mountvolume>MountVolume</h5><p>对于文件系统卷类型，operationGenerator.GenerateMountVolumeFunc(waitForAttachTimeout, volumeToMount, actualStateOfWorld)
具体挂载操作 GenerateMountVolumeFunc</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-golang data-lang=golang>
<span class=kd>func</span> <span class=p>(</span><span class=nx>oe</span> <span class=o>*</span><span class=nx>operationExecutor</span><span class=p>)</span> <span class=nf>MountVolume</span><span class=p>(</span>
    <span class=nx>waitForAttachTimeout</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>,</span>
    <span class=nx>volumeToMount</span> <span class=nx>VolumeToMount</span><span class=p>,</span>
    <span class=nx>actualStateOfWorld</span> <span class=nx>ActualStateOfWorldMounterUpdater</span><span class=p>,</span>
    <span class=nx>isRemount</span> <span class=kt>bool</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=nx>fsVolume</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>util</span><span class=p>.</span><span class=nf>CheckVolumeModeFilesystem</span><span class=p>(</span><span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>VolumeSpec</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nx>err</span>
    <span class=p>}</span>
    <span class=kd>var</span> <span class=nx>generatedOperations</span> <span class=nx>volumetypes</span><span class=p>.</span><span class=nx>GeneratedOperations</span>
    <span class=k>if</span> <span class=nx>fsVolume</span> <span class=p>{</span>
        <span class=c1>// Filesystem volume case
</span><span class=c1></span>        <span class=c1>// Mount/remount a volume when a volume is attached
</span><span class=c1></span>        <span class=nx>generatedOperations</span> <span class=p>=</span> <span class=nx>oe</span><span class=p>.</span><span class=nx>operationGenerator</span><span class=p>.</span><span class=nf>GenerateMountVolumeFunc</span><span class=p>(</span>
            <span class=nx>waitForAttachTimeout</span><span class=p>,</span> <span class=nx>volumeToMount</span><span class=p>,</span> <span class=nx>actualStateOfWorld</span><span class=p>,</span> <span class=nx>isRemount</span><span class=p>)</span>

    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=c1>// Block volume case
</span><span class=c1></span>        <span class=c1>// Creates a map to device if a volume is attached
</span><span class=c1></span>        <span class=nx>generatedOperations</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>oe</span><span class=p>.</span><span class=nx>operationGenerator</span><span class=p>.</span><span class=nf>GenerateMapVolumeFunc</span><span class=p>(</span>
            <span class=nx>waitForAttachTimeout</span><span class=p>,</span> <span class=nx>volumeToMount</span><span class=p>,</span> <span class=nx>actualStateOfWorld</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nx>err</span>
    <span class=p>}</span>
    <span class=c1>// Avoid executing mount/map from multiple pods referencing the
</span><span class=c1></span>    <span class=c1>// same volume in parallel
</span><span class=c1></span>    <span class=nx>podName</span> <span class=o>:=</span> <span class=nx>nestedpendingoperations</span><span class=p>.</span><span class=nx>EmptyUniquePodName</span>

    <span class=c1>// TODO: remove this -- not necessary
</span><span class=c1></span>    <span class=k>if</span> <span class=p>!</span><span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>PluginIsAttachable</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>PluginIsDeviceMountable</span> <span class=p>{</span>
        <span class=c1>// volume plugins which are Non-attachable and Non-deviceMountable can execute mount for multiple pods
</span><span class=c1></span>        <span class=c1>// referencing the same volume in parallel
</span><span class=c1></span>        <span class=nx>podName</span> <span class=p>=</span> <span class=nx>util</span><span class=p>.</span><span class=nf>GetUniquePodName</span><span class=p>(</span><span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=c1>// TODO mount_device
</span><span class=c1></span>    <span class=k>return</span> <span class=nx>oe</span><span class=p>.</span><span class=nx>pendingOperations</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span>
        <span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>VolumeName</span><span class=p>,</span> <span class=nx>podName</span><span class=p>,</span> <span class=s>&#34;&#34;</span> <span class=cm>/* nodeName */</span><span class=p>,</span> <span class=nx>generatedOperations</span><span class=p>)</span>
<span class=p>}</span>


<span class=c1>// 挂载操作函数
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>og</span> <span class=o>*</span><span class=nx>operationGenerator</span><span class=p>)</span> <span class=nf>GenerateMountVolumeFunc</span><span class=p>(</span>
    <span class=nx>waitForAttachTimeout</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>,</span>
    <span class=nx>volumeToMount</span> <span class=nx>VolumeToMount</span><span class=p>,</span>
    <span class=nx>actualStateOfWorld</span> <span class=nx>ActualStateOfWorldMounterUpdater</span><span class=p>,</span>
    <span class=nx>isRemount</span> <span class=kt>bool</span><span class=p>)</span> <span class=nx>volumetypes</span><span class=p>.</span><span class=nx>GeneratedOperations</span> <span class=p>{</span>

    
<span class=c1>// .......
</span><span class=c1></span>    <span class=nx>mountVolumeFunc</span> <span class=o>:=</span> <span class=kd>func</span><span class=p>()</span> <span class=p>(</span><span class=kt>error</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// Get mounter plugin
</span><span class=c1></span>        <span class=nx>volumePlugin</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>og</span><span class=p>.</span><span class=nx>volumePluginMgr</span><span class=p>.</span><span class=nf>FindPluginBySpec</span><span class=p>(</span><span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>VolumeSpec</span><span class=p>)</span>
        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>||</span> <span class=nx>volumePlugin</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=k>return</span> <span class=nx>volumeToMount</span><span class=p>.</span><span class=nf>GenerateError</span><span class=p>(</span><span class=s>&#34;MountVolume.FindPluginBySpec failed&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
        <span class=p>}</span>

        <span class=nx>affinityErr</span> <span class=o>:=</span> <span class=nf>checkNodeAffinity</span><span class=p>(</span><span class=nx>og</span><span class=p>,</span> <span class=nx>volumeToMount</span><span class=p>)</span>
        <span class=k>if</span> <span class=nx>affinityErr</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=k>return</span> <span class=nx>volumeToMount</span><span class=p>.</span><span class=nf>GenerateError</span><span class=p>(</span><span class=s>&#34;MountVolume.NodeAffinity check failed&#34;</span><span class=p>,</span> <span class=nx>affinityErr</span><span class=p>)</span>
        <span class=p>}</span>

        <span class=nx>volumeMounter</span><span class=p>,</span> <span class=nx>newMounterErr</span> <span class=o>:=</span> <span class=nx>volumePlugin</span><span class=p>.</span><span class=nf>NewMounter</span><span class=p>(</span>
            <span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>VolumeSpec</span><span class=p>,</span>
            <span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span>
            <span class=nx>volume</span><span class=p>.</span><span class=nx>VolumeOptions</span><span class=p>{})</span>


        <span class=c1>// get deviceMounter, if possible
</span><span class=c1></span>        <span class=nx>deviceMountableVolumePlugin</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>og</span><span class=p>.</span><span class=nx>volumePluginMgr</span><span class=p>.</span><span class=nf>FindDeviceMountablePluginBySpec</span><span class=p>(</span><span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>VolumeSpec</span><span class=p>)</span>
        <span class=k>if</span> <span class=nx>volumeDeviceMounter</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>{</span>
            <span class=c1>// Mount device to global mount path
</span><span class=c1></span>            <span class=nx>err</span> <span class=p>=</span> <span class=nx>volumeDeviceMounter</span><span class=p>.</span><span class=nf>MountDevice</span><span class=p>(</span>
                <span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>VolumeSpec</span><span class=p>,</span>
                <span class=nx>devicePath</span><span class=p>,</span>
                <span class=nx>deviceMountPath</span><span class=p>)</span>
        <span class=p>}</span>
        

        <span class=c1>// SetUp prepares and mounts/unpacks the volume to a
</span><span class=c1></span>        <span class=c1>// self-determined directory path. The mount point and its
</span><span class=c1></span>        <span class=c1>// content should be owned by `fsUser` or &#39;fsGroup&#39; so that it can be
</span><span class=c1></span>        <span class=c1>// accessed by the pod. This may be called more than once, so
</span><span class=c1></span>        <span class=c1>// implementations must be idempotent.
</span><span class=c1></span>        <span class=c1>// It could return following types of errors:
</span><span class=c1></span>        <span class=c1>//   - TransientOperationFailure
</span><span class=c1></span>        <span class=c1>//   - UncertainProgressError
</span><span class=c1></span>        <span class=c1>//   - Error of any other type should be considered a final error
</span><span class=c1></span>
        <span class=c1>// Execute mount
</span><span class=c1></span>        <span class=nx>mountErr</span> <span class=o>:=</span> <span class=nx>volumeMounter</span><span class=p>.</span><span class=nf>SetUp</span><span class=p>(</span><span class=nx>volume</span><span class=p>.</span><span class=nx>MounterArgs</span><span class=p>{</span>
            <span class=nx>FsUser</span><span class=p>:</span>              <span class=nx>util</span><span class=p>.</span><span class=nf>FsUserFrom</span><span class=p>(</span><span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>Pod</span><span class=p>),</span>
            <span class=nx>FsGroup</span><span class=p>:</span>             <span class=nx>fsGroup</span><span class=p>,</span>
            <span class=nx>DesiredSize</span><span class=p>:</span>         <span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>DesiredSizeLimit</span><span class=p>,</span>
            <span class=nx>FSGroupChangePolicy</span><span class=p>:</span> <span class=nx>fsGroupChangePolicy</span><span class=p>,</span>
        <span class=p>})</span>

        <span class=c1>// Update actual state of world
</span><span class=c1></span>        <span class=nx>markOpts</span> <span class=o>:=</span> <span class=nx>MarkVolumeOpts</span><span class=p>{</span>
            <span class=nx>PodName</span><span class=p>:</span>             <span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>PodName</span><span class=p>,</span>
            <span class=nx>PodUID</span><span class=p>:</span>              <span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>Pod</span><span class=p>.</span><span class=nx>UID</span><span class=p>,</span>
            <span class=nx>VolumeName</span><span class=p>:</span>          <span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>VolumeName</span><span class=p>,</span>
            <span class=nx>Mounter</span><span class=p>:</span>             <span class=nx>volumeMounter</span><span class=p>,</span>
            <span class=nx>OuterVolumeSpecName</span><span class=p>:</span> <span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>OuterVolumeSpecName</span><span class=p>,</span>
            <span class=nx>VolumeGidVolume</span><span class=p>:</span>     <span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>VolumeGidValue</span><span class=p>,</span>
            <span class=nx>VolumeSpec</span><span class=p>:</span>          <span class=nx>volumeToMount</span><span class=p>.</span><span class=nx>VolumeSpec</span><span class=p>,</span>
            <span class=nx>VolumeMountState</span><span class=p>:</span>    <span class=nx>VolumeMounted</span><span class=p>,</span>
        <span class=p>}</span>
        <span class=c1>// MarkVolumeAsMounted实际上更新了attachedVolumes[volumeName].mountedPods，卷的挂载信息：
</span><span class=c1></span>        <span class=c1>//  podObj.volumeMountStateForPod = markVolumeOpts.VolumeMountState
</span><span class=c1></span>        <span class=c1>//  asw.attachedVolumes[volumeName].mountedPods[podName] = podObj
</span><span class=c1></span>        <span class=nx>markVolMountedErr</span> <span class=o>:=</span> <span class=nx>actualStateOfWorld</span><span class=p>.</span><span class=nf>MarkVolumeAsMounted</span><span class=p>(</span><span class=nx>markOpts</span><span class=p>)</span>
    <span class=p>}</span>
    
<span class=c1>// .......
</span><span class=c1></span>
<span class=c1>// .......
</span><span class=c1></span>


<span class=p>}</span>

</code></pre></td></tr></table></div></div><h2 id=nfs的mount-setup>NFS的mount setup</h2><ul><li>挂载命令默认使用了系统命令mount</li><li>nfs中为每个volume的挂载目录路径的pluginName是kubernetes.io~nfs</li><li>mount操作的source为nfs server 的 exportPath</li><li>mount操作的target为dir，即pod的nfs卷路径位置nfsMounter.GetPath()，示例见下</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-golang data-lang=golang><span class=nx>source</span> <span class=o>:=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s:%s&#34;</span><span class=p>,</span> <span class=nx>nfsMounter</span><span class=p>.</span><span class=nx>server</span><span class=p>,</span> <span class=nx>nfsMounter</span><span class=p>.</span><span class=nx>exportPath</span><span class=p>)</span>
<span class=nx>err</span> <span class=p>=</span> <span class=nx>nfsMounter</span><span class=p>.</span><span class=nx>mounter</span><span class=p>.</span><span class=nf>MountSensitiveWithoutSystemd</span><span class=p>(</span><span class=nx>source</span><span class=p>,</span> <span class=nx>dir</span><span class=p>,</span> <span class=s>&#34;nfs&#34;</span><span class=p>,</span> <span class=nx>mountOptions</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>nfs的挂载volume路径dir示例：
<strong>var/lib/kubelet/pods/{podid}//volumes/{pluginName}/{pvname}</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=c1># nfsMounter.GetPath()</span>
<span class=c1>#/var/lib/kubelet/pods/{podid}//volumes/{pluginName}/{pvname}</span>
/var/lib/kubelet/pods/06d10daa-c7e8-46e5-b94a-c0fcd2f27a2e/volumes/kubernetes.io~nfs/pvc-1f9f7ceb-6ca8-453e-87a0-013e53841fad
</code></pre></td></tr></table></div></div><p>mount挂载处理</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-golang data-lang=golang>


<span class=c1>// SetUp attaches the disk and bind mounts to the volume path.
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>nfsMounter</span> <span class=o>*</span><span class=nx>nfsMounter</span><span class=p>)</span> <span class=nf>SetUp</span><span class=p>(</span><span class=nx>mounterArgs</span> <span class=nx>volume</span><span class=p>.</span><span class=nx>MounterArgs</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=k>return</span> <span class=nx>nfsMounter</span><span class=p>.</span><span class=nf>SetUpAt</span><span class=p>(</span><span class=nx>nfsMounter</span><span class=p>.</span><span class=nf>GetPath</span><span class=p>(),</span> <span class=nx>mounterArgs</span><span class=p>)</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>nfsMounter</span> <span class=o>*</span><span class=nx>nfsMounter</span><span class=p>)</span> <span class=nf>SetUpAt</span><span class=p>(</span><span class=nx>dir</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>mounterArgs</span> <span class=nx>volume</span><span class=p>.</span><span class=nx>MounterArgs</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=nx>notMnt</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>mount</span><span class=p>.</span><span class=nf>IsNotMountPoint</span><span class=p>(</span><span class=nx>nfsMounter</span><span class=p>.</span><span class=nx>mounter</span><span class=p>,</span> <span class=nx>dir</span><span class=p>)</span>
    <span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;NFS mount set up: %s %v %v&#34;</span><span class=p>,</span> <span class=nx>dir</span><span class=p>,</span> <span class=p>!</span><span class=nx>notMnt</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>os</span><span class=p>.</span><span class=nf>IsNotExist</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nx>err</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=p>!</span><span class=nx>notMnt</span> <span class=p>{</span>
        <span class=k>return</span> <span class=kc>nil</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>MkdirAll</span><span class=p>(</span><span class=nx>dir</span><span class=p>,</span> <span class=mo>0750</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nx>err</span>
    <span class=p>}</span>
    <span class=nx>source</span> <span class=o>:=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s:%s&#34;</span><span class=p>,</span> <span class=nx>nfsMounter</span><span class=p>.</span><span class=nx>server</span><span class=p>,</span> <span class=nx>nfsMounter</span><span class=p>.</span><span class=nx>exportPath</span><span class=p>)</span>
    <span class=nx>options</span> <span class=o>:=</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{}</span>
    <span class=k>if</span> <span class=nx>nfsMounter</span><span class=p>.</span><span class=nx>readOnly</span> <span class=p>{</span>
        <span class=nx>options</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>options</span><span class=p>,</span> <span class=s>&#34;ro&#34;</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=nx>mountOptions</span> <span class=o>:=</span> <span class=nx>util</span><span class=p>.</span><span class=nf>JoinMountOptions</span><span class=p>(</span><span class=nx>nfsMounter</span><span class=p>.</span><span class=nx>mountOptions</span><span class=p>,</span> <span class=nx>options</span><span class=p>)</span>
    <span class=nx>err</span> <span class=p>=</span> <span class=nx>nfsMounter</span><span class=p>.</span><span class=nx>mounter</span><span class=p>.</span><span class=nf>MountSensitiveWithoutSystemd</span><span class=p>(</span><span class=nx>source</span><span class=p>,</span> <span class=nx>dir</span><span class=p>,</span> <span class=s>&#34;nfs&#34;</span><span class=p>,</span> <span class=nx>mountOptions</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>notMnt</span><span class=p>,</span> <span class=nx>mntErr</span> <span class=o>:=</span> <span class=nx>mount</span><span class=p>.</span><span class=nf>IsNotMountPoint</span><span class=p>(</span><span class=nx>nfsMounter</span><span class=p>.</span><span class=nx>mounter</span><span class=p>,</span> <span class=nx>dir</span><span class=p>)</span>
        <span class=k>if</span> <span class=nx>mntErr</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;IsNotMountPoint check failed: %v&#34;</span><span class=p>,</span> <span class=nx>mntErr</span><span class=p>)</span>
            <span class=k>return</span> <span class=nx>err</span>
        <span class=p>}</span>
        <span class=k>if</span> <span class=p>!</span><span class=nx>notMnt</span> <span class=p>{</span>
            <span class=k>if</span> <span class=nx>mntErr</span> <span class=p>=</span> <span class=nx>nfsMounter</span><span class=p>.</span><span class=nx>mounter</span><span class=p>.</span><span class=nf>Unmount</span><span class=p>(</span><span class=nx>dir</span><span class=p>);</span> <span class=nx>mntErr</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
                <span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Failed to unmount: %v&#34;</span><span class=p>,</span> <span class=nx>mntErr</span><span class=p>)</span>
                <span class=k>return</span> <span class=nx>err</span>
            <span class=p>}</span>
            <span class=nx>notMnt</span><span class=p>,</span> <span class=nx>mntErr</span> <span class=o>:=</span> <span class=nx>mount</span><span class=p>.</span><span class=nf>IsNotMountPoint</span><span class=p>(</span><span class=nx>nfsMounter</span><span class=p>.</span><span class=nx>mounter</span><span class=p>,</span> <span class=nx>dir</span><span class=p>)</span>
            <span class=k>if</span> <span class=nx>mntErr</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
                <span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;IsNotMountPoint check failed: %v&#34;</span><span class=p>,</span> <span class=nx>mntErr</span><span class=p>)</span>
                <span class=k>return</span> <span class=nx>err</span>
            <span class=p>}</span>
            <span class=k>if</span> <span class=p>!</span><span class=nx>notMnt</span> <span class=p>{</span>
                <span class=c1>// This is very odd, we don&#39;t expect it.  We&#39;ll try again next sync loop.
</span><span class=c1></span>                <span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;%s is still mounted, despite call to unmount().  Will try again next sync loop.&#34;</span><span class=p>,</span> <span class=nx>dir</span><span class=p>)</span>
                <span class=k>return</span> <span class=nx>err</span>
            <span class=p>}</span>
        <span class=p>}</span>
        <span class=nx>os</span><span class=p>.</span><span class=nf>Remove</span><span class=p>(</span><span class=nx>dir</span><span class=p>)</span>
        <span class=k>return</span> <span class=nx>err</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=kc>nil</span>
<span class=p>}</span>



<span class=kd>func</span> <span class=p>(</span><span class=nx>plugin</span> <span class=o>*</span><span class=nx>nfsPlugin</span><span class=p>)</span> <span class=nf>newMounterInternal</span><span class=p>(</span><span class=nx>spec</span> <span class=o>*</span><span class=nx>volume</span><span class=p>.</span><span class=nx>Spec</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>mounter</span> <span class=nx>mount</span><span class=p>.</span><span class=nx>Interface</span><span class=p>)</span> <span class=p>(</span><span class=nx>volume</span><span class=p>.</span><span class=nx>Mounter</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>source</span><span class=p>,</span> <span class=nx>readOnly</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>getVolumeSource</span><span class=p>(</span><span class=nx>spec</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
    <span class=p>}</span>

    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>nfsMounter</span><span class=p>{</span>
        <span class=nx>nfs</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>nfs</span><span class=p>{</span>
            <span class=nx>volName</span><span class=p>:</span>         <span class=nx>spec</span><span class=p>.</span><span class=nf>Name</span><span class=p>(),</span>
            <span class=nx>mounter</span><span class=p>:</span>         <span class=nx>mounter</span><span class=p>,</span>
            <span class=nx>pod</span><span class=p>:</span>             <span class=nx>pod</span><span class=p>,</span>
            <span class=nx>plugin</span><span class=p>:</span>          <span class=nx>plugin</span><span class=p>,</span>
            <span class=nx>MetricsProvider</span><span class=p>:</span> <span class=nx>volume</span><span class=p>.</span><span class=nf>NewMetricsStatFS</span><span class=p>(</span><span class=nf>getPath</span><span class=p>(</span><span class=nx>pod</span><span class=p>.</span><span class=nx>UID</span><span class=p>,</span> <span class=nx>spec</span><span class=p>.</span><span class=nf>Name</span><span class=p>(),</span> <span class=nx>plugin</span><span class=p>.</span><span class=nx>host</span><span class=p>)),</span>
        <span class=p>},</span>
        <span class=nx>server</span><span class=p>:</span>       <span class=nx>source</span><span class=p>.</span><span class=nx>Server</span><span class=p>,</span>
        <span class=nx>exportPath</span><span class=p>:</span>   <span class=nx>source</span><span class=p>.</span><span class=nx>Path</span><span class=p>,</span>
        <span class=nx>readOnly</span><span class=p>:</span>     <span class=nx>readOnly</span><span class=p>,</span>
        <span class=nx>mountOptions</span><span class=p>:</span> <span class=nx>util</span><span class=p>.</span><span class=nf>MountOptionFromSpec</span><span class=p>(</span><span class=nx>spec</span><span class=p>),</span>
    <span class=p>},</span> <span class=kc>nil</span>
<span class=p>}</span>

<span class=c1>// Name returns the name of either Volume or PersistentVolume, one of which must not be nil.
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>spec</span> <span class=o>*</span><span class=nx>Spec</span><span class=p>)</span> <span class=nf>Name</span><span class=p>()</span> <span class=kt>string</span> <span class=p>{</span>
    <span class=k>switch</span> <span class=p>{</span>
    <span class=k>case</span> <span class=nx>spec</span><span class=p>.</span><span class=nx>Volume</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>:</span>
        <span class=k>return</span> <span class=nx>spec</span><span class=p>.</span><span class=nx>Volume</span><span class=p>.</span><span class=nx>Name</span>
    <span class=k>case</span> <span class=nx>spec</span><span class=p>.</span><span class=nx>PersistentVolume</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>:</span>
        <span class=k>return</span> <span class=nx>spec</span><span class=p>.</span><span class=nx>PersistentVolume</span><span class=p>.</span><span class=nx>Name</span>
    <span class=k>default</span><span class=p>:</span>
        <span class=k>return</span> <span class=s>&#34;&#34;</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=c1>// NFS volumes represent a bare host file or directory mount of an NFS export.
</span><span class=c1></span><span class=kd>type</span> <span class=nx>nfs</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>volName</span> <span class=kt>string</span>
    <span class=nx>pod</span>     <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span>
    <span class=nx>mounter</span> <span class=nx>mount</span><span class=p>.</span><span class=nx>Interface</span>
    <span class=nx>plugin</span>  <span class=o>*</span><span class=nx>nfsPlugin</span>
    <span class=nx>volume</span><span class=p>.</span><span class=nx>MetricsProvider</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>nfsVolume</span> <span class=o>*</span><span class=nx>nfs</span><span class=p>)</span> <span class=nf>GetPath</span><span class=p>()</span> <span class=kt>string</span> <span class=p>{</span>
    <span class=nx>name</span> <span class=o>:=</span> <span class=nx>nfsPluginName</span>
    <span class=c1>// GetPodVolumeDir returns the absolute path a directory which
</span><span class=c1></span>    <span class=c1>// represents the named volume under the named plugin for the given
</span><span class=c1></span>    <span class=c1>// pod.  If the specified pod does not exist, the result of this call
</span><span class=c1></span>    <span class=c1>// might not exist.
</span><span class=c1></span>    <span class=k>return</span> <span class=nx>nfsVolume</span><span class=p>.</span><span class=nx>plugin</span><span class=p>.</span><span class=nx>host</span><span class=p>.</span><span class=nf>GetPodVolumeDir</span><span class=p>(</span><span class=nx>nfsVolume</span><span class=p>.</span><span class=nx>pod</span><span class=p>.</span><span class=nx>UID</span><span class=p>,</span> <span class=nx>utilstrings</span><span class=p>.</span><span class=nf>EscapeQualifiedName</span><span class=p>(</span><span class=nx>name</span><span class=p>),</span> <span class=nx>nfsVolume</span><span class=p>.</span><span class=nx>volName</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><h2 id=kueblet-syncpod>Kueblet SyncPod</h2><h3 id=syncpod上下文>SyncPod上下文</h3><blockquote><p>这里先回顾下pod容器创建准备过程，粗体标注为volume相关的处理。</p></blockquote><p>完成创建容器前的准备工作（SyncPod）
在这个方法中，主要完成以下几件事情：</p><ul><li>如果是删除 pod，立即执行并返回</li><li>同步 podStatus 到 kubelet.statusManager</li><li>检查 pod 是否能运行在本节点，主要是权限检查（是否能使用主机网络模式，是否可以以 privileged 权限运行等）。如果没有权限，就删除本地旧的 pod 并返回错误信息</li><li>创建 containerManagar 对象，并且创建 pod level cgroup，更新 Qos level cgroup</li><li>如果是 static Pod，就创建或者更新对应的 mirrorPod</li><li><strong>创建 pod 的数据目录，存放 volume 和 plugin 信息,如果定义了 pv，等待所有的 volume mount 完成（volumeManager 会在后台做这些事情）,如果有 image secrets，去 apiserver 获取对应的 secrets 数据</strong></li><li><strong>然后调用 kubelet.volumeManager 组件，等待它将 pod 所需要的所有外挂的 volume 都准备好。</strong></li><li>调用 container runtime 的 SyncPod 方法，去实现真正的容器创建逻辑
这里所有的事情都和具体的容器没有关系，可以看到该方法是创建 pod 实体（即容器）之前需要完成的准备工作。</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-golang data-lang=golang><span class=kd>func</span> <span class=p>(</span><span class=nx>kl</span> <span class=o>*</span><span class=nx>Kubelet</span><span class=p>)</span> <span class=nf>syncPod</span><span class=p>(</span><span class=nx>o</span> <span class=nx>syncPodOptions</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=c1>// pull out the required options
</span><span class=c1></span>    <span class=nx>pod</span> <span class=o>:=</span> <span class=nx>o</span><span class=p>.</span><span class=nx>pod</span>
    <span class=nx>mirrorPod</span> <span class=o>:=</span> <span class=nx>o</span><span class=p>.</span><span class=nx>mirrorPod</span>
    <span class=nx>podStatus</span> <span class=o>:=</span> <span class=nx>o</span><span class=p>.</span><span class=nx>podStatus</span>
    <span class=nx>updateType</span> <span class=o>:=</span> <span class=nx>o</span><span class=p>.</span><span class=nx>updateType</span>

    <span class=c1>// 是否为 删除 pod
</span><span class=c1></span>    <span class=k>if</span> <span class=nx>updateType</span> <span class=o>==</span> <span class=nx>kubetypes</span><span class=p>.</span><span class=nx>SyncPodKill</span> <span class=p>{</span>
        <span class=o>...</span>
    <span class=p>}</span>
    <span class=o>...</span>
    <span class=c1>// 检查 pod 是否能运行在本节点
</span><span class=c1></span>    <span class=nx>runnable</span> <span class=o>:=</span> <span class=nx>kl</span><span class=p>.</span><span class=nf>canRunPod</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span>
    <span class=k>if</span> <span class=p>!</span><span class=nx>runnable</span><span class=p>.</span><span class=nx>Admit</span> <span class=p>{</span>
        <span class=o>...</span>
    <span class=p>}</span>

    <span class=c1>// 更新 pod 状态
</span><span class=c1></span>    <span class=nx>kl</span><span class=p>.</span><span class=nx>statusManager</span><span class=p>.</span><span class=nf>SetPodStatus</span><span class=p>(</span><span class=nx>pod</span><span class=p>,</span> <span class=nx>apiPodStatus</span><span class=p>)</span>

    <span class=c1>// 如果 pod 非 running 状态则直接 kill 掉
</span><span class=c1></span>    <span class=k>if</span> <span class=p>!</span><span class=nx>runnable</span><span class=p>.</span><span class=nx>Admit</span> <span class=o>||</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>DeletionTimestamp</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>||</span> <span class=nx>apiPodStatus</span><span class=p>.</span><span class=nx>Phase</span> <span class=o>==</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>PodFailed</span> <span class=p>{</span>
        <span class=o>...</span>
    <span class=p>}</span>

    <span class=c1>// 加载网络插件
</span><span class=c1></span>    <span class=k>if</span> <span class=nx>rs</span> <span class=o>:=</span> <span class=nx>kl</span><span class=p>.</span><span class=nx>runtimeState</span><span class=p>.</span><span class=nf>networkErrors</span><span class=p>();</span> <span class=nb>len</span><span class=p>(</span><span class=nx>rs</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>kubecontainer</span><span class=p>.</span><span class=nf>IsHostNetworkPod</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span> <span class=p>{</span>
        <span class=o>...</span>
    <span class=p>}</span>

    <span class=nx>pcm</span> <span class=o>:=</span> <span class=nx>kl</span><span class=p>.</span><span class=nx>containerManager</span><span class=p>.</span><span class=nf>NewPodContainerManager</span><span class=p>()</span>
    <span class=k>if</span> <span class=p>!</span><span class=nx>kl</span><span class=p>.</span><span class=nf>podIsTerminated</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span> <span class=p>{</span>
        <span class=o>...</span>
        <span class=c1>// 创建并更新 pod 的 cgroups
</span><span class=c1></span>        <span class=k>if</span> <span class=p>!(</span><span class=nx>podKilled</span> <span class=o>&amp;&amp;</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>RestartPolicy</span> <span class=o>==</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>RestartPolicyNever</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>if</span> <span class=p>!</span><span class=nx>pcm</span><span class=p>.</span><span class=nf>Exists</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span> <span class=p>{</span>
                <span class=o>...</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=c1>// 为 static pod 创建对应的 mirror pod
</span><span class=c1></span>    <span class=k>if</span> <span class=nx>kubepod</span><span class=p>.</span><span class=nf>IsStaticPod</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span> <span class=p>{</span>
        <span class=o>...</span>
    <span class=p>}</span>

    <span class=c1>// 创建数据目录
</span><span class=c1></span>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>kl</span><span class=p>.</span><span class=nf>makePodDataDirs</span><span class=p>(</span><span class=nx>pod</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=o>...</span>
    <span class=p>}</span>

    <span class=c1>// 挂载 volume
</span><span class=c1></span>    <span class=k>if</span> <span class=p>!</span><span class=nx>kl</span><span class=p>.</span><span class=nf>podIsTerminated</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>kl</span><span class=p>.</span><span class=nx>volumeManager</span><span class=p>.</span><span class=nf>WaitForAttachAndMount</span><span class=p>(</span><span class=nx>pod</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=o>...</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=c1>// 获取 secret 信息
</span><span class=c1></span>    <span class=nx>pullSecrets</span> <span class=o>:=</span> <span class=nx>kl</span><span class=p>.</span><span class=nf>getPullSecretsForPod</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span>

    <span class=c1>// 调用 containerRuntime 的 SyncPod 方法开始创建容器
</span><span class=c1></span>    <span class=nx>result</span> <span class=o>:=</span> <span class=nx>kl</span><span class=p>.</span><span class=nx>containerRuntime</span><span class=p>.</span><span class=nf>SyncPod</span><span class=p>(</span><span class=nx>pod</span><span class=p>,</span> <span class=nx>apiPodStatus</span><span class=p>,</span> <span class=nx>podStatus</span><span class=p>,</span> <span class=nx>pullSecrets</span><span class=p>,</span> <span class=nx>kl</span><span class=p>.</span><span class=nx>backOff</span><span class=p>)</span>
    <span class=nx>kl</span><span class=p>.</span><span class=nx>reasonCache</span><span class=p>.</span><span class=nf>Update</span><span class=p>(</span><span class=nx>pod</span><span class=p>.</span><span class=nx>UID</span><span class=p>,</span> <span class=nx>result</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>result</span><span class=p>.</span><span class=nf>Error</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=o>...</span>
    <span class=p>}</span>

    <span class=k>return</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>在上面的上下文中，看到了kubelet的syncpod处理，同步 pod 时，等待 pod attach 和 mount 完成</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-golang data-lang=golang><span class=kd>func</span> <span class=p>(</span><span class=nx>kl</span> <span class=o>*</span><span class=nx>Kubelet</span><span class=p>)</span> <span class=nf>syncPod</span><span class=p>(</span><span class=nx>o</span> <span class=nx>syncPodOptions</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=c1>// 挂载 volume
</span><span class=c1></span>    <span class=k>if</span> <span class=p>!</span><span class=nx>kl</span><span class=p>.</span><span class=nf>podIsTerminated</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>kl</span><span class=p>.</span><span class=nx>volumeManager</span><span class=p>.</span><span class=nf>WaitForAttachAndMount</span><span class=p>(</span><span class=nx>pod</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=o>...</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><h3 id=waitforattachandmount>WaitForAttachAndMount</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-golang data-lang=golang>
<span class=kd>func</span> <span class=p>(</span><span class=nx>vm</span> <span class=o>*</span><span class=nx>volumeManager</span><span class=p>)</span> <span class=nf>WaitForAttachAndMount</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=k>if</span> <span class=nx>pod</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=k>return</span> <span class=kc>nil</span>
    <span class=p>}</span>
    <span class=c1>// pod的全部挂载卷
</span><span class=c1></span>    <span class=nx>expectedVolumes</span> <span class=o>:=</span> <span class=nf>getExpectedVolumes</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span>
    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>expectedVolumes</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
        <span class=c1>// No volumes to verify
</span><span class=c1></span>        <span class=k>return</span> <span class=kc>nil</span>
    <span class=p>}</span>

    <span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Waiting for volumes to attach and mount for pod %q&#34;</span><span class=p>,</span> <span class=nx>format</span><span class=p>.</span><span class=nf>Pod</span><span class=p>(</span><span class=nx>pod</span><span class=p>))</span>
    <span class=nx>uniquePodName</span> <span class=o>:=</span> <span class=nx>util</span><span class=p>.</span><span class=nf>GetUniquePodName</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span>

    <span class=c1>// Some pods expect to have Setup called over and over again to update.
</span><span class=c1></span>    <span class=c1>// Remount plugins for which this is true. (Atomically updating volumes,
</span><span class=c1></span>    <span class=c1>// like Downward API, depend on this to update the contents of the volume).
</span><span class=c1></span>    <span class=nx>vm</span><span class=p>.</span><span class=nx>desiredStateOfWorldPopulator</span><span class=p>.</span><span class=nf>ReprocessPod</span><span class=p>(</span><span class=nx>uniquePodName</span><span class=p>)</span>

    <span class=nx>err</span> <span class=o>:=</span> <span class=nx>wait</span><span class=p>.</span><span class=nf>PollImmediate</span><span class=p>(</span>
        <span class=nx>podAttachAndMountRetryInterval</span><span class=p>,</span>
        <span class=nx>podAttachAndMountTimeout</span><span class=p>,</span>
        <span class=nx>vm</span><span class=p>.</span><span class=nf>verifyVolumesMountedFunc</span><span class=p>(</span><span class=nx>uniquePodName</span><span class=p>,</span> <span class=nx>expectedVolumes</span><span class=p>))</span>

    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>unmountedVolumes</span> <span class=o>:=</span>
            <span class=nx>vm</span><span class=p>.</span><span class=nf>getUnmountedVolumes</span><span class=p>(</span><span class=nx>uniquePodName</span><span class=p>,</span> <span class=nx>expectedVolumes</span><span class=p>)</span>
        <span class=c1>// Also get unattached volumes for error message
</span><span class=c1></span>        <span class=nx>unattachedVolumes</span> <span class=o>:=</span>
            <span class=nx>vm</span><span class=p>.</span><span class=nf>getUnattachedVolumes</span><span class=p>(</span><span class=nx>expectedVolumes</span><span class=p>)</span>
        <span class=c1>// 没有被 mount 的volume 数量为0，表示成功完成挂载
</span><span class=c1></span>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>unmountedVolumes</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
            <span class=k>return</span> <span class=kc>nil</span>
        <span class=p>}</span>

        <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span>
            <span class=s>&#34;unmounted volumes=%v, unattached volumes=%v: %s&#34;</span><span class=p>,</span>
            <span class=nx>unmountedVolumes</span><span class=p>,</span>
            <span class=nx>unattachedVolumes</span><span class=p>,</span>
            <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;All volumes are attached and mounted for pod %q&#34;</span><span class=p>,</span> <span class=nx>format</span><span class=p>.</span><span class=nf>Pod</span><span class=p>(</span><span class=nx>pod</span><span class=p>))</span>
    <span class=k>return</span> <span class=kc>nil</span>
<span class=p>}</span>

</code></pre></td></tr></table></div></div><h3 id=verifyvolumesmountedfunc>verifyVolumesMountedFunc</h3><ul><li>没有被 mount 的volume 数量为0，表示成功完成挂载</li><li>UnmountedVolumes = expectedVolumes - mountedVolumes</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-golang data-lang=golang>
<span class=c1>// verifyVolumesMountedFunc returns a method that returns true when all expected
</span><span class=c1>// volumes are mounted.
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>vm</span> <span class=o>*</span><span class=nx>volumeManager</span><span class=p>)</span> <span class=nf>verifyVolumesMountedFunc</span><span class=p>(</span><span class=nx>podName</span> <span class=nx>types</span><span class=p>.</span><span class=nx>UniquePodName</span><span class=p>,</span> <span class=nx>expectedVolumes</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=nx>wait</span><span class=p>.</span><span class=nx>ConditionFunc</span> <span class=p>{</span>
    <span class=k>return</span> <span class=kd>func</span><span class=p>()</span> <span class=p>(</span><span class=nx>done</span> <span class=kt>bool</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=nx>errs</span> <span class=o>:=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>desiredStateOfWorld</span><span class=p>.</span><span class=nf>PopPodErrors</span><span class=p>(</span><span class=nx>podName</span><span class=p>);</span> <span class=nb>len</span><span class=p>(</span><span class=nx>errs</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
            <span class=k>return</span> <span class=kc>true</span><span class=p>,</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>strings</span><span class=p>.</span><span class=nf>Join</span><span class=p>(</span><span class=nx>errs</span><span class=p>,</span> <span class=s>&#34;; &#34;</span><span class=p>))</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=nb>len</span><span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nf>getUnmountedVolumes</span><span class=p>(</span><span class=nx>podName</span><span class=p>,</span> <span class=nx>expectedVolumes</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span><span class=p>,</span> <span class=kc>nil</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=c1>// getUnmountedVolumes fetches the current list of mounted volumes from
</span><span class=c1>// the actual state of the world, and uses it to process the list of
</span><span class=c1>// expectedVolumes. It returns a list of unmounted volumes.
</span><span class=c1>// The list also includes volume that may be mounted in uncertain state.
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>vm</span> <span class=o>*</span><span class=nx>volumeManager</span><span class=p>)</span> <span class=nf>getUnmountedVolumes</span><span class=p>(</span><span class=nx>podName</span> <span class=nx>types</span><span class=p>.</span><span class=nx>UniquePodName</span><span class=p>,</span> <span class=nx>expectedVolumes</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>[]</span><span class=kt>string</span> <span class=p>{</span>
    <span class=nx>mountedVolumes</span> <span class=o>:=</span> <span class=nx>sets</span><span class=p>.</span><span class=nf>NewString</span><span class=p>()</span>
    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>mountedVolume</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>actualStateOfWorld</span><span class=p>.</span><span class=nf>GetMountedVolumesForPod</span><span class=p>(</span><span class=nx>podName</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// 实际的挂载卷
</span><span class=c1></span>        <span class=nx>mountedVolumes</span><span class=p>.</span><span class=nf>Insert</span><span class=p>(</span><span class=nx>mountedVolume</span><span class=p>.</span><span class=nx>OuterVolumeSpecName</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=c1>// expectedVolumes为pod的全部挂载卷
</span><span class=c1></span>    <span class=c1>// UnmountedVolumes = expectedVolumes - mountedVolumes
</span><span class=c1></span>    <span class=k>return</span> <span class=nf>filterUnmountedVolumes</span><span class=p>(</span><span class=nx>mountedVolumes</span><span class=p>,</span> <span class=nx>expectedVolumes</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><h2 id=参考资料>参考资料</h2><ul><li><a href=https://blog.csdn.net/zhonglinzhang/article/details/82800287 target=_blank rel="noopener noreffer">kubelet源码分析之volume manager源码分析</a></li><li><a href=https://zhuanlan.zhihu.com/p/111241212 target=_blank rel="noopener noreffer">kubelet 创建 pod 的流程</a></li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2021-02-25</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/k8s/>K8S</a></section><section><span><a href=javascript:void(0); onclick=window.history.back();>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/2021/02/k8s-dynamic-provisioning-and-storage-%E4%BB%8B%E7%BB%8D/ class=prev rel=prev title="k8s dynamic provisioning and storage 介绍"><i class="fas fa-angle-left fa-fw"></i>k8s dynamic provisioning and storage 介绍</a>
<a href=/posts/2021/02/k8s%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/ class=next rel=next title=K8S常用操作命令集合>K8S常用操作命令集合<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript><script src=https://utteranc.es/client.js repo=$utterances.repo issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2016 - 2021</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=bingerambo.com target=_blank>Binge</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=http://bingerambo.com/ target=_blank>bingerambo.com</a></span></div><div class=footer-line><i class="fa fa-eye"></i>本站总访问量<span id=busuanzi_value_site_pv></span>次
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{"utterances":{"darkTheme":"github-dark","issueTerm":"pathname","label":"","lightTheme":"github-light","repo":"bingerambo/myblog-comments"}},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true}};</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','UA-81425808-1',{'anonymize_ip':true});</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=UA-81425808-1" async></script><script src=https://libs.baidu.com/jquery/2.1.4/jquery.min.js></script><script src=https://cdn.bootcdn.net/ajax/libs/jquery-backstretch/2.1.18/jquery.backstretch.min.js></script><script type=text/javascript src=/js/custom.js></script><script>var _hmt=_hmt||[];(function(){var hm=document.createElement("script");hm.src="https://hm.baidu.com/hm.js?c0176279eee823ce422da4e8d06708f9";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script></body></html>