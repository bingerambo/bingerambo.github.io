<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>k8s的pod的污点容忍度和亲和性说明[k8s pod tanit-tolerance and affinity] - 斌哥的小站|Binge Blog</title><meta name=Description content="k8s的pod的污点容忍度和亲和性说明"><meta property="og:title" content="k8s的pod的污点容忍度和亲和性说明[k8s pod tanit-tolerance and affinity]"><meta property="og:description" content="k8s的pod的污点容忍度和亲和性说明"><meta property="og:type" content="article"><meta property="og:url" content="http://bingerambo.com/posts/2022/08/k8s%E7%9A%84pod%E7%9A%84%E6%B1%A1%E7%82%B9%E5%AE%B9%E5%BF%8D%E5%BA%A6%E5%92%8C%E4%BA%B2%E5%92%8C%E6%80%A7%E8%AF%B4%E6%98%8Ek8s-pod-tanit-tolerance-and-affinity/"><meta property="og:image" content="http://bingerambo.com/logo.png"><meta property="article:published_time" content="2022-08-01T08:43:17+08:00"><meta property="article:modified_time" content="2022-08-01T08:43:17+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://bingerambo.com/logo.png"><meta name=twitter:title content="k8s的pod的污点容忍度和亲和性说明[k8s pod tanit-tolerance and affinity]"><meta name=twitter:description content="k8s的pod的污点容忍度和亲和性说明"><meta name=application-name content="Binge Blog"><meta name=apple-mobile-web-app-title content="Binge Blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=http://bingerambo.com/posts/2022/08/k8s%E7%9A%84pod%E7%9A%84%E6%B1%A1%E7%82%B9%E5%AE%B9%E5%BF%8D%E5%BA%A6%E5%92%8C%E4%BA%B2%E5%92%8C%E6%80%A7%E8%AF%B4%E6%98%8Ek8s-pod-tanit-tolerance-and-affinity/><link rel=prev href=http://bingerambo.com/posts/2022/07/linux%E9%98%B2%E7%81%AB%E5%A2%99firewall-cmd%E5%91%BD%E4%BB%A4%E8%AF%B4%E6%98%8E/><link rel=next href=http://bingerambo.com/posts/2022/09/arm%E5%B9%B3%E5%8F%B0%E9%95%9C%E5%83%8F%E9%80%82%E9%85%8D%E6%93%8D%E4%BD%9C/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"k8s的pod的污点容忍度和亲和性说明[k8s pod tanit-tolerance and affinity]","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/bingerambo.com\/posts\/2022\/08\/k8s%E7%9A%84pod%E7%9A%84%E6%B1%A1%E7%82%B9%E5%AE%B9%E5%BF%8D%E5%BA%A6%E5%92%8C%E4%BA%B2%E5%92%8C%E6%80%A7%E8%AF%B4%E6%98%8Ek8s-pod-tanit-tolerance-and-affinity\/"},"image":["http:\/\/bingerambo.com\/images\/Apple-Devices-Preview.png"],"genre":"posts","keywords":"K8S","wordcount":7904,"url":"http:\/\/bingerambo.com\/posts\/2022\/08\/k8s%E7%9A%84pod%E7%9A%84%E6%B1%A1%E7%82%B9%E5%AE%B9%E5%BF%8D%E5%BA%A6%E5%92%8C%E4%BA%B2%E5%92%8C%E6%80%A7%E8%AF%B4%E6%98%8Ek8s-pod-tanit-tolerance-and-affinity\/","datePublished":"2022-08-01T08:43:17+08:00","dateModified":"2022-08-01T08:43:17+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"xxxx","logo":"http:\/\/bingerambo.com\/images\/avatar.png"},"author":{"@type":"Person","name":"Binge"},"description":"k8s的pod的污点容忍度和亲和性说明"}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="斌哥的小站|Binge Blog"><span class=header-title-pre><i class="fas fa-biking fa-fw"></i></span>Binge Blog</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/><i class="fas fa-fw fa-archive"></i>文章 </a><a class=menu-item href=/tags/><i class="fas fa-fw fa-tag"></i>标签 </a><a class=menu-item href=/categories/><i class="fas fa-fw fa-th"></i>分类 </a><a class=menu-item href=/timeline/><i class="fas fa-cog fa-spin"></i>随记 </a><a class=menu-item href=/about/><i class="fas fa-fw fa-at"></i>关于 </a><a class=menu-item href=/search/><i class="fas fa-fw fa-search"></i>搜索 </a><a class=menu-item href=/friend/ title=Friend><i class="fas fa fa-user"></i>友链 </a><a class=menu-item href=https://github.com/bingerambo title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><a class=menu-item href=/><i class="fas fa fa-eye"></i><span id=busuanzi_value_site_uv></span></a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="斌哥的小站|Binge Blog"><span class=header-title-pre><i class="fas fa-biking fa-fw"></i></span>Binge Blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/><i class="fas fa-fw fa-archive"></i>文章</a><a class=menu-item href=/tags/><i class="fas fa-fw fa-tag"></i>标签</a><a class=menu-item href=/categories/><i class="fas fa-fw fa-th"></i>分类</a><a class=menu-item href=/timeline/><i class="fas fa-cog fa-spin"></i>随记</a><a class=menu-item href=/about/><i class="fas fa-fw fa-at"></i>关于</a><a class=menu-item href=/search/><i class="fas fa-fw fa-search"></i>搜索</a><a class=menu-item href=/friend/ title=Friend><i class="fas fa fa-user"></i>友链</a><a class=menu-item href=https://github.com/bingerambo title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><a class=menu-item href=/><i class="fas fa fa-eye"></i><span id=busuanzi_value_site_uv></span></a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">k8s的pod的污点容忍度和亲和性说明[k8s pod tanit-tolerance and affinity]</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=http://bingerambo.com title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw"></i>Binge</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/k8s/><i class="far fa-folder fa-fw"></i>K8S</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-08-01>2022-08-01</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 7904 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 16 分钟&nbsp;
<i class="fa fa-eye fa-fw"></i>&nbsp;本文总阅读量 <span id=busuanzi_value_page_pv></span>次&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#污点和容忍度>污点和容忍度</a><ul><li><a href=#概念>概念</a></li><li><a href=#使用例子>使用例子</a></li><li><a href=#基于污点的驱逐>基于污点的驱逐</a></li><li><a href=#基于节点状态添加污点>基于节点状态添加污点</a></li></ul></li><li><a href=#将-pod-指派给节点>将 Pod 指派给节点</a><ul><li><a href=#nodeselector>nodeSelector</a></li><li><a href=#亲和性与反亲和性>亲和性与反亲和性</a><ul><li><a href=#节点亲和性>节点亲和性</a><ul><li><a href=#节点亲和性权重>节点亲和性权重</a></li></ul></li><li><a href=#pod-间亲和性与反亲和性-httpskubernetesiozh-cndocsconceptsscheduling-evictionassign-pod-nodeinter-pod-affinity-and-anti-affinity>Pod 间亲和性与反亲和性<a href=https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/assign-pod-node/#inter-pod-affinity-and-anti-affinity></a></a><ul><li><a href=#pod-间亲和性与反亲和性的类型>Pod 间亲和性与反亲和性的类型</a></li><li><a href=#pod-亲和性示例>Pod 亲和性示例</a></li></ul></li></ul></li></ul></li><li><a href=#用节点亲和性把-pods-分配到节点>用节点亲和性把 Pods 分配到节点</a><ul><li><a href=#给节点添加标签>给节点添加标签</a></li><li><a href=#依据强制的节点亲和性调度-pod>依据强制的节点亲和性调度 Pod</a></li><li><a href=#使用首选的节点亲和性调度-pod>使用首选的节点亲和性调度 Pod</a></li><li><a href=#示例>示例</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>介绍k8s的pod的污点容忍度和亲和性</p><h2 id=污点和容忍度>污点和容忍度</h2><p><a href=https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/assign-pod-node/#affinity-and-anti-affinity target=_blank rel="noopener noreffer">节点亲和性</a> 是 <a href=https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/ target=_blank rel="noopener noreffer">Pod</a> 的一种属性，它使 Pod 被吸引到一类特定的<a href=https://kubernetes.io/zh-cn/docs/concepts/architecture/nodes/ target=_blank rel="noopener noreffer">节点</a> （这可能出于一种偏好，也可能是硬性要求）。 <strong>污点（Taint）</strong> 则相反——它使节点能够排斥一类特定的 Pod。</p><p><strong>容忍度（Toleration）</strong> 是应用于 Pod 上的。容忍度允许调度器调度带有对应污点的节点。 容忍度允许调度但并不保证调度：作为其功能的一部分， 调度器也会<a href=https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/pod-priority-preemption/ target=_blank rel="noopener noreffer">评估其他参数</a>。</p><p>污点和容忍度（Toleration）相互配合，可以用来避免 Pod 被分配到不合适的节点上。 每个节点上都可以应用一个或多个污点，这表示对于那些不能容忍这些污点的 Pod， 是不会被该节点接受的。</p><h3 id=概念>概念</h3><p>你可以使用命令 <a href=https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#taint target=_blank rel="noopener noreffer">kubectl taint</a> 给节点增加一个污点。比如，</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>kubectl taint nodes node1 <span class=nv>key1</span><span class=o>=</span>value1:NoSchedule
</code></pre></td></tr></table></div></div><p>给节点 <code>node1</code> 增加一个污点，它的键名是 <code>key1</code>，键值是 <code>value1</code>，效果是 <code>NoSchedule</code>。 这表示只有拥有和这个污点相匹配的容忍度的 Pod 才能够被分配到 <code>node1</code> 这个节点。</p><p>若要移除上述命令所添加的污点，你可以执行：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>kubectl taint nodes node1 <span class=nv>key1</span><span class=o>=</span>value1:NoSchedule-
</code></pre></td></tr></table></div></div><p>你可以在 Pod 规约中为 Pod 设置容忍度。 下面两个容忍度均与上面例子中使用 <code>kubectl taint</code> 命令创建的污点相匹配， 因此如果一个 Pod 拥有其中的任何一个容忍度，都能够被调度到 <code>node1</code> ：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;key1&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Equal&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;value1&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;NoSchedule&#34;</span><span class=w>
</span><span class=w></span><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;key1&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Exists&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;NoSchedule&#34;</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>这里是一个使用了容忍度的 Pod：</p><p><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/zh-cn/examples/pods/pod-with-toleration.yaml target=_blank rel="noopener noreffer"><code>pods/pod-with-toleration.yaml</code></a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w> </span><span class=l>test</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span><span class=w>    </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span><span class=w>  </span><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;example-key&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Exists&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;NoSchedule&#34;</span><span class=w>
</span></code></pre></td></tr></table></div></div><p><code>operator</code> 的默认值是 <code>Equal</code>。</p><p>一个容忍度和一个污点相“匹配”是指它们有一样的键名和效果，并且：</p><ul><li>如果 <code>operator</code> 是 <code>Exists</code> （此时容忍度不能指定 <code>value</code>），或者</li><li>如果 <code>operator</code> 是 <code>Equal</code> ，则它们的 <code>value</code> 应该相等</li></ul><p><strong>说明：</strong></p><blockquote><p>存在两种特殊情况：</p><p>如果一个容忍度的 <code>key</code> 为空且 <code>operator</code> 为 <code>Exists</code>， 表示这个容忍度与任意的 key、value 和 effect 都匹配，即这个容忍度能容忍任何污点。</p><p>如果 <code>effect</code> 为空，则可以与所有键名 <code>key1</code> 的效果相匹配。</p></blockquote><p>上述例子中 <code>effect</code> 使用的值为 <code>NoSchedule</code>，你也可以使用另外一个值 <code>PreferNoSchedule</code>。 这是“优化”或“软”版本的 <code>NoSchedule</code> —— 系统会 <strong>尽量</strong> 避免将 Pod 调度到存在其不能容忍污点的节点上， 但这不是强制的。<code>effect</code> 的值还可以设置为 <code>NoExecute</code>，下文会详细描述这个值。</p><p>你可以给一个节点添加多个污点，也可以给一个 Pod 添加多个容忍度设置。 Kubernetes 处理多个污点和容忍度的过程就像一个过滤器：从一个节点的所有污点开始遍历， 过滤掉那些 Pod 中存在与之相匹配的容忍度的污点。余下未被过滤的污点的 effect 值决定了 Pod 是否会被分配到该节点，特别是以下情况：</p><ul><li>如果未被忽略的污点中存在至少一个 effect 值为 <code>NoSchedule</code> 的污点， 则 Kubernetes 不会将 Pod 调度到该节点。</li><li>如果未被忽略的污点中不存在 effect 值为 <code>NoSchedule</code> 的污点， 但是存在 effect 值为 <code>PreferNoSchedule</code> 的污点， 则 Kubernetes 会 <strong>尝试</strong> 不将 Pod 调度到该节点。</li><li>如果未被忽略的污点中存在至少一个 effect 值为 <code>NoExecute</code> 的污点， 则 Kubernetes 不会将 Pod 调度到该节点（如果 Pod 还未在节点上运行）， 或者将 Pod 从该节点驱逐（如果 Pod 已经在节点上运行）。</li></ul><p>例如，假设你给一个节点添加了如下污点</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>kubectl taint nodes node1 <span class=nv>key1</span><span class=o>=</span>value1:NoSchedule
kubectl taint nodes node1 <span class=nv>key1</span><span class=o>=</span>value1:NoExecute
kubectl taint nodes node1 <span class=nv>key2</span><span class=o>=</span>value2:NoSchedule
</code></pre></td></tr></table></div></div><p>假定有一个 Pod，它有两个容忍度：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;key1&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Equal&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;value1&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;NoSchedule&#34;</span><span class=w>
</span><span class=w></span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;key1&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Equal&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;value1&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;NoExecute&#34;</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>在这种情况下，上述 Pod 不会被调度到上述节点，因为其没有容忍度和第三个污点相匹配。 但是如果在给节点添加上述污点之前，该 Pod 已经在上述节点运行， 那么它还可以继续运行在该节点上，因为第三个污点是三个污点中唯一不能被这个 Pod 容忍的。</p><p>通常情况下，如果给一个节点添加了一个 effect 值为 <code>NoExecute</code> 的污点， 则任何不能忍受这个污点的 Pod 都会马上被驱逐，任何可以忍受这个污点的 Pod 都不会被驱逐。 但是，如果 Pod 存在一个 effect 值为 <code>NoExecute</code> 的容忍度指定了可选属性 <code>tolerationSeconds</code> 的值，则表示在给节点添加了上述污点之后， Pod 还能继续在节点上运行的时间。例如，</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;key1&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Equal&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;value1&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;NoExecute&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>tolerationSeconds</span><span class=p>:</span><span class=w> </span><span class=m>3600</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>这表示如果这个 Pod 正在运行，同时一个匹配的污点被添加到其所在的节点， 那么 Pod 还将继续在节点上运行 3600 秒，然后被驱逐。 如果在此之前上述污点被删除了，则 Pod 不会被驱逐。</p><h3 id=使用例子>使用例子</h3><p>通过污点和容忍度，可以灵活地让 Pod <strong>避开</strong>某些节点或者将 Pod 从某些节点驱逐。 下面是几个使用例子：</p><ul><li><p><strong>专用节点</strong>：如果你想将某些节点专门分配给特定的一组用户使用，你可以给这些节点添加一个污点（即， <code>kubectl taint nodes nodename dedicated=groupName:NoSchedule</code>）， 然后给这组用户的 Pod 添加一个相对应的容忍度 （通过编写一个自定义的<a href=https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/admission-controllers/ target=_blank rel="noopener noreffer">准入控制器</a>来实现）。 拥有上述容忍度的 Pod 就能够被调度到上述专用节点，同时也能够被调度到集群中的其它节点。 如果你希望这些 Pod 只能被调度到上述专用节点， 那么你还需要给这些专用节点另外添加一个和上述污点类似的 label （例如：<code>dedicated=groupName</code>）， 同时还要在上述准入控制器中给 Pod 增加节点亲和性要求，要求上述 Pod 只能被调度到添加了 <code>dedicated=groupName</code> 标签的节点上。</p></li><li><p><strong>配备了特殊硬件的节点</strong>：在部分节点配备了特殊硬件（比如 GPU）的集群中， 我们希望不需要这类硬件的 Pod 不要被调度到这些特殊节点，以便为后继需要这类硬件的 Pod 保留资源。 要达到这个目的，可以先给配备了特殊硬件的节点添加污点 （例如 <code>kubectl taint nodes nodename special=true:NoSchedule</code> 或 <code>kubectl taint nodes nodename special=true:PreferNoSchedule</code>)， 然后给使用了这类特殊硬件的 Pod 添加一个相匹配的容忍度。 和专用节点的例子类似，添加这个容忍度的最简单的方法是使用自定义 <a href=https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/admission-controllers/ target=_blank rel="noopener noreffer">准入控制器</a>。 比如，我们推荐使用<a href=https://kubernetes.io/zh-cn/docs/concepts/configuration/manage-resources-containers/#extended-resources target=_blank rel="noopener noreffer">扩展资源</a> 来表示特殊硬件，给配置了特殊硬件的节点添加污点时包含扩展资源名称， 然后运行一个 <a href=https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/admission-controllers/#extendedresourcetoleration target=_blank rel="noopener noreffer">ExtendedResourceToleration</a> 准入控制器。此时，因为节点已经被设置污点了，没有对应容忍度的 Pod 不会被调度到这些节点。 但当你创建一个使用了扩展资源的 Pod 时，<code>ExtendedResourceToleration</code> 准入控制器会自动给 Pod 加上正确的容忍度，这样 Pod 就会被自动调度到这些配置了特殊硬件的节点上。 这种方式能够确保配置了特殊硬件的节点专门用于运行需要这些硬件的 Pod， 并且你无需手动给这些 Pod 添加容忍度。</p></li><li><p><strong>基于污点的驱逐</strong>: 这是在每个 Pod 中配置的在节点出现问题时的驱逐行为， 接下来的章节会描述这个特性。</p></li></ul><h3 id=基于污点的驱逐>基于污点的驱逐</h3><p><strong>特性状态：</strong> <code>Kubernetes v1.18 [stable]</code></p><p>前文提到过污点的效果值 <code>NoExecute</code> 会影响已经在节点上运行的 Pod，如下</p><ul><li>如果 Pod 不能忍受这类污点，Pod 会马上被驱逐</li><li>如果 Pod 能够忍受这类污点，但是在容忍度定义中没有指定 <code>tolerationSeconds</code>， 则 Pod 还会一直在这个节点上运行。</li><li>如果 Pod 能够忍受这类污点，而且指定了 <code>tolerationSeconds</code>， 则 Pod 还能在这个节点上继续运行这个指定的时间长度。</li></ul><p>当某种条件为真时，节点控制器会自动给节点添加一个污点。当前内置的污点包括：</p><ul><li><code>node.kubernetes.io/not-ready</code>：节点未准备好。这相当于节点状况 <code>Ready</code> 的值为 &ldquo;<code>False</code>"。</li><li><code>node.kubernetes.io/unreachable</code>：节点控制器访问不到节点. 这相当于节点状况 <code>Ready</code> 的值为 &ldquo;<code>Unknown</code>"。</li><li><code>node.kubernetes.io/memory-pressure</code>：节点存在内存压力。</li><li><code>node.kubernetes.io/disk-pressure</code>：节点存在磁盘压力。</li><li><code>node.kubernetes.io/pid-pressure</code>: 节点的 PID 压力。</li><li><code>node.kubernetes.io/network-unavailable</code>：节点网络不可用。</li><li><code>node.kubernetes.io/unschedulable</code>: 节点不可调度。</li><li><code>node.cloudprovider.kubernetes.io/uninitialized</code>：如果 kubelet 启动时指定了一个“外部”云平台驱动， 它将给当前节点添加一个污点将其标志为不可用。在 cloud-controller-manager 的一个控制器初始化这个节点后，kubelet 将删除这个污点。</li></ul><p>在节点被驱逐时，节点控制器或者 kubelet 会添加带有 <code>NoExecute</code> 效果的相关污点。 如果异常状态恢复正常，kubelet 或节点控制器能够移除相关的污点。</p><p><strong>说明：</strong></p><p>控制面会限制向节点添加新污点的速率。这一速率限制可以管理多个节点同时不可达时 （例如出现网络中断的情况），可能触发的驱逐的数量。</p><p>你可以为 Pod 设置 <code>tolerationSeconds</code>，以指定当节点失效或者不响应时， Pod 维系与该节点间绑定关系的时长。</p><p>比如，你可能希望在出现网络分裂事件时，对于一个与节点本地状态有着深度绑定的应用而言， 仍然停留在当前节点上运行一段较长的时间，以等待网络恢复以避免被驱逐。 你为这种 Pod 所设置的容忍度看起来可能是这样：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;node.kubernetes.io/unreachable&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Exists&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;NoExecute&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>tolerationSeconds</span><span class=p>:</span><span class=w> </span><span class=m>6000</span><span class=w>
</span></code></pre></td></tr></table></div></div><p><strong>说明：</strong></p><p>Kubernetes 会自动给 Pod 添加针对 <code>node.kubernetes.io/not-ready</code> 和 <code>node.kubernetes.io/unreachable</code> 的容忍度，且配置 <code>tolerationSeconds=300</code>， 除非用户自身或者某控制器显式设置此容忍度。</p><p>这些自动添加的容忍度意味着 Pod 可以在检测到对应的问题之一时，在 5 分钟内保持绑定在该节点上。</p><p><a href=https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/daemonset/ target=_blank rel="noopener noreffer">DaemonSet</a> 中的 Pod 被创建时， 针对以下污点自动添加的 <code>NoExecute</code> 的容忍度将不会指定 <code>tolerationSeconds</code>：</p><ul><li><code>node.kubernetes.io/unreachable</code></li><li><code>node.kubernetes.io/not-ready</code></li></ul><p>这保证了出现上述问题时 DaemonSet 中的 Pod 永远不会被驱逐。</p><h3 id=基于节点状态添加污点>基于节点状态添加污点</h3><p>控制平面使用节点<a href=https://kubernetes.io/zh-cn/docs/concepts/architecture/controller/ target=_blank rel="noopener noreffer">控制器</a>自动创建 与<a href=https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/node-pressure-eviction/#node-conditions target=_blank rel="noopener noreffer">节点状况</a> 对应的、效果为 <code>NoSchedule</code> 的污点。</p><p>调度器在进行调度时检查污点，而不是检查节点状况。这确保节点状况不会直接影响调度。 例如，如果 <code>DiskPressure</code> 节点状况处于活跃状态，则控制平面添加 <code>node.kubernetes.io/disk-pressure</code> 污点并且不会调度新的 Pod 到受影响的节点。 如果 <code>MemoryPressure</code> 节点状况处于活跃状态，则控制平面添加 <code>node.kubernetes.io/memory-pressure</code> 污点。</p><p>对于新创建的 Pod，可以通过添加相应的 Pod 容忍度来忽略节点状况。 控制平面还在具有除 <code>BestEffort</code> 之外的 <a href="https://kubernetes.io/zh-cn/docs/reference/glossary/?all=true#term-qos-class" target=_blank rel="noopener noreffer">QoS 类</a>的 Pod 上添加 <code>node.kubernetes.io/memory-pressure</code> 容忍度。 这是因为 Kubernetes 将 <code>Guaranteed</code> 或 <code>Burstable</code> QoS 类中的 Pod（甚至没有设置内存请求的 Pod） 视为能够应对内存压力，而新创建的 <code>BestEffort</code> Pod 不会被调度到受影响的节点上。</p><p>DaemonSet 控制器自动为所有守护进程添加如下 <code>NoSchedule</code> 容忍度以防 DaemonSet 崩溃：</p><ul><li><code>node.kubernetes.io/memory-pressure</code></li><li><code>node.kubernetes.io/disk-pressure</code></li><li><code>node.kubernetes.io/pid-pressure</code> (1.14 或更高版本)</li><li><code>node.kubernetes.io/unschedulable</code> (1.10 或更高版本)</li><li><code>node.kubernetes.io/network-unavailable</code> (<strong>只适合主机网络配置</strong>)</li></ul><p>添加上述容忍度确保了向后兼容，你也可以选择自由向 DaemonSet 添加容忍度。</p><h2 id=将-pod-指派给节点>将 Pod 指派给节点</h2><p>你可以约束一个 <a href=https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/ target=_blank rel="noopener noreffer">Pod</a> 只能在特定的<a href=https://kubernetes.io/zh-cn/docs/concepts/architecture/nodes/ target=_blank rel="noopener noreffer">节点</a>上运行。 有几种方法可以实现这点，推荐的方法都是用 <a href=https://kubernetes.io/zh-cn/docs/concepts/overview/working-with-objects/labels/ target=_blank rel="noopener noreffer">标签选择算符</a>来进行选择。 通常这样的约束不是必须的，因为调度器将自动进行合理的放置（比如，将 Pod 分散到节点上， 而不是将 Pod 放置在可用资源不足的节点上等等）。但在某些情况下，你可能需要进一步控制 Pod 被部署到的节点。例如，确保 Pod 最终落在连接了 SSD 的机器上， 或者将来自两个不同的服务且有大量通信的 Pods 被放置在同一个可用区。</p><p>你可以使用下列方法中的任何一种来选择 Kubernetes 对特定 Pod 的调度：</p><ul><li>与<a href=https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/assign-pod-node/#built-in-node-labels target=_blank rel="noopener noreffer">节点标签</a>匹配的 <a href=https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/assign-pod-node/#nodeSelector target=_blank rel="noopener noreffer">nodeSelector</a></li><li><a href=https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/assign-pod-node/#affinity-and-anti-affinity target=_blank rel="noopener noreffer">亲和性与反亲和性</a></li><li><a href=https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/assign-pod-node/#nodename target=_blank rel="noopener noreffer">nodeName</a> 字段</li></ul><h3 id=nodeselector>nodeSelector</h3><p><code>nodeSelector</code> 是节点选择约束的最简单推荐形式。你可以将 <code>nodeSelector</code> 字段添加到 Pod 的规约中设置你希望目标节点所具有的<a href=https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/assign-pod-node/#built-in-node-labels target=_blank rel="noopener noreffer">节点标签</a>。 Kubernetes 只会将 Pod 调度到拥有你所指定的每个标签的节点上。</p><h3 id=亲和性与反亲和性>亲和性与反亲和性</h3><p><code>nodeSelector</code> 提供了一种最简单的方法来将 Pod 约束到具有特定标签的节点上。 亲和性和反亲和性扩展了你可以定义的约束类型。使用亲和性与反亲和性的一些好处有：</p><ul><li>亲和性、反亲和性语言的表达能力更强。<code>nodeSelector</code> 只能选择拥有所有指定标签的节点。 亲和性、反亲和性为你提供对选择逻辑的更强控制能力。</li><li>你可以标明某规则是“软需求”或者“偏好”，这样调度器在无法找到匹配节点时仍然调度该 Pod。</li><li>你可以使用节点上（或其他拓扑域中）运行的其他 Pod 的标签来实施调度约束， 而不是只能使用节点本身的标签。这个能力让你能够定义规则允许哪些 Pod 可以被放置在一起。</li></ul><p>亲和性功能由两种类型的亲和性组成：</p><ul><li><strong>节点亲和性</strong>功能类似于 <code>nodeSelector</code> 字段，但它的表达能力更强，并且允许你指定软规则。</li><li>Pod 间亲和性/反亲和性允许你根据其他 Pod 的标签来约束 Pod。</li></ul><h4 id=节点亲和性>节点亲和性</h4><p>节点亲和性概念上类似于 <code>nodeSelector</code>， 它使你可以根据节点上的标签来约束 Pod 可以调度到哪些节点上。 节点亲和性有两种：</p><ul><li><code>requiredDuringSchedulingIgnoredDuringExecution</code>： 调度器只有在规则被满足的时候才能执行调度。此功能类似于 <code>nodeSelector</code>， 但其语法表达能力更强。</li><li><code>preferredDuringSchedulingIgnoredDuringExecution</code>： 调度器会尝试寻找满足对应规则的节点。如果找不到匹配的节点，调度器仍然会调度该 Pod。</li></ul><p><strong>说明：</strong></p><p>在上述类型中，<code>IgnoredDuringExecution</code> 意味着如果节点标签在 Kubernetes 调度 Pod 时发生了变更，Pod 仍将继续运行。</p><p>你可以使用 Pod 规约中的 <code>.spec.affinity.nodeAffinity</code> 字段来设置节点亲和性。 例如，考虑下面的 Pod 规约：</p><p><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/zh-cn/examples/pods/pod-with-node-affinity.yaml target=_blank rel="noopener noreffer"><code>pods/pod-with-node-affinity.yaml</code></a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>with-node-affinity</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>affinity</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>nodeAffinity</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>requiredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>nodeSelectorTerms</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span><span class=w>          </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes.io/os</span><span class=w>
</span><span class=w>            </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span><span class=w>            </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=l>linux</span><span class=w>
</span><span class=w>      </span><span class=nt>preferredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>weight</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>        </span><span class=nt>preference</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span><span class=w>          </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>another-node-label-key</span><span class=w>
</span><span class=w>            </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span><span class=w>            </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=l>another-node-label-value</span><span class=w>
</span><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>with-node-affinity</span><span class=w>
</span><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>k8s.gcr.io/pause:2.0</span><span class=w>
</span></code></pre></td></tr></table></div></div><p><strong>说明：</strong></p><p>如果你希望 Kubernetes 能够成功地调度此例中的 Pod，你必须拥有打了 <code>kubernetes.io/os=linux</code> 标签的节点。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>with-node-affinity</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>affinity</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>nodeAffinity</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>requiredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>nodeSelectorTerms</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span><span class=w>          </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>topology.kubernetes.io/zone</span><span class=w>
</span><span class=w>            </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span><span class=w>            </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=l>antarctica-east1</span><span class=w>
</span><span class=w>            </span>- <span class=l>antarctica-west1</span><span class=w>
</span><span class=w>      </span><span class=nt>preferredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>weight</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>        </span><span class=nt>preference</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span><span class=w>          </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>another-node-label-key</span><span class=w>
</span><span class=w>            </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span><span class=w>            </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=l>another-node-label-value</span><span class=w>
</span><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>with-node-affinity</span><span class=w>
</span><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>k8s.gcr.io/pause:2.0</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>在这一示例中，所应用的规则如下：</p><ul><li>节点<strong>必须</strong>包含一个键名为 <code>topology.kubernetes.io/zone</code> 的标签， 并且该标签的取值<strong>必须</strong>为 <code>antarctica-east1</code> 或 <code>antarctica-west1</code>。</li><li>节点<strong>最好</strong>具有一个键名为 <code>another-node-label-key</code> 且取值为 <code>another-node-label-value</code> 的标签。</li></ul><p>你可以使用 <code>operator</code> 字段来为 Kubernetes 设置在解释规则时要使用的逻辑操作符。 你可以使用 <code>In</code>、<code>NotIn</code>、<code>Exists</code>、<code>DoesNotExist</code>、<code>Gt</code> 和 <code>Lt</code> 之一作为操作符。</p><p><code>NotIn</code> 和 <code>DoesNotExist</code> 可用来实现节点反亲和性行为。 你也可以使用<a href=https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/taint-and-toleration/ target=_blank rel="noopener noreffer">节点污点</a> 将 Pod 从特定节点上驱逐。</p><p><strong>说明：</strong></p><p>如果你同时指定了 <code>nodeSelector</code> 和 <code>nodeAffinity</code>，<strong>两者</strong> 必须都要满足， 才能将 Pod 调度到候选节点上。</p><p>如果你指定了多个与 <code>nodeAffinity</code> 类型关联的 <code>nodeSelectorTerms</code>， 只要其中一个 <code>nodeSelectorTerms</code> 满足的话，Pod 就可以被调度到节点上。</p><p>如果你指定了多个与同一 <code>nodeSelectorTerms</code> 关联的 <code>matchExpressions</code>， 则只有当所有 <code>matchExpressions</code> 都满足时 Pod 才可以被调度到节点上。</p><p>参阅<a href=https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/assign-pods-nodes-using-node-affinity/ target=_blank rel="noopener noreffer">使用节点亲和性来为 Pod 指派节点</a>， 以了解进一步的信息。</p><h5 id=节点亲和性权重>节点亲和性权重</h5><p>你可以为 <code>preferredDuringSchedulingIgnoredDuringExecution</code> 亲和性类型的每个实例设置 <code>weight</code> 字段，其取值范围是 1 到 100。 当调度器找到能够满足 Pod 的其他调度请求的节点时，调度器会遍历节点满足的所有的偏好性规则， 并将对应表达式的 <code>weight</code> 值加和。</p><p>最终的加和值会添加到该节点的其他优先级函数的评分之上。 在调度器为 Pod 作出调度决定时，总分最高的节点的优先级也最高。</p><p>例如，考虑下面的 Pod 规约：</p><p><code>pods/pod-with-affinity-anti-affinity.yaml</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>with-affinity-anti-affinity</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>affinity</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>nodeAffinity</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>requiredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>nodeSelectorTerms</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span><span class=w>          </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>topology.kubernetes.io/zone</span><span class=w>
</span><span class=w>            </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span><span class=w>            </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=l>antarctica-east1</span><span class=w>
</span><span class=w>            </span>- <span class=l>antarctica-west1</span><span class=w>
</span><span class=w>      </span><span class=nt>preferredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>weight</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>        </span><span class=nt>preference</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span><span class=w>          </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>label-1</span><span class=w>
</span><span class=w>            </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span><span class=w>            </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=l>key-1</span><span class=w>
</span><span class=w>      </span>- <span class=nt>weight</span><span class=p>:</span><span class=w> </span><span class=m>50</span><span class=w>
</span><span class=w>        </span><span class=nt>preference</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span><span class=w>          </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>label-2</span><span class=w>
</span><span class=w>            </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span><span class=w>            </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=l>key-2</span><span class=w>
</span><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>with-node-affinity</span><span class=w>
</span><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>k8s.gcr.io/pause:2.0</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>如果存在两个候选节点，都满足 <code>requiredDuringSchedulingIgnoredDuringExecution</code> 规则， 其中一个节点具有标签 <code>label-1:key-1</code>，另一个节点具有标签 <code>label-2:key-2</code>， 调度器会考察各个节点的 <code>weight</code> 取值，并将该权重值添加到节点的其他得分值之上。</p><p><strong>注意：此策略需要考虑调度器的优选策略实现方式。</strong></p><h4 id=pod-间亲和性与反亲和性-httpskubernetesiozh-cndocsconceptsscheduling-evictionassign-pod-nodeinter-pod-affinity-and-anti-affinity>Pod 间亲和性与反亲和性<a href=https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/assign-pod-node/#inter-pod-affinity-and-anti-affinity target=_blank rel="noopener noreffer"></a></h4><p>Pod 间亲和性与反亲和性使你可以基于已经在节点上运行的 <strong>Pod</strong> 的标签来约束 Pod 可以调度到的节点，而不是基于节点上的标签。</p><p>Pod 间亲和性与反亲和性的规则格式为“如果 X 上已经运行了一个或多个满足规则 Y 的 Pod， 则这个 Pod 应该（或者在反亲和性的情况下不应该）运行在 X 上”。 这里的 X 可以是节点、机架、云提供商可用区或地理区域或类似的拓扑域， Y 则是 Kubernetes 尝试满足的规则。</p><p>你通过<a href=https://kubernetes.io/zh-cn/docs/concepts/overview/working-with-objects/labels/#label-selectors target=_blank rel="noopener noreffer">标签选择算符</a> 的形式来表达规则（Y），并可根据需要指定选关联的名字空间列表。 Pod 在 Kubernetes 中是名字空间作用域的对象，因此 Pod 的标签也隐式地具有名字空间属性。 针对 Pod 标签的所有标签选择算符都要指定名字空间，Kubernetes 会在指定的名字空间内寻找标签。</p><p>你会通过 <code>topologyKey</code> 来表达拓扑域（X）的概念，其取值是系统用来标示域的节点标签键。 相关示例可参见<a href=https://kubernetes.io/zh-cn/docs/reference/labels-annotations-taints/ target=_blank rel="noopener noreffer">常用标签、注解和污点</a>。</p><blockquote><p><strong>说明：</strong></p><p><strong>Pod 间亲和性和反亲和性都需要相当的计算量，因此会在大规模集群中显著降低调度速度。 我们不建议在包含数百个节点的集群中使用这类设置。</strong></p><p><strong>说明：</strong></p><p>Pod 反亲和性需要节点上存在一致性的标签。换言之， 集群中每个节点都必须拥有与 <code>topologyKey</code> 匹配的标签。 如果某些或者所有节点上不存在所指定的 <code>topologyKey</code> 标签，调度行为可能与预期的不同。</p></blockquote><p><strong>注意：在实际使用和测试中，特别是大规模集群场景下，这个pod亲和性特性确实会影响调度性能。所以，pod亲和性不做重点来使用</strong></p><h5 id=pod-间亲和性与反亲和性的类型>Pod 间亲和性与反亲和性的类型</h5><p>与<a href=https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/assign-pod-node/#node-affinity target=_blank rel="noopener noreffer">节点亲和性</a>类似，Pod 的亲和性与反亲和性也有两种类型：</p><ul><li><code>requiredDuringSchedulingIgnoredDuringExecution</code></li><li><code>preferredDuringSchedulingIgnoredDuringExecution</code></li></ul><p>例如，你可以使用 <code>requiredDuringSchedulingIgnoredDuringExecution</code> 亲和性来告诉调度器， 将两个服务的 Pod 放到同一个云提供商可用区内，因为它们彼此之间通信非常频繁。 类似地，你可以使用 <code>preferredDuringSchedulingIgnoredDuringExecution</code> 反亲和性来将同一服务的多个 Pod 分布到多个云提供商可用区中。</p><p>要使用 Pod 间亲和性，可以使用 Pod 规约中的 <code>.affinity.podAffinity</code> 字段。 对于 Pod 间反亲和性，可以使用 Pod 规约中的 <code>.affinity.podAntiAffinity</code> 字段。</p><h5 id=pod-亲和性示例>Pod 亲和性示例</h5><p>考虑下面的 Pod 规约：</p><p><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/zh-cn/examples/pods/pod-with-pod-affinity.yaml target=_blank rel="noopener noreffer"><code>pods/pod-with-pod-affinity.yaml</code></a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>with-pod-affinity</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>affinity</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>podAffinity</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>requiredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>labelSelector</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span><span class=w>          </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>security</span><span class=w>
</span><span class=w>            </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span><span class=w>            </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=l>S1</span><span class=w>
</span><span class=w>        </span><span class=nt>topologyKey</span><span class=p>:</span><span class=w> </span><span class=l>topology.kubernetes.io/zone</span><span class=w>
</span><span class=w>    </span><span class=nt>podAntiAffinity</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>preferredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>weight</span><span class=p>:</span><span class=w> </span><span class=m>100</span><span class=w>
</span><span class=w>        </span><span class=nt>podAffinityTerm</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>labelSelector</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>security</span><span class=w>
</span><span class=w>              </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span><span class=w>              </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span><span class=w>              </span>- <span class=l>S2</span><span class=w>
</span><span class=w>          </span><span class=nt>topologyKey</span><span class=p>:</span><span class=w> </span><span class=l>topology.kubernetes.io/zone</span><span class=w>
</span><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>with-pod-affinity</span><span class=w>
</span><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>k8s.gcr.io/pause:2.0</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>本示例定义了一条 Pod 亲和性规则和一条 Pod 反亲和性规则。Pod 亲和性规则配置为 <code>requiredDuringSchedulingIgnoredDuringExecution</code>，而 Pod 反亲和性配置为 <code>preferredDuringSchedulingIgnoredDuringExecution</code>。</p><p>亲和性规则表示，仅当节点和至少一个已运行且有 <code>security=S1</code> 的标签的 Pod 处于同一区域时，才可以将该 Pod 调度到节点上。 更确切的说，调度器必须将 Pod 调度到具有 <code>topology.kubernetes.io/zone=V</code> 标签的节点上，并且集群中至少有一个位于该可用区的节点上运行着带有 <code>security=S1</code> 标签的 Pod。</p><p>反亲和性规则表示，如果节点处于 Pod 所在的同一可用区且至少一个 Pod 具有 <code>security=S2</code> 标签，则该 Pod 不应被调度到该节点上。 更确切地说， 如果同一可用区中存在其他运行着带有 <code>security=S2</code> 标签的 Pod 节点， 并且节点具有标签 <code>topology.kubernetes.io/zone=R</code>，Pod 不能被调度到该节点上。</p><p>查阅<a href=https://git.k8s.io/design-proposals-archive/scheduling/podaffinity.md target=_blank rel="noopener noreffer">设计文档</a> 以进一步熟悉 Pod 亲和性与反亲和性的示例。</p><p>你可以针对 Pod 间亲和性与反亲和性为其 <code>operator</code> 字段使用 <code>In</code>、<code>NotIn</code>、<code>Exists</code>、 <code>DoesNotExist</code> 等值。</p><p>原则上，<code>topologyKey</code> 可以是任何合法的标签键。出于性能和安全原因，<code>topologyKey</code> 有一些限制：</p><ul><li>对于 Pod 亲和性而言，在 <code>requiredDuringSchedulingIgnoredDuringExecution</code> 和 <code>preferredDuringSchedulingIgnoredDuringExecution</code> 中，<code>topologyKey</code> 不允许为空。</li><li>对于 <code>requiredDuringSchedulingIgnoredDuringExecution</code> 要求的 Pod 反亲和性， 准入控制器 <code>LimitPodHardAntiAffinityTopology</code> 要求 <code>topologyKey</code> 只能是 <code>kubernetes.io/hostname</code>。如果你希望使用其他定制拓扑逻辑， 你可以更改准入控制器或者禁用之。</li></ul><p>除了 <code>labelSelector</code> 和 <code>topologyKey</code>，你也可以指定 <code>labelSelector</code> 要匹配的命名空间列表，方法是在 <code>labelSelector</code> 和 <code>topologyKey</code> 所在层同一层次上设置 <code>namespaces</code>。 如果 <code>namespaces</code> 被忽略或者为空，则默认为 Pod 亲和性/反亲和性的定义所在的命名空间。</p><h2 id=用节点亲和性把-pods-分配到节点>用节点亲和性把 Pods 分配到节点</h2><h3 id=给节点添加标签>给节点添加标签</h3><ol><li><p>列出集群中的节点及其标签：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>kubectl get nodes --show-labels
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>输出类似于此：

NAME      STATUS    ROLES    AGE     VERSION        LABELS
worker0   Ready     &lt;none&gt;   1d      v1.13.0        ...,kubernetes.io/hostname=worker0
worker1   Ready     &lt;none&gt;   1d      v1.13.0        ...,kubernetes.io/hostname=worker1
worker2   Ready     &lt;none&gt;   1d      v1.13.0        ...,kubernetes.io/hostname=worker2
</code></pre></td></tr></table></div></div><ol><li>选择一个节点，给它添加一个标签：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>kubectl label nodes &lt;your-node-name&gt; <span class=nv>disktype</span><span class=o>=</span>ssd
</code></pre></td></tr></table></div></div><p>其中 <code>&lt;your-node-name></code> 是你所选节点的名称。</p></li><li><p>验证你所选节点具有 <code>disktype=ssd</code> 标签：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>kubectl get nodes --show-labels
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>输出类似于此：

NAME      STATUS    ROLES    AGE     VERSION        LABELS
worker0   Ready     &lt;none&gt;   1d      v1.13.0        ...,disktype=ssd,kubernetes.io/hostname=worker0
worker1   Ready     &lt;none&gt;   1d      v1.13.0        ...,kubernetes.io/hostname=worker1
worker2   Ready     &lt;none&gt;   1d      v1.13.0        ...,kubernetes.io/hostname=worker2
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>在前面的输出中，可以看到 `worker0` 节点有一个 `disktype=ssd` 标签。
</code></pre></td></tr></table></div></div></li></ol><h3 id=依据强制的节点亲和性调度-pod>依据强制的节点亲和性调度 Pod</h3><p>下面清单描述了一个 Pod，它有一个节点亲和性配置 <code>requiredDuringSchedulingIgnoredDuringExecution</code>，<code>disktype=ssd</code>。 这意味着 pod 只会被调度到具有 <code>disktype=ssd</code> 标签的节点上。</p><p><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/zh-cn/examples/pods/pod-nginx-required-affinity.yaml target=_blank rel="noopener noreffer"><code>pods/pod-nginx-required-affinity.yaml</code></a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>affinity</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>nodeAffinity</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>requiredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>nodeSelectorTerms</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span><span class=w>          </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>disktype</span><span class=w>
</span><span class=w>            </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span><span class=w>            </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=l>ssd            </span><span class=w>
</span><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span><span class=w>    </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></code></pre></td></tr></table></div></div><ol><li><p>执行（Apply）此清单来创建一个调度到所选节点上的 Pod：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>kubectl apply -f https://k8s.io/examples/pods/pod-nginx-required-affinity.yaml
</code></pre></td></tr></table></div></div><ol><li>验证 pod 已经在所选节点上运行：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>kubectl get pods --output<span class=o>=</span>wide
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>输出类似于此：

NAME     READY     STATUS    RESTARTS   AGE    IP           NODE
nginx    1/1       Running   0          13s    10.200.0.4   worker0
</code></pre></td></tr></table></div></div></li></ol><h3 id=使用首选的节点亲和性调度-pod>使用首选的节点亲和性调度 Pod</h3><p>本清单描述了一个Pod，它有一个节点亲和性设置 <code>preferredDuringSchedulingIgnoredDuringExecution</code>，<code>disktype: ssd</code>。 这意味着 pod 将首选具有 <code>disktype=ssd</code> 标签的节点。</p><p><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/zh-cn/examples/pods/pod-nginx-preferred-affinity.yaml target=_blank rel="noopener noreffer"><code>pods/pod-nginx-preferred-affinity.yaml</code></a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>affinity</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>nodeAffinity</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>preferredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>weight</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>        </span><span class=nt>preference</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span><span class=w>          </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>disktype</span><span class=w>
</span><span class=w>            </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span><span class=w>            </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=l>ssd          </span><span class=w>
</span><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span><span class=w>    </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></code></pre></td></tr></table></div></div><ol><li><p>执行此清单创建一个会调度到所选节点上的 Pod：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>kubectl apply -f https://k8s.io/examples/pods/pod-nginx-preferred-affinity.yaml
</code></pre></td></tr></table></div></div></li><li><p>验证 pod 是否在所选节点上运行：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>kubectl get pods --output<span class=o>=</span>wide
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>输出类似于此：
 
NAME     READY     STATUS    RESTARTS   AGE    IP           NODE
nginx    1/1       Running   0          13s    10.200.0.4   worker0
</code></pre></td></tr></table></div></div></li></ol><h3 id=示例>示例</h3><p>nodeAffinity测试 affinitypod.yaml</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>tini-test-1</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=c>#- image: 100.7.36.88:5000/com.inspur/busybox:1.31.0</span><span class=w>
</span><span class=w>    </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>com.inspur/busybox:1.31.0</span><span class=w>
</span><span class=w>      </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=s2>&#34;sh&#34;</span><span class=w>
</span><span class=w>        </span>- <span class=s2>&#34;-c&#34;</span><span class=w>
</span><span class=w>        </span>- <span class=s2>&#34;sleep 60m&#34;</span><span class=w>
</span><span class=w>      </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span><span class=w>  </span><span class=nt>schedulerName</span><span class=p>:</span><span class=w> </span><span class=l>kube-batch</span><span class=w>
</span><span class=w>  </span><span class=c>#nodeSelector:</span><span class=w>
</span><span class=w>   </span><span class=c># gpuShare: &#34;true&#34;</span><span class=w>
</span><span class=w>   </span><span class=c># kubernetes.io/hostname: &#34;node3&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>affinity</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>nodeAffinity</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>requiredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>  </span><span class=c># 硬策略</span><span class=w>
</span><span class=w>            </span><span class=nt>nodeSelectorTerms</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=c># - matchExpressions:</span><span class=w>
</span><span class=w>            </span><span class=c>#   - key: node-role.kubernetes.io/master</span><span class=w>
</span><span class=w>            </span><span class=c>#     operator: In</span><span class=w>
</span><span class=w>            </span><span class=c>#     values:</span><span class=w>
</span><span class=w>            </span><span class=c>#     - &#34;true&#34;</span><span class=w>
</span><span class=w>            </span><span class=c># - matchExpressions:</span><span class=w>
</span><span class=w>            </span><span class=c>#   - key: kubernetes.io/hostname</span><span class=w>
</span><span class=w>            </span><span class=c>#     operator: In</span><span class=w>
</span><span class=w>            </span><span class=c>#     values:</span><span class=w>
</span><span class=w>            </span><span class=c>#     - &#34;node-arm-22&#34;</span><span class=w>
</span><span class=w>            </span>- <span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span><span class=w>              </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>mount/tini</span><span class=w>
</span><span class=w>                </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>NotIn</span><span class=w>
</span><span class=w>                </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span><span class=w>                </span>- <span class=s2>&#34;failed&#34;</span><span class=w>   
</span><span class=w>
</span></code></pre></td></tr></table></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2022-08-01</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/k8s/>K8S</a></section><section><span><a href=javascript:void(0); onclick=window.history.back();>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/2022/07/linux%E9%98%B2%E7%81%AB%E5%A2%99firewall-cmd%E5%91%BD%E4%BB%A4%E8%AF%B4%E6%98%8E/ class=prev rel=prev title=linux防火墙firewall-cmd命令说明><i class="fas fa-angle-left fa-fw"></i>linux防火墙firewall-cmd命令说明</a>
<a href=/posts/2022/09/arm%E5%B9%B3%E5%8F%B0%E9%95%9C%E5%83%8F%E9%80%82%E9%85%8D%E6%93%8D%E4%BD%9C/ class=next rel=next title=arm平台镜像适配操作>arm平台镜像适配操作<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2016 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=bingerambo.com target=_blank>Binge</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=http://bingerambo.com/ target=_blank>bingerambo.com</a></span></div><div class=footer-line><i class="fa fa-eye"></i>本站总访问量<span id=busuanzi_value_site_pv></span>次
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{"utterances":{"darkTheme":"github-dark","issueTerm":"pathname","label":"","lightTheme":"github-light","repo":"bingerambo/myblog-comments"}},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true}};</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','UA-81425808-1',{'anonymize_ip':true});</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=UA-81425808-1" async></script><script src=https://libs.baidu.com/jquery/2.1.4/jquery.min.js></script><script src=https://cdn.bootcdn.net/ajax/libs/jquery-backstretch/2.1.18/jquery.backstretch.min.js></script><script type=text/javascript src=/js/custom.js></script><script>var _hmt=_hmt||[];(function(){var hm=document.createElement("script");hm.src="https://hm.baidu.com/hm.js?c0176279eee823ce422da4e8d06708f9";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script></body></html>