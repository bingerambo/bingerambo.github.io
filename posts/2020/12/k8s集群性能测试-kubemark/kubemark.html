<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><style>body {
  max-width: 980px;
  border: 1px solid #ddd;
  outline: 1300px solid #fff;
  margin: 16px auto;
}

body .markdown-body
{
  padding: 45px;
}

@font-face {
  font-family: fontawesome-mini;
  src: url(data:font/woff;charset=utf-8;base64,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) format('woff');
}

.markdown-body {
  font-family: sans-serif;
  -ms-text-size-adjust: 100%;
  -webkit-text-size-adjust: 100%;
  color: #333333;
  overflow: hidden;
  font-family: "Helvetica Neue", Helvetica, "Segoe UI", Arial, freesans, sans-serif;
  font-size: 16px;
  line-height: 1.6;
  word-wrap: break-word;
}

.markdown-body a {
  background: transparent;
}

.markdown-body a:active,
.markdown-body a:hover {
  outline: 0;
}

.markdown-body b,
.markdown-body strong {
  font-weight: bold;
}

.markdown-body mark {
  background: #ff0;
  color: #000;
  font-style: italic;
  font-weight: bold;
}

.markdown-body sub,
.markdown-body sup {
  font-size: 75%;
  line-height: 0;
  position: relative;
  vertical-align: baseline;
}
.markdown-body sup {
  top: -0.5em;
}
.markdown-body sub {
  bottom: -0.25em;
}

.markdown-body h1 {
  font-size: 2em;
  margin: 0.67em 0;
}

.markdown-body img {
  border: 0;
}

.markdown-body hr {
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  height: 0;
}

.markdown-body pre {
  overflow: auto;
}

.markdown-body code,
.markdown-body kbd,
.markdown-body pre,
.markdown-body samp {
  font-family: monospace, monospace;
  font-size: 1em;
}

.markdown-body input {
  color: inherit;
  font: inherit;
  margin: 0;
}

.markdown-body html input[disabled] {
  cursor: default;
}

.markdown-body input {
  line-height: normal;
}

.markdown-body input[type="checkbox"] {
  box-sizing: border-box;
  padding: 0;
}

.markdown-body table {
  border-collapse: collapse;
  border-spacing: 0;
}

.markdown-body td,
.markdown-body th {
  padding: 0;
}

.markdown-body .codehilitetable,
.markdown-body .highlighttable {
  border: 0;
  border-spacing: 0;
}

.markdown-body .codehilitetable tr,
.markdown-body .highlighttable {
  border: 0;
}

.markdown-body .codehilitetable pre,
.markdown-body .codehilitetable div.codehilite,
.markdown-body .highlighttable pre,
.markdown-body .highlighttable div.highlight {
  margin: 0;
}

.markdown-body .linenos,
.markdown-body .code,
.markdown-body .codehilitetable td,
.markdown-body .highlighttable td {
  border: 0;
  padding: 0;
}

.markdown-body td:not(.linenos) .linenodiv {
  padding: 0 !important;
}

.markdown-body .code {
  width: 100%;
}

.markdown-body .linenos div pre,
.markdown-body .linenodiv pre,
.markdown-body .linenodiv {
  border: 0;
  -webkit-border-radius: 0;
  -moz-border-radius: 0;
  border-radius: 0;
  -webkit-border-top-left-radius: 3px;
  -webkit-border-bottom-left-radius: 3px;
  -moz-border-radius-topleft: 3px;
  -moz-border-radius-bottomleft: 3px;
  border-top-left-radius: 3px;
  border-bottom-left-radius: 3px;
}

.markdown-body .code div pre,
.markdown-body .code div {
  border: 0;
  -webkit-border-radius: 0;
  -moz-border-radius: 0;
  border-radius: 0;
  -webkit-border-top-right-radius: 3px;
  -webkit-border-bottom-right-radius: 3px;
  -moz-border-radius-topright: 3px;
  -moz-border-radius-bottomright: 3px;
  border-top-right-radius: 3px;
  border-bottom-right-radius: 3px;
}

.markdown-body * {
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.markdown-body input {
  font: 13px Helvetica, arial, freesans, clean, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol";
  line-height: 1.4;
}

.markdown-body a {
  color: #4183c4;
  text-decoration: none;
}

.markdown-body a:hover,
.markdown-body a:focus,
.markdown-body a:active {
  text-decoration: underline;
}

.markdown-body hr {
  height: 0;
  margin: 15px 0;
  overflow: hidden;
  background: transparent;
  border: 0;
  border-bottom: 1px solid #ddd;
}

.markdown-body hr:before,
.markdown-body hr:after {
  display: table;
  content: " ";
}

.markdown-body hr:after {
  clear: both;
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  margin-top: 15px;
  margin-bottom: 15px;
  line-height: 1.1;
}

.markdown-body h1 {
  font-size: 30px;
}

.markdown-body h2 {
  font-size: 21px;
}

.markdown-body h3 {
  font-size: 16px;
}

.markdown-body h4 {
  font-size: 14px;
}

.markdown-body h5 {
  font-size: 12px;
}

.markdown-body h6 {
  font-size: 11px;
}

.markdown-body blockquote {
  margin: 0;
}

.markdown-body ul,
.markdown-body ol {
  padding: 0;
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body ol ol,
.markdown-body ul ol {
  list-style-type: lower-roman;
}

.markdown-body ul ul ol,
.markdown-body ul ol ol,
.markdown-body ol ul ol,
.markdown-body ol ol ol {
  list-style-type: lower-alpha;
}

.markdown-body dd {
  margin-left: 0;
}

.markdown-body code,
.markdown-body pre,
.markdown-body samp {
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  font-size: 12px;
}

.markdown-body pre {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body kbd {
  background-color: #e7e7e7;
  background-image: -moz-linear-gradient(#fefefe, #e7e7e7);
  background-image: -webkit-linear-gradient(#fefefe, #e7e7e7);
  background-image: linear-gradient(#fefefe, #e7e7e7);
  background-repeat: repeat-x;
  border-radius: 2px;
  border: 1px solid #cfcfcf;
  color: #000;
  padding: 3px 5px;
  line-height: 10px;
  font: 11px Consolas, "Liberation Mono", Menlo, Courier, monospace;
  display: inline-block;
}

.markdown-body>*:first-child {
  margin-top: 0 !important;
}

.markdown-body>*:last-child {
  margin-bottom: 0 !important;
}

.markdown-body .headerlink {
  font: normal 400 16px fontawesome-mini;
  vertical-align: middle;
  margin-left: -16px;
  float: left;
  display: inline-block;
  text-decoration: none;
  opacity: 0;
  color: #333;
}

.markdown-body .headerlink:focus {
  outline: none;
}

.markdown-body h1 .headerlink {
  margin-top: 0.8rem;
}

.markdown-body h2 .headerlink,
.markdown-body h3 .headerlink {
  margin-top: 0.6rem;
}

.markdown-body h4 .headerlink {
  margin-top: 0.2rem;
}

.markdown-body h5 .headerlink,
.markdown-body h6 .headerlink {
  margin-top: 0;
}

.markdown-body .headerlink:hover,
.markdown-body h1:hover .headerlink,
.markdown-body h2:hover .headerlink,
.markdown-body h3:hover .headerlink,
.markdown-body h4:hover .headerlink,
.markdown-body h5:hover .headerlink,
.markdown-body h6:hover .headerlink {
  opacity: 1;
  text-decoration: none;
}

.markdown-body h1 {
  padding-bottom: 0.3em;
  font-size: 2.25em;
  line-height: 1.2;
  border-bottom: 1px solid #eee;
}

.markdown-body h2 {
  padding-bottom: 0.3em;
  font-size: 1.75em;
  line-height: 1.225;
  border-bottom: 1px solid #eee;
}

.markdown-body h3 {
  font-size: 1.5em;
  line-height: 1.43;
}

.markdown-body h4 {
  font-size: 1.25em;
}

.markdown-body h5 {
  font-size: 1em;
}

.markdown-body h6 {
  font-size: 1em;
  color: #777;
}

.markdown-body p,
.markdown-body blockquote,
.markdown-body ul,
.markdown-body ol,
.markdown-body dl,
.markdown-body table,
.markdown-body pre,
.markdown-body .admonition {
  margin-top: 0;
  margin-bottom: 16px;
}

.markdown-body hr {
  height: 4px;
  padding: 0;
  margin: 16px 0;
  background-color: #e7e7e7;
  border: 0 none;
}

.markdown-body ul,
.markdown-body ol {
  padding-left: 2em;
}

.markdown-body ul ul,
.markdown-body ul ol,
.markdown-body ol ol,
.markdown-body ol ul {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body li>p {
  margin-top: 16px;
}

.markdown-body dl {
  padding: 0;
}

.markdown-body dl dt {
  padding: 0;
  margin-top: 16px;
  font-size: 1em;
  font-style: italic;
  font-weight: bold;
}

.markdown-body dl dd {
  padding: 0 16px;
  margin-bottom: 16px;
}

.markdown-body blockquote {
  padding: 0 15px;
  color: #777;
  border-left: 4px solid #ddd;
}

.markdown-body blockquote>:first-child {
  margin-top: 0;
}

.markdown-body blockquote>:last-child {
  margin-bottom: 0;
}

.markdown-body table {
  display: block;
  width: 100%;
  overflow: auto;
  word-break: normal;
  word-break: keep-all;
}

.markdown-body table th {
  font-weight: bold;
}

.markdown-body table th,
.markdown-body table td {
  padding: 6px 13px;
  border: 1px solid #ddd;
}

.markdown-body table tr {
  background-color: #fff;
  border-top: 1px solid #ccc;
}

.markdown-body table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

.markdown-body img {
  max-width: 100%;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.markdown-body code,
.markdown-body samp {
  padding: 0;
  padding-top: 0.2em;
  padding-bottom: 0.2em;
  margin: 0;
  font-size: 85%;
  background-color: rgba(0,0,0,0.04);
  border-radius: 3px;
}

.markdown-body code:before,
.markdown-body code:after {
  letter-spacing: -0.2em;
  content: "\00a0";
}

.markdown-body pre>code {
  padding: 0;
  margin: 0;
  font-size: 100%;
  word-break: normal;
  white-space: pre;
  background: transparent;
  border: 0;
}

.markdown-body .codehilite,
.markdown-body .highlight {
  margin-bottom: 16px;
}

.markdown-body .codehilite pre,
.markdown-body .highlight pre,
.markdown-body pre {
  padding: 16px;
  overflow: auto;
  font-size: 85%;
  line-height: 1.45;
  background-color: #f7f7f7;
  border-radius: 3px;
}

.markdown-body .codehilite pre,
.markdown-body .highlight pre {
  margin-bottom: 0;
  word-break: normal;
}

.markdown-body pre {
  word-wrap: normal;
}

.markdown-body pre code {
  display: inline;
  max-width: initial;
  padding: 0;
  margin: 0;
  overflow: initial;
  line-height: inherit;
  word-wrap: normal;
  background-color: transparent;
  border: 0;
}

.markdown-body pre code:before,
.markdown-body pre code:after {
  content: normal;
}

/* Admonition */
.markdown-body .admonition {
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  position: relative;
  border-radius: 3px;
  border: 1px solid #e0e0e0;
  border-left: 6px solid #333;
  padding: 10px 10px 10px 30px;
}

.markdown-body .admonition table {
  color: #333;
}

.markdown-body .admonition p {
  padding: 0;
}

.markdown-body .admonition-title {
  font-weight: bold;
  margin: 0;
}

.markdown-body .admonition>.admonition-title {
  color: #333;
}

.markdown-body .attention>.admonition-title {
  color: #a6d796;
}

.markdown-body .caution>.admonition-title {
  color: #d7a796;
}

.markdown-body .hint>.admonition-title {
  color: #96c6d7;
}

.markdown-body .danger>.admonition-title {
  color: #c25f77;
}

.markdown-body .question>.admonition-title {
  color: #96a6d7;
}

.markdown-body .note>.admonition-title {
  color: #d7c896;
}

.markdown-body .admonition:before,
.markdown-body .attention:before,
.markdown-body .caution:before,
.markdown-body .hint:before,
.markdown-body .danger:before,
.markdown-body .question:before,
.markdown-body .note:before {
  font: normal normal 16px fontawesome-mini;
  -moz-osx-font-smoothing: grayscale;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  line-height: 1.5;
  color: #333;
  position: absolute;
  left: 0;
  top: 0;
  padding-top: 10px;
  padding-left: 10px;
}

.markdown-body .admonition:before {
  content: "\f056\00a0";
  color: 333;
}

.markdown-body .attention:before {
  content: "\f058\00a0";
  color: #a6d796;
}

.markdown-body .caution:before {
  content: "\f06a\00a0";
  color: #d7a796;
}

.markdown-body .hint:before {
  content: "\f05a\00a0";
  color: #96c6d7;
}

.markdown-body .danger:before {
  content: "\f057\00a0";
  color: #c25f77;
}

.markdown-body .question:before {
  content: "\f059\00a0";
  color: #96a6d7;
}

.markdown-body .note:before {
  content: "\f040\00a0";
  color: #d7c896;
}

.markdown-body .admonition::after {
  content: normal;
}

.markdown-body .attention {
  border-left: 6px solid #a6d796;
}

.markdown-body .caution {
  border-left: 6px solid #d7a796;
}

.markdown-body .hint {
  border-left: 6px solid #96c6d7;
}

.markdown-body .danger {
  border-left: 6px solid #c25f77;
}

.markdown-body .question {
  border-left: 6px solid #96a6d7;
}

.markdown-body .note {
  border-left: 6px solid #d7c896;
}

.markdown-body .admonition>*:first-child {
  margin-top: 0 !important;
}

.markdown-body .admonition>*:last-child {
  margin-bottom: 0 !important;
}

/* progress bar*/
.markdown-body .progress {
  display: block;
  width: 300px;
  margin: 10px 0;
  height: 24px;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
  background-color: #ededed;
  position: relative;
  box-shadow: inset -1px 1px 3px rgba(0, 0, 0, .1);
}

.markdown-body .progress-label {
  position: absolute;
  text-align: center;
  font-weight: bold;
  width: 100%; margin: 0;
  line-height: 24px;
  color: #333;
  text-shadow: 1px 1px 0 #fefefe, -1px -1px 0 #fefefe, -1px 1px 0 #fefefe, 1px -1px 0 #fefefe, 0 1px 0 #fefefe, 0 -1px 0 #fefefe, 1px 0 0 #fefefe, -1px 0 0 #fefefe, 1px 1px 2px #000;
  -webkit-font-smoothing: antialiased !important;
  white-space: nowrap;
  overflow: hidden;
}

.markdown-body .progress-bar {
  height: 24px;
  float: left;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
  background-color: #96c6d7;
  box-shadow: inset 0 1px 0 rgba(255, 255, 255, .5), inset 0 -1px 0 rgba(0, 0, 0, .1);
  background-size: 30px 30px;
  background-image: -webkit-linear-gradient(
    135deg, rgba(255, 255, 255, .4) 27%,
    transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%,
    transparent 77%, transparent
  );
  background-image: -moz-linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
  background-image: -ms-linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
  background-image: -o-linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
  background-image: linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
}

.markdown-body .progress-100plus .progress-bar {
  background-color: #a6d796;
}

.markdown-body .progress-80plus .progress-bar {
  background-color: #c6d796;
}

.markdown-body .progress-60plus .progress-bar {
  background-color: #d7c896;
}

.markdown-body .progress-40plus .progress-bar {
  background-color: #d7a796;
}

.markdown-body .progress-20plus .progress-bar {
  background-color: #d796a6;
}

.markdown-body .progress-0plus .progress-bar {
  background-color: #c25f77;
}

.markdown-body .candystripe-animate .progress-bar{
  -webkit-animation: animate-stripes 3s linear infinite;
  -moz-animation: animate-stripes 3s linear infinite;
  animation: animate-stripes 3s linear infinite;
}

@-webkit-keyframes animate-stripes {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 60px 0;
  }
}

@-moz-keyframes animate-stripes {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 60px 0;
  }
}

@keyframes animate-stripes {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 60px 0;
  }
}

.markdown-body .gloss .progress-bar {
  box-shadow:
    inset 0 4px 12px rgba(255, 255, 255, .7),
    inset 0 -12px 0 rgba(0, 0, 0, .05);
}

/* MultiMarkdown Critic Blocks */
.markdown-body .critic_mark {
  background: #ff0;
}

.markdown-body .critic_delete {
  color: #c82829;
  text-decoration: line-through;
}

.markdown-body .critic_insert {
  color: #718c00 ;
  text-decoration: underline;
}

.markdown-body .critic_comment {
  color: #8e908c;
  font-style: italic;
}

.markdown-body .headeranchor {
  font: normal normal 16px fontawesome-mini;
  line-height: 1;
  display: inline-block;
  text-decoration: none;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.headeranchor:before {
  content: '\e157';
}

.markdown-body .task-list-item {
  list-style-type: none;
}

.markdown-body .task-list-item+.task-list-item {
  margin-top: 3px;
}

.markdown-body .task-list-item input {
  margin: 0 4px 0.25em -20px;
  vertical-align: middle;
}

/* Media */
@media only screen and (min-width: 480px) {
  .markdown-body {
    font-size:14px;
  }
}

@media only screen and (min-width: 768px) {
  .markdown-body {
    font-size:16px;
  }
}

@media print {
  .markdown-body * {
    background: transparent !important;
    color: black !important;
    filter:none !important;
    -ms-filter: none !important;
  }

  .markdown-body {
    font-size:12pt;
    max-width:100%;
    outline:none;
    border: 0;
  }

  .markdown-body a,
  .markdown-body a:visited {
    text-decoration: underline;
  }

  .markdown-body .headeranchor-link {
    display: none;
  }

  .markdown-body a[href]:after {
    content: " (" attr(href) ")";
  }

  .markdown-body abbr[title]:after {
    content: " (" attr(title) ")";
  }

  .markdown-body .ir a:after,
  .markdown-body a[href^="javascript:"]:after,
  .markdown-body a[href^="#"]:after {
    content: "";
  }

  .markdown-body pre {
    white-space: pre;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .markdown-body pre,
  .markdown-body blockquote {
    border: 1px solid #999;
    padding-right: 1em;
    page-break-inside: avoid;
  }

  .markdown-body .progress,
  .markdown-body .progress-bar {
    -moz-box-shadow: none;
    -webkit-box-shadow: none;
    box-shadow: none;
  }

  .markdown-body .progress {
    border: 1px solid #ddd;
  }

  .markdown-body .progress-bar {
    height: 22px;
    border-right: 1px solid #ddd;
  }

  .markdown-body tr,
  .markdown-body img {
    page-break-inside: avoid;
  }

  .markdown-body img {
    max-width: 100% !important;
  }

  .markdown-body p,
  .markdown-body h2,
  .markdown-body h3 {
    orphans: 3;
    widows: 3;
  }

  .markdown-body h2,
  .markdown-body h3 {
    page-break-after: avoid;
  }
}
</style><style>/*GitHub*/
.codehilite {background-color:#fff;color:#333333;}
.codehilite .hll {background-color:#ffffcc;}
.codehilite .c{color:#999988;font-style:italic}
.codehilite .err{color:#a61717;background-color:#e3d2d2}
.codehilite .k{font-weight:bold}
.codehilite .o{font-weight:bold}
.codehilite .cm{color:#999988;font-style:italic}
.codehilite .cp{color:#999999;font-weight:bold}
.codehilite .c1{color:#999988;font-style:italic}
.codehilite .cs{color:#999999;font-weight:bold;font-style:italic}
.codehilite .gd{color:#000000;background-color:#ffdddd}
.codehilite .ge{font-style:italic}
.codehilite .gr{color:#aa0000}
.codehilite .gh{color:#999999}
.codehilite .gi{color:#000000;background-color:#ddffdd}
.codehilite .go{color:#888888}
.codehilite .gp{color:#555555}
.codehilite .gs{font-weight:bold}
.codehilite .gu{color:#800080;font-weight:bold}
.codehilite .gt{color:#aa0000}
.codehilite .kc{font-weight:bold}
.codehilite .kd{font-weight:bold}
.codehilite .kn{font-weight:bold}
.codehilite .kp{font-weight:bold}
.codehilite .kr{font-weight:bold}
.codehilite .kt{color:#445588;font-weight:bold}
.codehilite .m{color:#009999}
.codehilite .s{color:#dd1144}
.codehilite .n{color:#333333}
.codehilite .na{color:teal}
.codehilite .nb{color:#0086b3}
.codehilite .nc{color:#445588;font-weight:bold}
.codehilite .no{color:teal}
.codehilite .ni{color:purple}
.codehilite .ne{color:#990000;font-weight:bold}
.codehilite .nf{color:#990000;font-weight:bold}
.codehilite .nn{color:#555555}
.codehilite .nt{color:navy}
.codehilite .nv{color:teal}
.codehilite .ow{font-weight:bold}
.codehilite .w{color:#bbbbbb}
.codehilite .mf{color:#009999}
.codehilite .mh{color:#009999}
.codehilite .mi{color:#009999}
.codehilite .mo{color:#009999}
.codehilite .sb{color:#dd1144}
.codehilite .sc{color:#dd1144}
.codehilite .sd{color:#dd1144}
.codehilite .s2{color:#dd1144}
.codehilite .se{color:#dd1144}
.codehilite .sh{color:#dd1144}
.codehilite .si{color:#dd1144}
.codehilite .sx{color:#dd1144}
.codehilite .sr{color:#009926}
.codehilite .s1{color:#dd1144}
.codehilite .ss{color:#990073}
.codehilite .bp{color:#999999}
.codehilite .vc{color:teal}
.codehilite .vg{color:teal}
.codehilite .vi{color:teal}
.codehilite .il{color:#009999}
.codehilite .gc{color:#999;background-color:#EAF2F5}
</style><title>kubemark</title></head><body><article class="markdown-body"><p>了解如何使用kubemark对k8s组件进行性能测试</p>
<h2>1 背景</h2>
<p>项目想对k8s组件进行集群性能测试。原有组件如调度器，已有的测试工具多是单元测试。需要寻找一种可以对k8s集群进行性能测试。比如多多节点大集群规模下的调度器性能指标如何？</p>
<p>考虑使用k8s项目自带的性能测试组件kubemark。</p>
<h2>2 kubemark</h2>
<h3>介绍</h3>
<p>kubemark 是 K8s 官方给出的性能测试工具，能够不受任何资源限制，模拟出一个大规模 K8s 集群。其主要架构如图所示:需要一个外部 K8s 集群（external cluster） 以及一个机器节点运行 kubemark master，即另外一个 K8s 集群，但是只有一个 master 节点。我们需要在 external cluster 中部署运行 hollow pod，这些 pod 会主动向 kubemark 集群注册，并成为 kubemark 集群中的 hollow node(虚拟节点)。然后我们就可以在 kubemark 集群中进行 e2e 测试。虽然与真实集群的稍微有点误差，不过可以代表真实集群的数据。</p>
<p>{{&lt; figure src ="/images/2020-12-08/kubemark.png"&gt;}}</p>
<p><br></p>
<p><strong>本文则只构造了kubemark组件，且只使用了测试集群，即外部 K8s 集群（external cluster），未使用第2个kubemark集群。目的为测试集群中的master组件，如调度器和控制器等。另外，此方式还可以自己使用第三方测试工具和框架</strong></p>
<p><br></p>
<p>{{&lt; figure src ="/images/2020-12-08/k8s-perf.png"&gt;}}</p>
<h3>kubemark构造</h3>
<h4>1. 编译kubemark</h4>
<p>在 K8s 源码路径下构建 kubemark，生成的二进制文件在 _output/bin 目录下。
```shell</p>
<h1>KUBE_BUILD_PLATFORMS=linux/amd64 make kubemark GOFLAGS=-v GOGCFLAGS="-N -l"</h1>
<p>make kubemark GOGCFLAGS="-N -l"
```</p>
<h4>2. 构建kubemark镜像</h4>
<p>将生成的 kubemark 二进制文件从 _output/bin 复制到 cluster/images/kubemark 目录下。 
<code>shell
cp _output/bin/kubemark cluster/images/kubemark/</code></p>
<p>并在该目录下执行构建镜像命令，生成镜像：staging-registry.cn-hangzhou.aliyuncs.com/google_containers/kubemark:v1.14.8。</p>
<p>```shell</p>
<h1>IMAGE_TAG=v1.14.3 make build</h1>
<p>cd cluster/images/kubemark/
IMAGE_TAG=v1.14.8 make build</p>
<p>```</p>
<h4>3. 保存镜像至kubemark.tar</h4>
<h4>4. kubemark部署到测试集群</h4>
<p>在测试集群中的所有node节点中，导入该kubemark镜像。用于启动桩节点。
接下来进行桩节点hollow-node启动配置操作</p>
<p>``` shell</p>
<h1>以下命令在测试集群的master节点上执行</h1>
<h1>从kubemark-master节点（191节点）拷贝过来kubeconfig文件，到测试集群的master节点中</h1>
<h1>scp -r 192.168.182.191:/root/.kube/config /home/wangb/</h1>
<h1>在测试集群master节点上执行</h1>
<p>kubectl create ns kubemark</p>
<p>kubectl create configmap node-configmap -n kubemark --from-literal=content.type="test-cluster"</p>
<h1>kubectl create secret generic kubeconfig --type=Opaque --namespace=kubemark --from-file=kubelet.kubeconfig=config --from-file=kubeproxy.kubeconfig=config</h1>
<p>kubectl create secret generic kubeconfig --type=Opaque --namespace=kubemark --from-file=kubelet.kubeconfig=/root/.kube/config --from-file=kubeproxy.kubeconfig=/root/.kube/config</p>
<p>```</p>
<h4>5. 在测试集群中启动hollow nodes</h4>
<p><code>shell
kubectl create -f hollow-node-sts.yaml -n kubemark</code></p>
<h3>清理kubemark 资源</h3>
<p>```shell</p>
<h1>delete hollow-node-sts</h1>
<p>kubectl delete -f hollow-node-sts.yaml</p>
<p>NAMESPACE=kubemark
kubectl get po -n $NAMESPACE |grep -E "Terminating|CrashLoopBackOff|Error" |awk '{print $1}' |xargs kubectl delete pod  -n $NAMESPACE --force --grace-period=0</p>
<p>NAMESPACE=kube-system
kubectl get po -n $NAMESPACE |grep -E "ContainerCreating|Init:0/1|Pending" |grep -v "metrics-server"|awk '{print $1}' |xargs kubectl delete pod  -n $NAMESPACE --force --grace-period=0</p>
<p>NAMESPACE=aistation
kubectl get po -n $NAMESPACE |grep -E "ContainerCreating|Init:0/1|Pending" |awk '{print $1}' |xargs kubectl delete pod  -n $NAMESPACE --force --grace-period=0</p>
<h1>NAMESPACE=kubemark</h1>
<h1>kubectl delete ns $NAMESPACE --force --grace-period=0</h1>
<h1>clear nodes</h1>
<p>kubectl get no |grep "hollow-node" |awk '{print $1}' |xargs kubectl delete no --force --grace-period=0</p>
<p>```</p>
<h3>测试pod</h3>
<p>启动桩节点，hollow-node-sts.yaml的默认配置如下：
```yaml
apiVersion: v1
kind: Service
metadata:
  name: hollow-node
  namespace: kubemark
spec:
  clusterIP: None
  ports:
  - port: 80
    protocol: TCP
    targetPort: 80
  selector:
    name: hollow-node</p>
<hr />
<p>apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: hollow-node
  namespace: kubemark
spec:
  podManagementPolicy: Parallel
  replicas: 6
  selector:
    matchLabels:
      name: hollow-node
  serviceName: hollow-node
  template:
    metadata:
      labels:
        name: hollow-node
    spec:
      initContainers:
      - name: init-inotify-limit
        image: docker.io/busybox:latest
        imagePullPolicy: IfNotPresent
        command: ['sysctl', '-w', 'fs.inotify.max_user_instances=200']
        securityContext:
          privileged: true
      volumes:
      - name: kubeconfig-volume
        secret:
          secretName: kubeconfig
      - name: logs-volume
        hostPath:
          path: /var/log
      containers:
      - name: hollow-kubelet
        image: staging-registry.cn-hangzhou.aliyuncs.com/google_containers/kubemark:v1.14.8
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 4194
        - containerPort: 10250
        - containerPort: 10255
        env:
        - name: CONTENT_TYPE
          valueFrom:
            configMapKeyRef:
              name: node-configmap
              key: content.type
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        command:
        - /bin/sh
        - -c
        - /kubemark --morph=kubelet --name=$(NODE_NAME) --kubeconfig=/kubeconfig/kubelet.kubeconfig $(CONTENT_TYPE) --alsologtostderr --v=2
        volumeMounts:
        - name: kubeconfig-volume
          mountPath: /kubeconfig
          readOnly: true
        - name: logs-volume
          mountPath: /var/log
        resources:
          requests:
            cpu: 20m
            memory: 50M
        securityContext:
          privileged: true
      - name: hollow-proxy
        image: staging-registry.cn-hangzhou.aliyuncs.com/google_containers/kubemark:v1.14.8
        imagePullPolicy: IfNotPresent
        env:
        - name: CONTENT_TYPE
          valueFrom:
            configMapKeyRef:
              name: node-configmap
              key: content.type
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        command:
        - /bin/sh
        - -c
        - /kubemark --morph=proxy --name=$(NODE_NAME) --use-real-proxier=false --kubeconfig=/kubeconfig/kubeproxy.kubeconfig $(CONTENT_TYPE) --alsologtostderr --v=2
        volumeMounts:
        - name: kubeconfig-volume
          mountPath: /kubeconfig
          readOnly: true
        - name: logs-volume
          mountPath: /var/log
        resources:
          requests:
            cpu: 20m
            memory: 50M
      tolerations:
      - effect: NoExecute
        key: node.kubernetes.io/unreachable
        operator: Exists
      - effect: NoExecute
        key: node.kubernetes.io/not-ready
        operator: Exists
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:  # 硬策略
            nodeSelectorTerms:
            - matchExpressions:
              - key: name
                operator: NotIn
                values:
                - hollow-node
              - key: node-role.kubernetes.io/master
                operator: NotIn
                values:
                - "true"</p>
<p>```
由上可知，hollow-node实际上是启动过了kubelet和proxy的2个进程，后来分析源码确实如此。</p>
<p>写个测试pod，验证桩node是否可用，test-pod.yaml如下
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: myapp-pod
  labels:
    app: myapp
    version: v1
spec:
  containers:
  - name: app
    image: docker.io/busybox:latest
    imagePullPolicy: IfNotPresent
    command: ['sleep', '3600']
    securityContext:
      privileged: true</p>
<p>affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:  # 硬策略
            nodeSelectorTerms:
            - matchExpressions:
              - key: node-role.kubernetes.io/node
                operator: NotIn
                values:
                - "true"
```</p>
<p>节点信息 hollow-node-0, 此信息为默认信息
```shell
Name:               hollow-node-0
Roles:              <none>
Labels:             beta.kubernetes.io/arch=amd64
                    beta.kubernetes.io/os=linux
                    kubernetes.io/arch=amd64
                    kubernetes.io/hostname=hollow-node-0
                    kubernetes.io/os=linux
Annotations:        node.alpha.kubernetes.io/ttl: 0
CreationTimestamp:  Mon, 07 Dec 2020 17:25:15 +0800
Taints:             <none>
Unschedulable:      false
Conditions:
  Type             Status  LastHeartbeatTime                 LastTransitionTime                Reason                       Message
  ----             ------  -----------------                 ------------------                ------                       -------
  MemoryPressure   False   Tue, 08 Dec 2020 09:37:21 +0800   Mon, 07 Dec 2020 17:25:15 +0800   KubeletHasSufficientMemory   kubelet has sufficient memory available
  DiskPressure     False   Tue, 08 Dec 2020 09:37:21 +0800   Mon, 07 Dec 2020 17:25:15 +0800   KubeletHasNoDiskPressure     kubelet has no disk pressure
  PIDPressure      False   Tue, 08 Dec 2020 09:37:21 +0800   Mon, 07 Dec 2020 17:25:15 +0800   KubeletHasSufficientPID      kubelet has sufficient PID available
  Ready            True    Tue, 08 Dec 2020 09:37:21 +0800   Mon, 07 Dec 2020 17:25:15 +0800   KubeletReady                 kubelet is posting ready status
Addresses:
  InternalIP:  10.233.96.39
  Hostname:    hollow-node-0
Capacity:
 cpu:                1
 ephemeral-storage:  0
 memory:             3840Mi
 pods:               110
Allocatable:
 cpu:                1
 ephemeral-storage:  0
 memory:             3840Mi
 pods:               110
System Info:
 Machine ID:
 System UUID:
 Boot ID:
 Kernel Version:             3.16.0-0.bpo.4-amd64
 OS Image:                   Debian GNU/Linux 7 (wheezy)
 Operating System:           linux
 Architecture:               amd64
 Container Runtime Version:  docker://1.13.1
 Kubelet Version:            v0.0.0-master+4d3c9e0c
 Kube-Proxy Version:         v0.0.0-master+4d3c9e0c
PodCIDR:                     10.233.98.0/24
Non-terminated Pods:         (3 in total)
  Namespace                  Name                               CPU Requests  CPU Limits  Memory Requests  Memory Limits  AGE
  ---------                  ----                               ------------  ----------  ---------------  -------------  ---
  kube-system                calico-node-29z7g                  150m (15%)    300m (30%)  64M (1%)         500M (12%)     16h
  kube-system                kube-proxy-8wcss                   0 (0%)        0 (0%)      0 (0%)           0 (0%)         16h
  kube-system                metrics-server-84d6dbd58b-6vqmf    50m (5%)      145m (14%)  125Mi (3%)       375Mi (9%)     16h</p>
<p>```</p>
<p>作业运行到hollow node 
```shell
[root@node1 .kube]# kubectl get po -A -owide
NAMESPACE     NAME                              READY   STATUS              RESTARTS   AGE    IP                NODE            NOMINATED NODE   READINESS GATES
default       myapp-pod                         1/1     Running             0          6s     10.94.251.209     hollow-node-1   <none>           <none>
kube-system   calico-node-77l7w                 0/1     Init:0/1            0          20m    10.233.96.20      hollow-node-3   <none>           <none>
kube-system   calico-node-fhlsn                 0/1     Init:0/1            0          20m    10.233.96.21      hollow-node-0   <none>           <none>
kube-system   calico-node-g9fx8                 0/1     Init:0/1            0          20m    10.233.96.19      hollow-node-5   <none>           <none>
kube-system   calico-node-gdrlk                 0/1     Init:0/1            0          20m    10.233.96.17      hollow-node-1   <none>           <none>
kube-system   calico-node-lnzc7                 0/1     Init:0/1            0          20m    10.233.96.22      hollow-node-4   <none>           <none>
kube-system   calico-node-lt9jh                 0/1     Init:0/1            0          20m    10.233.96.18      hollow-node-2   <none>           <none>
kube-system   calico-node-ms5t6                 1/1     Running             0          51m    192.168.182.102   node2           <none>           <none>
kube-system   calico-node-vxcb7                 1/1     Running             0          51m    192.168.182.101   node1           <none>           <none>
kube-system   coredns-654c8ccdc8-575qx          1/1     Running             0          53m    10.233.90.74      node1           <none>           <none>
kube-system   coredns-654c8ccdc8-m8ntn          0/1     Pending             0          174d   <none>            <none>          <none>           <none>
kube-system   dns-autoscaler-77445c9c8b-b565h   1/1     Running             0          53m    10.233.90.65      node1           <none>           <none>
kube-system   kube-apiserver-node1              1/1     Running             11         51m    192.168.182.101   node1           <none>           <none>
kube-system   kube-controller-manager-node1     1/1     Running             11         51m    192.168.182.101   node1           <none>           <none>
kube-system   kube-proxy-72xn7                  0/1     ContainerCreating   0          20m    10.233.96.21      hollow-node-0   <none>           <none>
kube-system   kube-proxy-8jw9r                  0/1     ContainerCreating   0          20m    10.233.96.19      hollow-node-5   <none>           <none>
kube-system   kube-proxy-92jzz                  0/1     ContainerCreating   0          20m    10.233.96.20      hollow-node-3   <none>           <none>
kube-system   kube-proxy-djxjg                  0/1     ContainerCreating   0          20m    10.233.96.18      hollow-node-2   <none>           <none>
kube-system   kube-proxy-dsghn                  1/1     Running             0          51m    192.168.182.101   node1           <none>           <none>
kube-system   kube-proxy-gjzq8                  1/1     Running             0          51m    192.168.182.102   node2           <none>           <none>
kube-system   kube-proxy-lpb8m                  0/1     ContainerCreating   0          20m    10.233.96.17      hollow-node-1   <none>           <none>
kube-system   kube-proxy-sfjlq                  0/1     ContainerCreating   0          20m    10.233.96.22      hollow-node-4   <none>           <none>
kube-system   kube-scheduler-node1              1/1     Running             11         51m    192.168.182.101   node1           <none>           <none>
kube-system   metrics-server-84d6dbd58b-rbrjd   0/2     ContainerCreating   0          20m    <none>            hollow-node-3   <none>           <none>
kubemark      hollow-node-0                     2/2     Running             0          20m    10.233.96.21      node2           <none>           <none>
kubemark      hollow-node-1                     2/2     Running             0          20m    10.233.96.17      node2           <none>           <none>
kubemark      hollow-node-2                     2/2     Running             0          20m    10.233.96.18      node2           <none>           <none>
kubemark      hollow-node-3                     2/2     Running             0          20m    10.233.96.20      node2           <none>           <none>
kubemark      hollow-node-4                     2/2     Running             0          20m    10.233.96.22      node2           <none>           <none>
kubemark      hollow-node-5                     2/2     Running             0          20m    10.233.96.19      node2           <none>           <none>
[root@node1 .kube]# kubectl describe po -ndefault       myapp-pod
Name:               myapp-pod
Namespace:          default
Priority:           0
PriorityClassName:  <none>
Node:               hollow-node-1/10.233.96.17
Start Time:         Mon, 07 Dec 2020 16:33:50 +0800
Labels:             app=myapp
                    version=v1
Annotations:        <none>
Status:             Running
IP:                 10.94.251.209
Containers:
  app:
    Container ID:  docker://3033a0ef90209b22
    Image:         docker.io/busybox:latest
    Image ID:      docker://docker.io/busybox:latest
    Port:          <none>
    Host Port:     <none>
    Command:
      sleep
      3600
    State:          Running
      Started:      Mon, 07 Dec 2020 16:33:54 +0800
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-fm7gj (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  default-token-fm7gj:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-fm7gj
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  <none>
Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s
                 node.kubernetes.io/unreachable:NoExecute for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  17s   default-scheduler  Successfully assigned default/myapp-pod to hollow-node-1</p>
<p>```</p>
<p>上面的kubemark和测试hollow-node是缺省默认配置，无法满足项目的k8s测试需要，比如node的自定义资源描述等，所以还需对kubemark和测试hollow-node进行改造。</p>
<p>修改kubemark（kubelet），重新编译kubemark，重新部署kubemark，查看桩节点信息（<em>资源信息</em>）如下：</p>
<p>```shell
Name:               hollow-node-0
Roles:              <none>
Labels:             beta.kubernetes.io/arch=amd64
                    beta.kubernetes.io/os=linux
                    kubernetes.io/arch=amd64
                    kubernetes.io/hostname=hollow-node-0
                    kubernetes.io/os=linux
Annotations:        node.alpha.kubernetes.io/ttl: 0
CreationTimestamp:  Tue, 08 Dec 2020 13:34:35 +0800
Taints:             <none>
Unschedulable:      false
Conditions:
  Type             Status  LastHeartbeatTime                 LastTransitionTime                Reason                       Message
  ----             ------  -----------------                 ------------------                ------                       -------
  MemoryPressure   False   Tue, 08 Dec 2020 13:34:35 +0800   Tue, 08 Dec 2020 13:34:35 +0800   KubeletHasSufficientMemory   kubelet has sufficient memory available
  DiskPressure     False   Tue, 08 Dec 2020 13:34:35 +0800   Tue, 08 Dec 2020 13:34:35 +0800   KubeletHasNoDiskPressure     kubelet has no disk pressure
  PIDPressure      False   Tue, 08 Dec 2020 13:34:35 +0800   Tue, 08 Dec 2020 13:34:35 +0800   KubeletHasSufficientPID      kubelet has sufficient PID available
  Ready            True    Tue, 08 Dec 2020 13:34:35 +0800   Tue, 08 Dec 2020 13:34:35 +0800   KubeletReady                 kubelet is posting ready status
Addresses:
  InternalIP:  10.233.96.50
  Hostname:    hollow-node-0
Capacity:
 cpu:                  72
 ephemeral-storage:    15726578Mi
 inspur.com/gpu:       99999
 inspur.com/rdma-hca:  99999
 memory:               256Gi
 nvidia.com/gpu:       8
 pods:                 110
Allocatable:
 cpu:                  72
 ephemeral-storage:    15726578Mi
 inspur.com/gpu:       99999
 inspur.com/rdma-hca:  99999
 memory:               256Gi
 nvidia.com/gpu:       8
 pods:                 110
System Info:
 Machine ID:
 System UUID:
 Boot ID:
 Kernel Version:             3.16.0-0.bpo.4-amd64
 OS Image:                   Debian GNU/Linux 7 (wheezy)
 Operating System:           linux
 Architecture:               amd64
 Container Runtime Version:  docker://1.13.1
 Kubelet Version:            v0.0.0-master+4d3c9e0c
 Kube-Proxy Version:         v0.0.0-master+4d3c9e0c
PodCIDR:                     10.233.67.0/24
Non-terminated Pods:         (3 in total)
  Namespace                  Name                               CPU Requests  CPU Limits  Memory Requests  Memory Limits  AGE
  ---------                  ----                               ------------  ----------  ---------------  -------------  ---
  kube-system                calico-node-n5528                  150m (0%)     300m (0%)   64M (0%)         500M (0%)      14s
  kube-system                kube-proxy-fxcs4                   0 (0%)        0 (0%)      0 (0%)           0 (0%)         14s
  kube-system                metrics-server-84d6dbd58b-sx7sl    50m (0%)      145m (0%)   125Mi (0%)       375Mi (0%)     8s
Allocated resources:
  (Total limits may be over 100 percent, i.e., overcommitted.)
  Resource             Requests      Limits
  --------             --------      ------
  cpu                  200m (0%)     445m (0%)
  memory               195072k (0%)  893216k (0%)
  ephemeral-storage    0 (0%)        0 (0%)
  inspur.com/gpu       0             0
  inspur.com/rdma-hca  0             0
  nvidia.com/gpu       0             0
Events:
  Type    Reason    Age   From                       Message
  ----    ------    ----  ----                       -------
  Normal  Starting  16s   kube-proxy, hollow-node-0  Starting kube-proxy.</p>
<p>```</p>
<p>然后再运行测试pod，pod定义如下</p>
<p><code>yaml
apiVersion: v1
kind: Pod
metadata:
  name: myapp-pod
  labels:
    app: myapp
    version: v1
spec:
  containers:
  - name: app
    image: docker.io/busybox:latest
    imagePullPolicy: IfNotPresent
    command: ['sleep', '3600']
    securityContext:
      privileged: true
    resources:
      limits:
        cpu: "1"
        memory: "2Mi"
        nvidia.com/gpu: "1"
      requests:
        cpu: "1"
        memory: "2Mi"
        nvidia.com/gpu: "1"        
  affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:  # 硬策略
            nodeSelectorTerms:
            - matchExpressions:
              - key: node-role.kubernetes.io/node
                operator: NotIn
                values:
                - "true"</code></p>
<p>运行测试pod后的集群信息如下：</p>
<p>```shell
NAMESPACE     NAME                              READY   STATUS              RESTARTS   AGE    IP                NODE            NOMINATED NODE   READINESS GATES
default       myapp-pod                         1/1     Running             0          15s    10.142.241.4      hollow-node-3   <none>           <none>
kube-system   calico-node-6n95j                 0/1     Init:0/1            0          14m    10.233.96.49      hollow-node-5   <none>           <none>
kube-system   calico-node-g5qlq                 0/1     Init:0/1            0          14m    10.233.96.51      hollow-node-1   <none>           <none>
kube-system   calico-node-g6rqs                 0/1     Init:0/1            0          14m    10.233.96.46      hollow-node-3   <none>           <none>
kube-system   calico-node-m55zq                 0/1     Init:0/1            0          14m    10.233.96.47      hollow-node-2   <none>           <none>
kube-system   calico-node-ms5t6                 1/1     Running             1          22h    192.168.182.102   node2           <none>           <none>
kube-system   calico-node-n5528                 0/1     Init:0/1            0          14m    10.233.96.50      hollow-node-0   <none>           <none>
kube-system   calico-node-njrr9                 0/1     Init:0/1            0          14m    10.233.96.48      hollow-node-4   <none>           <none>
kube-system   calico-node-vxcb7                 1/1     Running             1          22h    192.168.182.101   node1           <none>           <none>
kube-system   coredns-654c8ccdc8-575qx          1/1     Running             1          22h    10.233.90.76      node1           <none>           <none>
kube-system   coredns-654c8ccdc8-m8ntn          0/1     Pending             0          175d   <none>            <none>          <none>           <none>
kube-system   dns-autoscaler-77445c9c8b-b565h   1/1     Running             1          22h    10.233.90.77      node1           <none>           <none>
kube-system   kube-apiserver-node1              1/1     Running             12         22h    192.168.182.101   node1           <none>           <none>
kube-system   kube-controller-manager-node1     1/1     Running             12         22h    192.168.182.101   node1           <none>           <none>
kube-system   kube-proxy-dsghn                  1/1     Running             1          22h    192.168.182.101   node1           <none>           <none>
kube-system   kube-proxy-dzll2                  0/1     ContainerCreating   0          14m    10.233.96.46      hollow-node-3   <none>           <none>
kube-system   kube-proxy-fqfqx                  0/1     ContainerCreating   0          14m    10.233.96.51      hollow-node-1   <none>           <none>
kube-system   kube-proxy-fxcs4                  0/1     ContainerCreating   0          14m    10.233.96.50      hollow-node-0   <none>           <none>
kube-system   kube-proxy-gjzq8                  1/1     Running             1          22h    192.168.182.102   node2           <none>           <none>
kube-system   kube-proxy-khv5c                  0/1     ContainerCreating   0          14m    10.233.96.48      hollow-node-4   <none>           <none>
kube-system   kube-proxy-l7hzh                  0/1     ContainerCreating   0          14m    10.233.96.49      hollow-node-5   <none>           <none>
kube-system   kube-proxy-r5lfv                  0/1     ContainerCreating   0          14m    10.233.96.47      hollow-node-2   <none>           <none>
kube-system   kube-scheduler-node1              1/1     Running             12         22h    192.168.182.101   node1           <none>           <none>
kube-system   metrics-server-84d6dbd58b-sx7sl   0/2     ContainerCreating   0          14m    <none>            hollow-node-0   <none>           <none>
kubemark      hollow-node-0                     2/2     Running             0          14m    10.233.96.50      node2           <none>           <none>
kubemark      hollow-node-1                     2/2     Running             0          14m    10.233.96.51      node2           <none>           <none>
kubemark      hollow-node-2                     2/2     Running             0          14m    10.233.96.47      node2           <none>           <none>
kubemark      hollow-node-3                     2/2     Running             0          14m    10.233.96.46      node2           <none>           <none>
kubemark      hollow-node-4                     2/2     Running             0          14m    10.233.96.48      node2           <none>           <none>
kubemark      hollow-node-5                     2/2     Running             0          14m    10.233.96.49      node2           <none>           <none></p>
<p>```
<em>说明： 网络插件和proxy组件的非running态，并不影响集群测试使用，比如proxy使用了--use-real-proxier=false，并未使用真正的iptables</em></p>
<p>测试pod调度到了hollow-node-3上，hollow-node-3节点信息如下
<code>shell
Name:               hollow-node-3
Roles:              &lt;none&gt;
Labels:             beta.kubernetes.io/arch=amd64
                    beta.kubernetes.io/os=linux
                    kubernetes.io/arch=amd64
                    kubernetes.io/hostname=hollow-node-3
                    kubernetes.io/os=linux
Annotations:        node.alpha.kubernetes.io/ttl: 0
CreationTimestamp:  Tue, 08 Dec 2020 13:34:35 +0800
Taints:             &lt;none&gt;
Unschedulable:      false
Conditions:
  Type             Status  LastHeartbeatTime                 LastTransitionTime                Reason                       Message
  ----             ------  -----------------                 ------------------                ------                       -------
  MemoryPressure   False   Tue, 08 Dec 2020 13:49:06 +0800   Tue, 08 Dec 2020 13:34:35 +0800   KubeletHasSufficientMemory   kubelet has sufficient memory available
  DiskPressure     False   Tue, 08 Dec 2020 13:49:06 +0800   Tue, 08 Dec 2020 13:34:35 +0800   KubeletHasNoDiskPressure     kubelet has no disk pressure
  PIDPressure      False   Tue, 08 Dec 2020 13:49:06 +0800   Tue, 08 Dec 2020 13:34:35 +0800   KubeletHasSufficientPID      kubelet has sufficient PID available
  Ready            True    Tue, 08 Dec 2020 13:49:06 +0800   Tue, 08 Dec 2020 13:34:35 +0800   KubeletReady                 kubelet is posting ready status
Addresses:
  InternalIP:  10.233.96.46
  Hostname:    hollow-node-3
Capacity:
 cpu:                  72
 ephemeral-storage:    15726578Mi
 inspur.com/gpu:       99999
 inspur.com/rdma-hca:  99999
 memory:               256Gi
 nvidia.com/gpu:       8
 pods:                 110
Allocatable:
 cpu:                  72
 ephemeral-storage:    15726578Mi
 inspur.com/gpu:       99999
 inspur.com/rdma-hca:  99999
 memory:               256Gi
 nvidia.com/gpu:       8
 pods:                 110
System Info:
 Machine ID:
 System UUID:
 Boot ID:
 Kernel Version:             3.16.0-0.bpo.4-amd64
 OS Image:                   Debian GNU/Linux 7 (wheezy)
 Operating System:           linux
 Architecture:               amd64
 Container Runtime Version:  docker://1.13.1
 Kubelet Version:            v0.0.0-master+4d3c9e0c
 Kube-Proxy Version:         v0.0.0-master+4d3c9e0c
PodCIDR:                     10.233.69.0/24
Non-terminated Pods:         (3 in total)
  Namespace                  Name                 CPU Requests  CPU Limits  Memory Requests  Memory Limits  AGE
  ---------                  ----                 ------------  ----------  ---------------  -------------  ---
  default                    myapp-pod            1 (1%)        1 (1%)      2Mi (0%)         2Mi (0%)       33s
  kube-system                calico-node-g6rqs    150m (0%)     300m (0%)   64M (0%)         500M (0%)      14m
  kube-system                kube-proxy-dzll2     0 (0%)        0 (0%)      0 (0%)           0 (0%)         14m
Allocated resources:
  (Total limits may be over 100 percent, i.e., overcommitted.)
  Resource             Requests      Limits
  --------             --------      ------
  cpu                  1150m (1%)    1300m (1%)
  memory               64548Ki (0%)  502097152 (0%)
  ephemeral-storage    0 (0%)        0 (0%)
  inspur.com/gpu       0             0
  inspur.com/rdma-hca  0             0
  nvidia.com/gpu       1             1
Events:
  Type    Reason    Age   From                       Message
  ----    ------    ----  ----                       -------
  Normal  Starting  14m   kube-proxy, hollow-node-3  Starting kube-proxy.</code></p>
<p>由上面测试集群信息，可以看到模拟了4个桩节点可用于测试pod调度。</p>
<h3>kubemark源码</h3>
<h4>程序入口</h4>
<p>kubemark根据参数Morph，可执行kubelet和proxy流程，从而实现节点组件功能。</p>
<p>cmd/kubemark/hollow-node.go
```golang
func run(config *hollowNodeConfig) {
  if !knownMorphs.Has(config.Morph) {
    klog.Fatalf("Unknown morph: %v. Allowed values: %v", config.Morph, knownMorphs.List())
  }</p>
<p>// create a client to communicate with API server.
  clientConfig, err := config.createClientConfigFromFile()
  if err != nil {
    klog.Fatalf("Failed to create a ClientConfig: %v. Exiting.", err)
  }</p>
<p>client, err := clientset.NewForConfig(clientConfig)
  if err != nil {
    klog.Fatalf("Failed to create a ClientSet: %v. Exiting.", err)
  }</p>
<p>if config.Morph == "kubelet" {
    cadvisorInterface := &amp;cadvisortest.Fake{
      NodeName: config.NodeName,
    }
    containerManager := cm.NewStubContainerManager()</p>
<pre><code>fakeDockerClientConfig := &amp;dockershim.ClientConfig{
  DockerEndpoint:    libdocker.FakeDockerEndpoint,
  EnableSleep:       true,
  WithTraceDisabled: true,
}

hollowKubelet := kubemark.NewHollowKubelet(
  config.NodeName,
  client,
  cadvisorInterface,
  fakeDockerClientConfig,
  config.KubeletPort,
  config.KubeletReadOnlyPort,
  containerManager,
  maxPods,
  podsPerCore,
)
hollowKubelet.Run()
</code></pre>
<p>}</p>
<p>if config.Morph == "proxy" {
    client, err := clientset.NewForConfig(clientConfig)
    if err != nil {
      klog.Fatalf("Failed to create API Server client: %v", err)
    }
    iptInterface := fakeiptables.NewFake()
    sysctl := fakesysctl.NewFake()
    execer := &amp;fakeexec.FakeExec{}
    eventBroadcaster := record.NewBroadcaster()
    recorder := eventBroadcaster.NewRecorder(legacyscheme.Scheme, v1.EventSource{Component: "kube-proxy", Host: config.NodeName})</p>
<pre><code>hollowProxy, err := kubemark.NewHollowProxyOrDie(
  config.NodeName,
  client,
  client.CoreV1(),
  iptInterface,
  sysctl,
  execer,
  eventBroadcaster,
  recorder,
  config.UseRealProxier,
  config.ProxierSyncPeriod,
  config.ProxierMinSyncPeriod,
)
if err != nil {
  klog.Fatalf("Failed to create hollowProxy instance: %v", err)
}
hollowProxy.Run()
</code></pre>
<p>}
}
```</p>
<h4>hollow_kubelet</h4>
<p>pkg/kubemark/hollow_kubelet</p>
<p>```golang
type HollowKubelet struct {
  KubeletFlags         <em>options.KubeletFlags
  KubeletConfiguration </em>kubeletconfig.KubeletConfiguration
  KubeletDeps          *kubelet.Dependencies
}</p>
<p>func NewHollowKubelet(
  nodeName string,
  client <em>clientset.Clientset,
  cadvisorInterface cadvisor.Interface,
  dockerClientConfig </em>dockershim.ClientConfig,
  kubeletPort, kubeletReadOnlyPort int,
  containerManager cm.ContainerManager,
  maxPods int, podsPerCore int,
) *HollowKubelet {
  // -----------------
  // Static config
  // -----------------
  f, c := GetHollowKubeletConfig(nodeName, kubeletPort, kubeletReadOnlyPort, maxPods, podsPerCore)</p>
<p>// -----------------
  // Injected objects
  // -----------------
  volumePlugins := emptydir.ProbeVolumePlugins()
  volumePlugins = append(volumePlugins, secret.ProbeVolumePlugins()...)
  volumePlugins = append(volumePlugins, projected.ProbeVolumePlugins()...)
  d := &amp;kubelet.Dependencies{
    KubeClient:         client,
    HeartbeatClient:    client,
    DockerClientConfig: dockerClientConfig,
    CAdvisorInterface:  cadvisorInterface,
    Cloud:              nil,
    OSInterface:        &amp;containertest.FakeOS{},
    ContainerManager:   containerManager,
    VolumePlugins:      volumePlugins,
    TLSOptions:         nil,
    OOMAdjuster:        oom.NewFakeOOMAdjuster(),
    Mounter:            mount.New("" /<em> default mount path </em>/),
    Subpather:          &amp;subpath.FakeSubpath{},
  }</p>
<p>return &amp;HollowKubelet{
    KubeletFlags:         f,
    KubeletConfiguration: c,
    KubeletDeps:          d,
  }
}</p>
<p>// Starts this HollowKubelet and blocks.
func (hk <em>HollowKubelet) Run() {
  if err := kubeletapp.RunKubelet(&amp;options.KubeletServer{
    KubeletFlags:         </em>hk.KubeletFlags,
    KubeletConfiguration: *hk.KubeletConfiguration,
  }, hk.KubeletDeps, false); err != nil {
    klog.Fatalf("Failed to run HollowKubelet: %v. Exiting.", err)
  }
  select {}
}
```</p>
<h4>hollow_proxy</h4>
<p>pkg/kubemark/hollow_proxy
```golang
type HollowProxy struct {
  ProxyServer *proxyapp.ProxyServer
}</p>
<p>type FakeProxier struct{}</p>
<p>func (<em>FakeProxier) Sync() {}
func (</em>FakeProxier) SyncLoop() {
  select {}
}
func (<em>FakeProxier) OnServiceAdd(service </em>v1.Service)                        {}
func (<em>FakeProxier) OnServiceUpdate(oldService, service </em>v1.Service)         {}
func (<em>FakeProxier) OnServiceDelete(service </em>v1.Service)                     {}
func (<em>FakeProxier) OnServiceSynced()                                        {}
func (</em>FakeProxier) OnEndpointsAdd(endpoints <em>v1.Endpoints)                  {}
func (</em>FakeProxier) OnEndpointsUpdate(oldEndpoints, endpoints <em>v1.Endpoints) {}
func (</em>FakeProxier) OnEndpointsDelete(endpoints <em>v1.Endpoints)               {}
func (</em>FakeProxier) OnEndpointsSynced()                                      {}</p>
<p>func NewHollowProxyOrDie(
  nodeName string,
  client clientset.Interface,
  eventClient v1core.EventsGetter,
  iptInterface utiliptables.Interface,
  sysctl utilsysctl.Interface,
  execer utilexec.Interface,
  broadcaster record.EventBroadcaster,
  recorder record.EventRecorder,
  useRealProxier bool,
  proxierSyncPeriod time.Duration,
  proxierMinSyncPeriod time.Duration,
) (*HollowProxy, error) {
  // Create proxier and service/endpoint handlers.
  var proxier proxy.ProxyProvider
  var serviceHandler proxyconfig.ServiceHandler
  var endpointsHandler proxyconfig.EndpointsHandler</p>
<p>if useRealProxier {
    // Real proxier with fake iptables, sysctl, etc underneath it.
    //var err error
    proxierIPTables, err := iptables.NewProxier(
      iptInterface,
      sysctl,
      execer,
      proxierSyncPeriod,
      proxierMinSyncPeriod,
      false,
      0,
      "10.0.0.0/8",
      nodeName,
      utilnode.GetNodeIP(client, nodeName),
      recorder,
      nil,
      []string{},
    )
    if err != nil {
      return nil, fmt.Errorf("unable to create proxier: %v", err)
    }
    proxier = proxierIPTables
    serviceHandler = proxierIPTables
    endpointsHandler = proxierIPTables
  } else {
    proxier = &amp;FakeProxier{}
    serviceHandler = &amp;FakeProxier{}
    endpointsHandler = &amp;FakeProxier{}
  }</p>
<p>// Create a Hollow Proxy instance.
  nodeRef := &amp;v1.ObjectReference{
    Kind:      "Node",
    Name:      nodeName,
    UID:       types.UID(nodeName),
    Namespace: "",
  }
  return &amp;HollowProxy{
    ProxyServer: &amp;proxyapp.ProxyServer{
      Client:                client,
      EventClient:           eventClient,
      IptInterface:          iptInterface,
      Proxier:               proxier,
      Broadcaster:           broadcaster,
      Recorder:              recorder,
      ProxyMode:             "fake",
      NodeRef:               nodeRef,
      OOMScoreAdj:           utilpointer.Int32Ptr(0),
      ResourceContainer:     "",
      ConfigSyncPeriod:      30 * time.Second,
      ServiceEventHandler:   serviceHandler,
      EndpointsEventHandler: endpointsHandler,
    },
  }, nil
}</p>
<p>func (hp *HollowProxy) Run() {
  if err := hp.ProxyServer.Run(); err != nil {
    klog.Fatalf("Error while running proxy: %v\n", err)
  }
}
```</p>
<h3>kubemark总结</h3>
<ol>
<li>kubemark实际上是个K8S组件，包含了kubelet和一个controller，模拟桩节点主要使用了kubelet功能。</li>
<li>kubemark通过在真实节点上构造批量的hollow-node的pod方式，模拟运行了大量的桩节点。这些桩节点可以定时跟master同步状态和信息。</li>
<li>kubemark一般用于测试master节点上的组件的性能测试，比如测试调度器和控制器组件性能。</li>
<li>kubemark由于其构造方式，决定其不能测试node节点组件，比如kubelet性能和网络等。</li>
</ol>
<h2>3 测试框架</h2>
<p>可参考k8s的perf-test</p>
<ul>
<li>
<p><a href="https://blog.csdn.net/qingdao666666/article/details/104625457">Kubernetes测试系列 - 性能测试</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/6844904142389919758">kubernetes性能指标体系：clusterloader2</a></p>
</li>
<li>
<p><a href="https://www.colabug.com/2020/0428/7329883/">clusterloader2的漫漫踩坑路：最详细解析与使用指南</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes/perf-tests/blob/master/clusterloader2/docs/design.md">clusterloader2设计说明：Cluster loader vision</a></p>
</li>
</ul>
<h2>4 问题</h2>
<h3>kubemark的hollow node 启动后，报错：</h3>
<p>此时node状态为为not ready
```shell
I0223 04:37:53.577861       6 kubelet_node_status.go:468] Recording NodeHasSufficientPID event message for node hollow-node-1
I0223 04:37:53.577871       6 kubelet_node_status.go:468] Recording NodeNotReady event message for node hollow-node-1
I0223 04:37:53.577879       6 setters.go:526] Node became not ready: {Type:Ready Status:False LastHeartbeatTime:2021-02-23 04:37:53.577865902 +0000 UTC m=+46.268886946 LastTransitionTime:2021-02-23 04:37:53.577865902 +0000 UTC m=+46.268886946 Reason:KubeletNotReady Message:Missing node capacity for resources: pods}
I0223 04:37:53.640378       6 reconciler.go:154] Reconciler: start to sync state</p>
<p>```</p>
<p>编译kubemark时，需要设置nodesstatus的maxpods数量 v1.ResourcePods:      *resource.NewQuantity(maxpods, resource.DecimalSI)</p>
<h3>如果启动kubemark的hollow node 状态为not ready，查看log报错信息</h3>
<p>```shell</p>
<p>E0223 06:15:30.382797       6 reflector.go:126] k8s.io/kubernetes/pkg/kubelet/config/apiserver.go:47: Failed to list <em>v1.Pod: Get "https://192.168.182.101:6443/api/v1/pods?fieldSelector=spec.nodeName%3Dhollow-node-0&amp;limit=500&amp;resourceVersion=0": dial tcp 192.168.182.101:6443: i/o timeout
I0223 06:15:30.383089       6 trace.go:81] Trace[432657393]: "Reflector k8s.io/kubernetes/pkg/kubelet/kubelet.go:451 ListAndWatch" (started: 2021-02-23 06:15:00.377839254 +0000 UTC m=+0.144897671) (total time: 30.005174003s):
Trace[432657393]: [30.005174003s] [30.005174003s] END
E0223 06:15:30.383123       6 reflector.go:126] k8s.io/kubernetes/pkg/kubelet/kubelet.go:451: Failed to list </em>v1.Node: Get "https://192.168.182.101:6443/api/v1/nodes?fieldSelector=metadata.name%3Dhollow-node-0&amp;limit=500&amp;resourceVersion=0": dial tcp 192.168.182.101:6443: i/o timeout
E0223 06:15:30.402640       6 kubelet.go:2246] node "hollow-node-0" not found
E0223 06:15:30.502860       6 kubelet.go:2246] node "hollow-node-0" not found</p>
<p>```</p>
<p>此时可能为网络原因，停止kubelet和docker服务，清理下网络即可解决</p>
<h2>5 附录</h2>
<p>参考操作命令。。。</p>
<p>```shell
[root@test-master ~]# kubectl get secret -A |grep kubeconfig
kubemark          kubeconfig                                       Opaque                                2      94s</p>
<p>[root@test-master ~]# kubectl describe secret -nkubemark          kubeconfig
Name:         kubeconfig
Namespace:    kubemark
Labels:       <none>
Annotations:  <none></p>
<p>Type:  Opaque</p>
<h1>Data</h1>
<p>kubelet.kubeconfig:    5463 bytes
kubeproxy.kubeconfig:  5463 bytes</p>
<h4>如果要删除刚刚创建的secret和 configmap</h4>
<p>kubectl delete secret -nkubemark          kubeconfig
kubectl delete configmap -n kubemark node-configmap 
kubectl delete ns kubemark</p>
<p>--force --grace-period=0</p>
<h4>强制删除资源</h4>
<p>kubectl delete po --force --grace-period=0 -nkube-system   kube-proxy-p6k42 </p>
<h3>删除kubemark命名空间下所有node资源</h3>
<p>kubectl delete no --all -n kubemark</p>
<h4>设置master节点不可调度</h4>
<h1>kubectl cordon nodename</h1>
<p>kubectl cordon node1</p>
<h1>kubectl uncordon nodename       #取消</h1>
<h4>节点打标签</h4>
<p>kubectl label node  node1 accessswitch=switch1
kubectl label node  node1 groupId=defaultGroup
kubectl label node  node1 node-role.kubernetes.io/master=true
kubectl label node  node1 node-role.kubernetes.io/node=true
kubectl label node  node1 switchtype=ether</p>
<p>kubectl label node  node2 accessswitch=switch1
kubectl label node  node2 groupId=defaultGroup
kubectl label node  node2 node-role.kubernetes.io/node=true
kubectl label node  node2 switchtype=ether</p>
<p>```</p>
<p>修改hollow-node信息，不是node的全部信息都可以修改更新，如capacity等字段无法更新
<code>shell
kubectl patch node hollow-node-0 -p '{"spec":{"unschedulable":true}}'</code></p>
<p>e2e测试
编译e2e.test
make WHAT="test/e2e/e2e.test"</p>
<p>```shell</p>
<h1>进入k8s项目，进行测试工具编译</h1>
<p>make WHAT="test/e2e/e2e.test"</p>
<h1>在目录下能够看到输出文件如下：</h1>
<p>[root@node1 k8s1.14.8modify-wangb]# ll _output/bin/ -h
total 241M
-rwxr-xr-x. 1 root root 5.9M Dec  7 10:04 conversion-gen
-rwxr-xr-x. 1 root root 5.9M Dec  7 10:04 deepcopy-gen
-rwxr-xr-x. 1 root root 5.9M Dec  7 10:04 defaulter-gen
-rwxr-xr-x. 1 root root 110M Dec  7 17:01 e2e.test
-rwxr-xr-x. 1 root root 3.5M Dec  7 10:04 go2make
-rwxr-xr-x. 1 root root 2.0M Dec  7 10:04 go-bindata
-rwxr-xr-x. 1 root root  99M Dec  7 10:05 kubemark
-rwxr-xr-x. 1 root root  10M Dec  7 10:04 openapi-gen</p>
<h1>把 e2e.test 文件拷贝到测试集群的master节点上</h1>
<p>```
需要注意：网上的搜到的文章大多数都是编译e2e的二进制文件直接运行</p>
<p>``` shell</p>
<h1>./e2e.test --kube-master=192.168.182.101 --host=https://192.168.182.101:6443 --ginkgo.focus="[Performance]" --provider=local --kubeconfig=kubemark.kubeconfig --num-nodes=10 --v=3 --ginkgo.failFast --e2e-output-dir=. --report-dir=.</h1>
<p>./e2e.test --kube-master=192.168.182.101 --host=https://192.168.182.101:6443 --ginkgo.focus="[Performance]" --provider=local --kubeconfig=/root/.kube/config --num-nodes=4 --v=3 --ginkgo.failFast --e2e-output-dir=. --report-dir=.
```
但其实e2e的性能用例已经被移出主库了 https://github.com/kubernetes/kubernetes/pull/83322，所以在2019.10.1之后出的版本用上面的命令是无法运行性能测试的</p>
<p><br></p>
<p>{{&lt; admonition note "Deployment中pod创建的流程" &gt;}}</p>
<ol>
<li>apiserver收到创建deployment的请求，存储至etcd，告知controller-manager</li>
<li>controller-manager创建pod的壳子，打上creationTimeStamp，发送请求到apiserver</li>
<li>apiserver收到创建pod的请求，发送至etcd，推送到scheduler。</li>
<li>schduler选择node，填充nodeName，向apiserver更新pod信息。此时pod处于pending状态，pod也没有真正创建。</li>
<li>apiserver向etcd更新pod信息，同时推送到相应节点的kubelet</li>
<li>kubelet创建pod，填充HostIP与resourceVersion，向apiserver发送更新请求，pod处于pending状态</li>
<li>apiserver更新pod信息至etcd，同时kubelet继续创建pod。等到容器都处于running状态，kubelet再次发送pod的更新请求给apiserver，此时pod running</li>
<li>apiserver收到请求，更新到etcd中，并推送到informer中，informer记录下watchPhase</li>
</ol>
<p>{{&lt; /admonition &gt;}}</p></article></body></html>