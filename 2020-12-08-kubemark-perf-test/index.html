<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>K8S集群性能测试-kubemark - 斌哥的小站|Binge Blog</title><meta name=Description content="了解如何使用kubemark对k8s组件进行性能测试"><meta property="og:title" content="K8S集群性能测试-kubemark"><meta property="og:description" content="了解如何使用kubemark对k8s组件进行性能测试"><meta property="og:type" content="article"><meta property="og:url" content="http://bingerambo.com/2020-12-08-kubemark-perf-test/"><meta property="og:image" content="http://bingerambo.com/2020-12-08-kubemark-perf-test/featured-image.jpg"><meta property="article:published_time" content="2020-12-08T13:43:17+08:00"><meta property="article:modified_time" content="2020-12-08T13:43:17+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://bingerambo.com/2020-12-08-kubemark-perf-test/featured-image.jpg"><meta name=twitter:title content="K8S集群性能测试-kubemark"><meta name=twitter:description content="了解如何使用kubemark对k8s组件进行性能测试"><meta name=application-name content="Binge Blog"><meta name=apple-mobile-web-app-title content="Binge Blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=http://bingerambo.com/2020-12-08-kubemark-perf-test/><link rel=prev href=http://bingerambo.com/basic-markdown-syntax/><link rel=next href=http://bingerambo.com/2020-12-15-perf-test-clusterloader/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"K8S集群性能测试-kubemark","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/bingerambo.com\/2020-12-08-kubemark-perf-test\/"},"image":[{"@type":"ImageObject","url":"http:\/\/bingerambo.com\/2020-12-08-kubemark-perf-test\/featured-image.jpg","width":1280,"height":640}],"genre":"posts","keywords":"K8S, GO","wordcount":6050,"url":"http:\/\/bingerambo.com\/2020-12-08-kubemark-perf-test\/","datePublished":"2020-12-08T13:43:17+08:00","dateModified":"2020-12-08T13:43:17+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"xxxx","logo":"http:\/\/bingerambo.com\/images\/avatar.png"},"author":{"@type":"Person","name":"Binge"},"description":"了解如何使用kubemark对k8s组件进行性能测试"}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="斌哥的小站|Binge Blog"><span class=header-title-pre><i class="fas fa-biking fa-fw"></i></span>Binge Blog</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/><i class="fas fa-fw fa-archive"></i>文章 </a><a class=menu-item href=/tags/><i class="fas fa-fw fa-tag"></i>标签 </a><a class=menu-item href=/categories/><i class="fas fa-fw fa-th"></i>分类 </a><a class=menu-item href=/notes/><i class="fas fa-cog fa-spin"></i>随记 </a><a class=menu-item href=/about/><i class="fas fa-fw fa-at"></i>关于 </a><a class=menu-item href=/search/><i class="fas fa-fw fa-search"></i>搜索 </a><a class=menu-item href=https://github.com/bingerambo title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><a class=menu-item href=/><i class="fas fa fa-user"></i><span id=busuanzi_value_site_uv></span></a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="斌哥的小站|Binge Blog"><span class=header-title-pre><i class="fas fa-biking fa-fw"></i></span>Binge Blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/><i class="fas fa-fw fa-archive"></i>文章</a><a class=menu-item href=/tags/><i class="fas fa-fw fa-tag"></i>标签</a><a class=menu-item href=/categories/><i class="fas fa-fw fa-th"></i>分类</a><a class=menu-item href=/notes/><i class="fas fa-cog fa-spin"></i>随记</a><a class=menu-item href=/about/><i class="fas fa-fw fa-at"></i>关于</a><a class=menu-item href=/search/><i class="fas fa-fw fa-search"></i>搜索</a><a class=menu-item href=https://github.com/bingerambo title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><a class=menu-item href=/><i class="fas fa fa-user"></i><span id=busuanzi_value_site_uv></span></a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">K8S集群性能测试-kubemark</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=http://bingerambo.com title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw"></i>Binge</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/k8s/><i class="far fa-folder fa-fw"></i>K8S</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2020-12-08>2020-12-08</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 6050 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 13 分钟&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=/2020-12-08-kubemark-perf-test/featured-image.jpg data-srcset="/2020-12-08-kubemark-perf-test/featured-image.jpg, /2020-12-08-kubemark-perf-test/featured-image.jpg 1.5x, /2020-12-08-kubemark-perf-test/featured-image.jpg 2x" data-sizes=auto alt=/2020-12-08-kubemark-perf-test/featured-image.jpg title=了解如何使用kubemark对k8s组件进行性能测试></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#1-背景>1 背景</a></li><li><a href=#2-kubemark>2 kubemark</a><ul><li><a href=#介绍>介绍</a></li><li><a href=#kubemark构造>kubemark构造</a><ul><li><a href=#1-编译kubemark>1. 编译kubemark</a></li><li><a href=#2-构建kubemark镜像>2. 构建kubemark镜像</a></li><li><a href=#3-保存镜像至kubemarktar>3. 保存镜像至kubemark.tar</a></li><li><a href=#4-kubemark部署到测试集群>4. kubemark部署到测试集群</a></li><li><a href=#5-在测试集群中启动hollow-nodes>5. 在测试集群中启动hollow nodes</a></li></ul></li><li><a href=#测试pod>测试pod</a></li><li><a href=#kubemark源码>kubemark源码</a><ul><li><a href=#程序入口>程序入口</a></li><li><a href=#hollow_kubelet>hollow_kubelet</a></li><li><a href=#hollow_proxy>hollow_proxy</a></li></ul></li><li><a href=#kubemark总结>kubemark总结</a></li></ul></li><li><a href=#3-测试框架>3 测试框架</a></li><li><a href=#4-附录>4 附录</a></li></ul></nav></div></div><div class=content id=content><p>了解如何使用kubemark对k8s组件进行性能测试</p><h2 id=1-背景>1 背景</h2><p>项目想对k8s组件进行集群性能测试。原有组件如调度器，已有的测试工具多是单元测试。需要寻找一种可以对k8s集群进行性能测试。比如多多节点大集群规模下的调度器性能指标如何？</p><p>考虑使用k8s项目自带的性能测试组件kubemark。</p><h2 id=2-kubemark>2 kubemark</h2><h3 id=介绍>介绍</h3><p>kubemark 是 K8s 官方给出的性能测试工具，能够不受任何资源限制，模拟出一个大规模 K8s 集群。其主要架构如图所示:需要一个外部 K8s 集群（external cluster） 以及一个机器节点运行 kubemark master，即另外一个 K8s 集群，但是只有一个 master 节点。我们需要在 external cluster 中部署运行 hollow pod，这些 pod 会主动向 kubemark 集群注册，并成为 kubemark 集群中的 hollow node(虚拟节点)。然后我们就可以在 kubemark 集群中进行 e2e 测试。虽然与真实集群的稍微有点误差，不过可以代表真实集群的数据。</p><figure><img src=/images/2020-12-08/kubemark.png></figure><br><p><strong>本文则只构造了kubemark组件，且只使用了测试集群，即外部 K8s 集群（external cluster），未使用第2个kubemark集群。目的为测试集群中的master组件，如调度器和控制器等。另外，此方式还可以自己使用第三方测试工具和框架</strong></p><br><figure><img src=/images/2020-12-08/k8s-perf.png></figure><h3 id=kubemark构造>kubemark构造</h3><h4 id=1-编译kubemark>1. 编译kubemark</h4><p>在 K8s 源码路径下构建 kubemark，生成的二进制文件在 _output/bin 目录下。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=c1># KUBE_BUILD_PLATFORMS=linux/amd64 make kubemark GOFLAGS=-v GOGCFLAGS=&#34;-N -l&#34;</span>

 make kubemark <span class=nv>GOGCFLAGS</span><span class=o>=</span><span class=s2>&#34;-N -l&#34;</span>
</code></pre></td></tr></table></div></div><h4 id=2-构建kubemark镜像>2. 构建kubemark镜像</h4><p>将生成的 kubemark 二进制文件从 _output/bin 复制到 cluster/images/kubemark 目录下。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>cp _output/bin/kubemark cluster/images/kubemark/
</code></pre></td></tr></table></div></div><p>并在该目录下执行构建镜像命令，生成镜像：staging-registry.cn-hangzhou.aliyuncs.com/google_containers/kubemark:v1.14.8。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=c1># IMAGE_TAG=v1.14.3 make build</span>
<span class=nb>cd</span> cluster/images/kubemark/
<span class=nv>IMAGE_TAG</span><span class=o>=</span>v1.14.8 make build

</code></pre></td></tr></table></div></div><h4 id=3-保存镜像至kubemarktar>3. 保存镜像至kubemark.tar</h4><h4 id=4-kubemark部署到测试集群>4. kubemark部署到测试集群</h4><p>在测试集群中的所有node节点中，导入该kubemark镜像。用于启动桩节点。
接下来进行桩节点hollow-node启动配置操作</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=c1># 以下命令在测试集群的master节点上执行</span>
<span class=c1># 从kubemark-master节点（191节点）拷贝过来kubeconfig文件，到测试集群的master节点中</span>
scp -r 192.168.182.191:/root/.kube/config /home/wangb/

kubectl create ns kubemark

kubectl create configmap node-configmap -n kubemark --from-literal<span class=o>=</span>content.type<span class=o>=</span><span class=s2>&#34;test-cluster&#34;</span>

<span class=c1># kubectl create secret generic kubeconfig --type=Opaque --namespace=kubemark --from-file=kubelet.kubeconfig=config --from-file=kubeproxy.kubeconfig=config</span>

kubectl create secret generic kubeconfig --type<span class=o>=</span>Opaque --namespace<span class=o>=</span>kubemark --from-file<span class=o>=</span>kubelet.kubeconfig<span class=o>=</span>/root/.kube/config --from-file<span class=o>=</span>kubeproxy.kubeconfig<span class=o>=</span>/root/.kube/config

</code></pre></td></tr></table></div></div><h4 id=5-在测试集群中启动hollow-nodes>5. 在测试集群中启动hollow nodes</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>kubectl create -f hollow-node-sts.yaml -n kubemark
</code></pre></td></tr></table></div></div><h3 id=测试pod>测试pod</h3><p>启动桩节点，hollow-node-sts.yaml的默认配置如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>hollow-node</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kubemark</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>clusterIP</span><span class=p>:</span><span class=w> </span><span class=l>None</span><span class=w>
</span><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>    </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>hollow-node</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>StatefulSet</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>hollow-node</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kubemark</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>podManagementPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Parallel</span><span class=w>
</span><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>6</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>hollow-node</span><span class=w>
</span><span class=w>  </span><span class=nt>serviceName</span><span class=p>:</span><span class=w> </span><span class=l>hollow-node</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>hollow-node</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>initContainers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>init-inotify-limit</span><span class=w>
</span><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker.io/busybox:latest</span><span class=w>
</span><span class=w>        </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;sysctl&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;-w&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;fs.inotify.max_user_instances=200&#39;</span><span class=p>]</span><span class=w>
</span><span class=w>        </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>privileged</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kubeconfig-volume</span><span class=w>
</span><span class=w>        </span><span class=nt>secret</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>kubeconfig</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>logs-volume</span><span class=w>
</span><span class=w>        </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/var/log</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>hollow-kubelet</span><span class=w>
</span><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>staging-registry.cn-hangzhou.aliyuncs.com/google_containers/kubemark:v1.14.8</span><span class=w>
</span><span class=w>        </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>4194</span><span class=w>
</span><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>10250</span><span class=w>
</span><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>10255</span><span class=w>
</span><span class=w>        </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>CONTENT_TYPE</span><span class=w>
</span><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>configMapKeyRef</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>node-configmap</span><span class=w>
</span><span class=w>              </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>content.type</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>NODE_NAME</span><span class=w>
</span><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=l>metadata.name</span><span class=w>
</span><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=l>/bin/sh</span><span class=w>
</span><span class=w>        </span>- -<span class=l>c</span><span class=w>
</span><span class=w>        </span>- <span class=l>/kubemark --morph=kubelet --name=$(NODE_NAME) --kubeconfig=/kubeconfig/kubelet.kubeconfig $(CONTENT_TYPE) --alsologtostderr --v=2</span><span class=w>
</span><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kubeconfig-volume</span><span class=w>
</span><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/kubeconfig</span><span class=w>
</span><span class=w>          </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>logs-volume</span><span class=w>
</span><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/var/log</span><span class=w>
</span><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>20m</span><span class=w>
</span><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>50M</span><span class=w>
</span><span class=w>        </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>privileged</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>hollow-proxy</span><span class=w>
</span><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>staging-registry.cn-hangzhou.aliyuncs.com/google_containers/kubemark:v1.14.8</span><span class=w>
</span><span class=w>        </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span><span class=w>        </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>CONTENT_TYPE</span><span class=w>
</span><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>configMapKeyRef</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>node-configmap</span><span class=w>
</span><span class=w>              </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>content.type</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>NODE_NAME</span><span class=w>
</span><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=l>metadata.name</span><span class=w>
</span><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=l>/bin/sh</span><span class=w>
</span><span class=w>        </span>- -<span class=l>c</span><span class=w>
</span><span class=w>        </span>- <span class=l>/kubemark --morph=proxy --name=$(NODE_NAME) --use-real-proxier=false --kubeconfig=/kubeconfig/kubeproxy.kubeconfig $(CONTENT_TYPE) --alsologtostderr --v=2</span><span class=w>
</span><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kubeconfig-volume</span><span class=w>
</span><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/kubeconfig</span><span class=w>
</span><span class=w>          </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>logs-volume</span><span class=w>
</span><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/var/log</span><span class=w>
</span><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>20m</span><span class=w>
</span><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>50M</span><span class=w>
</span><span class=w>      </span><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=l>NoExecute</span><span class=w>
</span><span class=w>        </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>node.kubernetes.io/unreachable</span><span class=w>
</span><span class=w>        </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>Exists</span><span class=w>
</span><span class=w>      </span>- <span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=l>NoExecute</span><span class=w>
</span><span class=w>        </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>node.kubernetes.io/not-ready</span><span class=w>
</span><span class=w>        </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>Exists</span><span class=w>
</span><span class=w>      </span><span class=nt>affinity</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>nodeAffinity</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>requiredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>  </span><span class=c># 硬策略</span><span class=w>
</span><span class=w>            </span><span class=nt>nodeSelectorTerms</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span><span class=w>              </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>name</span><span class=w>
</span><span class=w>                </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>NotIn</span><span class=w>
</span><span class=w>                </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span><span class=w>                </span>- <span class=l>hollow-node</span><span class=w>
</span><span class=w>              </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>node-role.kubernetes.io/master</span><span class=w>
</span><span class=w>                </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>NotIn</span><span class=w>
</span><span class=w>                </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span><span class=w>                </span>- <span class=s2>&#34;true&#34;</span><span class=w>
</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>由上可知，hollow-node实际上是启动过了kubelet和proxy的2个进程，后来分析源码确实如此。</p><p>写个测试pod，验证桩node是否可用，test-pod.yaml如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myapp-pod</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span><span class=w>    </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker.io/busybox:latest</span><span class=w>
</span><span class=w>    </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;sleep&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;3600&#39;</span><span class=p>]</span><span class=w>
</span><span class=w>    </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>privileged</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=nt>affinity</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>nodeAffinity</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>requiredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>  </span><span class=c># 硬策略</span><span class=w>
</span><span class=w>            </span><span class=nt>nodeSelectorTerms</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span><span class=w>              </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>node-role.kubernetes.io/node</span><span class=w>
</span><span class=w>                </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>NotIn</span><span class=w>
</span><span class=w>                </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span><span class=w>                </span>- <span class=s2>&#34;true&#34;</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>节点信息 hollow-node-0, 此信息为默认信息</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>Name:               hollow-node-0
Roles:              &lt;none&gt;
Labels:             beta.kubernetes.io/arch<span class=o>=</span>amd64
                    beta.kubernetes.io/os<span class=o>=</span>linux
                    kubernetes.io/arch<span class=o>=</span>amd64
                    kubernetes.io/hostname<span class=o>=</span>hollow-node-0
                    kubernetes.io/os<span class=o>=</span>linux
Annotations:        node.alpha.kubernetes.io/ttl: <span class=m>0</span>
CreationTimestamp:  Mon, <span class=m>07</span> Dec <span class=m>2020</span> 17:25:15 +0800
Taints:             &lt;none&gt;
Unschedulable:      <span class=nb>false</span>
Conditions:
  Type             Status  LastHeartbeatTime                 LastTransitionTime                Reason                       Message
  ----             ------  -----------------                 ------------------                ------                       -------
  MemoryPressure   False   Tue, <span class=m>08</span> Dec <span class=m>2020</span> 09:37:21 +0800   Mon, <span class=m>07</span> Dec <span class=m>2020</span> 17:25:15 +0800   KubeletHasSufficientMemory   kubelet has sufficient memory available
  DiskPressure     False   Tue, <span class=m>08</span> Dec <span class=m>2020</span> 09:37:21 +0800   Mon, <span class=m>07</span> Dec <span class=m>2020</span> 17:25:15 +0800   KubeletHasNoDiskPressure     kubelet has no disk pressure
  PIDPressure      False   Tue, <span class=m>08</span> Dec <span class=m>2020</span> 09:37:21 +0800   Mon, <span class=m>07</span> Dec <span class=m>2020</span> 17:25:15 +0800   KubeletHasSufficientPID      kubelet has sufficient PID available
  Ready            True    Tue, <span class=m>08</span> Dec <span class=m>2020</span> 09:37:21 +0800   Mon, <span class=m>07</span> Dec <span class=m>2020</span> 17:25:15 +0800   KubeletReady                 kubelet is posting ready status
Addresses:
  InternalIP:  10.233.96.39
  Hostname:    hollow-node-0
Capacity:
 cpu:                <span class=m>1</span>
 ephemeral-storage:  <span class=m>0</span>
 memory:             3840Mi
 pods:               <span class=m>110</span>
Allocatable:
 cpu:                <span class=m>1</span>
 ephemeral-storage:  <span class=m>0</span>
 memory:             3840Mi
 pods:               <span class=m>110</span>
System Info:
 Machine ID:
 System UUID:
 Boot ID:
 Kernel Version:             3.16.0-0.bpo.4-amd64
 OS Image:                   Debian GNU/Linux <span class=m>7</span> <span class=o>(</span>wheezy<span class=o>)</span>
 Operating System:           linux
 Architecture:               amd64
 Container Runtime Version:  docker://1.13.1
 Kubelet Version:            v0.0.0-master+4d3c9e0c
 Kube-Proxy Version:         v0.0.0-master+4d3c9e0c
PodCIDR:                     10.233.98.0/24
Non-terminated Pods:         <span class=o>(</span><span class=m>3</span> in total<span class=o>)</span>
  Namespace                  Name                               CPU Requests  CPU Limits  Memory Requests  Memory Limits  AGE
  ---------                  ----                               ------------  ----------  ---------------  -------------  ---
  kube-system                calico-node-29z7g                  150m <span class=o>(</span>15%<span class=o>)</span>    300m <span class=o>(</span>30%<span class=o>)</span>  64M <span class=o>(</span>1%<span class=o>)</span>         500M <span class=o>(</span>12%<span class=o>)</span>     16h
  kube-system                kube-proxy-8wcss                   <span class=m>0</span> <span class=o>(</span>0%<span class=o>)</span>        <span class=m>0</span> <span class=o>(</span>0%<span class=o>)</span>      <span class=m>0</span> <span class=o>(</span>0%<span class=o>)</span>           <span class=m>0</span> <span class=o>(</span>0%<span class=o>)</span>         16h
  kube-system                metrics-server-84d6dbd58b-6vqmf    50m <span class=o>(</span>5%<span class=o>)</span>      145m <span class=o>(</span>14%<span class=o>)</span>  125Mi <span class=o>(</span>3%<span class=o>)</span>       375Mi <span class=o>(</span>9%<span class=o>)</span>     16h

</code></pre></td></tr></table></div></div><p>作业运行到hollow node</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=o>[</span>root@node1 .kube<span class=o>]</span><span class=c1># kubectl get po -A -owide</span>
NAMESPACE     NAME                              READY   STATUS              RESTARTS   AGE    IP                NODE            NOMINATED NODE   READINESS GATES
default       myapp-pod                         1/1     Running             <span class=m>0</span>          6s     10.94.251.209     hollow-node-1   &lt;none&gt;           &lt;none&gt;
kube-system   calico-node-77l7w                 0/1     Init:0/1            <span class=m>0</span>          20m    10.233.96.20      hollow-node-3   &lt;none&gt;           &lt;none&gt;
kube-system   calico-node-fhlsn                 0/1     Init:0/1            <span class=m>0</span>          20m    10.233.96.21      hollow-node-0   &lt;none&gt;           &lt;none&gt;
kube-system   calico-node-g9fx8                 0/1     Init:0/1            <span class=m>0</span>          20m    10.233.96.19      hollow-node-5   &lt;none&gt;           &lt;none&gt;
kube-system   calico-node-gdrlk                 0/1     Init:0/1            <span class=m>0</span>          20m    10.233.96.17      hollow-node-1   &lt;none&gt;           &lt;none&gt;
kube-system   calico-node-lnzc7                 0/1     Init:0/1            <span class=m>0</span>          20m    10.233.96.22      hollow-node-4   &lt;none&gt;           &lt;none&gt;
kube-system   calico-node-lt9jh                 0/1     Init:0/1            <span class=m>0</span>          20m    10.233.96.18      hollow-node-2   &lt;none&gt;           &lt;none&gt;
kube-system   calico-node-ms5t6                 1/1     Running             <span class=m>0</span>          51m    192.168.182.102   node2           &lt;none&gt;           &lt;none&gt;
kube-system   calico-node-vxcb7                 1/1     Running             <span class=m>0</span>          51m    192.168.182.101   node1           &lt;none&gt;           &lt;none&gt;
kube-system   coredns-654c8ccdc8-575qx          1/1     Running             <span class=m>0</span>          53m    10.233.90.74      node1           &lt;none&gt;           &lt;none&gt;
kube-system   coredns-654c8ccdc8-m8ntn          0/1     Pending             <span class=m>0</span>          174d   &lt;none&gt;            &lt;none&gt;          &lt;none&gt;           &lt;none&gt;
kube-system   dns-autoscaler-77445c9c8b-b565h   1/1     Running             <span class=m>0</span>          53m    10.233.90.65      node1           &lt;none&gt;           &lt;none&gt;
kube-system   kube-apiserver-node1              1/1     Running             <span class=m>11</span>         51m    192.168.182.101   node1           &lt;none&gt;           &lt;none&gt;
kube-system   kube-controller-manager-node1     1/1     Running             <span class=m>11</span>         51m    192.168.182.101   node1           &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-72xn7                  0/1     ContainerCreating   <span class=m>0</span>          20m    10.233.96.21      hollow-node-0   &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-8jw9r                  0/1     ContainerCreating   <span class=m>0</span>          20m    10.233.96.19      hollow-node-5   &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-92jzz                  0/1     ContainerCreating   <span class=m>0</span>          20m    10.233.96.20      hollow-node-3   &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-djxjg                  0/1     ContainerCreating   <span class=m>0</span>          20m    10.233.96.18      hollow-node-2   &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-dsghn                  1/1     Running             <span class=m>0</span>          51m    192.168.182.101   node1           &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-gjzq8                  1/1     Running             <span class=m>0</span>          51m    192.168.182.102   node2           &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-lpb8m                  0/1     ContainerCreating   <span class=m>0</span>          20m    10.233.96.17      hollow-node-1   &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-sfjlq                  0/1     ContainerCreating   <span class=m>0</span>          20m    10.233.96.22      hollow-node-4   &lt;none&gt;           &lt;none&gt;
kube-system   kube-scheduler-node1              1/1     Running             <span class=m>11</span>         51m    192.168.182.101   node1           &lt;none&gt;           &lt;none&gt;
kube-system   metrics-server-84d6dbd58b-rbrjd   0/2     ContainerCreating   <span class=m>0</span>          20m    &lt;none&gt;            hollow-node-3   &lt;none&gt;           &lt;none&gt;
kubemark      hollow-node-0                     2/2     Running             <span class=m>0</span>          20m    10.233.96.21      node2           &lt;none&gt;           &lt;none&gt;
kubemark      hollow-node-1                     2/2     Running             <span class=m>0</span>          20m    10.233.96.17      node2           &lt;none&gt;           &lt;none&gt;
kubemark      hollow-node-2                     2/2     Running             <span class=m>0</span>          20m    10.233.96.18      node2           &lt;none&gt;           &lt;none&gt;
kubemark      hollow-node-3                     2/2     Running             <span class=m>0</span>          20m    10.233.96.20      node2           &lt;none&gt;           &lt;none&gt;
kubemark      hollow-node-4                     2/2     Running             <span class=m>0</span>          20m    10.233.96.22      node2           &lt;none&gt;           &lt;none&gt;
kubemark      hollow-node-5                     2/2     Running             <span class=m>0</span>          20m    10.233.96.19      node2           &lt;none&gt;           &lt;none&gt;
<span class=o>[</span>root@node1 .kube<span class=o>]</span><span class=c1># kubectl describe po -ndefault       myapp-pod</span>
Name:               myapp-pod
Namespace:          default
Priority:           <span class=m>0</span>
PriorityClassName:  &lt;none&gt;
Node:               hollow-node-1/10.233.96.17
Start Time:         Mon, <span class=m>07</span> Dec <span class=m>2020</span> 16:33:50 +0800
Labels:             <span class=nv>app</span><span class=o>=</span>myapp
                    <span class=nv>version</span><span class=o>=</span>v1
Annotations:        &lt;none&gt;
Status:             Running
IP:                 10.94.251.209
Containers:
  app:
    Container ID:  docker://3033a0ef90209b22
    Image:         docker.io/busybox:latest
    Image ID:      docker://docker.io/busybox:latest
    Port:          &lt;none&gt;
    Host Port:     &lt;none&gt;
    Command:
      sleep
      <span class=m>3600</span>
    State:          Running
      Started:      Mon, <span class=m>07</span> Dec <span class=m>2020</span> 16:33:54 +0800
    Ready:          True
    Restart Count:  <span class=m>0</span>
    Environment:    &lt;none&gt;
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-fm7gj <span class=o>(</span>ro<span class=o>)</span>
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  default-token-fm7gj:
    Type:        Secret <span class=o>(</span>a volume populated by a Secret<span class=o>)</span>
    SecretName:  default-token-fm7gj
    Optional:    <span class=nb>false</span>
QoS Class:       BestEffort
Node-Selectors:  &lt;none&gt;
Tolerations:     node.kubernetes.io/not-ready:NoExecute <span class=k>for</span> 300s
                 node.kubernetes.io/unreachable:NoExecute <span class=k>for</span> 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  17s   default-scheduler  Successfully assigned default/myapp-pod to hollow-node-1

</code></pre></td></tr></table></div></div><p>上面的kubemark和测试hollow-node是缺省默认配置，无法满足项目的k8s测试需要，比如node的自定义资源描述等，所以还需对kubemark和测试hollow-node进行改造。</p><p>修改kubemark（kubelet），重新编译kubemark，重新部署kubemark，查看桩节点信息（<em>资源信息</em>）如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>Name:               hollow-node-0
Roles:              &lt;none&gt;
Labels:             beta.kubernetes.io/arch<span class=o>=</span>amd64
                    beta.kubernetes.io/os<span class=o>=</span>linux
                    kubernetes.io/arch<span class=o>=</span>amd64
                    kubernetes.io/hostname<span class=o>=</span>hollow-node-0
                    kubernetes.io/os<span class=o>=</span>linux
Annotations:        node.alpha.kubernetes.io/ttl: <span class=m>0</span>
CreationTimestamp:  Tue, <span class=m>08</span> Dec <span class=m>2020</span> 13:34:35 +0800
Taints:             &lt;none&gt;
Unschedulable:      <span class=nb>false</span>
Conditions:
  Type             Status  LastHeartbeatTime                 LastTransitionTime                Reason                       Message
  ----             ------  -----------------                 ------------------                ------                       -------
  MemoryPressure   False   Tue, <span class=m>08</span> Dec <span class=m>2020</span> 13:34:35 +0800   Tue, <span class=m>08</span> Dec <span class=m>2020</span> 13:34:35 +0800   KubeletHasSufficientMemory   kubelet has sufficient memory available
  DiskPressure     False   Tue, <span class=m>08</span> Dec <span class=m>2020</span> 13:34:35 +0800   Tue, <span class=m>08</span> Dec <span class=m>2020</span> 13:34:35 +0800   KubeletHasNoDiskPressure     kubelet has no disk pressure
  PIDPressure      False   Tue, <span class=m>08</span> Dec <span class=m>2020</span> 13:34:35 +0800   Tue, <span class=m>08</span> Dec <span class=m>2020</span> 13:34:35 +0800   KubeletHasSufficientPID      kubelet has sufficient PID available
  Ready            True    Tue, <span class=m>08</span> Dec <span class=m>2020</span> 13:34:35 +0800   Tue, <span class=m>08</span> Dec <span class=m>2020</span> 13:34:35 +0800   KubeletReady                 kubelet is posting ready status
Addresses:
  InternalIP:  10.233.96.50
  Hostname:    hollow-node-0
Capacity:
 cpu:                  <span class=m>72</span>
 ephemeral-storage:    15726578Mi
 inspur.com/gpu:       <span class=m>99999</span>
 inspur.com/rdma-hca:  <span class=m>99999</span>
 memory:               256Gi
 nvidia.com/gpu:       <span class=m>8</span>
 pods:                 <span class=m>110</span>
Allocatable:
 cpu:                  <span class=m>72</span>
 ephemeral-storage:    15726578Mi
 inspur.com/gpu:       <span class=m>99999</span>
 inspur.com/rdma-hca:  <span class=m>99999</span>
 memory:               256Gi
 nvidia.com/gpu:       <span class=m>8</span>
 pods:                 <span class=m>110</span>
System Info:
 Machine ID:
 System UUID:
 Boot ID:
 Kernel Version:             3.16.0-0.bpo.4-amd64
 OS Image:                   Debian GNU/Linux <span class=m>7</span> <span class=o>(</span>wheezy<span class=o>)</span>
 Operating System:           linux
 Architecture:               amd64
 Container Runtime Version:  docker://1.13.1
 Kubelet Version:            v0.0.0-master+4d3c9e0c
 Kube-Proxy Version:         v0.0.0-master+4d3c9e0c
PodCIDR:                     10.233.67.0/24
Non-terminated Pods:         <span class=o>(</span><span class=m>3</span> in total<span class=o>)</span>
  Namespace                  Name                               CPU Requests  CPU Limits  Memory Requests  Memory Limits  AGE
  ---------                  ----                               ------------  ----------  ---------------  -------------  ---
  kube-system                calico-node-n5528                  150m <span class=o>(</span>0%<span class=o>)</span>     300m <span class=o>(</span>0%<span class=o>)</span>   64M <span class=o>(</span>0%<span class=o>)</span>         500M <span class=o>(</span>0%<span class=o>)</span>      14s
  kube-system                kube-proxy-fxcs4                   <span class=m>0</span> <span class=o>(</span>0%<span class=o>)</span>        <span class=m>0</span> <span class=o>(</span>0%<span class=o>)</span>      <span class=m>0</span> <span class=o>(</span>0%<span class=o>)</span>           <span class=m>0</span> <span class=o>(</span>0%<span class=o>)</span>         14s
  kube-system                metrics-server-84d6dbd58b-sx7sl    50m <span class=o>(</span>0%<span class=o>)</span>      145m <span class=o>(</span>0%<span class=o>)</span>   125Mi <span class=o>(</span>0%<span class=o>)</span>       375Mi <span class=o>(</span>0%<span class=o>)</span>     8s
Allocated resources:
  <span class=o>(</span>Total limits may be over <span class=m>100</span> percent, i.e., overcommitted.<span class=o>)</span>
  Resource             Requests      Limits
  --------             --------      ------
  cpu                  200m <span class=o>(</span>0%<span class=o>)</span>     445m <span class=o>(</span>0%<span class=o>)</span>
  memory               195072k <span class=o>(</span>0%<span class=o>)</span>  893216k <span class=o>(</span>0%<span class=o>)</span>
  ephemeral-storage    <span class=m>0</span> <span class=o>(</span>0%<span class=o>)</span>        <span class=m>0</span> <span class=o>(</span>0%<span class=o>)</span>
  inspur.com/gpu       <span class=m>0</span>             <span class=m>0</span>
  inspur.com/rdma-hca  <span class=m>0</span>             <span class=m>0</span>
  nvidia.com/gpu       <span class=m>0</span>             <span class=m>0</span>
Events:
  Type    Reason    Age   From                       Message
  ----    ------    ----  ----                       -------
  Normal  Starting  16s   kube-proxy, hollow-node-0  Starting kube-proxy.

</code></pre></td></tr></table></div></div><p>然后再运行测试pod，pod定义如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myapp-pod</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span><span class=w>    </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker.io/busybox:latest</span><span class=w>
</span><span class=w>    </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;sleep&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;3600&#39;</span><span class=p>]</span><span class=w>
</span><span class=w>    </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>privileged</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2Mi&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>nvidia.com/gpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1&#34;</span><span class=w>
</span><span class=w>      </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2Mi&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>nvidia.com/gpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1&#34;</span><span class=w>        
</span><span class=w>  </span><span class=nt>affinity</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>nodeAffinity</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>requiredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>  </span><span class=c># 硬策略</span><span class=w>
</span><span class=w>            </span><span class=nt>nodeSelectorTerms</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span><span class=w>              </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>node-role.kubernetes.io/node</span><span class=w>
</span><span class=w>                </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>NotIn</span><span class=w>
</span><span class=w>                </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span><span class=w>                </span>- <span class=s2>&#34;true&#34;</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>运行测试pod后的集群信息如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>NAMESPACE     NAME                              READY   STATUS              RESTARTS   AGE    IP                NODE            NOMINATED NODE   READINESS GATES
default       myapp-pod                         1/1     Running             <span class=m>0</span>          15s    10.142.241.4      hollow-node-3   &lt;none&gt;           &lt;none&gt;
kube-system   calico-node-6n95j                 0/1     Init:0/1            <span class=m>0</span>          14m    10.233.96.49      hollow-node-5   &lt;none&gt;           &lt;none&gt;
kube-system   calico-node-g5qlq                 0/1     Init:0/1            <span class=m>0</span>          14m    10.233.96.51      hollow-node-1   &lt;none&gt;           &lt;none&gt;
kube-system   calico-node-g6rqs                 0/1     Init:0/1            <span class=m>0</span>          14m    10.233.96.46      hollow-node-3   &lt;none&gt;           &lt;none&gt;
kube-system   calico-node-m55zq                 0/1     Init:0/1            <span class=m>0</span>          14m    10.233.96.47      hollow-node-2   &lt;none&gt;           &lt;none&gt;
kube-system   calico-node-ms5t6                 1/1     Running             <span class=m>1</span>          22h    192.168.182.102   node2           &lt;none&gt;           &lt;none&gt;
kube-system   calico-node-n5528                 0/1     Init:0/1            <span class=m>0</span>          14m    10.233.96.50      hollow-node-0   &lt;none&gt;           &lt;none&gt;
kube-system   calico-node-njrr9                 0/1     Init:0/1            <span class=m>0</span>          14m    10.233.96.48      hollow-node-4   &lt;none&gt;           &lt;none&gt;
kube-system   calico-node-vxcb7                 1/1     Running             <span class=m>1</span>          22h    192.168.182.101   node1           &lt;none&gt;           &lt;none&gt;
kube-system   coredns-654c8ccdc8-575qx          1/1     Running             <span class=m>1</span>          22h    10.233.90.76      node1           &lt;none&gt;           &lt;none&gt;
kube-system   coredns-654c8ccdc8-m8ntn          0/1     Pending             <span class=m>0</span>          175d   &lt;none&gt;            &lt;none&gt;          &lt;none&gt;           &lt;none&gt;
kube-system   dns-autoscaler-77445c9c8b-b565h   1/1     Running             <span class=m>1</span>          22h    10.233.90.77      node1           &lt;none&gt;           &lt;none&gt;
kube-system   kube-apiserver-node1              1/1     Running             <span class=m>12</span>         22h    192.168.182.101   node1           &lt;none&gt;           &lt;none&gt;
kube-system   kube-controller-manager-node1     1/1     Running             <span class=m>12</span>         22h    192.168.182.101   node1           &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-dsghn                  1/1     Running             <span class=m>1</span>          22h    192.168.182.101   node1           &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-dzll2                  0/1     ContainerCreating   <span class=m>0</span>          14m    10.233.96.46      hollow-node-3   &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-fqfqx                  0/1     ContainerCreating   <span class=m>0</span>          14m    10.233.96.51      hollow-node-1   &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-fxcs4                  0/1     ContainerCreating   <span class=m>0</span>          14m    10.233.96.50      hollow-node-0   &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-gjzq8                  1/1     Running             <span class=m>1</span>          22h    192.168.182.102   node2           &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-khv5c                  0/1     ContainerCreating   <span class=m>0</span>          14m    10.233.96.48      hollow-node-4   &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-l7hzh                  0/1     ContainerCreating   <span class=m>0</span>          14m    10.233.96.49      hollow-node-5   &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-r5lfv                  0/1     ContainerCreating   <span class=m>0</span>          14m    10.233.96.47      hollow-node-2   &lt;none&gt;           &lt;none&gt;
kube-system   kube-scheduler-node1              1/1     Running             <span class=m>12</span>         22h    192.168.182.101   node1           &lt;none&gt;           &lt;none&gt;
kube-system   metrics-server-84d6dbd58b-sx7sl   0/2     ContainerCreating   <span class=m>0</span>          14m    &lt;none&gt;            hollow-node-0   &lt;none&gt;           &lt;none&gt;
kubemark      hollow-node-0                     2/2     Running             <span class=m>0</span>          14m    10.233.96.50      node2           &lt;none&gt;           &lt;none&gt;
kubemark      hollow-node-1                     2/2     Running             <span class=m>0</span>          14m    10.233.96.51      node2           &lt;none&gt;           &lt;none&gt;
kubemark      hollow-node-2                     2/2     Running             <span class=m>0</span>          14m    10.233.96.47      node2           &lt;none&gt;           &lt;none&gt;
kubemark      hollow-node-3                     2/2     Running             <span class=m>0</span>          14m    10.233.96.46      node2           &lt;none&gt;           &lt;none&gt;
kubemark      hollow-node-4                     2/2     Running             <span class=m>0</span>          14m    10.233.96.48      node2           &lt;none&gt;           &lt;none&gt;
kubemark      hollow-node-5                     2/2     Running             <span class=m>0</span>          14m    10.233.96.49      node2           &lt;none&gt;           &lt;none&gt;

</code></pre></td></tr></table></div></div><p><em>说明： 网络插件和proxy组件的非running态，并不影响集群测试使用，比如proxy使用了&ndash;use-real-proxier=false，并未使用真正的iptables</em></p><p>测试pod调度到了hollow-node-3上，hollow-node-3节点信息如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>Name:               hollow-node-3
Roles:              &lt;none&gt;
Labels:             beta.kubernetes.io/arch<span class=o>=</span>amd64
                    beta.kubernetes.io/os<span class=o>=</span>linux
                    kubernetes.io/arch<span class=o>=</span>amd64
                    kubernetes.io/hostname<span class=o>=</span>hollow-node-3
                    kubernetes.io/os<span class=o>=</span>linux
Annotations:        node.alpha.kubernetes.io/ttl: <span class=m>0</span>
CreationTimestamp:  Tue, <span class=m>08</span> Dec <span class=m>2020</span> 13:34:35 +0800
Taints:             &lt;none&gt;
Unschedulable:      <span class=nb>false</span>
Conditions:
  Type             Status  LastHeartbeatTime                 LastTransitionTime                Reason                       Message
  ----             ------  -----------------                 ------------------                ------                       -------
  MemoryPressure   False   Tue, <span class=m>08</span> Dec <span class=m>2020</span> 13:49:06 +0800   Tue, <span class=m>08</span> Dec <span class=m>2020</span> 13:34:35 +0800   KubeletHasSufficientMemory   kubelet has sufficient memory available
  DiskPressure     False   Tue, <span class=m>08</span> Dec <span class=m>2020</span> 13:49:06 +0800   Tue, <span class=m>08</span> Dec <span class=m>2020</span> 13:34:35 +0800   KubeletHasNoDiskPressure     kubelet has no disk pressure
  PIDPressure      False   Tue, <span class=m>08</span> Dec <span class=m>2020</span> 13:49:06 +0800   Tue, <span class=m>08</span> Dec <span class=m>2020</span> 13:34:35 +0800   KubeletHasSufficientPID      kubelet has sufficient PID available
  Ready            True    Tue, <span class=m>08</span> Dec <span class=m>2020</span> 13:49:06 +0800   Tue, <span class=m>08</span> Dec <span class=m>2020</span> 13:34:35 +0800   KubeletReady                 kubelet is posting ready status
Addresses:
  InternalIP:  10.233.96.46
  Hostname:    hollow-node-3
Capacity:
 cpu:                  <span class=m>72</span>
 ephemeral-storage:    15726578Mi
 inspur.com/gpu:       <span class=m>99999</span>
 inspur.com/rdma-hca:  <span class=m>99999</span>
 memory:               256Gi
 nvidia.com/gpu:       <span class=m>8</span>
 pods:                 <span class=m>110</span>
Allocatable:
 cpu:                  <span class=m>72</span>
 ephemeral-storage:    15726578Mi
 inspur.com/gpu:       <span class=m>99999</span>
 inspur.com/rdma-hca:  <span class=m>99999</span>
 memory:               256Gi
 nvidia.com/gpu:       <span class=m>8</span>
 pods:                 <span class=m>110</span>
System Info:
 Machine ID:
 System UUID:
 Boot ID:
 Kernel Version:             3.16.0-0.bpo.4-amd64
 OS Image:                   Debian GNU/Linux <span class=m>7</span> <span class=o>(</span>wheezy<span class=o>)</span>
 Operating System:           linux
 Architecture:               amd64
 Container Runtime Version:  docker://1.13.1
 Kubelet Version:            v0.0.0-master+4d3c9e0c
 Kube-Proxy Version:         v0.0.0-master+4d3c9e0c
PodCIDR:                     10.233.69.0/24
Non-terminated Pods:         <span class=o>(</span><span class=m>3</span> in total<span class=o>)</span>
  Namespace                  Name                 CPU Requests  CPU Limits  Memory Requests  Memory Limits  AGE
  ---------                  ----                 ------------  ----------  ---------------  -------------  ---
  default                    myapp-pod            <span class=m>1</span> <span class=o>(</span>1%<span class=o>)</span>        <span class=m>1</span> <span class=o>(</span>1%<span class=o>)</span>      2Mi <span class=o>(</span>0%<span class=o>)</span>         2Mi <span class=o>(</span>0%<span class=o>)</span>       33s
  kube-system                calico-node-g6rqs    150m <span class=o>(</span>0%<span class=o>)</span>     300m <span class=o>(</span>0%<span class=o>)</span>   64M <span class=o>(</span>0%<span class=o>)</span>         500M <span class=o>(</span>0%<span class=o>)</span>      14m
  kube-system                kube-proxy-dzll2     <span class=m>0</span> <span class=o>(</span>0%<span class=o>)</span>        <span class=m>0</span> <span class=o>(</span>0%<span class=o>)</span>      <span class=m>0</span> <span class=o>(</span>0%<span class=o>)</span>           <span class=m>0</span> <span class=o>(</span>0%<span class=o>)</span>         14m
Allocated resources:
  <span class=o>(</span>Total limits may be over <span class=m>100</span> percent, i.e., overcommitted.<span class=o>)</span>
  Resource             Requests      Limits
  --------             --------      ------
  cpu                  1150m <span class=o>(</span>1%<span class=o>)</span>    1300m <span class=o>(</span>1%<span class=o>)</span>
  memory               64548Ki <span class=o>(</span>0%<span class=o>)</span>  <span class=m>502097152</span> <span class=o>(</span>0%<span class=o>)</span>
  ephemeral-storage    <span class=m>0</span> <span class=o>(</span>0%<span class=o>)</span>        <span class=m>0</span> <span class=o>(</span>0%<span class=o>)</span>
  inspur.com/gpu       <span class=m>0</span>             <span class=m>0</span>
  inspur.com/rdma-hca  <span class=m>0</span>             <span class=m>0</span>
  nvidia.com/gpu       <span class=m>1</span>             <span class=m>1</span>
Events:
  Type    Reason    Age   From                       Message
  ----    ------    ----  ----                       -------
  Normal  Starting  14m   kube-proxy, hollow-node-3  Starting kube-proxy.
</code></pre></td></tr></table></div></div><p>由上面测试集群信息，可以看到模拟了4个桩节点可用于测试pod调度。</p><h3 id=kubemark源码>kubemark源码</h3><h4 id=程序入口>程序入口</h4><p>kubemark根据参数Morph，可执行kubelet和proxy流程，从而实现节点组件功能。</p><p>cmd/kubemark/hollow-node.go</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-golang data-lang=golang><span class=kd>func</span> <span class=nf>run</span><span class=p>(</span><span class=nx>config</span> <span class=o>*</span><span class=nx>hollowNodeConfig</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>!</span><span class=nx>knownMorphs</span><span class=p>.</span><span class=nf>Has</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>Morph</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>klog</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Unknown morph: %v. Allowed values: %v&#34;</span><span class=p>,</span> <span class=nx>config</span><span class=p>.</span><span class=nx>Morph</span><span class=p>,</span> <span class=nx>knownMorphs</span><span class=p>.</span><span class=nf>List</span><span class=p>())</span>
  <span class=p>}</span>

  <span class=c1>// create a client to communicate with API server.
</span><span class=c1></span>  <span class=nx>clientConfig</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>config</span><span class=p>.</span><span class=nf>createClientConfigFromFile</span><span class=p>()</span>
  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
    <span class=nx>klog</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Failed to create a ClientConfig: %v. Exiting.&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
  <span class=p>}</span>

  <span class=nx>client</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>clientset</span><span class=p>.</span><span class=nf>NewForConfig</span><span class=p>(</span><span class=nx>clientConfig</span><span class=p>)</span>
  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
    <span class=nx>klog</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Failed to create a ClientSet: %v. Exiting.&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
  <span class=p>}</span>

  <span class=k>if</span> <span class=nx>config</span><span class=p>.</span><span class=nx>Morph</span> <span class=o>==</span> <span class=s>&#34;kubelet&#34;</span> <span class=p>{</span>
    <span class=nx>cadvisorInterface</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>cadvisortest</span><span class=p>.</span><span class=nx>Fake</span><span class=p>{</span>
      <span class=nx>NodeName</span><span class=p>:</span> <span class=nx>config</span><span class=p>.</span><span class=nx>NodeName</span><span class=p>,</span>
    <span class=p>}</span>
    <span class=nx>containerManager</span> <span class=o>:=</span> <span class=nx>cm</span><span class=p>.</span><span class=nf>NewStubContainerManager</span><span class=p>()</span>

    <span class=nx>fakeDockerClientConfig</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>dockershim</span><span class=p>.</span><span class=nx>ClientConfig</span><span class=p>{</span>
      <span class=nx>DockerEndpoint</span><span class=p>:</span>    <span class=nx>libdocker</span><span class=p>.</span><span class=nx>FakeDockerEndpoint</span><span class=p>,</span>
      <span class=nx>EnableSleep</span><span class=p>:</span>       <span class=kc>true</span><span class=p>,</span>
      <span class=nx>WithTraceDisabled</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
    <span class=p>}</span>

    <span class=nx>hollowKubelet</span> <span class=o>:=</span> <span class=nx>kubemark</span><span class=p>.</span><span class=nf>NewHollowKubelet</span><span class=p>(</span>
      <span class=nx>config</span><span class=p>.</span><span class=nx>NodeName</span><span class=p>,</span>
      <span class=nx>client</span><span class=p>,</span>
      <span class=nx>cadvisorInterface</span><span class=p>,</span>
      <span class=nx>fakeDockerClientConfig</span><span class=p>,</span>
      <span class=nx>config</span><span class=p>.</span><span class=nx>KubeletPort</span><span class=p>,</span>
      <span class=nx>config</span><span class=p>.</span><span class=nx>KubeletReadOnlyPort</span><span class=p>,</span>
      <span class=nx>containerManager</span><span class=p>,</span>
      <span class=nx>maxPods</span><span class=p>,</span>
      <span class=nx>podsPerCore</span><span class=p>,</span>
    <span class=p>)</span>
    <span class=nx>hollowKubelet</span><span class=p>.</span><span class=nf>Run</span><span class=p>()</span>
  <span class=p>}</span>

  <span class=k>if</span> <span class=nx>config</span><span class=p>.</span><span class=nx>Morph</span> <span class=o>==</span> <span class=s>&#34;proxy&#34;</span> <span class=p>{</span>
    <span class=nx>client</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>clientset</span><span class=p>.</span><span class=nf>NewForConfig</span><span class=p>(</span><span class=nx>clientConfig</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
      <span class=nx>klog</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Failed to create API Server client: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=nx>iptInterface</span> <span class=o>:=</span> <span class=nx>fakeiptables</span><span class=p>.</span><span class=nf>NewFake</span><span class=p>()</span>
    <span class=nx>sysctl</span> <span class=o>:=</span> <span class=nx>fakesysctl</span><span class=p>.</span><span class=nf>NewFake</span><span class=p>()</span>
    <span class=nx>execer</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>fakeexec</span><span class=p>.</span><span class=nx>FakeExec</span><span class=p>{}</span>
    <span class=nx>eventBroadcaster</span> <span class=o>:=</span> <span class=nx>record</span><span class=p>.</span><span class=nf>NewBroadcaster</span><span class=p>()</span>
    <span class=nx>recorder</span> <span class=o>:=</span> <span class=nx>eventBroadcaster</span><span class=p>.</span><span class=nf>NewRecorder</span><span class=p>(</span><span class=nx>legacyscheme</span><span class=p>.</span><span class=nx>Scheme</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>EventSource</span><span class=p>{</span><span class=nx>Component</span><span class=p>:</span> <span class=s>&#34;kube-proxy&#34;</span><span class=p>,</span> <span class=nx>Host</span><span class=p>:</span> <span class=nx>config</span><span class=p>.</span><span class=nx>NodeName</span><span class=p>})</span>

    <span class=nx>hollowProxy</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>kubemark</span><span class=p>.</span><span class=nf>NewHollowProxyOrDie</span><span class=p>(</span>
      <span class=nx>config</span><span class=p>.</span><span class=nx>NodeName</span><span class=p>,</span>
      <span class=nx>client</span><span class=p>,</span>
      <span class=nx>client</span><span class=p>.</span><span class=nf>CoreV1</span><span class=p>(),</span>
      <span class=nx>iptInterface</span><span class=p>,</span>
      <span class=nx>sysctl</span><span class=p>,</span>
      <span class=nx>execer</span><span class=p>,</span>
      <span class=nx>eventBroadcaster</span><span class=p>,</span>
      <span class=nx>recorder</span><span class=p>,</span>
      <span class=nx>config</span><span class=p>.</span><span class=nx>UseRealProxier</span><span class=p>,</span>
      <span class=nx>config</span><span class=p>.</span><span class=nx>ProxierSyncPeriod</span><span class=p>,</span>
      <span class=nx>config</span><span class=p>.</span><span class=nx>ProxierMinSyncPeriod</span><span class=p>,</span>
    <span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
      <span class=nx>klog</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Failed to create hollowProxy instance: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=nx>hollowProxy</span><span class=p>.</span><span class=nf>Run</span><span class=p>()</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><h4 id=hollow_kubelet>hollow_kubelet</h4><p>pkg/kubemark/hollow_kubelet</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-golang data-lang=golang><span class=kd>type</span> <span class=nx>HollowKubelet</span> <span class=kd>struct</span> <span class=p>{</span>
  <span class=nx>KubeletFlags</span>         <span class=o>*</span><span class=nx>options</span><span class=p>.</span><span class=nx>KubeletFlags</span>
  <span class=nx>KubeletConfiguration</span> <span class=o>*</span><span class=nx>kubeletconfig</span><span class=p>.</span><span class=nx>KubeletConfiguration</span>
  <span class=nx>KubeletDeps</span>          <span class=o>*</span><span class=nx>kubelet</span><span class=p>.</span><span class=nx>Dependencies</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>NewHollowKubelet</span><span class=p>(</span>
  <span class=nx>nodeName</span> <span class=kt>string</span><span class=p>,</span>
  <span class=nx>client</span> <span class=o>*</span><span class=nx>clientset</span><span class=p>.</span><span class=nx>Clientset</span><span class=p>,</span>
  <span class=nx>cadvisorInterface</span> <span class=nx>cadvisor</span><span class=p>.</span><span class=nx>Interface</span><span class=p>,</span>
  <span class=nx>dockerClientConfig</span> <span class=o>*</span><span class=nx>dockershim</span><span class=p>.</span><span class=nx>ClientConfig</span><span class=p>,</span>
  <span class=nx>kubeletPort</span><span class=p>,</span> <span class=nx>kubeletReadOnlyPort</span> <span class=kt>int</span><span class=p>,</span>
  <span class=nx>containerManager</span> <span class=nx>cm</span><span class=p>.</span><span class=nx>ContainerManager</span><span class=p>,</span>
  <span class=nx>maxPods</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>podsPerCore</span> <span class=kt>int</span><span class=p>,</span>
<span class=p>)</span> <span class=o>*</span><span class=nx>HollowKubelet</span> <span class=p>{</span>
  <span class=c1>// -----------------
</span><span class=c1></span>  <span class=c1>// Static config
</span><span class=c1></span>  <span class=c1>// -----------------
</span><span class=c1></span>  <span class=nx>f</span><span class=p>,</span> <span class=nx>c</span> <span class=o>:=</span> <span class=nf>GetHollowKubeletConfig</span><span class=p>(</span><span class=nx>nodeName</span><span class=p>,</span> <span class=nx>kubeletPort</span><span class=p>,</span> <span class=nx>kubeletReadOnlyPort</span><span class=p>,</span> <span class=nx>maxPods</span><span class=p>,</span> <span class=nx>podsPerCore</span><span class=p>)</span>

  <span class=c1>// -----------------
</span><span class=c1></span>  <span class=c1>// Injected objects
</span><span class=c1></span>  <span class=c1>// -----------------
</span><span class=c1></span>  <span class=nx>volumePlugins</span> <span class=o>:=</span> <span class=nx>emptydir</span><span class=p>.</span><span class=nf>ProbeVolumePlugins</span><span class=p>()</span>
  <span class=nx>volumePlugins</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>volumePlugins</span><span class=p>,</span> <span class=nx>secret</span><span class=p>.</span><span class=nf>ProbeVolumePlugins</span><span class=p>()</span><span class=o>...</span><span class=p>)</span>
  <span class=nx>volumePlugins</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>volumePlugins</span><span class=p>,</span> <span class=nx>projected</span><span class=p>.</span><span class=nf>ProbeVolumePlugins</span><span class=p>()</span><span class=o>...</span><span class=p>)</span>
  <span class=nx>d</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>kubelet</span><span class=p>.</span><span class=nx>Dependencies</span><span class=p>{</span>
    <span class=nx>KubeClient</span><span class=p>:</span>         <span class=nx>client</span><span class=p>,</span>
    <span class=nx>HeartbeatClient</span><span class=p>:</span>    <span class=nx>client</span><span class=p>,</span>
    <span class=nx>DockerClientConfig</span><span class=p>:</span> <span class=nx>dockerClientConfig</span><span class=p>,</span>
    <span class=nx>CAdvisorInterface</span><span class=p>:</span>  <span class=nx>cadvisorInterface</span><span class=p>,</span>
    <span class=nx>Cloud</span><span class=p>:</span>              <span class=kc>nil</span><span class=p>,</span>
    <span class=nx>OSInterface</span><span class=p>:</span>        <span class=o>&amp;</span><span class=nx>containertest</span><span class=p>.</span><span class=nx>FakeOS</span><span class=p>{},</span>
    <span class=nx>ContainerManager</span><span class=p>:</span>   <span class=nx>containerManager</span><span class=p>,</span>
    <span class=nx>VolumePlugins</span><span class=p>:</span>      <span class=nx>volumePlugins</span><span class=p>,</span>
    <span class=nx>TLSOptions</span><span class=p>:</span>         <span class=kc>nil</span><span class=p>,</span>
    <span class=nx>OOMAdjuster</span><span class=p>:</span>        <span class=nx>oom</span><span class=p>.</span><span class=nf>NewFakeOOMAdjuster</span><span class=p>(),</span>
    <span class=nx>Mounter</span><span class=p>:</span>            <span class=nx>mount</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;&#34;</span> <span class=cm>/* default mount path */</span><span class=p>),</span>
    <span class=nx>Subpather</span><span class=p>:</span>          <span class=o>&amp;</span><span class=nx>subpath</span><span class=p>.</span><span class=nx>FakeSubpath</span><span class=p>{},</span>
  <span class=p>}</span>

  <span class=k>return</span> <span class=o>&amp;</span><span class=nx>HollowKubelet</span><span class=p>{</span>
    <span class=nx>KubeletFlags</span><span class=p>:</span>         <span class=nx>f</span><span class=p>,</span>
    <span class=nx>KubeletConfiguration</span><span class=p>:</span> <span class=nx>c</span><span class=p>,</span>
    <span class=nx>KubeletDeps</span><span class=p>:</span>          <span class=nx>d</span><span class=p>,</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=c1>// Starts this HollowKubelet and blocks.
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>hk</span> <span class=o>*</span><span class=nx>HollowKubelet</span><span class=p>)</span> <span class=nf>Run</span><span class=p>()</span> <span class=p>{</span>
  <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>kubeletapp</span><span class=p>.</span><span class=nf>RunKubelet</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>options</span><span class=p>.</span><span class=nx>KubeletServer</span><span class=p>{</span>
    <span class=nx>KubeletFlags</span><span class=p>:</span>         <span class=o>*</span><span class=nx>hk</span><span class=p>.</span><span class=nx>KubeletFlags</span><span class=p>,</span>
    <span class=nx>KubeletConfiguration</span><span class=p>:</span> <span class=o>*</span><span class=nx>hk</span><span class=p>.</span><span class=nx>KubeletConfiguration</span><span class=p>,</span>
  <span class=p>},</span> <span class=nx>hk</span><span class=p>.</span><span class=nx>KubeletDeps</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
    <span class=nx>klog</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Failed to run HollowKubelet: %v. Exiting.&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
  <span class=p>}</span>
  <span class=k>select</span> <span class=p>{}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><h4 id=hollow_proxy>hollow_proxy</h4><p>pkg/kubemark/hollow_proxy</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span><span class=lnt>96
</span><span class=lnt>97
</span><span class=lnt>98
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-golang data-lang=golang><span class=kd>type</span> <span class=nx>HollowProxy</span> <span class=kd>struct</span> <span class=p>{</span>
  <span class=nx>ProxyServer</span> <span class=o>*</span><span class=nx>proxyapp</span><span class=p>.</span><span class=nx>ProxyServer</span>
<span class=p>}</span>

<span class=kd>type</span> <span class=nx>FakeProxier</span> <span class=kd>struct</span><span class=p>{}</span>

<span class=kd>func</span> <span class=p>(</span><span class=o>*</span><span class=nx>FakeProxier</span><span class=p>)</span> <span class=nf>Sync</span><span class=p>()</span> <span class=p>{}</span>
<span class=kd>func</span> <span class=p>(</span><span class=o>*</span><span class=nx>FakeProxier</span><span class=p>)</span> <span class=nf>SyncLoop</span><span class=p>()</span> <span class=p>{</span>
  <span class=k>select</span> <span class=p>{}</span>
<span class=p>}</span>
<span class=kd>func</span> <span class=p>(</span><span class=o>*</span><span class=nx>FakeProxier</span><span class=p>)</span> <span class=nf>OnServiceAdd</span><span class=p>(</span><span class=nx>service</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Service</span><span class=p>)</span>                        <span class=p>{}</span>
<span class=kd>func</span> <span class=p>(</span><span class=o>*</span><span class=nx>FakeProxier</span><span class=p>)</span> <span class=nf>OnServiceUpdate</span><span class=p>(</span><span class=nx>oldService</span><span class=p>,</span> <span class=nx>service</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Service</span><span class=p>)</span>         <span class=p>{}</span>
<span class=kd>func</span> <span class=p>(</span><span class=o>*</span><span class=nx>FakeProxier</span><span class=p>)</span> <span class=nf>OnServiceDelete</span><span class=p>(</span><span class=nx>service</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Service</span><span class=p>)</span>                     <span class=p>{}</span>
<span class=kd>func</span> <span class=p>(</span><span class=o>*</span><span class=nx>FakeProxier</span><span class=p>)</span> <span class=nf>OnServiceSynced</span><span class=p>()</span>                                        <span class=p>{}</span>
<span class=kd>func</span> <span class=p>(</span><span class=o>*</span><span class=nx>FakeProxier</span><span class=p>)</span> <span class=nf>OnEndpointsAdd</span><span class=p>(</span><span class=nx>endpoints</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Endpoints</span><span class=p>)</span>                  <span class=p>{}</span>
<span class=kd>func</span> <span class=p>(</span><span class=o>*</span><span class=nx>FakeProxier</span><span class=p>)</span> <span class=nf>OnEndpointsUpdate</span><span class=p>(</span><span class=nx>oldEndpoints</span><span class=p>,</span> <span class=nx>endpoints</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Endpoints</span><span class=p>)</span> <span class=p>{}</span>
<span class=kd>func</span> <span class=p>(</span><span class=o>*</span><span class=nx>FakeProxier</span><span class=p>)</span> <span class=nf>OnEndpointsDelete</span><span class=p>(</span><span class=nx>endpoints</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Endpoints</span><span class=p>)</span>               <span class=p>{}</span>
<span class=kd>func</span> <span class=p>(</span><span class=o>*</span><span class=nx>FakeProxier</span><span class=p>)</span> <span class=nf>OnEndpointsSynced</span><span class=p>()</span>                                      <span class=p>{}</span>

<span class=kd>func</span> <span class=nf>NewHollowProxyOrDie</span><span class=p>(</span>
  <span class=nx>nodeName</span> <span class=kt>string</span><span class=p>,</span>
  <span class=nx>client</span> <span class=nx>clientset</span><span class=p>.</span><span class=nx>Interface</span><span class=p>,</span>
  <span class=nx>eventClient</span> <span class=nx>v1core</span><span class=p>.</span><span class=nx>EventsGetter</span><span class=p>,</span>
  <span class=nx>iptInterface</span> <span class=nx>utiliptables</span><span class=p>.</span><span class=nx>Interface</span><span class=p>,</span>
  <span class=nx>sysctl</span> <span class=nx>utilsysctl</span><span class=p>.</span><span class=nx>Interface</span><span class=p>,</span>
  <span class=nx>execer</span> <span class=nx>utilexec</span><span class=p>.</span><span class=nx>Interface</span><span class=p>,</span>
  <span class=nx>broadcaster</span> <span class=nx>record</span><span class=p>.</span><span class=nx>EventBroadcaster</span><span class=p>,</span>
  <span class=nx>recorder</span> <span class=nx>record</span><span class=p>.</span><span class=nx>EventRecorder</span><span class=p>,</span>
  <span class=nx>useRealProxier</span> <span class=kt>bool</span><span class=p>,</span>
  <span class=nx>proxierSyncPeriod</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>,</span>
  <span class=nx>proxierMinSyncPeriod</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>,</span>
<span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>HollowProxy</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// Create proxier and service/endpoint handlers.
</span><span class=c1></span>  <span class=kd>var</span> <span class=nx>proxier</span> <span class=nx>proxy</span><span class=p>.</span><span class=nx>ProxyProvider</span>
  <span class=kd>var</span> <span class=nx>serviceHandler</span> <span class=nx>proxyconfig</span><span class=p>.</span><span class=nx>ServiceHandler</span>
  <span class=kd>var</span> <span class=nx>endpointsHandler</span> <span class=nx>proxyconfig</span><span class=p>.</span><span class=nx>EndpointsHandler</span>

  <span class=k>if</span> <span class=nx>useRealProxier</span> <span class=p>{</span>
    <span class=c1>// Real proxier with fake iptables, sysctl, etc underneath it.
</span><span class=c1></span>    <span class=c1>//var err error
</span><span class=c1></span>    <span class=nx>proxierIPTables</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>iptables</span><span class=p>.</span><span class=nf>NewProxier</span><span class=p>(</span>
      <span class=nx>iptInterface</span><span class=p>,</span>
      <span class=nx>sysctl</span><span class=p>,</span>
      <span class=nx>execer</span><span class=p>,</span>
      <span class=nx>proxierSyncPeriod</span><span class=p>,</span>
      <span class=nx>proxierMinSyncPeriod</span><span class=p>,</span>
      <span class=kc>false</span><span class=p>,</span>
      <span class=mi>0</span><span class=p>,</span>
      <span class=s>&#34;10.0.0.0/8&#34;</span><span class=p>,</span>
      <span class=nx>nodeName</span><span class=p>,</span>
      <span class=nx>utilnode</span><span class=p>.</span><span class=nf>GetNodeIP</span><span class=p>(</span><span class=nx>client</span><span class=p>,</span> <span class=nx>nodeName</span><span class=p>),</span>
      <span class=nx>recorder</span><span class=p>,</span>
      <span class=kc>nil</span><span class=p>,</span>
      <span class=p>[]</span><span class=kt>string</span><span class=p>{},</span>
    <span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
      <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;unable to create proxier: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=nx>proxier</span> <span class=p>=</span> <span class=nx>proxierIPTables</span>
    <span class=nx>serviceHandler</span> <span class=p>=</span> <span class=nx>proxierIPTables</span>
    <span class=nx>endpointsHandler</span> <span class=p>=</span> <span class=nx>proxierIPTables</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=nx>proxier</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>FakeProxier</span><span class=p>{}</span>
    <span class=nx>serviceHandler</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>FakeProxier</span><span class=p>{}</span>
    <span class=nx>endpointsHandler</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>FakeProxier</span><span class=p>{}</span>
  <span class=p>}</span>

  <span class=c1>// Create a Hollow Proxy instance.
</span><span class=c1></span>  <span class=nx>nodeRef</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>v1</span><span class=p>.</span><span class=nx>ObjectReference</span><span class=p>{</span>
    <span class=nx>Kind</span><span class=p>:</span>      <span class=s>&#34;Node&#34;</span><span class=p>,</span>
    <span class=nx>Name</span><span class=p>:</span>      <span class=nx>nodeName</span><span class=p>,</span>
    <span class=nx>UID</span><span class=p>:</span>       <span class=nx>types</span><span class=p>.</span><span class=nf>UID</span><span class=p>(</span><span class=nx>nodeName</span><span class=p>),</span>
    <span class=nx>Namespace</span><span class=p>:</span> <span class=s>&#34;&#34;</span><span class=p>,</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=o>&amp;</span><span class=nx>HollowProxy</span><span class=p>{</span>
    <span class=nx>ProxyServer</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>proxyapp</span><span class=p>.</span><span class=nx>ProxyServer</span><span class=p>{</span>
      <span class=nx>Client</span><span class=p>:</span>                <span class=nx>client</span><span class=p>,</span>
      <span class=nx>EventClient</span><span class=p>:</span>           <span class=nx>eventClient</span><span class=p>,</span>
      <span class=nx>IptInterface</span><span class=p>:</span>          <span class=nx>iptInterface</span><span class=p>,</span>
      <span class=nx>Proxier</span><span class=p>:</span>               <span class=nx>proxier</span><span class=p>,</span>
      <span class=nx>Broadcaster</span><span class=p>:</span>           <span class=nx>broadcaster</span><span class=p>,</span>
      <span class=nx>Recorder</span><span class=p>:</span>              <span class=nx>recorder</span><span class=p>,</span>
      <span class=nx>ProxyMode</span><span class=p>:</span>             <span class=s>&#34;fake&#34;</span><span class=p>,</span>
      <span class=nx>NodeRef</span><span class=p>:</span>               <span class=nx>nodeRef</span><span class=p>,</span>
      <span class=nx>OOMScoreAdj</span><span class=p>:</span>           <span class=nx>utilpointer</span><span class=p>.</span><span class=nf>Int32Ptr</span><span class=p>(</span><span class=mi>0</span><span class=p>),</span>
      <span class=nx>ResourceContainer</span><span class=p>:</span>     <span class=s>&#34;&#34;</span><span class=p>,</span>
      <span class=nx>ConfigSyncPeriod</span><span class=p>:</span>      <span class=mi>30</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span>
      <span class=nx>ServiceEventHandler</span><span class=p>:</span>   <span class=nx>serviceHandler</span><span class=p>,</span>
      <span class=nx>EndpointsEventHandler</span><span class=p>:</span> <span class=nx>endpointsHandler</span><span class=p>,</span>
    <span class=p>},</span>
  <span class=p>},</span> <span class=kc>nil</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>hp</span> <span class=o>*</span><span class=nx>HollowProxy</span><span class=p>)</span> <span class=nf>Run</span><span class=p>()</span> <span class=p>{</span>
  <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>hp</span><span class=p>.</span><span class=nx>ProxyServer</span><span class=p>.</span><span class=nf>Run</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
    <span class=nx>klog</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Error while running proxy: %v\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><h3 id=kubemark总结>kubemark总结</h3><ol><li>kubemark实际上是个K8S组件，包含了kubelet和一个controller，模拟桩节点主要使用了kubelet功能。</li><li>kubemark通过在真实节点上构造批量的hollow-node的pod方式，模拟运行了大量的桩节点。这些桩节点可以定时跟master同步状态和信息。</li><li>kubemark一般用于测试master节点上的组件的性能测试，比如测试调度器和控制器组件性能。</li><li>kubemark由于其构造方式，决定其不能测试node节点组件，比如kubelet性能和网络等。</li></ol><h2 id=3-测试框架>3 测试框架</h2><p>可参考k8s的perf-test</p><ul><li><p><a href=https://blog.csdn.net/qingdao666666/article/details/104625457 target=_blank rel="noopener noreffer">Kubernetes测试系列 - 性能测试</a></p></li><li><p><a href=https://juejin.cn/post/6844904142389919758 target=_blank rel="noopener noreffer">kubernetes性能指标体系：clusterloader2</a></p></li><li><p><a href=https://www.colabug.com/2020/0428/7329883/ target=_blank rel="noopener noreffer">clusterloader2的漫漫踩坑路：最详细解析与使用指南</a></p></li><li><p><a href=https://github.com/kubernetes/perf-tests/blob/master/clusterloader2/docs/design.md target=_blank rel="noopener noreffer">clusterloader2设计说明：Cluster loader vision</a></p></li></ul><h2 id=4-附录>4 附录</h2><p>参考操作命令。。。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=o>[</span>root@test-master ~<span class=o>]</span><span class=c1># kubectl get secret -A |grep kubeconfig</span>
kubemark          kubeconfig                                       Opaque                                <span class=m>2</span>      94s

<span class=o>[</span>root@test-master ~<span class=o>]</span><span class=c1># kubectl describe secret -nkubemark          kubeconfig</span>
Name:         kubeconfig
Namespace:    kubemark
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;

Type:  Opaque

<span class=nv>Data</span>
<span class=o>====</span>
kubelet.kubeconfig:    <span class=m>5463</span> bytes
kubeproxy.kubeconfig:  <span class=m>5463</span> bytes

<span class=c1>#### 如果要删除刚刚创建的secret和 configmap</span>

kubectl delete secret -nkubemark          kubeconfig
kubectl delete configmap -n kubemark node-configmap 
kubectl delete ns kubemark


--force --grace-period<span class=o>=</span><span class=m>0</span>

<span class=c1>#### 强制删除资源</span>
kubectl delete po --force --grace-period<span class=o>=</span><span class=m>0</span> -nkube-system   kube-proxy-p6k42 

<span class=c1>### 删除kubemark命名空间下所有node资源</span>
kubectl delete no --all -n kubemark


<span class=c1>#### 设置master节点不可调度</span>
<span class=c1># kubectl cordon nodename</span>

kubectl cordon node1

<span class=c1># kubectl uncordon nodename       #取消</span>


<span class=c1>#### 节点打标签</span>

kubectl label node  node1 <span class=nv>accessswitch</span><span class=o>=</span>switch1
kubectl label node  node1 <span class=nv>groupId</span><span class=o>=</span>defaultGroup
kubectl label node  node1 node-role.kubernetes.io/master<span class=o>=</span><span class=nb>true</span>
kubectl label node  node1 node-role.kubernetes.io/node<span class=o>=</span><span class=nb>true</span>
kubectl label node  node1 <span class=nv>switchtype</span><span class=o>=</span>ether

kubectl label node  node2 <span class=nv>accessswitch</span><span class=o>=</span>switch1
kubectl label node  node2 <span class=nv>groupId</span><span class=o>=</span>defaultGroup
kubectl label node  node2 node-role.kubernetes.io/node<span class=o>=</span><span class=nb>true</span>
kubectl label node  node2 <span class=nv>switchtype</span><span class=o>=</span>ether


</code></pre></td></tr></table></div></div><p>修改hollow-node信息，不是node的全部信息都可以修改更新，如capacity等字段无法更新</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>kubectl patch node hollow-node-0 -p <span class=s1>&#39;{&#34;spec&#34;:{&#34;unschedulable&#34;:true}}&#39;</span>
</code></pre></td></tr></table></div></div><p>e2e测试
编译e2e.test
make WHAT=&ldquo;test/e2e/e2e.test&rdquo;</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=c1># 进入k8s项目，进行测试工具编译</span>
make <span class=nv>WHAT</span><span class=o>=</span><span class=s2>&#34;test/e2e/e2e.test&#34;</span>

<span class=c1># 在目录下能够看到输出文件如下：</span>
<span class=o>[</span>root@node1 k8s1.14.8modify-wangb<span class=o>]</span><span class=c1># ll _output/bin/ -h</span>
total 241M
-rwxr-xr-x. <span class=m>1</span> root root 5.9M Dec  <span class=m>7</span> 10:04 conversion-gen
-rwxr-xr-x. <span class=m>1</span> root root 5.9M Dec  <span class=m>7</span> 10:04 deepcopy-gen
-rwxr-xr-x. <span class=m>1</span> root root 5.9M Dec  <span class=m>7</span> 10:04 defaulter-gen
-rwxr-xr-x. <span class=m>1</span> root root 110M Dec  <span class=m>7</span> 17:01 e2e.test
-rwxr-xr-x. <span class=m>1</span> root root 3.5M Dec  <span class=m>7</span> 10:04 go2make
-rwxr-xr-x. <span class=m>1</span> root root 2.0M Dec  <span class=m>7</span> 10:04 go-bindata
-rwxr-xr-x. <span class=m>1</span> root root  99M Dec  <span class=m>7</span> 10:05 kubemark
-rwxr-xr-x. <span class=m>1</span> root root  10M Dec  <span class=m>7</span> 10:04 openapi-gen


<span class=c1># 把 e2e.test 文件拷贝到测试集群的master节点上</span>


</code></pre></td></tr></table></div></div><p>需要注意：网上的搜到的文章大多数都是编译e2e的二进制文件直接运行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=c1>#./e2e.test --kube-master=192.168.182.101 --host=https://192.168.182.101:6443 --ginkgo.focus=&#34;\[Performance\]&#34; --provider=local --kubeconfig=kubemark.kubeconfig --num-nodes=10 --v=3 --ginkgo.failFast --e2e-output-dir=. --report-dir=.</span>


./e2e.test --kube-master<span class=o>=</span>192.168.182.101 --host<span class=o>=</span>https://192.168.182.101:6443 --ginkgo.focus<span class=o>=</span><span class=s2>&#34;\[Performance\]&#34;</span> --provider<span class=o>=</span><span class=nb>local</span> --kubeconfig<span class=o>=</span>/root/.kube/config --num-nodes<span class=o>=</span><span class=m>4</span> --v<span class=o>=</span><span class=m>3</span> --ginkgo.failFast --e2e-output-dir<span class=o>=</span>. --report-dir<span class=o>=</span>.
</code></pre></td></tr></table></div></div><p>但其实e2e的性能用例已经被移出主库了 <a href=https://github.com/kubernetes/kubernetes/pull/83322>https://github.com/kubernetes/kubernetes/pull/83322</a>，所以在2019.10.1之后出的版本用上面的命令是无法运行性能测试的</p><br><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw"></i>Deployment中pod创建的流程<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content><ol><li>apiserver收到创建deployment的请求，存储至etcd，告知controller-manager</li><li>controller-manager创建pod的壳子，打上creationTimeStamp，发送请求到apiserver</li><li>apiserver收到创建pod的请求，发送至etcd，推送到scheduler。</li><li>schduler选择node，填充nodeName，向apiserver更新pod信息。此时pod处于pending状态，pod也没有真正创建。</li><li>apiserver向etcd更新pod信息，同时推送到相应节点的kubelet</li><li>kubelet创建pod，填充HostIP与resourceVersion，向apiserver发送更新请求，pod处于pending状态</li><li>apiserver更新pod信息至etcd，同时kubelet继续创建pod。等到容器都处于running状态，kubelet再次发送pod的更新请求给apiserver，此时pod running</li><li>apiserver收到请求，更新到etcd中，并推送到informer中，informer记录下watchPhase</li></ol></div></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2020-12-08</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/k8s/>K8S</a>,&nbsp;<a href=/tags/go/>GO</a></section><section><span><a href=javascript:void(0); onclick=window.history.back();>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/basic-markdown-syntax/ class=prev rel=prev title="[转载]Markdown 基本语法"><i class="fas fa-angle-left fa-fw"></i>[转载]Markdown 基本语法</a>
<a href=/2020-12-15-perf-test-clusterloader/ class=next rel=next title=K8S集群性能测试-clusterloader>K8S集群性能测试-clusterloader<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2016 - 2020</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=bingerambo.com target=_blank>Binge</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=http://bingerambo.com/ target=_blank>bingerambo.com</a></span></div><div class=footer-line><i class="fa fa-eye"></i>本站总访问量<span id=busuanzi_value_site_pv></span>次
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true}};</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','UA-81425808-1',{'anonymize_ip':true});</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=UA-81425808-1" async></script><script src=https://libs.baidu.com/jquery/2.1.4/jquery.min.js></script><script src=https://cdn.bootcdn.net/ajax/libs/jquery-backstretch/2.1.18/jquery.backstretch.min.js></script><script type=text/javascript src=/js/custom.js></script></body></html>