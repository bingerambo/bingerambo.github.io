<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>K8S集群性能测试-clusterloader - 斌哥的小站|Binge Blog</title><meta name=Description content="如何使用perf-test的clusterloader进行性能测试"><meta property="og:title" content="K8S集群性能测试-clusterloader"><meta property="og:description" content="如何使用perf-test的clusterloader进行性能测试"><meta property="og:type" content="article"><meta property="og:url" content="http://bingerambo.com/2020-12-15-perf-test-clusterloader/"><meta property="og:image" content="http://bingerambo.com/logo.png"><meta property="article:published_time" content="2020-12-15T08:43:17+08:00"><meta property="article:modified_time" content="2020-12-15T08:43:17+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://bingerambo.com/logo.png"><meta name=twitter:title content="K8S集群性能测试-clusterloader"><meta name=twitter:description content="如何使用perf-test的clusterloader进行性能测试"><meta name=application-name content="Binge Blog"><meta name=apple-mobile-web-app-title content="Binge Blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=http://bingerambo.com/2020-12-15-perf-test-clusterloader/><link rel=prev href=http://bingerambo.com/2020-12-08-kubemark-perf-test/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"K8S集群性能测试-clusterloader","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/bingerambo.com\/2020-12-15-perf-test-clusterloader\/"},"image":["http:\/\/bingerambo.com\/images\/Apple-Devices-Preview.png"],"genre":"posts","keywords":"K8S","wordcount":14283,"url":"http:\/\/bingerambo.com\/2020-12-15-perf-test-clusterloader\/","datePublished":"2020-12-15T08:43:17+08:00","dateModified":"2020-12-15T08:43:17+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"xxxx","logo":"http:\/\/bingerambo.com\/images\/avatar.png"},"author":{"@type":"Person","name":"Binge"},"description":"如何使用perf-test的clusterloader进行性能测试"}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="斌哥的小站|Binge Blog"><span class=header-title-pre><i class="fas fa-biking fa-fw"></i></span>Binge Blog</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/><i class="fas fa-fw fa-archive"></i>文章 </a><a class=menu-item href=/tags/><i class="fas fa-fw fa-tag"></i>标签 </a><a class=menu-item href=/categories/><i class="fas fa-fw fa-th"></i>分类 </a><a class=menu-item href=/notes/><i class="fas fa-cog fa-spin"></i>随记 </a><a class=menu-item href=/about/><i class="fas fa-fw fa-at"></i>关于 </a><a class=menu-item href=/search/><i class="fas fa-fw fa-search"></i>搜索 </a><a class=menu-item href=https://github.com/bingerambo title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><a class=menu-item href=/><i class="fas fa fa-user"></i><span id=busuanzi_value_site_uv></span></a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="斌哥的小站|Binge Blog"><span class=header-title-pre><i class="fas fa-biking fa-fw"></i></span>Binge Blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/><i class="fas fa-fw fa-archive"></i>文章</a><a class=menu-item href=/tags/><i class="fas fa-fw fa-tag"></i>标签</a><a class=menu-item href=/categories/><i class="fas fa-fw fa-th"></i>分类</a><a class=menu-item href=/notes/><i class="fas fa-cog fa-spin"></i>随记</a><a class=menu-item href=/about/><i class="fas fa-fw fa-at"></i>关于</a><a class=menu-item href=/search/><i class="fas fa-fw fa-search"></i>搜索</a><a class=menu-item href=https://github.com/bingerambo title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><a class=menu-item href=/><i class="fas fa fa-user"></i><span id=busuanzi_value_site_uv></span></a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">K8S集群性能测试-clusterloader</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=http://bingerambo.com title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw"></i>Binge</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/k8s/><i class="far fa-folder fa-fw"></i>K8S</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2020-12-15>2020-12-15</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 14283 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 29 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#1-k8s的性能指标slisslos>1 K8S的性能指标：SLIs/SLOs</a></li><li><a href=#2-clusterloader准备>2 clusterloader准备</a></li><li><a href=#3-clusterloader测试>3 clusterloader测试</a><ul><li><a href=#1-运行命令>1. 运行命令</a></li><li><a href=#2-测试配置文件-test-config默认>2. 测试配置文件 test config（默认）</a><ul><li><a href=#test-configyaml默认配置>test config.yaml（默认配置）</a></li><li><a href=#rcyaml>rc.yaml</a></li><li><a href=#deploymentyaml>deployment.yaml</a></li></ul></li><li><a href=#3-clusterloader2-源码简析>3. clusterloader2 源码简析</a><ul><li><a href=#measurement处理>Measurement处理</a></li><li><a href=#phases处理>Phases处理</a></li></ul></li><li><a href=#4-部署测试>4. 部署测试</a><ul><li><a href=#1-k8s-2节点环境>.1 k8s-2节点环境</a><ul><li><a href=#1-部署configyaml>.1 部署config.yaml</a></li><li><a href=#2-部署rcyaml>.2 部署rc.yaml</a></li><li><a href=#3-部署测试信息>.3 部署测试信息</a></li><li><a href=#4-测试报告>.4 测试报告</a></li></ul></li><li><a href=#2-kubemark节点环境>.2 kubemark节点环境</a><ul><li><a href=#node-pod状态>node-pod状态</a></li><li><a href=#测试1>测试1</a></li><li><a href=#测试2>测试2</a></li><li><a href=#测试3>测试3</a></li><li><a href=#测试4>测试4</a></li></ul></li></ul></li></ul></li><li><a href=#4-问题>4 问题</a><ul><li><a href=#1-提示-getting-master-name-error-master-node-not-found和-getting-master-internal-ip-error-didnt-find-any-internalip-master-ips>1. 提示 Getting master name error: master node not found和 Getting master internal ip error: didn&rsquo;t find any InternalIP master IPs</a></li><li><a href=#2--errors-measurement-call-testmetrics---testmetrics-error-unexpected-error-code-0-in-ssh-connection-to-master-errorserrorstringserror-getting-signer-for-provider--getsigner-not-implemented-for->2. Errors: [measurement call TestMetrics - TestMetrics error: [unexpected error (code: 0) in ssh connection to master: &errors.errorString{s:&ldquo;error getting signer for provider : &lsquo;GetSigner(&mldr;) not implemented for &lsquo;"}]</a></li><li><a href=#3-告警提示master-node-is-not-registered-grabbing-metrics-from-scheduler-controllermanager-and-clusterautoscaler-is-disabled>3. 告警提示：Master node is not registered. Grabbing metrics from Scheduler, ControllerManager and ClusterAutoscaler is disabled.</a></li><li><a href=#4-etcdmetrics信息获取不到etcdmetrics-failed-to-collect-etcd-database-size>4. EtcdMetrics信息获取不到：EtcdMetrics: failed to collect etcd database size</a></li><li><a href=#5报错找不到资源--testmetrics-the-server-could-not-find-the-requested-resource-get-pods-kube-scheduler-19216818210110251>5.报错找不到资源 TestMetrics: [the server could not find the requested resource (get pods kube-scheduler-192.168.182.101:10251)]</a></li><li><a href=#6-测试结果指标异常输出>6. 测试结果指标异常输出</a></li></ul></li><li><a href=#5-总结>5 总结</a></li><li><a href=#6-附录>6 附录</a><ul><li><ul><li><a href=#k8s的sli-服务等级指标-和-slo-服务等级目标>K8S的SLI (服务等级指标) 和 SLO (服务等级目标)</a></li></ul></li><li><a href=#etcd监控指标>Etcd监控指标</a><ul><li><a href=#领导者相关>领导者相关</a></li><li><a href=#网络相关>网络相关</a></li><li><a href=#提案相关>提案相关</a></li><li><a href=#这些指标描述了磁盘操作的状态>这些指标描述了磁盘操作的状态。</a></li><li><a href=#快照>快照</a></li><li><a href=#文件>文件</a></li></ul></li></ul></li></ul></nav></div></div><div class=content id=content><p>如何使用perf-test的clusterloader进行性能测试</p><img src=/images/k8s/featured-image.jpg><h2 id=1-k8s的性能指标slisslos>1 K8S的性能指标：SLIs/SLOs</h2><p>K8S的SLI (服务等级指标) 和 SLO (服务等级目标)：
Kubernetes 社区提供的K8S系统性能测试指标定义。</p><p>社区参考文档：<a href=https://github.com/kubernetes/community/blob/master/sig-scalability/slos/slos.md target=_blank rel="noopener noreffer">Kubernetes scalability and performance SLIs/SLOs</a></p><p>目前社区提供的<code>官方正式</code>的性能指标有3个，如下表：</p><table><thead><tr><th>Status</th><th>SLI</th><th>SLO</th></tr></thead><tbody><tr><td>Official</td><td>Latency of mutating API calls for single objects for every (resource, verb) pair, measured as 99th percentile over last 5 minutes</td><td>In default Kubernetes installation, for every (resource, verb) pair, excluding virtual and aggregated resources and Custom Resource Definitions, 99th percentile per cluster-day1 &lt;= 1s</td></tr><tr><td>Official</td><td>Latency of non-streaming read-only API calls for every (resource, scope pair, measured as 99th percentile over last 5 minutes</td><td>In default Kubernetes installation, for every (resource, scope) pair, excluding virtual and aggregated resources and Custom Resource Definitions, 99th percentile per cluster-day1 (a) &lt;= 1s if scope=resource (b) &lt;= 5s if scope=namespace (c) &lt;= 30s if scope=cluster</td></tr><tr><td>Official</td><td>Startup latency of schedulable stateless pods, excluding time to pull images and run init containers, measured from pod creation timestamp to when all its containers are reported as started and observed via watch, measured as 99th percentile over last 5 minutes</td><td>In default Kubernetes installation, 99th percentile per cluster-day1 &lt;= 5s</td></tr></tbody></table><h2 id=2-clusterloader准备>2 clusterloader准备</h2><ol><li>从github上拉取<a href=https://github.com/kubernetes/perf-tests target=_blank rel="noopener noreffer">perf-test项目</a>，其中包含clusterloader2。perf-tests位置为：$GOPATH/src/k8s.io/perf-tests<ul><li>需要选择与测试k8s集群匹配的版本，这里选择了1.14版本</li></ul></li><li>进入clusterloader2目录，进行编译</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=nb>export</span> <span class=nv>GOPATH</span><span class=o>=</span>/home/wangb/goprojects
<span class=nb>cd</span> <span class=nv>$GOPATH</span>/src/k8s.io/perf-tests/clusterloader2
go build -o clusterloader <span class=s1>&#39;./cmd/&#39;</span>
</code></pre></td></tr></table></div></div><ol start=3><li>clusterloader2的测试配置文件在testing目录下。可以参考修改配置</li><li>按修改后的测试配置文件，指定参数变量，执行clusterloader测试</li></ol><h2 id=3-clusterloader测试>3 clusterloader测试</h2><h3 id=1-运行命令>1. 运行命令</h3><p><strong>说明：运行命令前，需要根据测试场景，修改测试配置文件中的变量参数，配置文件包括有config.yaml， rc.yaml，deployment.yaml
具体配置参数说明，见下文。</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>
<span class=c1># 进入clusterloader可执行文件目录，配置文件也需转移到了此位置</span>
<span class=nb>cd</span> /home/wangb/perf-test/clusterloader2
<span class=c1># ssh访问参数</span>
<span class=nb>export</span> <span class=nv>KUBE_SSH_KEY_PATH</span><span class=o>=</span>/root/.ssh/id_rsa
<span class=c1># master节点信息</span>
<span class=nv>MASTER_NAME</span><span class=o>=</span>node1
<span class=nv>TEST_MASTER_IP</span><span class=o>=</span>192.168.182.101
<span class=nv>TEST_MASTER_INTERNAL_IP</span><span class=o>=</span>192.168.182.101
<span class=nv>KUBE_CONFIG</span><span class=o>=</span><span class=si>${</span><span class=nv>HOME</span><span class=si>}</span>/.kube/config
<span class=c1># 测试配置文件</span>
<span class=nv>TEST_CONFIG</span><span class=o>=</span><span class=s1>&#39;/home/wangb/perf-test/clusterloader2/testing/density/config2.yaml&#39;</span>
<span class=c1># 测试报告目录位置</span>
<span class=nv>REPORT_DIR</span><span class=o>=</span><span class=s1>&#39;./reports&#39;</span>
<span class=c1># 测试日志打印文件</span>
<span class=nv>LOG_FILE</span><span class=o>=</span><span class=s1>&#39;test.log&#39;</span>


./clusterloader --kubeconfig<span class=o>=</span><span class=nv>$KUBE_CONFIG</span> <span class=se>\
</span><span class=se></span>    --mastername<span class=o>=</span><span class=nv>$TEST_MASTER_IP</span> <span class=se>\
</span><span class=se></span>    --masterip<span class=o>=</span><span class=nv>$MASTER_IP</span> <span class=se>\
</span><span class=se></span>    --master-internal-ip<span class=o>=</span>TEST_MASTER_INTERNAL_IP <span class=se>\
</span><span class=se></span>    --testconfig<span class=o>=</span><span class=nv>$TEST_CONFIG</span> <span class=se>\
</span><span class=se></span>    --report-dir<span class=o>=</span><span class=nv>$REPORT_DIR</span> <span class=se>\
</span><span class=se></span>    --alsologtostderr 2&gt;<span class=p>&amp;</span><span class=m>1</span> <span class=p>|</span> tee <span class=nv>$LOG_FILE</span>
</code></pre></td></tr></table></div></div><h3 id=2-测试配置文件-test-config默认>2. 测试配置文件 test config（默认）</h3><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw"></i>density 测试配置<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content><ul><li>Steps is the procedures you defined. Each step might contain phases, measurements</li><li>Meansurement defines what you want to supervise or capture.</li><li>Phase describes the attributes of some certain tasks.</li></ul></div></div></div><div class="details admonition tip open"><div class="details-summary admonition-title"><i class="icon fas fa-lightbulb fa-fw"></i>This config defines the following steps:<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content><ol><li>Starting measurements
: don’t care about what happens during preparation.</li><li>Starting saturation pod measurements
: same as above</li><li>Creating saturation pods
: the first case is saturation pods</li><li>Collecting saturation pod measurements</li><li>Starting latency pod measurements</li><li>Creating latency pods
: the second case is latency pods</li><li>Waiting for latency pods to be running</li><li>Deleting latency pods</li><li>Waiting for latency pods to be deleted</li><li>Collecting pod startup latency</li><li>Deleting saturation pods</li><li>Waiting for saturation pods to be deleted</li><li>Collecting measurements</li></ol></div></div></div><p><strong>So we can see the testing mainly gathers measurements during the CRUD of saturation pods and latency pods:</strong></p><ul><li>saturation pods: pods in deployments with quite a large repliacas</li><li>latency pods: pods in deployments with one replicas</li></ul><p>So you see the differences between the two modes. When saturation pods are created, replicas-controller in kube-controller-manager is handling one event. But in terms of latency pods, it’s hundreds of events. But what’s the difference anyway? It’s because the various rate-limiter inside kubernetes affects the performance of scheduler and controller-manager.</p><p>In each case, what we’re concerned is the number of pods, deployments and namespaces. We all know that kubernetes limits the pods/node, pods/namespace, so it’s quite essential to adust relative parameters to achieve a reasonable load.</p><h4 id=test-configyaml默认配置>test config.yaml（默认配置）</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=c># ASSUMPTIONS:</span><span class=w>
</span><span class=w></span><span class=c># - Underlying cluster should have 100+ nodes.</span><span class=w>
</span><span class=w></span><span class=c># - Number of nodes should be divisible by NODES_PER_NAMESPACE (default 100).</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=c>#Constants</span><span class=w>
</span><span class=w></span>{{<span class=l>$DENSITY_RESOURCE_CONSTRAINTS_FILE := DefaultParam .DENSITY_RESOURCE_CONSTRAINTS_FILE &#34;&#34;}}</span><span class=w>
</span><span class=w></span>{{<span class=l>$NODE_MODE := DefaultParam .NODE_MODE &#34;allnodes&#34;}}</span><span class=w>
</span><span class=w></span>{{<span class=l>$NODES_PER_NAMESPACE := DefaultParam .NODES_PER_NAMESPACE 100}}</span><span class=w>
</span><span class=w></span>{{<span class=l>$PODS_PER_NODE := DefaultParam .PODS_PER_NODE 30}}</span><span class=w>
</span><span class=w></span>{{<span class=l>$DENSITY_TEST_THROUGHPUT := DefaultParam .DENSITY_TEST_THROUGHPUT 20}}</span><span class=w>
</span><span class=w></span><span class=c># LATENCY_POD_MEMORY and LATENCY_POD_CPU are calculated for 1-core 4GB node.</span><span class=w>
</span><span class=w></span><span class=c># Increasing allocation of both memory and cpu by 10%</span><span class=w>
</span><span class=w></span><span class=c># decreases the value of priority function in scheduler by one point.</span><span class=w>
</span><span class=w></span><span class=c># This results in decreased probability of choosing the same node again.</span><span class=w>
</span><span class=w></span>{{<span class=l>$LATENCY_POD_CPU := DefaultParam .LATENCY_POD_CPU 100}}</span><span class=w>
</span><span class=w></span>{{<span class=l>$LATENCY_POD_MEMORY := DefaultParam .LATENCY_POD_MEMORY 350}}</span><span class=w>
</span><span class=w></span>{{<span class=l>$MIN_LATENCY_PODS := 500}}</span><span class=w>
</span><span class=w></span>{{<span class=l>$MIN_SATURATION_PODS_TIMEOUT := 180}}</span><span class=w>
</span><span class=w></span>{{<span class=l>$ENABLE_CHAOSMONKEY := DefaultParam .ENABLE_CHAOSMONKEY false}}</span><span class=w>
</span><span class=w></span>{{<span class=l>$ENABLE_SYSTEM_POD_METRICS:= DefaultParam .ENABLE_SYSTEM_POD_METRICS true}}</span><span class=w>
</span><span class=w></span>{{<span class=l>$ENABLE_RESTART_COUNT_CHECK := DefaultParam .ENABLE_RESTART_COUNT_CHECK false}}</span><span class=w>
</span><span class=w></span>{{<span class=l>$RESTART_COUNT_THRESHOLD_OVERRIDES:= DefaultParam .RESTART_COUNT_THRESHOLD_OVERRIDES &#34;&#34;}}</span><span class=w>
</span><span class=w></span><span class=c>#Variables</span><span class=w>
</span><span class=w></span>{{<span class=l>$namespaces := DivideInt .Nodes $NODES_PER_NAMESPACE}}</span><span class=w>
</span><span class=w></span>{{<span class=l>$podsPerNamespace := MultiplyInt $PODS_PER_NODE $NODES_PER_NAMESPACE}}</span><span class=w>
</span><span class=w></span>{{<span class=l>$totalPods := MultiplyInt $podsPerNamespace $namespaces}}</span><span class=w>
</span><span class=w></span>{{<span class=l>$latencyReplicas := DivideInt (MaxInt $MIN_LATENCY_PODS .Nodes) $namespaces}}</span><span class=w>
</span><span class=w></span>{{<span class=l>$totalLatencyPods := MultiplyInt $namespaces $latencyReplicas}}</span><span class=w>
</span><span class=w></span>{{<span class=l>$saturationRCTimeout := DivideFloat $totalPods $DENSITY_TEST_THROUGHPUT | AddInt $MIN_SATURATION_PODS_TIMEOUT}}</span><span class=w>
</span><span class=w></span><span class=c># saturationRCHardTimeout must be at least 20m to make sure that ~10m node</span><span class=w>
</span><span class=w></span><span class=c># failure won&#39;t fail the test. See https://github.com/kubernetes/kubernetes/issues/73461#issuecomment-467338711</span><span class=w>
</span><span class=w></span>{{<span class=l>$saturationRCHardTimeout := MaxInt $saturationRCTimeout 1200}}</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>density</span><span class=w>
</span><span class=w></span><span class=nt>automanagedNamespaces</span><span class=p>:</span><span class=w> </span>{{<span class=l>$namespaces}}</span><span class=w>
</span><span class=w></span><span class=nt>tuningSets</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Uniform5qps</span><span class=w>
</span><span class=w>  </span><span class=nt>qpsLoad</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>qps</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span><span class=w></span>{{<span class=l>if $ENABLE_CHAOSMONKEY}}</span><span class=w>
</span><span class=w></span><span class=nt>chaosMonkey</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>nodeFailure</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>failureRate</span><span class=p>:</span><span class=w> </span><span class=m>0.01</span><span class=w>
</span><span class=w>    </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=l>1m</span><span class=w>
</span><span class=w>    </span><span class=nt>jitterFactor</span><span class=p>:</span><span class=w> </span><span class=m>10.0</span><span class=w>
</span><span class=w>    </span><span class=nt>simulatedDowntime</span><span class=p>:</span><span class=w> </span><span class=l>10m</span><span class=w>
</span><span class=w></span>{{<span class=l>end}}</span><span class=w>
</span><span class=w></span><span class=nt>steps</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>measurements</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>Identifier</span><span class=p>:</span><span class=w> </span><span class=l>APIResponsiveness</span><span class=w>
</span><span class=w>    </span><span class=nt>Method</span><span class=p>:</span><span class=w> </span><span class=l>APIResponsiveness</span><span class=w>
</span><span class=w>    </span><span class=nt>Params</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>reset</span><span class=w>
</span><span class=w>  </span>- <span class=nt>Identifier</span><span class=p>:</span><span class=w> </span><span class=l>TestMetrics</span><span class=w>
</span><span class=w>    </span><span class=nt>Method</span><span class=p>:</span><span class=w> </span><span class=l>TestMetrics</span><span class=w>
</span><span class=w>    </span><span class=nt>Params</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>start</span><span class=w>
</span><span class=w>      </span><span class=nt>nodeMode</span><span class=p>:</span><span class=w> </span>{{<span class=l>$NODE_MODE}}</span><span class=w>
</span><span class=w>      </span><span class=nt>resourceConstraints</span><span class=p>:</span><span class=w> </span>{{<span class=l>$DENSITY_RESOURCE_CONSTRAINTS_FILE}}</span><span class=w>
</span><span class=w>      </span><span class=nt>systemPodMetricsEnabled</span><span class=p>:</span><span class=w> </span>{{<span class=l>$ENABLE_SYSTEM_POD_METRICS}}</span><span class=w>
</span><span class=w>      </span><span class=nt>restartCountThresholdOverrides</span><span class=p>:</span><span class=w> </span>{{<span class=l>YamlQuote $RESTART_COUNT_THRESHOLD_OVERRIDES 4}}</span><span class=w>
</span><span class=w>      </span><span class=nt>enableRestartCountCheck</span><span class=p>:</span><span class=w> </span>{{<span class=l>$ENABLE_RESTART_COUNT_CHECK}}</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=c># Create saturation pods</span><span class=w>
</span><span class=w></span>- <span class=nt>measurements</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>Identifier</span><span class=p>:</span><span class=w> </span><span class=l>SaturationPodStartupLatency</span><span class=w>
</span><span class=w>    </span><span class=nt>Method</span><span class=p>:</span><span class=w> </span><span class=l>PodStartupLatency</span><span class=w>
</span><span class=w>    </span><span class=nt>Params</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>start</span><span class=w>
</span><span class=w>      </span><span class=nt>labelSelector</span><span class=p>:</span><span class=w> </span><span class=l>group = saturation</span><span class=w>
</span><span class=w>      </span><span class=nt>threshold</span><span class=p>:</span><span class=w> </span>{{<span class=l>$saturationRCTimeout}}s</span><span class=w>
</span><span class=w></span>- <span class=nt>measurements</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>Identifier</span><span class=p>:</span><span class=w> </span><span class=l>WaitForRunningSaturationRCs</span><span class=w>
</span><span class=w>    </span><span class=nt>Method</span><span class=p>:</span><span class=w> </span><span class=l>WaitForControlledPodsRunning</span><span class=w>
</span><span class=w>    </span><span class=nt>Params</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>start</span><span class=w>
</span><span class=w>      </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w>      </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ReplicationController</span><span class=w>
</span><span class=w>      </span><span class=nt>labelSelector</span><span class=p>:</span><span class=w> </span><span class=l>group = saturation</span><span class=w>
</span><span class=w>      </span><span class=nt>operationTimeout</span><span class=p>:</span><span class=w> </span>{{<span class=l>$saturationRCHardTimeout}}s</span><span class=w>
</span><span class=w></span>- <span class=nt>phases</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>namespaceRange</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>min</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>      </span><span class=nt>max</span><span class=p>:</span><span class=w> </span>{{<span class=l>$namespaces}}</span><span class=w>
</span><span class=w>    </span><span class=nt>replicasPerNamespace</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>    </span><span class=nt>tuningSet</span><span class=p>:</span><span class=w> </span><span class=l>Uniform5qps</span><span class=w>
</span><span class=w>    </span><span class=nt>objectBundle</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>basename</span><span class=p>:</span><span class=w> </span><span class=l>saturation-rc</span><span class=w>
</span><span class=w>      </span><span class=nt>objectTemplatePath</span><span class=p>:</span><span class=w> </span><span class=l>rc.yaml</span><span class=w>
</span><span class=w>      </span><span class=nt>templateFillMap</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>Replicas</span><span class=p>:</span><span class=w> </span>{{<span class=l>$podsPerNamespace}}</span><span class=w>
</span><span class=w>        </span><span class=nt>Group</span><span class=p>:</span><span class=w> </span><span class=l>saturation</span><span class=w>
</span><span class=w>        </span><span class=nt>CpuRequest</span><span class=p>:</span><span class=w> </span><span class=l>1m</span><span class=w>
</span><span class=w>        </span><span class=nt>MemoryRequest</span><span class=p>:</span><span class=w> </span><span class=l>10M</span><span class=w>
</span><span class=w></span>- <span class=nt>measurements</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>Identifier</span><span class=p>:</span><span class=w> </span><span class=l>SchedulingThroughput</span><span class=w>
</span><span class=w>    </span><span class=nt>Method</span><span class=p>:</span><span class=w> </span><span class=l>SchedulingThroughput</span><span class=w>
</span><span class=w>    </span><span class=nt>Params</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>start</span><span class=w>
</span><span class=w>      </span><span class=nt>labelSelector</span><span class=p>:</span><span class=w> </span><span class=l>group = saturation</span><span class=w>
</span><span class=w></span>- <span class=nt>measurements</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>Identifier</span><span class=p>:</span><span class=w> </span><span class=l>WaitForRunningSaturationRCs</span><span class=w>
</span><span class=w>    </span><span class=nt>Method</span><span class=p>:</span><span class=w> </span><span class=l>WaitForControlledPodsRunning</span><span class=w>
</span><span class=w>    </span><span class=nt>Params</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>gather</span><span class=w>
</span><span class=w></span>- <span class=nt>measurements</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>Identifier</span><span class=p>:</span><span class=w> </span><span class=l>SaturationPodStartupLatency</span><span class=w>
</span><span class=w>    </span><span class=nt>Method</span><span class=p>:</span><span class=w> </span><span class=l>PodStartupLatency</span><span class=w>
</span><span class=w>    </span><span class=nt>Params</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>gather</span><span class=w>
</span><span class=w></span>- <span class=nt>measurements</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>Identifier</span><span class=p>:</span><span class=w> </span><span class=l>SchedulingThroughput</span><span class=w>
</span><span class=w>    </span><span class=nt>Method</span><span class=p>:</span><span class=w> </span><span class=l>SchedulingThroughput</span><span class=w>
</span><span class=w>    </span><span class=nt>Params</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>gather</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Creating saturation pods</span><span class=w>
</span><span class=w></span><span class=c># Create latency pods</span><span class=w>
</span><span class=w></span>- <span class=nt>measurements</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>Identifier</span><span class=p>:</span><span class=w> </span><span class=l>PodStartupLatency</span><span class=w>
</span><span class=w>    </span><span class=nt>Method</span><span class=p>:</span><span class=w> </span><span class=l>PodStartupLatency</span><span class=w>
</span><span class=w>    </span><span class=nt>Params</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>start</span><span class=w>
</span><span class=w>      </span><span class=nt>labelSelector</span><span class=p>:</span><span class=w> </span><span class=l>group = latency</span><span class=w>
</span><span class=w></span>- <span class=nt>measurements</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>Identifier</span><span class=p>:</span><span class=w> </span><span class=l>WaitForRunningLatencyRCs</span><span class=w>
</span><span class=w>    </span><span class=nt>Method</span><span class=p>:</span><span class=w> </span><span class=l>WaitForControlledPodsRunning</span><span class=w>
</span><span class=w>    </span><span class=nt>Params</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>start</span><span class=w>
</span><span class=w>      </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w>      </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ReplicationController</span><span class=w>
</span><span class=w>      </span><span class=nt>labelSelector</span><span class=p>:</span><span class=w> </span><span class=l>group = latency</span><span class=w>
</span><span class=w>      </span><span class=nt>operationTimeout</span><span class=p>:</span><span class=w> </span><span class=l>15m</span><span class=w>
</span><span class=w></span>- <span class=nt>phases</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>namespaceRange</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>min</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>      </span><span class=nt>max</span><span class=p>:</span><span class=w> </span>{{<span class=l>$namespaces}}</span><span class=w>
</span><span class=w>    </span><span class=nt>replicasPerNamespace</span><span class=p>:</span><span class=w> </span>{{<span class=l>$latencyReplicas}}</span><span class=w>
</span><span class=w>    </span><span class=nt>tuningSet</span><span class=p>:</span><span class=w> </span><span class=l>Uniform5qps</span><span class=w>
</span><span class=w>    </span><span class=nt>objectBundle</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>basename</span><span class=p>:</span><span class=w> </span><span class=l>latency-pod-rc</span><span class=w>
</span><span class=w>      </span><span class=nt>objectTemplatePath</span><span class=p>:</span><span class=w> </span><span class=l>rc.yaml</span><span class=w>
</span><span class=w>      </span><span class=nt>templateFillMap</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>Replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>        </span><span class=nt>Group</span><span class=p>:</span><span class=w> </span><span class=l>latency</span><span class=w>
</span><span class=w>        </span><span class=nt>CpuRequest</span><span class=p>:</span><span class=w> </span>{{<span class=l>$LATENCY_POD_CPU}}m</span><span class=w>
</span><span class=w>        </span><span class=nt>MemoryRequest</span><span class=p>:</span><span class=w> </span>{{<span class=l>$LATENCY_POD_MEMORY}}M</span><span class=w>
</span><span class=w></span>- <span class=nt>measurements</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>Identifier</span><span class=p>:</span><span class=w> </span><span class=l>WaitForRunningLatencyRCs</span><span class=w>
</span><span class=w>    </span><span class=nt>Method</span><span class=p>:</span><span class=w> </span><span class=l>WaitForControlledPodsRunning</span><span class=w>
</span><span class=w>    </span><span class=nt>Params</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>gather</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Creating latency pods</span><span class=w>
</span><span class=w></span><span class=c># Remove latency pods</span><span class=w>
</span><span class=w></span>- <span class=nt>phases</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>namespaceRange</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>min</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>      </span><span class=nt>max</span><span class=p>:</span><span class=w> </span>{{<span class=l>$namespaces}}</span><span class=w>
</span><span class=w>    </span><span class=nt>replicasPerNamespace</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span><span class=w>    </span><span class=nt>tuningSet</span><span class=p>:</span><span class=w> </span><span class=l>Uniform5qps</span><span class=w>
</span><span class=w>    </span><span class=nt>objectBundle</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>basename</span><span class=p>:</span><span class=w> </span><span class=l>latency-pod-rc</span><span class=w>
</span><span class=w>      </span><span class=nt>objectTemplatePath</span><span class=p>:</span><span class=w> </span><span class=l>rc.yaml</span><span class=w>
</span><span class=w></span>- <span class=nt>measurements</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>Identifier</span><span class=p>:</span><span class=w> </span><span class=l>WaitForRunningLatencyRCs</span><span class=w>
</span><span class=w>    </span><span class=nt>Method</span><span class=p>:</span><span class=w> </span><span class=l>WaitForControlledPodsRunning</span><span class=w>
</span><span class=w>    </span><span class=nt>Params</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>gather</span><span class=w>
</span><span class=w></span>- <span class=nt>measurements</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>Identifier</span><span class=p>:</span><span class=w> </span><span class=l>PodStartupLatency</span><span class=w>
</span><span class=w>    </span><span class=nt>Method</span><span class=p>:</span><span class=w> </span><span class=l>PodStartupLatency</span><span class=w>
</span><span class=w>    </span><span class=nt>Params</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>gather</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Deleting latancy pods</span><span class=w>
</span><span class=w></span><span class=c># Delete pods</span><span class=w>
</span><span class=w></span>- <span class=nt>phases</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>namespaceRange</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>min</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>      </span><span class=nt>max</span><span class=p>:</span><span class=w> </span>{{<span class=l>$namespaces}}</span><span class=w>
</span><span class=w>    </span><span class=nt>replicasPerNamespace</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span><span class=w>    </span><span class=nt>tuningSet</span><span class=p>:</span><span class=w> </span><span class=l>Uniform5qps</span><span class=w>
</span><span class=w>    </span><span class=nt>objectBundle</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>basename</span><span class=p>:</span><span class=w> </span><span class=l>saturation-rc</span><span class=w>
</span><span class=w>      </span><span class=nt>objectTemplatePath</span><span class=p>:</span><span class=w> </span><span class=l>rc.yaml</span><span class=w>
</span><span class=w></span>- <span class=nt>measurements</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>Identifier</span><span class=p>:</span><span class=w> </span><span class=l>WaitForRunningSaturationRCs</span><span class=w>
</span><span class=w>    </span><span class=nt>Method</span><span class=p>:</span><span class=w> </span><span class=l>WaitForControlledPodsRunning</span><span class=w>
</span><span class=w>    </span><span class=nt>Params</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>gather</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Deleting saturation pods</span><span class=w>
</span><span class=w></span><span class=c># Collect measurements</span><span class=w>
</span><span class=w></span>- <span class=nt>measurements</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>Identifier</span><span class=p>:</span><span class=w> </span><span class=l>APIResponsiveness</span><span class=w>
</span><span class=w>    </span><span class=nt>Method</span><span class=p>:</span><span class=w> </span><span class=l>APIResponsiveness</span><span class=w>
</span><span class=w>    </span><span class=nt>Params</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>gather</span><span class=w>
</span><span class=w>  </span>- <span class=nt>Identifier</span><span class=p>:</span><span class=w> </span><span class=l>TestMetrics</span><span class=w>
</span><span class=w>    </span><span class=nt>Method</span><span class=p>:</span><span class=w> </span><span class=l>TestMetrics</span><span class=w>
</span><span class=w>    </span><span class=nt>Params</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>gather</span><span class=w>
</span><span class=w>      </span><span class=nt>systemPodMetricsEnabled</span><span class=p>:</span><span class=w> </span>{{<span class=l>$ENABLE_SYSTEM_POD_METRICS}}</span><span class=w>
</span><span class=w>      </span><span class=nt>restartCountThresholdOverrides</span><span class=p>:</span><span class=w> </span>{{<span class=l>YamlQuote $RESTART_COUNT_THRESHOLD_OVERRIDES 4}}</span><span class=w>
</span><span class=w>      </span><span class=nt>enableRestartCountCheck</span><span class=p>:</span><span class=w> </span>{{<span class=l>$ENABLE_RESTART_COUNT_CHECK}}</span><span class=w>
</span><span class=w>
</span></code></pre></td></tr></table></div></div><h4 id=rcyaml>rc.yaml</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ReplicationController</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span>{{<span class=l>.Name}}</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>group</span><span class=p>:</span><span class=w> </span>{{<span class=l>.Group}}</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span>{{<span class=l>.Replicas}}</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span>{{<span class=l>.Name}}</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span>{{<span class=l>.Name}}</span><span class=w>
</span><span class=w>        </span><span class=nt>group</span><span class=p>:</span><span class=w> </span>{{<span class=l>.Group}}</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>k8s.gcr.io/pause:3.1</span><span class=w>
</span><span class=w>        </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span>{{<span class=l>.Name}}</span><span class=w>
</span><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span>{{<span class=l>.CpuRequest}}</span><span class=w>
</span><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span>{{<span class=l>.MemoryRequest}}</span><span class=w>
</span><span class=w>      </span><span class=c># Add not-ready/unreachable tolerations for 15 minutes so that node</span><span class=w>
</span><span class=w>      </span><span class=c># failure doesn&#39;t trigger pod deletion.</span><span class=w>
</span><span class=w>      </span><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;node.kubernetes.io/not-ready&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Exists&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;NoExecute&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>tolerationSeconds</span><span class=p>:</span><span class=w> </span><span class=m>900</span><span class=w>
</span><span class=w>      </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;node.kubernetes.io/unreachable&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Exists&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;NoExecute&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>tolerationSeconds</span><span class=p>:</span><span class=w> </span><span class=m>900</span><span class=w>
</span><span class=w>
</span></code></pre></td></tr></table></div></div><h4 id=deploymentyaml>deployment.yaml</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span>{{<span class=l>.Name}}</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>group</span><span class=p>:</span><span class=w> </span>{{<span class=l>.Group}}</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span>{{<span class=l>.Replicas}}</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span>{{<span class=l>.Name}}</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span>{{<span class=l>.Name}}</span><span class=w>
</span><span class=w>        </span><span class=nt>group</span><span class=p>:</span><span class=w> </span>{{<span class=l>.Group}}</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>k8s.gcr.io/pause:3.1</span><span class=w>
</span><span class=w>        </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span>{{<span class=l>.Name}}</span><span class=w>
</span><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span>{{<span class=l>.CpuRequest}}</span><span class=w>
</span><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span>{{<span class=l>.MemoryRequest}}</span><span class=w>
</span><span class=w>      </span><span class=c># Add not-ready/unreachable tolerations for 15 minutes so that node</span><span class=w>
</span><span class=w>      </span><span class=c># failure doesn&#39;t trigger pod deletion.</span><span class=w>
</span><span class=w>      </span><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;node.kubernetes.io/not-ready&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Exists&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;NoExecute&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>tolerationSeconds</span><span class=p>:</span><span class=w> </span><span class=m>900</span><span class=w>
</span><span class=w>      </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;node.kubernetes.io/unreachable&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Exists&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;NoExecute&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>tolerationSeconds</span><span class=p>:</span><span class=w> </span><span class=m>900</span><span class=w>
</span><span class=w>
</span></code></pre></td></tr></table></div></div><h3 id=3-clusterloader2-源码简析>3. clusterloader2 源码简析</h3><p>解析测试配置信息，执行测试测试用例
clusterloader2/cmd/clusterloader.go</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-golang data-lang=golang><span class=nx>void</span> <span class=nf>main</span><span class=p>(){</span>

    <span class=c1>// 构造clusterLoaderConfig
</span><span class=c1></span>
    <span class=c1>// 构造framework，即各种k8s client
</span><span class=c1></span>    <span class=nx>f</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>NewFramework</span><span class=p>(</span>
        <span class=o>&amp;</span><span class=nx>clusterLoaderConfig</span><span class=p>.</span><span class=nx>ClusterConfig</span><span class=p>,</span>
        <span class=nf>getClientsNumber</span><span class=p>(</span><span class=nx>clusterLoaderConfig</span><span class=p>.</span><span class=nx>ClusterConfig</span><span class=p>.</span><span class=nx>Nodes</span><span class=p>),</span>
    <span class=p>)</span>
    <span class=c1>// 遍历测试配置文件（可多个），按配置用例运行测试
</span><span class=c1></span>    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>clusterLoaderConfig</span><span class=p>.</span><span class=nx>TestConfigPath</span> <span class=p>=</span> <span class=k>range</span> <span class=nx>testConfigPaths</span> <span class=p>{</span>
        <span class=nx>test</span><span class=p>.</span><span class=nf>RunTest</span><span class=p>(</span><span class=nx>f</span><span class=p>,</span> <span class=nx>prometheusFramework</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>clusterLoaderConfig</span><span class=p>)</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=c1>// RunTest runs test based on provided test configuration.
</span><span class=c1></span><span class=kd>func</span> <span class=nf>RunTest</span><span class=p>(</span><span class=nx>clusterFramework</span><span class=p>,</span> <span class=nx>prometheusFramework</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Framework</span><span class=p>,</span> <span class=nx>clusterLoaderConfig</span> <span class=o>*</span><span class=nx>config</span><span class=p>.</span><span class=nx>ClusterLoaderConfig</span><span class=p>)</span> <span class=o>*</span><span class=nx>errors</span><span class=p>.</span><span class=nx>ErrorList</span> <span class=p>{</span>

    <span class=c1>// simpleContext上下文信息
</span><span class=c1></span>    <span class=nx>ctx</span> <span class=o>:=</span> <span class=nf>CreateContext</span><span class=p>(</span><span class=nx>clusterLoaderConfig</span><span class=p>,</span> <span class=nx>clusterFramework</span><span class=p>,</span> <span class=nx>prometheusFramework</span><span class=p>,</span> <span class=nx>state</span><span class=p>.</span><span class=nf>NewState</span><span class=p>())</span>
    <span class=nx>testConfigFilename</span> <span class=o>:=</span> <span class=nx>filepath</span><span class=p>.</span><span class=nf>Base</span><span class=p>(</span><span class=nx>clusterLoaderConfig</span><span class=p>.</span><span class=nx>TestConfigPath</span><span class=p>)</span>
    <span class=c1>// 按参数 设置override config 和 nodes参数
</span><span class=c1></span>    <span class=nx>mapping</span><span class=p>,</span> <span class=nx>errList</span> <span class=o>:=</span> <span class=nx>config</span><span class=p>.</span><span class=nf>GetMapping</span><span class=p>(</span><span class=nx>clusterLoaderConfig</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>errList</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nx>errList</span>
    <span class=p>}</span>
    <span class=c1>// 使用emplateProvider根据mapping信息把testConfig的模板文件渲染成可用的api.Config
</span><span class=c1></span>    <span class=nx>testConfig</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ctx</span><span class=p>.</span><span class=nf>GetTemplateProvider</span><span class=p>().</span><span class=nf>TemplateToConfig</span><span class=p>(</span><span class=nx>testConfigFilename</span><span class=p>,</span> <span class=nx>mapping</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>NewErrorList</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;config reading error: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>))</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=nx>Test</span><span class=p>.</span><span class=nf>ExecuteTest</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>testConfig</span><span class=p>)</span>
<span class=p>}</span>

<span class=c1>// api.Config 定义
</span><span class=c1>// Config is a structure that represents configuration
</span><span class=c1>// for a single test scenario.
</span><span class=c1></span><span class=kd>type</span> <span class=nx>Config</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=c1>// Name of the test case.
</span><span class=c1></span>    <span class=nx>Name</span> <span class=kt>string</span> <span class=s>`json: name`</span>
    <span class=c1>// AutomanagedNamespaces is a number of automanaged namespaces.
</span><span class=c1></span>    <span class=nx>AutomanagedNamespaces</span> <span class=kt>int32</span> <span class=s>`json: automanagedNamespaces`</span>
    <span class=c1>// Steps is a sequence of test steps executed in serial.
</span><span class=c1></span>    <span class=nx>Steps</span> <span class=p>[]</span><span class=nx>Step</span> <span class=s>`json: steps`</span>
    <span class=c1>// TuningSets is a collection of tuning sets that can be used by steps.
</span><span class=c1></span>    <span class=nx>TuningSets</span> <span class=p>[]</span><span class=nx>TuningSet</span> <span class=s>`json: tuningSets`</span>
    <span class=c1>// ChaosMonkey is a config for simulated component failures.
</span><span class=c1></span>    <span class=nx>ChaosMonkey</span> <span class=nx>ChaosMonkeyConfig</span> <span class=s>`json: chaosMonkey`</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>RunTest 又调用了 ExecuteTest，示例代码如下：
循环steps，按顺序执行ExecuteStep</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-golang data-lang=golang><span class=c1>// ExecuteTest executes test based on provided configuration.
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>ste</span> <span class=o>*</span><span class=nx>simpleTestExecutor</span><span class=p>)</span> <span class=nf>ExecuteTest</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>Context</span><span class=p>,</span> <span class=nx>conf</span> <span class=o>*</span><span class=nx>api</span><span class=p>.</span><span class=nx>Config</span><span class=p>)</span>  <span class=p>{</span>

    <span class=c1>// auto set test namespace
</span><span class=c1></span>  <span class=nx>ctx</span><span class=p>.</span><span class=nf>GetClusterFramework</span><span class=p>().</span><span class=nf>SetAutomanagedNamespacePrefix</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;test-%s&#34;</span><span class=p>,</span> <span class=nx>util</span><span class=p>.</span><span class=nf>RandomDNS1123String</span><span class=p>(</span><span class=mi>6</span><span class=p>)))</span>
  <span class=c1>// clear test resource
</span><span class=c1></span>  <span class=k>defer</span> <span class=nf>cleanupResources</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>  
  <span class=c1>// create test namespace
</span><span class=c1></span>  <span class=nx>err</span> <span class=p>=</span> <span class=nx>ctx</span><span class=p>.</span><span class=nf>GetClusterFramework</span><span class=p>().</span><span class=nf>CreateAutomanagedNamespaces</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=nx>conf</span><span class=p>.</span><span class=nx>AutomanagedNamespaces</span><span class=p>))</span>
  <span class=c1>// 遍历steps，分步执行，如果某step出错stepErr，则退出。
</span><span class=c1></span>  <span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>conf</span><span class=p>.</span><span class=nx>Steps</span> <span class=p>{</span>
    <span class=k>if</span> <span class=nx>stepErrList</span> <span class=o>:=</span> <span class=nx>ste</span><span class=p>.</span><span class=nf>ExecuteStep</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>conf</span><span class=p>.</span><span class=nx>Steps</span><span class=p>[</span><span class=nx>i</span><span class=p>]);</span> <span class=p>!</span><span class=nx>stepErrList</span><span class=p>.</span><span class=nf>IsEmpty</span><span class=p>()</span> <span class=p>{</span>
      <span class=nx>errList</span><span class=p>.</span><span class=nf>Concat</span><span class=p>(</span><span class=nx>stepErrList</span><span class=p>)</span>
      <span class=k>if</span> <span class=nf>isErrsCritical</span><span class=p>(</span><span class=nx>stepErrList</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nx>errList</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=c1>// 输出测试汇总信息
</span><span class=c1></span>  <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>summary</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>ctx</span><span class=p>.</span><span class=nf>GetMeasurementManager</span><span class=p>().</span><span class=nf>GetSummaries</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>if</span> <span class=nx>ctx</span><span class=p>.</span><span class=nf>GetClusterLoaderConfig</span><span class=p>().</span><span class=nx>ReportDir</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
      <span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;%v: %v&#34;</span><span class=p>,</span> <span class=nx>summary</span><span class=p>.</span><span class=nf>SummaryName</span><span class=p>(),</span> <span class=nx>summary</span><span class=p>.</span><span class=nf>SummaryContent</span><span class=p>())</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
      <span class=c1>// TODO(krzysied): Remember to keep original filename style for backward compatibility.
</span><span class=c1></span>      <span class=nx>filePath</span> <span class=o>:=</span> <span class=nx>path</span><span class=p>.</span><span class=nf>Join</span><span class=p>(</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>GetClusterLoaderConfig</span><span class=p>().</span><span class=nx>ReportDir</span><span class=p>,</span> <span class=nx>summary</span><span class=p>.</span><span class=nf>SummaryName</span><span class=p>()</span><span class=o>+</span><span class=s>&#34;_&#34;</span><span class=o>+</span><span class=nx>conf</span><span class=p>.</span><span class=nx>Name</span><span class=o>+</span><span class=s>&#34;_&#34;</span><span class=o>+</span><span class=nx>summary</span><span class=p>.</span><span class=nf>SummaryTime</span><span class=p>().</span><span class=nf>Format</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>RFC3339</span><span class=p>)</span><span class=o>+</span><span class=s>&#34;.&#34;</span><span class=o>+</span><span class=nx>summary</span><span class=p>.</span><span class=nf>SummaryExt</span><span class=p>())</span>
      <span class=nx>ioutil</span><span class=p>.</span><span class=nf>WriteFile</span><span class=p>(</span><span class=nx>filePath</span><span class=p>,</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>summary</span><span class=p>.</span><span class=nf>SummaryContent</span><span class=p>()),</span> <span class=mo>0644</span><span class=p>)</span>
    <span class=p>}</span>
  <span class=p>}</span>

<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>可以看出 每个step中的Measurements和Phases都是并发执行的。</p><p>而且在每个step中，要么执行measurement.exec，要么执行phase.exec</p><p>clusterloader2/pkg/test/simple_test_executor.go</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-golang data-lang=golang>
<span class=c1>// ExecuteStep executes single test step based on provided step configuration.
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>ste</span> <span class=o>*</span><span class=nx>simpleTestExecutor</span><span class=p>)</span> <span class=nf>ExecuteStep</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>Context</span><span class=p>,</span> <span class=nx>step</span> <span class=o>*</span><span class=nx>api</span><span class=p>.</span><span class=nx>Step</span><span class=p>)</span> <span class=o>*</span><span class=nx>errors</span><span class=p>.</span><span class=nx>ErrorList</span> <span class=p>{</span>
  <span class=kd>var</span> <span class=nx>wg</span> <span class=nx>wait</span><span class=p>.</span><span class=nx>Group</span>
  <span class=nx>errList</span> <span class=o>:=</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>NewErrorList</span><span class=p>()</span>
  <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>step</span><span class=p>.</span><span class=nx>Measurements</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
    <span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>step</span><span class=p>.</span><span class=nx>Measurements</span> <span class=p>{</span>
      <span class=c1>// index is created to make i value unchangeable during thread execution.
</span><span class=c1></span>      <span class=nx>index</span> <span class=o>:=</span> <span class=nx>i</span>
      <span class=nx>wg</span><span class=p>.</span><span class=nf>Start</span><span class=p>(</span><span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
        <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ctx</span><span class=p>.</span><span class=nf>GetMeasurementManager</span><span class=p>().</span><span class=nf>Execute</span><span class=p>(</span><span class=nx>step</span><span class=p>.</span><span class=nx>Measurements</span><span class=p>[</span><span class=nx>index</span><span class=p>].</span><span class=nx>Method</span><span class=p>,</span>
          <span class=nx>step</span><span class=p>.</span><span class=nx>Measurements</span><span class=p>[</span><span class=nx>index</span><span class=p>].</span><span class=nx>Identifier</span><span class=p>,</span>
          <span class=nx>step</span><span class=p>.</span><span class=nx>Measurements</span><span class=p>[</span><span class=nx>index</span><span class=p>].</span><span class=nx>Params</span><span class=p>)</span>
        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
          <span class=nx>errList</span><span class=p>.</span><span class=nf>Append</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;measurement call %s - %s error: %v&#34;</span><span class=p>,</span> <span class=nx>step</span><span class=p>.</span><span class=nx>Measurements</span><span class=p>[</span><span class=nx>index</span><span class=p>].</span><span class=nx>Method</span><span class=p>,</span> <span class=nx>step</span><span class=p>.</span><span class=nx>Measurements</span><span class=p>[</span><span class=nx>index</span><span class=p>].</span><span class=nx>Identifier</span><span class=p>,</span> <span class=nx>err</span><span class=p>))</span>
        <span class=p>}</span>
      <span class=p>})</span>
    <span class=p>}</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>step</span><span class=p>.</span><span class=nx>Phases</span> <span class=p>{</span>
      <span class=nx>phase</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>step</span><span class=p>.</span><span class=nx>Phases</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span>
      <span class=nx>wg</span><span class=p>.</span><span class=nf>Start</span><span class=p>(</span><span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>if</span> <span class=nx>phaseErrList</span> <span class=o>:=</span> <span class=nx>ste</span><span class=p>.</span><span class=nf>ExecutePhase</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>phase</span><span class=p>);</span> <span class=p>!</span><span class=nx>phaseErrList</span><span class=p>.</span><span class=nf>IsEmpty</span><span class=p>()</span> <span class=p>{</span>
          <span class=nx>errList</span><span class=p>.</span><span class=nf>Concat</span><span class=p>(</span><span class=nx>phaseErrList</span><span class=p>)</span>
        <span class=p>}</span>
      <span class=p>})</span>
    <span class=p>}</span>
  <span class=p>}</span>
  <span class=nx>wg</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span>
  <span class=k>if</span> <span class=nx>step</span><span class=p>.</span><span class=nx>Name</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
    <span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Step \&#34;%s\&#34; ended&#34;</span><span class=p>,</span> <span class=nx>step</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=nx>errList</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>measurement Execute
根据 methodName, identifier 创建measurementInstance。目前有17种measurementInstance。比如：apiResponsivenessMeasurement；podStartupLatencyMeasurement等等</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=c1>// Execute executes measurement based on provided identifier, methodName and params.
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>mm</span> <span class=o>*</span><span class=nx>MeasurementManager</span><span class=p>)</span> <span class=nf>Execute</span><span class=p>(</span><span class=nx>methodName</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>identifier</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>params</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{})</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=nx>measurementInstance</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>mm</span><span class=p>.</span><span class=nf>getMeasurementInstance</span><span class=p>(</span><span class=nx>methodName</span><span class=p>,</span> <span class=nx>identifier</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nx>err</span>
    <span class=p>}</span>
    <span class=nx>config</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>MeasurementConfig</span><span class=p>{</span>
        <span class=nx>ClusterFramework</span><span class=p>:</span>    <span class=nx>mm</span><span class=p>.</span><span class=nx>clusterFramework</span><span class=p>,</span>
        <span class=nx>PrometheusFramework</span><span class=p>:</span> <span class=nx>mm</span><span class=p>.</span><span class=nx>prometheusFramework</span><span class=p>,</span>
        <span class=nx>Params</span><span class=p>:</span>              <span class=nx>params</span><span class=p>,</span>
        <span class=nx>TemplateProvider</span><span class=p>:</span>    <span class=nx>mm</span><span class=p>.</span><span class=nx>templateProvider</span><span class=p>,</span>
        <span class=nx>Identifier</span><span class=p>:</span>          <span class=nx>identifier</span><span class=p>,</span>
        <span class=nx>CloudProvider</span><span class=p>:</span>       <span class=nx>mm</span><span class=p>.</span><span class=nx>clusterLoaderConfig</span><span class=p>.</span><span class=nx>ClusterConfig</span><span class=p>.</span><span class=nx>Provider</span><span class=p>,</span>
    <span class=p>}</span>
    <span class=nx>summaries</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>measurementInstance</span><span class=p>.</span><span class=nf>Execute</span><span class=p>(</span><span class=nx>config</span><span class=p>)</span>
    <span class=nx>mm</span><span class=p>.</span><span class=nx>summaries</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>mm</span><span class=p>.</span><span class=nx>summaries</span><span class=p>,</span> <span class=nx>summaries</span><span class=o>...</span><span class=p>)</span>
    <span class=k>return</span> <span class=nx>err</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><h4 id=measurement处理>Measurement处理</h4><p>以podStartupLatencyMeasurement为例分析，action参数分为start和gather，分别表示测试启动和测试收集</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=c1>// Execute supports two actions:
</span><span class=c1>// - start - Starts to observe pods and pods events.
</span><span class=c1>// - gather - Gathers and prints current pod latency data.
</span><span class=c1>// Does NOT support concurrency. Multiple calls to this measurement
</span><span class=c1>// shouldn&#39;t be done within one step.
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>podStartupLatencyMeasurement</span><span class=p>)</span> <span class=nf>Execute</span><span class=p>(</span><span class=nx>config</span> <span class=o>*</span><span class=nx>measurement</span><span class=p>.</span><span class=nx>MeasurementConfig</span><span class=p>)</span> <span class=p>([]</span><span class=nx>measurement</span><span class=p>.</span><span class=nx>Summary</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>action</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>util</span><span class=p>.</span><span class=nf>GetString</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>Params</span><span class=p>,</span> <span class=s>&#34;action&#34;</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
    <span class=p>}</span>

    <span class=k>switch</span> <span class=nx>action</span> <span class=p>{</span>
    <span class=k>case</span> <span class=s>&#34;start&#34;</span><span class=p>:</span>
        <span class=nx>p</span><span class=p>.</span><span class=nx>namespace</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>util</span><span class=p>.</span><span class=nf>GetStringOrDefault</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>Params</span><span class=p>,</span> <span class=s>&#34;namespace&#34;</span><span class=p>,</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>NamespaceAll</span><span class=p>)</span>
        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
        <span class=p>}</span>
        <span class=nx>p</span><span class=p>.</span><span class=nx>labelSelector</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>util</span><span class=p>.</span><span class=nf>GetStringOrDefault</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>Params</span><span class=p>,</span> <span class=s>&#34;labelSelector&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>)</span>
        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
        <span class=p>}</span>
        <span class=nx>p</span><span class=p>.</span><span class=nx>fieldSelector</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>util</span><span class=p>.</span><span class=nf>GetStringOrDefault</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>Params</span><span class=p>,</span> <span class=s>&#34;fieldSelector&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>)</span>
        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
        <span class=p>}</span>
        <span class=nx>p</span><span class=p>.</span><span class=nx>threshold</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>util</span><span class=p>.</span><span class=nf>GetDurationOrDefault</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>Params</span><span class=p>,</span> <span class=s>&#34;threshold&#34;</span><span class=p>,</span> <span class=nx>defaultPodStartupLatencyThreshold</span><span class=p>)</span>
        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>p</span><span class=p>.</span><span class=nf>start</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>ClusterFramework</span><span class=p>.</span><span class=nf>GetClientSets</span><span class=p>().</span><span class=nf>GetClient</span><span class=p>())</span>
    <span class=k>case</span> <span class=s>&#34;gather&#34;</span><span class=p>:</span>
        <span class=k>return</span> <span class=nx>p</span><span class=p>.</span><span class=nf>gather</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>ClusterFramework</span><span class=p>.</span><span class=nf>GetClientSets</span><span class=p>().</span><span class=nf>GetClient</span><span class=p>(),</span> <span class=nx>config</span><span class=p>.</span><span class=nx>Identifier</span><span class=p>)</span>
    <span class=k>default</span><span class=p>:</span>
        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;unknown action %v&#34;</span><span class=p>,</span> <span class=nx>action</span><span class=p>)</span>
    <span class=p>}</span>

<span class=p>}</span>
<span class=c1>// 测试启动
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>podStartupLatencyMeasurement</span><span class=p>)</span> <span class=nf>start</span><span class=p>(</span><span class=nx>c</span> <span class=nx>clientset</span><span class=p>.</span><span class=nx>Interface</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=k>if</span> <span class=nx>p</span><span class=p>.</span><span class=nx>isRunning</span> <span class=p>{</span>
        <span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;%s: pod startup latancy measurement already running&#34;</span><span class=p>,</span> <span class=nx>p</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>nil</span>
    <span class=p>}</span>
    <span class=nx>p</span><span class=p>.</span><span class=nx>selectorsString</span> <span class=p>=</span> <span class=nx>measurementutil</span><span class=p>.</span><span class=nf>CreateSelectorsString</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>namespace</span><span class=p>,</span> <span class=nx>p</span><span class=p>.</span><span class=nx>labelSelector</span><span class=p>,</span> <span class=nx>p</span><span class=p>.</span><span class=nx>fieldSelector</span><span class=p>)</span>
    <span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;%s: starting pod startup latency measurement...&#34;</span><span class=p>,</span> <span class=nx>p</span><span class=p>)</span>
    <span class=nx>p</span><span class=p>.</span><span class=nx>isRunning</span> <span class=p>=</span> <span class=kc>true</span>
    <span class=nx>p</span><span class=p>.</span><span class=nx>stopCh</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span>
    <span class=nx>p</span><span class=p>.</span><span class=nx>informer</span> <span class=p>=</span> <span class=nx>informer</span><span class=p>.</span><span class=nf>NewInformer</span><span class=p>(</span>
        <span class=nx>c</span><span class=p>,</span>
        <span class=s>&#34;pods&#34;</span><span class=p>,</span>
        <span class=nx>p</span><span class=p>.</span><span class=nx>namespace</span><span class=p>,</span>
        <span class=nx>p</span><span class=p>.</span><span class=nx>fieldSelector</span><span class=p>,</span>
        <span class=nx>p</span><span class=p>.</span><span class=nx>labelSelector</span><span class=p>,</span>
        <span class=c1>// 使用checkPod回调处理，一旦pod状态为running，则更新测试工具保存的pod的start时间
</span><span class=c1></span>        <span class=nx>p</span><span class=p>.</span><span class=nx>checkPod</span><span class=p>,</span>
    <span class=p>)</span>
    <span class=c1>// 启动了监听该范围内的pod资源
</span><span class=c1></span>    <span class=k>go</span> <span class=nx>p</span><span class=p>.</span><span class=nx>informer</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>stopCh</span><span class=p>)</span>
    <span class=nx>timeoutCh</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span>
    <span class=nx>timeoutTimer</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>AfterFunc</span><span class=p>(</span><span class=nx>informerSyncTimeout</span><span class=p>,</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
        <span class=nb>close</span><span class=p>(</span><span class=nx>timeoutCh</span><span class=p>)</span>
    <span class=p>})</span>
    <span class=k>defer</span> <span class=nx>timeoutTimer</span><span class=p>.</span><span class=nf>Stop</span><span class=p>()</span>
    <span class=k>if</span> <span class=p>!</span><span class=nx>cache</span><span class=p>.</span><span class=nf>WaitForCacheSync</span><span class=p>(</span><span class=nx>timeoutCh</span><span class=p>,</span> <span class=nx>p</span><span class=p>.</span><span class=nx>informer</span><span class=p>.</span><span class=nx>HasSynced</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;timed out waiting for caches to sync&#34;</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=kc>nil</span>
<span class=p>}</span>


<span class=c1>// 测试收集
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>podStartupLatencyMeasurement</span><span class=p>)</span> <span class=nf>gather</span><span class=p>(</span><span class=nx>c</span> <span class=nx>clientset</span><span class=p>.</span><span class=nx>Interface</span><span class=p>,</span> <span class=nx>identifier</span> <span class=kt>string</span><span class=p>)</span> <span class=p>([]</span><span class=nx>measurement</span><span class=p>.</span><span class=nx>Summary</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;%s: gathering pod startup latency measurement...&#34;</span><span class=p>,</span> <span class=nx>p</span><span class=p>)</span>
    <span class=c1>// 检查podStartupLatencyMeasurement 是否已启动
</span><span class=c1></span>    <span class=k>if</span> <span class=p>!</span><span class=nx>p</span><span class=p>.</span><span class=nx>isRunning</span> <span class=p>{</span>
        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;metric %s has not been started&#34;</span><span class=p>,</span> <span class=nx>podStartupLatencyMeasurementName</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=nx>scheduleLag</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=nx>measurementutil</span><span class=p>.</span><span class=nx>LatencyData</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
    <span class=nx>startupLag</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=nx>measurementutil</span><span class=p>.</span><span class=nx>LatencyData</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
    <span class=nx>watchLag</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=nx>measurementutil</span><span class=p>.</span><span class=nx>LatencyData</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
    <span class=nx>schedToWatchLag</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=nx>measurementutil</span><span class=p>.</span><span class=nx>LatencyData</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
    <span class=nx>e2eLag</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=nx>measurementutil</span><span class=p>.</span><span class=nx>LatencyData</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>

    <span class=nx>p</span><span class=p>.</span><span class=nf>stop</span><span class=p>()</span>
    <span class=c1>// 通过schedEvents方式获取调度器事件的create时间
</span><span class=c1></span>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nf>gatherScheduleTimes</span><span class=p>(</span><span class=nx>c</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
    <span class=p>}</span>
    <span class=c1>// 遍历pod-createTime map，按pod生命周期逻辑，进行条件检查
</span><span class=c1></span>    <span class=k>for</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>create</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>p</span><span class=p>.</span><span class=nx>createTimes</span> <span class=p>{</span>
        <span class=nx>sched</span><span class=p>,</span> <span class=nx>hasSched</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>scheduleTimes</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span>
        <span class=k>if</span> <span class=p>!</span><span class=nx>hasSched</span> <span class=p>{</span>
            <span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;%s: failed to find schedule time for %v&#34;</span><span class=p>,</span> <span class=nx>p</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>
        <span class=p>}</span>
        <span class=nx>run</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>runTimes</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span>
        <span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
            <span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;%s: failed to find run time for %v&#34;</span><span class=p>,</span> <span class=nx>p</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>
            <span class=k>continue</span>
        <span class=p>}</span>
        <span class=nx>watch</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>watchTimes</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span>
        <span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
            <span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;%s: failed to find watch time for %v&#34;</span><span class=p>,</span> <span class=nx>p</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>
            <span class=k>continue</span>
        <span class=p>}</span>
        <span class=nx>node</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>nodeNames</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span>
        <span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
            <span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;%s: failed to find node for %v&#34;</span><span class=p>,</span> <span class=nx>p</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>
            <span class=k>continue</span>
        <span class=p>}</span>
        <span class=c1>// 计算各种延时，重要。。。
</span><span class=c1></span>        <span class=k>if</span> <span class=nx>hasSched</span> <span class=p>{</span>
            <span class=nx>scheduleLag</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>scheduleLag</span><span class=p>,</span> <span class=nx>podLatencyData</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>Node</span><span class=p>:</span> <span class=nx>node</span><span class=p>,</span> <span class=nx>Latency</span><span class=p>:</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>Time</span><span class=p>.</span><span class=nf>Sub</span><span class=p>(</span><span class=nx>create</span><span class=p>.</span><span class=nx>Time</span><span class=p>)})</span>
            <span class=nx>startupLag</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>startupLag</span><span class=p>,</span> <span class=nx>podLatencyData</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>Node</span><span class=p>:</span> <span class=nx>node</span><span class=p>,</span> <span class=nx>Latency</span><span class=p>:</span> <span class=nx>run</span><span class=p>.</span><span class=nx>Time</span><span class=p>.</span><span class=nf>Sub</span><span class=p>(</span><span class=nx>sched</span><span class=p>.</span><span class=nx>Time</span><span class=p>)})</span>
            <span class=nx>schedToWatchLag</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>schedToWatchLag</span><span class=p>,</span> <span class=nx>podLatencyData</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>Node</span><span class=p>:</span> <span class=nx>node</span><span class=p>,</span> <span class=nx>Latency</span><span class=p>:</span> <span class=nx>watch</span><span class=p>.</span><span class=nx>Time</span><span class=p>.</span><span class=nf>Sub</span><span class=p>(</span><span class=nx>sched</span><span class=p>.</span><span class=nx>Time</span><span class=p>)})</span>
        <span class=p>}</span>
        <span class=nx>watchLag</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>watchLag</span><span class=p>,</span> <span class=nx>podLatencyData</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>Node</span><span class=p>:</span> <span class=nx>node</span><span class=p>,</span> <span class=nx>Latency</span><span class=p>:</span> <span class=nx>watch</span><span class=p>.</span><span class=nx>Time</span><span class=p>.</span><span class=nf>Sub</span><span class=p>(</span><span class=nx>run</span><span class=p>.</span><span class=nx>Time</span><span class=p>)})</span>
        <span class=nx>e2eLag</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>e2eLag</span><span class=p>,</span> <span class=nx>podLatencyData</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>Node</span><span class=p>:</span> <span class=nx>node</span><span class=p>,</span> <span class=nx>Latency</span><span class=p>:</span> <span class=nx>watch</span><span class=p>.</span><span class=nx>Time</span><span class=p>.</span><span class=nf>Sub</span><span class=p>(</span><span class=nx>create</span><span class=p>.</span><span class=nx>Time</span><span class=p>)})</span>
    <span class=p>}</span>
    <span class=c1>// 把各个pod的各延时指标值进行排序，排序目的是为了方便进行数据统计
</span><span class=c1></span>    <span class=nx>sort</span><span class=p>.</span><span class=nf>Sort</span><span class=p>(</span><span class=nx>measurementutil</span><span class=p>.</span><span class=nf>LatencySlice</span><span class=p>(</span><span class=nx>scheduleLag</span><span class=p>))</span>
    <span class=nx>sort</span><span class=p>.</span><span class=nf>Sort</span><span class=p>(</span><span class=nx>measurementutil</span><span class=p>.</span><span class=nf>LatencySlice</span><span class=p>(</span><span class=nx>startupLag</span><span class=p>))</span>
    <span class=nx>sort</span><span class=p>.</span><span class=nf>Sort</span><span class=p>(</span><span class=nx>measurementutil</span><span class=p>.</span><span class=nf>LatencySlice</span><span class=p>(</span><span class=nx>watchLag</span><span class=p>))</span>
    <span class=nx>sort</span><span class=p>.</span><span class=nf>Sort</span><span class=p>(</span><span class=nx>measurementutil</span><span class=p>.</span><span class=nf>LatencySlice</span><span class=p>(</span><span class=nx>schedToWatchLag</span><span class=p>))</span>
    <span class=nx>sort</span><span class=p>.</span><span class=nf>Sort</span><span class=p>(</span><span class=nx>measurementutil</span><span class=p>.</span><span class=nf>LatencySlice</span><span class=p>(</span><span class=nx>e2eLag</span><span class=p>))</span>

    <span class=nx>p</span><span class=p>.</span><span class=nf>printLatencies</span><span class=p>(</span><span class=nx>scheduleLag</span><span class=p>,</span> <span class=s>&#34;worst create-to-schedule latencies&#34;</span><span class=p>)</span>
    <span class=nx>p</span><span class=p>.</span><span class=nf>printLatencies</span><span class=p>(</span><span class=nx>startupLag</span><span class=p>,</span> <span class=s>&#34;worst schedule-to-run latencies&#34;</span><span class=p>)</span>
    <span class=nx>p</span><span class=p>.</span><span class=nf>printLatencies</span><span class=p>(</span><span class=nx>watchLag</span><span class=p>,</span> <span class=s>&#34;worst run-to-watch latencies&#34;</span><span class=p>)</span>
    <span class=nx>p</span><span class=p>.</span><span class=nf>printLatencies</span><span class=p>(</span><span class=nx>schedToWatchLag</span><span class=p>,</span> <span class=s>&#34;worst schedule-to-watch latencies&#34;</span><span class=p>)</span>
    <span class=nx>p</span><span class=p>.</span><span class=nf>printLatencies</span><span class=p>(</span><span class=nx>e2eLag</span><span class=p>,</span> <span class=s>&#34;worst e2e latencies&#34;</span><span class=p>)</span>

    <span class=nx>podStartupLatency</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>podStartupLatency</span><span class=p>{</span>
        <span class=nx>CreateToScheduleLatency</span><span class=p>:</span> <span class=nx>measurementutil</span><span class=p>.</span><span class=nf>ExtractLatencyMetrics</span><span class=p>(</span><span class=nx>scheduleLag</span><span class=p>),</span>
        <span class=nx>ScheduleToRunLatency</span><span class=p>:</span>    <span class=nx>measurementutil</span><span class=p>.</span><span class=nf>ExtractLatencyMetrics</span><span class=p>(</span><span class=nx>startupLag</span><span class=p>),</span>
        <span class=nx>RunToWatchLatency</span><span class=p>:</span>       <span class=nx>measurementutil</span><span class=p>.</span><span class=nf>ExtractLatencyMetrics</span><span class=p>(</span><span class=nx>watchLag</span><span class=p>),</span>
        <span class=nx>ScheduleToWatchLatency</span><span class=p>:</span>  <span class=nx>measurementutil</span><span class=p>.</span><span class=nf>ExtractLatencyMetrics</span><span class=p>(</span><span class=nx>schedToWatchLag</span><span class=p>),</span>
        <span class=nx>E2ELatency</span><span class=p>:</span>              <span class=nx>measurementutil</span><span class=p>.</span><span class=nf>ExtractLatencyMetrics</span><span class=p>(</span><span class=nx>e2eLag</span><span class=p>),</span>
    <span class=p>}</span>
    <span class=c1>// 成功率
</span><span class=c1></span>    <span class=kd>var</span> <span class=nx>err</span> <span class=kt>error</span>
    <span class=k>if</span> <span class=nx>successRatio</span> <span class=o>:=</span> <span class=nb>float32</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>e2eLag</span><span class=p>))</span> <span class=o>/</span> <span class=nb>float32</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>createTimes</span><span class=p>));</span> <span class=nx>successRatio</span> <span class=p>&lt;</span> <span class=nx>successfulStartupRatioThreshold</span> <span class=p>{</span>
        <span class=nx>err</span> <span class=p>=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;only %v%% of all pods were scheduled successfully&#34;</span><span class=p>,</span> <span class=nx>successRatio</span><span class=o>*</span><span class=mi>100</span><span class=p>)</span>
        <span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;%s: %v&#34;</span><span class=p>,</span> <span class=nx>p</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=c1>// 设置阈值，这里各百分位数使用的都是相同阈值
</span><span class=c1></span>    <span class=nx>podStartupLatencyThreshold</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>measurementutil</span><span class=p>.</span><span class=nx>LatencyMetric</span><span class=p>{</span>
        <span class=nx>Perc50</span><span class=p>:</span> <span class=nx>p</span><span class=p>.</span><span class=nx>threshold</span><span class=p>,</span>
        <span class=nx>Perc90</span><span class=p>:</span> <span class=nx>p</span><span class=p>.</span><span class=nx>threshold</span><span class=p>,</span>
        <span class=nx>Perc99</span><span class=p>:</span> <span class=nx>p</span><span class=p>.</span><span class=nx>threshold</span><span class=p>,</span>
    <span class=p>}</span>
    <span class=c1>// 进行延时指标验证，判断是否满足slos，不满足则输出错误信息
</span><span class=c1></span>    <span class=k>if</span> <span class=nx>slosErr</span> <span class=o>:=</span> <span class=nx>podStartupLatency</span><span class=p>.</span><span class=nx>E2ELatency</span><span class=p>.</span><span class=nf>VerifyThreshold</span><span class=p>(</span><span class=nx>podStartupLatencyThreshold</span><span class=p>);</span> <span class=nx>slosErr</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>err</span> <span class=p>=</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>NewMetricViolationError</span><span class=p>(</span><span class=s>&#34;pod startup&#34;</span><span class=p>,</span> <span class=nx>slosErr</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
        <span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;%s: %v&#34;</span><span class=p>,</span> <span class=nx>p</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=nx>content</span><span class=p>,</span> <span class=nx>jsonErr</span> <span class=o>:=</span> <span class=nx>util</span><span class=p>.</span><span class=nf>PrettyPrintJSON</span><span class=p>(</span><span class=nf>podStartupLatencyToPerfData</span><span class=p>(</span><span class=nx>podStartupLatency</span><span class=p>))</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>jsonErr</span>
    <span class=p>}</span>
    <span class=nx>summary</span> <span class=o>:=</span> <span class=nx>measurement</span><span class=p>.</span><span class=nf>CreateSummary</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s_%s&#34;</span><span class=p>,</span> <span class=nx>podStartupLatencyMeasurementName</span><span class=p>,</span> <span class=nx>identifier</span><span class=p>),</span> <span class=s>&#34;json&#34;</span><span class=p>,</span> <span class=nx>content</span><span class=p>)</span>
    <span class=k>return</span> <span class=p>[]</span><span class=nx>measurement</span><span class=p>.</span><span class=nx>Summary</span><span class=p>{</span><span class=nx>summary</span><span class=p>},</span> <span class=nx>err</span>
<span class=p>}</span>


<span class=c1>// VerifyThreshold verifies latency metric against given percentile thresholds.
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>metric</span> <span class=o>*</span><span class=nx>LatencyMetric</span><span class=p>)</span> <span class=nf>VerifyThreshold</span><span class=p>(</span><span class=nx>threshold</span> <span class=o>*</span><span class=nx>LatencyMetric</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=k>if</span> <span class=nx>metric</span><span class=p>.</span><span class=nx>Perc50</span> <span class=p>&gt;</span> <span class=nx>threshold</span><span class=p>.</span><span class=nx>Perc50</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;too high latency 50th percentile: %v&#34;</span><span class=p>,</span> <span class=nx>metric</span><span class=p>.</span><span class=nx>Perc50</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=nx>metric</span><span class=p>.</span><span class=nx>Perc90</span> <span class=p>&gt;</span> <span class=nx>threshold</span><span class=p>.</span><span class=nx>Perc90</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;too high latency 90th percentile: %v&#34;</span><span class=p>,</span> <span class=nx>metric</span><span class=p>.</span><span class=nx>Perc90</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=nx>metric</span><span class=p>.</span><span class=nx>Perc99</span> <span class=p>&gt;</span> <span class=nx>threshold</span><span class=p>.</span><span class=nx>Perc99</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;too high latency 99th percentile: %v&#34;</span><span class=p>,</span> <span class=nx>metric</span><span class=p>.</span><span class=nx>Perc99</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=kc>nil</span>
<span class=p>}</span>

</code></pre></td></tr></table></div></div><h4 id=phases处理>Phases处理</h4><p>Phases处理，实际上就是对配置中的ObjectBundle进行处理, ste.ExecuteObject</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=c1>// ExecutePhase executes single test phase based on provided phase configuration.
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>ste</span> <span class=o>*</span><span class=nx>simpleTestExecutor</span><span class=p>)</span> <span class=nf>ExecutePhase</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>Context</span><span class=p>,</span> <span class=nx>phase</span> <span class=o>*</span><span class=nx>api</span><span class=p>.</span><span class=nx>Phase</span><span class=p>)</span> <span class=o>*</span><span class=nx>errors</span><span class=p>.</span><span class=nx>ErrorList</span> <span class=p>{</span>
    <span class=c1>// TODO: add tuning set
</span><span class=c1></span>    <span class=nx>errList</span> <span class=o>:=</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>NewErrorList</span><span class=p>()</span>
    <span class=nx>nsList</span> <span class=o>:=</span> <span class=nf>createNamespacesList</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>phase</span><span class=p>.</span><span class=nx>NamespaceRange</span><span class=p>)</span>
    <span class=nx>tuningSet</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ctx</span><span class=p>.</span><span class=nf>GetTuningSetFactory</span><span class=p>().</span><span class=nf>CreateTuningSet</span><span class=p>(</span><span class=nx>phase</span><span class=p>.</span><span class=nx>TuningSet</span><span class=p>)</span>

    <span class=nx>instances</span><span class=p>,</span> <span class=nx>exists</span> <span class=o>:=</span> <span class=nx>ctx</span><span class=p>.</span><span class=nf>GetState</span><span class=p>().</span><span class=nf>GetNamespacesState</span><span class=p>().</span><span class=nf>Get</span><span class=p>(</span><span class=nx>nsName</span><span class=p>,</span> <span class=nx>id</span><span class=p>)</span>
    <span class=c1>// // ExecuteObject executes single test object operation based on provided object configuration.
</span><span class=c1></span>    <span class=nx>ste</span><span class=p>.</span><span class=nf>ExecuteObject</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>phase</span><span class=p>.</span><span class=nx>ObjectBundle</span><span class=p>[</span><span class=nx>j</span><span class=p>],</span> <span class=nx>nsName</span><span class=p>,</span> <span class=nx>replicaIndex</span><span class=p>,</span> <span class=nx>XXX</span><span class=p>)</span>

    <span class=nx>tuningSet</span><span class=p>.</span><span class=nf>Execute</span><span class=p>(</span><span class=nx>actions</span><span class=p>)</span>
    
<span class=p>}</span>
</code></pre></td></tr></table></div></div><h3 id=4-部署测试>4. 部署测试</h3><h4 id=1-k8s-2节点环境>.1 k8s-2节点环境</h4><p>在本地虚拟机2节点的测试环境中，需要修改测试配置文件和pod部署脚本。
测试配置文件主要修改参数有</p><ol><li><p>Nodes，属于配置文件上下文参数，如果不指定，测试工具会抓取实际环境中的可用的节点数，进行设置</p></li><li><p>NODES_PER_NAMESPACE， 每个ns下的nodes数。<strong>这里需注意: NODES > NODES_PER_NAMESPACE</strong></p></li><li><p>PODS_PER_NODE，每个节点下的pod数</p></li><li><p>MIN_LATENCY_PODS这个数值会跟 PODS_PER_NODE比较 选取最大的，作为LATENCY测试的参数。因为LATENCY测试一般使用较多pod
数，即$MIN_LATENCY_PODS</p></li><li><p>测试中会有测试使用的资源参数，这里需要对实际情况进行config.yaml调整。</p><ul><li>LATENCY_POD_CPU</li><li>LATENCY_POD_MEMORY</li><li>其它自定义资源数量，可以在config.yaml或者rc.yaml和deployment文件中添加配置</li></ul></li></ol><h5 id=1-部署configyaml>.1 部署config.yaml</h5><p>这里主要修改如下：</p><ul><li><p>上述的测试配置参数</p></li><li><p>主要修改参数有</p><ul><li>NODES_PER_NAMESPACE</li><li>PODS_PER_NODE</li><li>MIN_LATENCY_PODS</li><li>LATENCY_POD_CPU</li><li>LATENCY_POD_MEMORY</li><li>DENSITY_TEST_THROUGHPUT</li></ul></li><li><p>measurement-TestMetrics 原有测试工具解析收集Metrics操作异常导致测试失败，详见后面问题描述</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=c># ASSUMPTIONS:</span><span class=w>
</span><span class=w></span><span class=c># - Underlying cluster should have 100+ nodes.</span><span class=w>
</span><span class=w></span><span class=c># - Number of nodes should be divisible by NODES_PER_NAMESPACE (default 100).</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=c>#Constants</span><span class=w>
</span><span class=w></span>{{<span class=l>$DENSITY_RESOURCE_CONSTRAINTS_FILE := DefaultParam .DENSITY_RESOURCE_CONSTRAINTS_FILE &#34;&#34;}}</span><span class=w>
</span><span class=w></span><span class=c>#{{$NODE_MODE := DefaultParam .NODE_MODE &#34;allnodes&#34;}}</span><span class=w>
</span><span class=w></span>{{<span class=l>$NODE_MODE := DefaultParam .NODE_MODE &#34;master&#34;}}</span><span class=w>
</span><span class=w></span>{{<span class=l>$NODES_PER_NAMESPACE := DefaultParam .NODES_PER_NAMESPACE 1}}</span><span class=w>
</span><span class=w></span>{{<span class=l>$PODS_PER_NODE := DefaultParam .PODS_PER_NODE 2}}</span><span class=w>
</span><span class=w></span>{{<span class=l>$DENSITY_TEST_THROUGHPUT := DefaultParam .DENSITY_TEST_THROUGHPUT 20}}</span><span class=w>
</span><span class=w></span><span class=c># LATENCY_POD_MEMORY and LATENCY_POD_CPU are calculated for 1-core 4GB node.</span><span class=w>
</span><span class=w></span><span class=c># Increasing allocation of both memory and cpu by 10%</span><span class=w>
</span><span class=w></span><span class=c># decreases the value of priority function in scheduler by one point.</span><span class=w>
</span><span class=w></span><span class=c># This results in decreased probability of choosing the same node again.</span><span class=w>
</span><span class=w></span>{{<span class=l>$LATENCY_POD_CPU := DefaultParam .LATENCY_POD_CPU 5}}</span><span class=w>
</span><span class=w></span>{{<span class=l>$LATENCY_POD_MEMORY := DefaultParam .LATENCY_POD_MEMORY 3}}</span><span class=w>
</span><span class=w></span>{{<span class=l>$MIN_LATENCY_PODS := 20}}</span><span class=w>
</span><span class=w></span>{{<span class=l>$MIN_SATURATION_PODS_TIMEOUT := 180}}</span><span class=w>
</span><span class=w></span>{{<span class=l>$ENABLE_CHAOSMONKEY := DefaultParam .ENABLE_CHAOSMONKEY false}}</span><span class=w>
</span><span class=w></span>{{<span class=l>$ENABLE_SYSTEM_POD_METRICS:= DefaultParam .ENABLE_SYSTEM_POD_METRICS false}}</span><span class=w>
</span><span class=w></span>{{<span class=l>$ENABLE_RESTART_COUNT_CHECK := DefaultParam .ENABLE_RESTART_COUNT_CHECK false}}</span><span class=w>
</span><span class=w></span>{{<span class=l>$RESTART_COUNT_THRESHOLD_OVERRIDES:= DefaultParam .RESTART_COUNT_THRESHOLD_OVERRIDES &#34;&#34;}}</span><span class=w>
</span><span class=w></span><span class=c>#Variables</span><span class=w>
</span><span class=w></span>{{<span class=l>$namespaces := DivideInt .Nodes $NODES_PER_NAMESPACE}}</span><span class=w>
</span><span class=w></span>{{<span class=l>$podsPerNamespace := MultiplyInt $PODS_PER_NODE $NODES_PER_NAMESPACE}}</span><span class=w>
</span><span class=w></span>{{<span class=l>$totalPods := MultiplyInt $podsPerNamespace $namespaces}}</span><span class=w>
</span><span class=w></span>{{<span class=l>$latencyReplicas := DivideInt (MaxInt $MIN_LATENCY_PODS .Nodes) $namespaces}}</span><span class=w>
</span><span class=w></span>{{<span class=l>$totalLatencyPods := MultiplyInt $namespaces $latencyReplicas}}</span><span class=w>
</span><span class=w></span>{{<span class=l>$saturationRCTimeout := DivideFloat $totalPods $DENSITY_TEST_THROUGHPUT | AddInt $MIN_SATURATION_PODS_TIMEOUT}}</span><span class=w>
</span><span class=w></span><span class=c># saturationRCHardTimeout must be at least 20m to make sure that ~10m node</span><span class=w>
</span><span class=w></span><span class=c># failure won&#39;t fail the test. See https://github.com/kubernetes/kubernetes/issues/73461#issuecomment-467338711</span><span class=w>
</span><span class=w></span>{{<span class=l>$saturationRCHardTimeout := MaxInt $saturationRCTimeout 1200}}</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>density</span><span class=w>
</span><span class=w></span><span class=nt>automanagedNamespaces</span><span class=p>:</span><span class=w> </span>{{<span class=l>$namespaces}}</span><span class=w>
</span><span class=w></span><span class=nt>tuningSets</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Uniform5qps</span><span class=w>
</span><span class=w>  </span><span class=nt>qpsLoad</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>qps</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span><span class=w></span>{{<span class=l>if $ENABLE_CHAOSMONKEY}}</span><span class=w>
</span><span class=w></span><span class=nt>chaosMonkey</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>nodeFailure</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>failureRate</span><span class=p>:</span><span class=w> </span><span class=m>0.01</span><span class=w>
</span><span class=w>    </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=l>1m</span><span class=w>
</span><span class=w>    </span><span class=nt>jitterFactor</span><span class=p>:</span><span class=w> </span><span class=m>10.0</span><span class=w>
</span><span class=w>    </span><span class=nt>simulatedDowntime</span><span class=p>:</span><span class=w> </span><span class=l>10m</span><span class=w>
</span><span class=w></span>{{<span class=l>end}}</span><span class=w>
</span><span class=w></span><span class=nt>steps</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>measurements</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>Identifier</span><span class=p>:</span><span class=w> </span><span class=l>APIResponsiveness</span><span class=w>
</span><span class=w>    </span><span class=nt>Method</span><span class=p>:</span><span class=w> </span><span class=l>APIResponsiveness</span><span class=w>
</span><span class=w>    </span><span class=nt>Params</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>reset</span><span class=w>
</span><span class=w>  </span>- <span class=nt>Identifier</span><span class=p>:</span><span class=w> </span><span class=l>TestMetrics</span><span class=w>
</span><span class=w>    </span><span class=nt>Method</span><span class=p>:</span><span class=w> </span><span class=l>TestMetrics</span><span class=w>
</span><span class=w>    </span><span class=nt>Params</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>start</span><span class=w>
</span><span class=w>      </span><span class=nt>nodeMode</span><span class=p>:</span><span class=w> </span>{{<span class=l>$NODE_MODE}}</span><span class=w>
</span><span class=w>      </span><span class=nt>resourceConstraints</span><span class=p>:</span><span class=w> </span>{{<span class=l>$DENSITY_RESOURCE_CONSTRAINTS_FILE}}</span><span class=w>
</span><span class=w>      </span><span class=nt>systemPodMetricsEnabled</span><span class=p>:</span><span class=w> </span>{{<span class=l>$ENABLE_SYSTEM_POD_METRICS}}</span><span class=w>
</span><span class=w>      </span><span class=nt>restartCountThresholdOverrides</span><span class=p>:</span><span class=w> </span>{{<span class=l>YamlQuote $RESTART_COUNT_THRESHOLD_OVERRIDES 4}}</span><span class=w>
</span><span class=w>      </span><span class=nt>enableRestartCountCheck</span><span class=p>:</span><span class=w> </span>{{<span class=l>$ENABLE_RESTART_COUNT_CHECK}}</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=c># Create saturation pods</span><span class=w>
</span><span class=w></span>- <span class=nt>measurements</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>Identifier</span><span class=p>:</span><span class=w> </span><span class=l>SaturationPodStartupLatency</span><span class=w>
</span><span class=w>    </span><span class=nt>Method</span><span class=p>:</span><span class=w> </span><span class=l>PodStartupLatency</span><span class=w>
</span><span class=w>    </span><span class=nt>Params</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>start</span><span class=w>
</span><span class=w>      </span><span class=nt>labelSelector</span><span class=p>:</span><span class=w> </span><span class=l>group = saturation</span><span class=w>
</span><span class=w>      </span><span class=nt>threshold</span><span class=p>:</span><span class=w> </span>{{<span class=l>$saturationRCTimeout}}s</span><span class=w>
</span><span class=w></span>- <span class=nt>measurements</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>Identifier</span><span class=p>:</span><span class=w> </span><span class=l>WaitForRunningSaturationRCs</span><span class=w>
</span><span class=w>    </span><span class=nt>Method</span><span class=p>:</span><span class=w> </span><span class=l>WaitForControlledPodsRunning</span><span class=w>
</span><span class=w>    </span><span class=nt>Params</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>start</span><span class=w>
</span><span class=w>      </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w>      </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ReplicationController</span><span class=w>
</span><span class=w>      </span><span class=nt>labelSelector</span><span class=p>:</span><span class=w> </span><span class=l>group = saturation</span><span class=w>
</span><span class=w>      </span><span class=nt>operationTimeout</span><span class=p>:</span><span class=w> </span>{{<span class=l>$saturationRCHardTimeout}}s</span><span class=w>
</span><span class=w></span>- <span class=nt>phases</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>namespaceRange</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>min</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>      </span><span class=nt>max</span><span class=p>:</span><span class=w> </span>{{<span class=l>$namespaces}}</span><span class=w>
</span><span class=w>    </span><span class=nt>replicasPerNamespace</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>    </span><span class=nt>tuningSet</span><span class=p>:</span><span class=w> </span><span class=l>Uniform5qps</span><span class=w>
</span><span class=w>    </span><span class=nt>objectBundle</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>basename</span><span class=p>:</span><span class=w> </span><span class=l>saturation-rc</span><span class=w>
</span><span class=w>      </span><span class=nt>objectTemplatePath</span><span class=p>:</span><span class=w> </span><span class=l>rc.yaml</span><span class=w>
</span><span class=w>      </span><span class=nt>templateFillMap</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>Replicas</span><span class=p>:</span><span class=w> </span>{{<span class=l>$podsPerNamespace}}</span><span class=w>
</span><span class=w>        </span><span class=nt>Group</span><span class=p>:</span><span class=w> </span><span class=l>saturation</span><span class=w>
</span><span class=w>        </span><span class=nt>CpuRequest</span><span class=p>:</span><span class=w> </span><span class=l>1m</span><span class=w>
</span><span class=w>        </span><span class=nt>MemoryRequest</span><span class=p>:</span><span class=w> </span><span class=l>10M</span><span class=w>
</span><span class=w></span>- <span class=nt>measurements</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>Identifier</span><span class=p>:</span><span class=w> </span><span class=l>SchedulingThroughput</span><span class=w>
</span><span class=w>    </span><span class=nt>Method</span><span class=p>:</span><span class=w> </span><span class=l>SchedulingThroughput</span><span class=w>
</span><span class=w>    </span><span class=nt>Params</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>start</span><span class=w>
</span><span class=w>      </span><span class=nt>labelSelector</span><span class=p>:</span><span class=w> </span><span class=l>group = saturation</span><span class=w>
</span><span class=w></span>- <span class=nt>measurements</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>Identifier</span><span class=p>:</span><span class=w> </span><span class=l>WaitForRunningSaturationRCs</span><span class=w>
</span><span class=w>    </span><span class=nt>Method</span><span class=p>:</span><span class=w> </span><span class=l>WaitForControlledPodsRunning</span><span class=w>
</span><span class=w>    </span><span class=nt>Params</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>gather</span><span class=w>
</span><span class=w></span>- <span class=nt>measurements</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>Identifier</span><span class=p>:</span><span class=w> </span><span class=l>SaturationPodStartupLatency</span><span class=w>
</span><span class=w>    </span><span class=nt>Method</span><span class=p>:</span><span class=w> </span><span class=l>PodStartupLatency</span><span class=w>
</span><span class=w>    </span><span class=nt>Params</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>gather</span><span class=w>
</span><span class=w></span>- <span class=nt>measurements</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>Identifier</span><span class=p>:</span><span class=w> </span><span class=l>SchedulingThroughput</span><span class=w>
</span><span class=w>    </span><span class=nt>Method</span><span class=p>:</span><span class=w> </span><span class=l>SchedulingThroughput</span><span class=w>
</span><span class=w>    </span><span class=nt>Params</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>gather</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Creating saturation pods</span><span class=w>
</span><span class=w></span><span class=c># Create latency pods</span><span class=w>
</span><span class=w></span>- <span class=nt>measurements</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>Identifier</span><span class=p>:</span><span class=w> </span><span class=l>PodStartupLatency</span><span class=w>
</span><span class=w>    </span><span class=nt>Method</span><span class=p>:</span><span class=w> </span><span class=l>PodStartupLatency</span><span class=w>
</span><span class=w>    </span><span class=nt>Params</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>start</span><span class=w>
</span><span class=w>      </span><span class=nt>labelSelector</span><span class=p>:</span><span class=w> </span><span class=l>group = latency</span><span class=w>
</span><span class=w></span>- <span class=nt>measurements</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>Identifier</span><span class=p>:</span><span class=w> </span><span class=l>WaitForRunningLatencyRCs</span><span class=w>
</span><span class=w>    </span><span class=nt>Method</span><span class=p>:</span><span class=w> </span><span class=l>WaitForControlledPodsRunning</span><span class=w>
</span><span class=w>    </span><span class=nt>Params</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>start</span><span class=w>
</span><span class=w>      </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w>      </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ReplicationController</span><span class=w>
</span><span class=w>      </span><span class=nt>labelSelector</span><span class=p>:</span><span class=w> </span><span class=l>group = latency</span><span class=w>
</span><span class=w>      </span><span class=nt>operationTimeout</span><span class=p>:</span><span class=w> </span><span class=l>15m</span><span class=w>
</span><span class=w></span>- <span class=nt>phases</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>namespaceRange</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>min</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>      </span><span class=nt>max</span><span class=p>:</span><span class=w> </span>{{<span class=l>$namespaces}}</span><span class=w>
</span><span class=w>    </span><span class=nt>replicasPerNamespace</span><span class=p>:</span><span class=w> </span>{{<span class=l>$latencyReplicas}}</span><span class=w>
</span><span class=w>    </span><span class=nt>tuningSet</span><span class=p>:</span><span class=w> </span><span class=l>Uniform5qps</span><span class=w>
</span><span class=w>    </span><span class=nt>objectBundle</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>basename</span><span class=p>:</span><span class=w> </span><span class=l>latency-pod-rc</span><span class=w>
</span><span class=w>      </span><span class=nt>objectTemplatePath</span><span class=p>:</span><span class=w> </span><span class=l>rc.yaml</span><span class=w>
</span><span class=w>      </span><span class=nt>templateFillMap</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>Replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>        </span><span class=nt>Group</span><span class=p>:</span><span class=w> </span><span class=l>latency</span><span class=w>
</span><span class=w>        </span><span class=nt>CpuRequest</span><span class=p>:</span><span class=w> </span>{{<span class=l>$LATENCY_POD_CPU}}m</span><span class=w>
</span><span class=w>        </span><span class=nt>MemoryRequest</span><span class=p>:</span><span class=w> </span>{{<span class=l>$LATENCY_POD_MEMORY}}M</span><span class=w>
</span><span class=w></span>- <span class=nt>measurements</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>Identifier</span><span class=p>:</span><span class=w> </span><span class=l>WaitForRunningLatencyRCs</span><span class=w>
</span><span class=w>    </span><span class=nt>Method</span><span class=p>:</span><span class=w> </span><span class=l>WaitForControlledPodsRunning</span><span class=w>
</span><span class=w>    </span><span class=nt>Params</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>gather</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Creating latency pods</span><span class=w>
</span><span class=w></span><span class=c># Remove latency pods</span><span class=w>
</span><span class=w></span>- <span class=nt>phases</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>namespaceRange</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>min</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>      </span><span class=nt>max</span><span class=p>:</span><span class=w> </span>{{<span class=l>$namespaces}}</span><span class=w>
</span><span class=w>    </span><span class=nt>replicasPerNamespace</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span><span class=w>    </span><span class=nt>tuningSet</span><span class=p>:</span><span class=w> </span><span class=l>Uniform5qps</span><span class=w>
</span><span class=w>    </span><span class=nt>objectBundle</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>basename</span><span class=p>:</span><span class=w> </span><span class=l>latency-pod-rc</span><span class=w>
</span><span class=w>      </span><span class=nt>objectTemplatePath</span><span class=p>:</span><span class=w> </span><span class=l>rc.yaml</span><span class=w>
</span><span class=w></span>- <span class=nt>measurements</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>Identifier</span><span class=p>:</span><span class=w> </span><span class=l>WaitForRunningLatencyRCs</span><span class=w>
</span><span class=w>    </span><span class=nt>Method</span><span class=p>:</span><span class=w> </span><span class=l>WaitForControlledPodsRunning</span><span class=w>
</span><span class=w>    </span><span class=nt>Params</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>gather</span><span class=w>
</span><span class=w></span>- <span class=nt>measurements</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>Identifier</span><span class=p>:</span><span class=w> </span><span class=l>PodStartupLatency</span><span class=w>
</span><span class=w>    </span><span class=nt>Method</span><span class=p>:</span><span class=w> </span><span class=l>PodStartupLatency</span><span class=w>
</span><span class=w>    </span><span class=nt>Params</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>gather</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Deleting latancy pods</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=c># Delete pods</span><span class=w>
</span><span class=w></span>- <span class=nt>phases</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>namespaceRange</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>min</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>      </span><span class=nt>max</span><span class=p>:</span><span class=w> </span>{{<span class=l>$namespaces}}</span><span class=w>
</span><span class=w>    </span><span class=nt>replicasPerNamespace</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span><span class=w>    </span><span class=nt>tuningSet</span><span class=p>:</span><span class=w> </span><span class=l>Uniform5qps</span><span class=w>
</span><span class=w>    </span><span class=nt>objectBundle</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>basename</span><span class=p>:</span><span class=w> </span><span class=l>saturation-rc</span><span class=w>
</span><span class=w>      </span><span class=nt>objectTemplatePath</span><span class=p>:</span><span class=w> </span><span class=l>rc.yaml</span><span class=w>
</span><span class=w></span>- <span class=nt>measurements</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>Identifier</span><span class=p>:</span><span class=w> </span><span class=l>WaitForRunningSaturationRCs</span><span class=w>
</span><span class=w>    </span><span class=nt>Method</span><span class=p>:</span><span class=w> </span><span class=l>WaitForControlledPodsRunning</span><span class=w>
</span><span class=w>    </span><span class=nt>Params</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>gather</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Deleting saturation pods</span><span class=w>
</span><span class=w></span><span class=c># Collect measurements</span><span class=w>
</span><span class=w></span>- <span class=nt>measurements</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>Identifier</span><span class=p>:</span><span class=w> </span><span class=l>APIResponsiveness</span><span class=w>
</span><span class=w>    </span><span class=nt>Method</span><span class=p>:</span><span class=w> </span><span class=l>APIResponsiveness</span><span class=w>
</span><span class=w>    </span><span class=nt>Params</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>gather</span><span class=w>
</span><span class=w>  </span>- <span class=nt>Identifier</span><span class=p>:</span><span class=w> </span><span class=l>TestMetrics</span><span class=w>
</span><span class=w>    </span><span class=nt>Method</span><span class=p>:</span><span class=w> </span><span class=l>TestMetrics</span><span class=w>
</span><span class=w>    </span><span class=nt>Params</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>gather</span><span class=w>
</span><span class=w>      </span><span class=nt>systemPodMetricsEnabled</span><span class=p>:</span><span class=w> </span>{{<span class=l>$ENABLE_SYSTEM_POD_METRICS}}</span><span class=w>
</span><span class=w>      </span><span class=nt>restartCountThresholdOverrides</span><span class=p>:</span><span class=w> </span>{{<span class=l>YamlQuote $RESTART_COUNT_THRESHOLD_OVERRIDES 4}}</span><span class=w>
</span><span class=w>      </span><span class=nt>enableRestartCountCheck</span><span class=p>:</span><span class=w> </span>{{<span class=l>$ENABLE_RESTART_COUNT_CHECK}}</span><span class=w>
</span><span class=w>
</span><span class=w>
</span></code></pre></td></tr></table></div></div><h5 id=2-部署rcyaml>.2 部署rc.yaml</h5><p>修改了image</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ReplicationController</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span>{{<span class=l>.Name}}</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>group</span><span class=p>:</span><span class=w> </span>{{<span class=l>.Group}}</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span>{{<span class=l>.Replicas}}</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span>{{<span class=l>.Name}}</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span>{{<span class=l>.Name}}</span><span class=w>
</span><span class=w>        </span><span class=nt>group</span><span class=p>:</span><span class=w> </span>{{<span class=l>.Group}}</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=m>192.168.182.101</span><span class=p>:</span><span class=m>5000</span><span class=l>/com.inspur/pause-amd64:3.1</span><span class=w>
</span><span class=w>        </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span>{{<span class=l>.Name}}</span><span class=w>
</span><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span>{{<span class=l>.CpuRequest}}</span><span class=w>
</span><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span>{{<span class=l>.MemoryRequest}}</span><span class=w>
</span><span class=w>      </span><span class=c># Add not-ready/unreachable tolerations for 15 minutes so that node</span><span class=w>
</span><span class=w>      </span><span class=c># failure doesn&#39;t trigger pod deletion.</span><span class=w>
</span><span class=w>      </span><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;node.kubernetes.io/not-ready&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Exists&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;NoExecute&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>tolerationSeconds</span><span class=p>:</span><span class=w> </span><span class=m>900</span><span class=w>
</span><span class=w>      </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;node.kubernetes.io/unreachable&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Exists&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;NoExecute&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>tolerationSeconds</span><span class=p>:</span><span class=w> </span><span class=m>900</span><span class=w>
</span><span class=w>
</span></code></pre></td></tr></table></div></div><h5 id=3-部署测试信息>.3 部署测试信息</h5><p>命令运行报告信息，根据命令配置的report参数，进入report目录进行查看</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>

<span class=o>[</span>root@node1 clusterloader2<span class=o>]</span><span class=c1># ls</span>
clusterloader  reports  testing  test.log
<span class=o>[</span>root@node1 clusterloader2<span class=o>]</span><span class=c1># cd reports/</span>
<span class=o>[</span>root@node1 reports<span class=o>]</span><span class=c1># ll</span>
total <span class=m>44</span>
-rw-r--r-- <span class=m>1</span> root root <span class=m>10093</span> Dec <span class=m>11</span> 15:38 APIResponsiveness_density_2020-12-11T15:38:47+08:00.json
-rw-r--r-- <span class=m>1</span> root root  <span class=m>9792</span> Dec <span class=m>11</span> 16:29 APIResponsiveness_density_2020-12-11T16:29:41+08:00.json
-rw-r--r-- <span class=m>1</span> root root   <span class=m>287</span> Dec <span class=m>11</span> 16:29 junit.xml
-rw-r--r-- <span class=m>1</span> root root  <span class=m>1054</span> Dec <span class=m>11</span> 15:38 PodStartupLatency_SaturationPodStartupLatency_density_2020-12-11T15:37:54+08:00.json
-rw-r--r-- <span class=m>1</span> root root  <span class=m>1048</span> Dec <span class=m>11</span> 16:29 PodStartupLatency_SaturationPodStartupLatency_density_2020-12-11T16:28:49+08:00.json
-rw-r--r-- <span class=m>1</span> root root    <span class=m>64</span> Dec <span class=m>11</span> 15:38 SchedulingThroughput_density_2020-12-11T15:37:54+08:00.json
-rw-r--r-- <span class=m>1</span> root root    <span class=m>64</span> Dec <span class=m>11</span> 16:29 SchedulingThroughput_density_2020-12-11T16:28:49+08:00.json

</code></pre></td></tr></table></div></div><p>按上面的config.yaml，在2节点的本地虚拟机环境执行density测试，完整信息如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>
I1214 15:48:46.685903  <span class=m>129068</span> clusterloader.go:105<span class=o>]</span> ClusterConfig.Nodes <span class=nb>set</span> to <span class=m>2</span>
E1214 15:48:46.690191  <span class=m>129068</span> clusterloader.go:122<span class=o>]</span> Getting master external ip error: did not find any ExternalIP master IPs
I1214 15:48:46.690809  <span class=m>129068</span> clusterloader.go:206<span class=o>]</span> Using config: <span class=o>{</span>ClusterConfig:<span class=o>{</span>KubeConfigPath:/root/.kube/config Nodes:2 Provider: MasterIPs:<span class=o>[]</span> MasterInternalIPs:<span class=o>[</span>TEST_MASTER_INTERNAL_IP<span class=o>]</span> MasterName:192.168.182.101 KubemarkRootKubeConfigPath:<span class=o>}</span> ReportDir:./reports EnablePrometheusServer:false TearDownPrometheusServer:false TestConfigPath: TestOverridesPath:<span class=o>[]</span> PrometheusConfig:<span class=o>{</span>EnableServer:false TearDownServer:true ScrapeEtcd:false ScrapeNodeExporter:false ScrapeKubelets:false ScrapeKubeProxy:true SnapshotProject:<span class=o>}}</span>
I1214 15:48:46.693242  <span class=m>129068</span> cluster.go:56<span class=o>]</span> Listing cluster nodes:
I1214 15:48:46.693254  <span class=m>129068</span> cluster.go:68<span class=o>]</span> Name: node1, clusterIP: 192.168.182.101, externalIP: , isSchedulable: <span class=nb>true</span>
I1214 15:48:46.693260  <span class=m>129068</span> cluster.go:68<span class=o>]</span> Name: node2, clusterIP: 192.168.182.102, externalIP: , isSchedulable: <span class=nb>true</span>
I1214 15:48:46.696447  <span class=m>129068</span> clusterloader.go:167<span class=o>]</span> --------------------------------------------------------------------------------
I1214 15:48:46.696469  <span class=m>129068</span> clusterloader.go:168<span class=o>]</span> Running /home/wangb/perf-test/clusterloader2/testing/density/config2.yaml
I1214 15:48:46.696472  <span class=m>129068</span> clusterloader.go:169<span class=o>]</span> --------------------------------------------------------------------------------
I1214 15:48:46.697804  <span class=m>129068</span> simple_test_executor.go:50<span class=o>]</span> AutomanagedNamespacePrefix: test-tteu8b
I1214 15:48:46.729142  <span class=m>129068</span> etcd_metrics.go:76<span class=o>]</span> EtcdMetrics: starting etcd metrics collecting...
I1214 15:48:46.729168  <span class=m>129068</span> scheduler_latency.go:77<span class=o>]</span> SchedulingMetrics: resetting latency metrics in scheduler...
I1214 15:48:46.729274  <span class=m>129068</span> api_responsiveness.go:70<span class=o>]</span> APIResponsiveness: resetting latency metrics in apiserver...
I1214 15:48:46.936885  <span class=m>129068</span> resource_usage.go:106<span class=o>]</span> ResourceUsageSummary: starting resource usage collecting...
I1214 15:48:46.948058  <span class=m>129068</span> system_pod_metrics.go:82<span class=o>]</span> skipping collection of system pod metrics
I1214 15:48:46.948107  <span class=m>129068</span> pod_startup_latency.go:131<span class=o>]</span> PodStartupLatency: labelSelector<span class=o>(</span><span class=nv>group</span> <span class=o>=</span> saturation<span class=o>)</span>: starting pod startup latency measurement...
I1214 15:48:47.048405  <span class=m>129068</span> wait_for_controlled_pods.go:163<span class=o>]</span> WaitForControlledPodsRunning: starting <span class=nb>wait</span> <span class=k>for</span> controlled pods measurement...
I1214 15:48:47.607326  <span class=m>129068</span> scheduling_throughput.go:107<span class=o>]</span> SchedulingThroughput: starting collecting throughput data
I1214 15:48:47.607393  <span class=m>129068</span> wait_for_controlled_pods.go:196<span class=o>]</span> WaitForControlledPodsRunning: waiting <span class=k>for</span> controlled pods measurement...
I1214 15:48:52.226268  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>saturation-rc-0<span class=o>)</span>: Pods: <span class=m>2</span> out of <span class=m>2</span> created, <span class=m>2</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:48:52.408575  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-2<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>saturation-rc-0<span class=o>)</span>: Pods: <span class=m>2</span> out of <span class=m>2</span> created, <span class=m>2</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:48:52.607705  <span class=m>129068</span> scheduling_throughput.go:123<span class=o>]</span> SchedulingThroughput: labelSelector<span class=o>(</span><span class=nv>group</span> <span class=o>=</span> saturation<span class=o>)</span>: <span class=m>4</span> pods scheduled
I1214 15:48:52.611510  <span class=m>129068</span> wait_for_controlled_pods.go:235<span class=o>]</span> WaitForControlledPodsRunning: running 2, deleted 0, timeout: 0, unknown: <span class=m>0</span>
I1214 15:48:52.611535  <span class=m>129068</span> wait_for_controlled_pods.go:249<span class=o>]</span> WaitForControlledPodsRunning: 2/2 ReplicationControllers are running with all pods
I1214 15:48:52.611582  <span class=m>129068</span> pod_startup_latency.go:163<span class=o>]</span> PodStartupLatency: labelSelector<span class=o>(</span><span class=nv>group</span> <span class=o>=</span> saturation<span class=o>)</span>: gathering pod startup latency measurement...
I1214 15:48:52.630805  <span class=m>129068</span> pod_startup_latency.go:312<span class=o>]</span> PodStartupLatency: labelSelector<span class=o>(</span><span class=nv>group</span> <span class=o>=</span> saturation<span class=o>)</span>: <span class=m>4</span> worst create-to-schedule latencies: <span class=o>[{</span>test-tteu8b-2/saturation-rc-0-t2t27 node2 0s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/saturation-rc-0-vxxc6 node2 0s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/saturation-rc-0-pqmh6 node1 0s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/saturation-rc-0-phkng node1 0s<span class=o>}]</span>
I1214 15:48:52.630877  <span class=m>129068</span> pod_startup_latency.go:313<span class=o>]</span> PodStartupLatency: labelSelector<span class=o>(</span><span class=nv>group</span> <span class=o>=</span> saturation<span class=o>)</span>: perc50: 0s, perc90: 0s, perc99: 0s<span class=p>;</span> threshold: 3m0s
I1214 15:48:52.630887  <span class=m>129068</span> pod_startup_latency.go:312<span class=o>]</span> PodStartupLatency: labelSelector<span class=o>(</span><span class=nv>group</span> <span class=o>=</span> saturation<span class=o>)</span>: <span class=m>4</span> worst schedule-to-run latencies: <span class=o>[{</span>test-tteu8b-2/saturation-rc-0-t2t27 node2 1s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/saturation-rc-0-vxxc6 node2 1s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/saturation-rc-0-pqmh6 node1 1s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/saturation-rc-0-phkng node1 1s<span class=o>}]</span>
I1214 15:48:52.630894  <span class=m>129068</span> pod_startup_latency.go:313<span class=o>]</span> PodStartupLatency: labelSelector<span class=o>(</span><span class=nv>group</span> <span class=o>=</span> saturation<span class=o>)</span>: perc50: 1s, perc90: 1s, perc99: 1s<span class=p>;</span> threshold: 3m0s
I1214 15:48:52.630903  <span class=m>129068</span> pod_startup_latency.go:312<span class=o>]</span> PodStartupLatency: labelSelector<span class=o>(</span><span class=nv>group</span> <span class=o>=</span> saturation<span class=o>)</span>: <span class=m>4</span> worst run-to-watch latencies: <span class=o>[{</span>test-tteu8b-2/saturation-rc-0-t2t27 node2 1.202667785s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/saturation-rc-0-vxxc6 node2 1.22260201s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/saturation-rc-0-pqmh6 node1 1.292204887s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/saturation-rc-0-phkng node1 1.30166796s<span class=o>}]</span>
I1214 15:48:52.630909  <span class=m>129068</span> pod_startup_latency.go:313<span class=o>]</span> PodStartupLatency: labelSelector<span class=o>(</span><span class=nv>group</span> <span class=o>=</span> saturation<span class=o>)</span>: perc50: 1.22260201s, perc90: 1.30166796s, perc99: 1.30166796s<span class=p>;</span> threshold: 3m0s
I1214 15:48:52.630912  <span class=m>129068</span> pod_startup_latency.go:312<span class=o>]</span> PodStartupLatency: labelSelector<span class=o>(</span><span class=nv>group</span> <span class=o>=</span> saturation<span class=o>)</span>: <span class=m>4</span> worst schedule-to-watch latencies: <span class=o>[{</span>test-tteu8b-2/saturation-rc-0-t2t27 node2 2.202667785s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/saturation-rc-0-vxxc6 node2 2.22260201s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/saturation-rc-0-pqmh6 node1 2.292204887s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/saturation-rc-0-phkng node1 2.30166796s<span class=o>}]</span>
I1214 15:48:52.630920  <span class=m>129068</span> pod_startup_latency.go:313<span class=o>]</span> PodStartupLatency: labelSelector<span class=o>(</span><span class=nv>group</span> <span class=o>=</span> saturation<span class=o>)</span>: perc50: 2.22260201s, perc90: 2.30166796s, perc99: 2.30166796s<span class=p>;</span> threshold: 3m0s
I1214 15:48:52.630922  <span class=m>129068</span> pod_startup_latency.go:312<span class=o>]</span> PodStartupLatency: labelSelector<span class=o>(</span><span class=nv>group</span> <span class=o>=</span> saturation<span class=o>)</span>: <span class=m>4</span> worst e2e latencies: <span class=o>[{</span>test-tteu8b-2/saturation-rc-0-t2t27 node2 2.202667785s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/saturation-rc-0-vxxc6 node2 2.22260201s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/saturation-rc-0-pqmh6 node1 2.292204887s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/saturation-rc-0-phkng node1 2.30166796s<span class=o>}]</span>
I1214 15:48:52.630926  <span class=m>129068</span> pod_startup_latency.go:313<span class=o>]</span> PodStartupLatency: labelSelector<span class=o>(</span><span class=nv>group</span> <span class=o>=</span> saturation<span class=o>)</span>: perc50: 2.22260201s, perc90: 2.30166796s, perc99: 2.30166796s<span class=p>;</span> threshold: 3m0s
I1214 15:48:52.631183  <span class=m>129068</span> scheduling_throughput.go:136<span class=o>]</span> SchedulingThroughput: gathering data
I1214 15:48:52.631231  <span class=m>129068</span> simple_test_executor.go:128<span class=o>]</span> Step <span class=s2>&#34;Creating saturation pods&#34;</span> ended
I1214 15:48:52.631261  <span class=m>129068</span> pod_startup_latency.go:131<span class=o>]</span> PodStartupLatency: labelSelector<span class=o>(</span><span class=nv>group</span> <span class=o>=</span> latency<span class=o>)</span>: starting pod startup latency measurement...
I1214 15:48:52.731639  <span class=m>129068</span> wait_for_controlled_pods.go:163<span class=o>]</span> WaitForControlledPodsRunning: starting <span class=nb>wait</span> <span class=k>for</span> controlled pods measurement...
I1214 15:48:56.854842  <span class=m>129068</span> wait_for_controlled_pods.go:196<span class=o>]</span> WaitForControlledPodsRunning: waiting <span class=k>for</span> controlled pods measurement...
I1214 15:48:57.893711  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-0<span class=o>)</span>: Pods: <span class=m>1</span> out of <span class=m>1</span> created, <span class=m>0</span> running, <span class=m>1</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:48:58.090743  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-1<span class=o>)</span>: Pods: <span class=m>1</span> out of <span class=m>1</span> created, <span class=m>0</span> running, <span class=m>1</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:48:58.290905  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-2<span class=o>)</span>: Pods: <span class=m>1</span> out of <span class=m>1</span> created, <span class=m>0</span> running, <span class=m>1</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:48:58.489711  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-3<span class=o>)</span>: Pods: <span class=m>1</span> out of <span class=m>1</span> created, <span class=m>0</span> running, <span class=m>1</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:48:58.690296  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-4<span class=o>)</span>: Pods: <span class=m>1</span> out of <span class=m>1</span> created, <span class=m>0</span> running, <span class=m>1</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:48:58.889999  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-5<span class=o>)</span>: Pods: <span class=m>1</span> out of <span class=m>1</span> created, <span class=m>0</span> running, <span class=m>1</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:48:59.089820  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-6<span class=o>)</span>: Pods: <span class=m>1</span> out of <span class=m>1</span> created, <span class=m>0</span> running, <span class=m>1</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:48:59.289666  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-7<span class=o>)</span>: Pods: <span class=m>1</span> out of <span class=m>1</span> created, <span class=m>0</span> running, <span class=m>1</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:48:59.490967  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-8<span class=o>)</span>: Pods: <span class=m>1</span> out of <span class=m>1</span> created, <span class=m>1</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:48:59.690953  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-9<span class=o>)</span>: Pods: <span class=m>1</span> out of <span class=m>1</span> created, <span class=m>0</span> running, <span class=m>1</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:48:59.892106  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-2<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-0<span class=o>)</span>: Pods: <span class=m>1</span> out of <span class=m>1</span> created, <span class=m>1</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:00.093290  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-2<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-1<span class=o>)</span>: Pods: <span class=m>1</span> out of <span class=m>1</span> created, <span class=m>0</span> running, <span class=m>1</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:00.296933  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-2<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-2<span class=o>)</span>: Pods: <span class=m>1</span> out of <span class=m>1</span> created, <span class=m>1</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:00.498491  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-2<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-3<span class=o>)</span>: Pods: <span class=m>1</span> out of <span class=m>1</span> created, <span class=m>0</span> running, <span class=m>1</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:00.700027  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-2<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-4<span class=o>)</span>: Pods: <span class=m>1</span> out of <span class=m>1</span> created, <span class=m>1</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:00.963786  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-2<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-5<span class=o>)</span>: Pods: <span class=m>1</span> out of <span class=m>1</span> created, <span class=m>0</span> running, <span class=m>1</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:01.107629  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-2<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-6<span class=o>)</span>: Pods: <span class=m>1</span> out of <span class=m>1</span> created, <span class=m>1</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:01.311728  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-2<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-7<span class=o>)</span>: Pods: <span class=m>1</span> out of <span class=m>1</span> created, <span class=m>0</span> running, <span class=m>1</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:01.509745  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-2<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-8<span class=o>)</span>: Pods: <span class=m>1</span> out of <span class=m>1</span> created, <span class=m>1</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:01.710317  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-2<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-9<span class=o>)</span>: Pods: <span class=m>1</span> out of <span class=m>1</span> created, <span class=m>0</span> running, <span class=m>1</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:02.893967  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-0<span class=o>)</span>: Pods: <span class=m>1</span> out of <span class=m>1</span> created, <span class=m>1</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:03.090943  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-1<span class=o>)</span>: Pods: <span class=m>1</span> out of <span class=m>1</span> created, <span class=m>1</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:03.290972  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-2<span class=o>)</span>: Pods: <span class=m>1</span> out of <span class=m>1</span> created, <span class=m>1</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:03.490268  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-3<span class=o>)</span>: Pods: <span class=m>1</span> out of <span class=m>1</span> created, <span class=m>1</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:03.690609  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-4<span class=o>)</span>: Pods: <span class=m>1</span> out of <span class=m>1</span> created, <span class=m>1</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:03.890985  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-5<span class=o>)</span>: Pods: <span class=m>1</span> out of <span class=m>1</span> created, <span class=m>1</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:04.090049  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-6<span class=o>)</span>: Pods: <span class=m>1</span> out of <span class=m>1</span> created, <span class=m>1</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:04.290203  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-7<span class=o>)</span>: Pods: <span class=m>1</span> out of <span class=m>1</span> created, <span class=m>1</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:04.691160  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-9<span class=o>)</span>: Pods: <span class=m>1</span> out of <span class=m>1</span> created, <span class=m>1</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:05.093608  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-2<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-1<span class=o>)</span>: Pods: <span class=m>1</span> out of <span class=m>1</span> created, <span class=m>1</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:05.499007  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-2<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-3<span class=o>)</span>: Pods: <span class=m>1</span> out of <span class=m>1</span> created, <span class=m>1</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:05.964020  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-2<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-5<span class=o>)</span>: Pods: <span class=m>1</span> out of <span class=m>1</span> created, <span class=m>1</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:06.312641  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-2<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-7<span class=o>)</span>: Pods: <span class=m>1</span> out of <span class=m>1</span> created, <span class=m>1</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:06.710758  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-2<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-9<span class=o>)</span>: Pods: <span class=m>1</span> out of <span class=m>1</span> created, <span class=m>1</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:06.710803  <span class=m>129068</span> wait_for_controlled_pods.go:235<span class=o>]</span> WaitForControlledPodsRunning: running 20, deleted 0, timeout: 0, unknown: <span class=m>0</span>
I1214 15:49:06.715769  <span class=m>129068</span> wait_for_controlled_pods.go:249<span class=o>]</span> WaitForControlledPodsRunning: 20/20 ReplicationControllers are running with all pods
I1214 15:49:06.720533  <span class=m>129068</span> simple_test_executor.go:128<span class=o>]</span> Step <span class=s2>&#34;Creating latency pods&#34;</span> ended
I1214 15:49:10.750656  <span class=m>129068</span> wait_for_controlled_pods.go:196<span class=o>]</span> WaitForControlledPodsRunning: waiting <span class=k>for</span> controlled pods measurement...
I1214 15:49:11.801519  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-0<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:11.986805  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-1<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:12.184772  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-2<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>1</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:12.382919  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-3<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>1</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:12.589442  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-4<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:12.785810  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-5<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>1</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:12.983926  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-6<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>1</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:13.184330  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-7<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>1</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:13.384069  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-8<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:13.586112  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-9<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>1</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:13.790252  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-2<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-0<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:13.987269  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-2<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-1<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>1</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:14.192313  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-2<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-2<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:14.397369  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-2<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-3<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>1</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:14.605276  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-2<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-4<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:14.798794  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-2<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-5<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>1</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:14.997796  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-2<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-6<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:15.209917  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-2<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-7<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>1</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:15.394405  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-2<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-8<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:15.594518  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-2<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-9<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>1</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:17.184991  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-2<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:17.383303  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-3<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:17.786423  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-5<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:17.984309  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-6<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>1</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:18.184626  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-7<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:18.586402  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-9<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>1</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:18.987494  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-2<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-1<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:19.397720  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-2<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-3<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:19.799365  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-2<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-5<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:20.210268  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-2<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-7<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:20.594992  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-2<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-9<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:22.984472  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-6<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:23.587181  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>latency-pod-rc-9<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:23.587247  <span class=m>129068</span> wait_for_controlled_pods.go:235<span class=o>]</span> WaitForControlledPodsRunning: running 0, deleted 20, timeout: 0, unknown: <span class=m>0</span>
I1214 15:49:23.587289  <span class=m>129068</span> wait_for_controlled_pods.go:249<span class=o>]</span> WaitForControlledPodsRunning: 0/0 ReplicationControllers are running with all pods
I1214 15:49:23.612305  <span class=m>129068</span> pod_startup_latency.go:163<span class=o>]</span> PodStartupLatency: labelSelector<span class=o>(</span><span class=nv>group</span> <span class=o>=</span> latency<span class=o>)</span>: gathering pod startup latency measurement...
I1214 15:49:23.650456  <span class=m>129068</span> pod_startup_latency.go:312<span class=o>]</span> PodStartupLatency: labelSelector<span class=o>(</span><span class=nv>group</span> <span class=o>=</span> latency<span class=o>)</span>: <span class=m>20</span> worst create-to-schedule latencies: <span class=o>[{</span>test-tteu8b-1/latency-pod-rc-0-lnrtg node2 0s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-7-646cq node2 0s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-4-tbszn node1 0s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-5-mjbsr node2 0s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-3-42gdw node2 0s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-7-c7rst node2 0s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-4-ngh2t node2 0s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-1-4j655 node2 0s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-9-xmct4 node2 0s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-1-nk24t node2 0s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-2-rj7h5 node2 0s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-9-ww659 node2 0s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-3-k8g85 node2 0s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-0-wdhxz node1 0s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-2-pwgsb node1 0s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-8-c5m4q node1 0s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-6-x7d4t node1 0s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-8-4kx24 node1 0s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-6-wskwq node2 0s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-5-xx7qn node2 1s<span class=o>}]</span>
I1214 15:49:23.650562  <span class=m>129068</span> pod_startup_latency.go:313<span class=o>]</span> PodStartupLatency: labelSelector<span class=o>(</span><span class=nv>group</span> <span class=o>=</span> latency<span class=o>)</span>: perc50: 0s, perc90: 0s, perc99: 1s<span class=p>;</span> threshold: 5s
I1214 15:49:23.650571  <span class=m>129068</span> pod_startup_latency.go:312<span class=o>]</span> PodStartupLatency: labelSelector<span class=o>(</span><span class=nv>group</span> <span class=o>=</span> latency<span class=o>)</span>: <span class=m>20</span> worst schedule-to-run latencies: <span class=o>[{</span>test-tteu8b-1/latency-pod-rc-8-4kx24 node1 1s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-2-pwgsb node1 1s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-0-wdhxz node1 2s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-6-x7d4t node1 2s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-4-tbszn node1 2s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-8-c5m4q node1 2s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-0-lnrtg node2 3s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-1-nk24t node2 3s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-5-xx7qn node2 4s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-9-xmct4 node2 4s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-3-42gdw node2 4s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-7-c7rst node2 4s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-2-rj7h5 node2 4s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-6-wskwq node2 4s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-9-ww659 node2 5s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-1-4j655 node2 5s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-4-ngh2t node2 5s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-5-mjbsr node2 5s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-7-646cq node2 5s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-3-k8g85 node2 5s<span class=o>}]</span>
I1214 15:49:23.650585  <span class=m>129068</span> pod_startup_latency.go:313<span class=o>]</span> PodStartupLatency: labelSelector<span class=o>(</span><span class=nv>group</span> <span class=o>=</span> latency<span class=o>)</span>: perc50: 4s, perc90: 5s, perc99: 5s<span class=p>;</span> threshold: 5s
I1214 15:49:23.650588  <span class=m>129068</span> pod_startup_latency.go:312<span class=o>]</span> PodStartupLatency: labelSelector<span class=o>(</span><span class=nv>group</span> <span class=o>=</span> latency<span class=o>)</span>: <span class=m>20</span> worst run-to-watch latencies: <span class=o>[{</span>test-tteu8b-2/latency-pod-rc-1-4j655 node2 560.606582ms<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-0-wdhxz node1 721.939052ms<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-8-c5m4q node1 833.924156ms<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-6-x7d4t node1 854.39232ms<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-5-mjbsr node2 1.012828114s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-5-xx7qn node2 1.411960877s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-7-646cq node2 1.647809261s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-3-k8g85 node2 1.812513167s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-2-pwgsb node1 1.832899011s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-4-tbszn node1 1.865941757s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-9-ww659 node2 2.009388509s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-2-rj7h5 node2 2.082626218s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-4-ngh2t node2 2.140752308s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-9-xmct4 node2 2.210054751s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-8-4kx24 node1 2.508582695s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-7-c7rst node2 2.611408502s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-6-wskwq node2 2.625719954s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-1-nk24t node2 3.066876643s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-3-42gdw node2 3.538575976s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-0-lnrtg node2 5.586231683s<span class=o>}]</span>
I1214 15:49:23.650601  <span class=m>129068</span> pod_startup_latency.go:313<span class=o>]</span> PodStartupLatency: labelSelector<span class=o>(</span><span class=nv>group</span> <span class=o>=</span> latency<span class=o>)</span>: perc50: 1.865941757s, perc90: 3.066876643s, perc99: 5.586231683s<span class=p>;</span> threshold: 5s
I1214 15:49:23.650604  <span class=m>129068</span> pod_startup_latency.go:312<span class=o>]</span> PodStartupLatency: labelSelector<span class=o>(</span><span class=nv>group</span> <span class=o>=</span> latency<span class=o>)</span>: <span class=m>20</span> worst schedule-to-watch latencies: <span class=o>[{</span>test-tteu8b-2/latency-pod-rc-0-wdhxz node1 2.721939052s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-2-pwgsb node1 2.832899011s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-8-c5m4q node1 2.833924156s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-6-x7d4t node1 2.85439232s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-8-4kx24 node1 3.508582695s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-4-tbszn node1 3.865941757s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-5-xx7qn node2 5.411960877s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-1-4j655 node2 5.560606582s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-5-mjbsr node2 6.012828114s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-1-nk24t node2 6.066876643s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-2-rj7h5 node2 6.082626218s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-9-xmct4 node2 6.210054751s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-7-c7rst node2 6.611408502s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-6-wskwq node2 6.625719954s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-7-646cq node2 6.647809261s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-3-k8g85 node2 6.812513167s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-9-ww659 node2 7.009388509s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-4-ngh2t node2 7.140752308s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-3-42gdw node2 7.538575976s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-0-lnrtg node2 8.586231683s<span class=o>}]</span>
I1214 15:49:23.650616  <span class=m>129068</span> pod_startup_latency.go:313<span class=o>]</span> PodStartupLatency: labelSelector<span class=o>(</span><span class=nv>group</span> <span class=o>=</span> latency<span class=o>)</span>: perc50: 6.066876643s, perc90: 7.140752308s, perc99: 8.586231683s<span class=p>;</span> threshold: 5s
I1214 15:49:23.650620  <span class=m>129068</span> pod_startup_latency.go:312<span class=o>]</span> PodStartupLatency: labelSelector<span class=o>(</span><span class=nv>group</span> <span class=o>=</span> latency<span class=o>)</span>: <span class=m>20</span> worst e2e latencies: <span class=o>[{</span>test-tteu8b-2/latency-pod-rc-0-wdhxz node1 2.721939052s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-2-pwgsb node1 2.832899011s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-8-c5m4q node1 2.833924156s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-6-x7d4t node1 2.85439232s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-8-4kx24 node1 3.508582695s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-4-tbszn node1 3.865941757s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-1-4j655 node2 5.560606582s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-5-mjbsr node2 6.012828114s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-1-nk24t node2 6.066876643s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-2-rj7h5 node2 6.082626218s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-9-xmct4 node2 6.210054751s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-5-xx7qn node2 6.411960877s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-7-c7rst node2 6.611408502s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-6-wskwq node2 6.625719954s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-7-646cq node2 6.647809261s<span class=o>}</span> <span class=o>{</span>test-tteu8b-2/latency-pod-rc-3-k8g85 node2 6.812513167s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-9-ww659 node2 7.009388509s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-4-ngh2t node2 7.140752308s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-3-42gdw node2 7.538575976s<span class=o>}</span> <span class=o>{</span>test-tteu8b-1/latency-pod-rc-0-lnrtg node2 8.586231683s<span class=o>}]</span>
I1214 15:49:23.650631  <span class=m>129068</span> pod_startup_latency.go:313<span class=o>]</span> PodStartupLatency: labelSelector<span class=o>(</span><span class=nv>group</span> <span class=o>=</span> latency<span class=o>)</span>: perc50: 6.082626218s, perc90: 7.140752308s, perc99: 8.586231683s<span class=p>;</span> threshold: 5s
E1214 15:49:23.651429  <span class=m>129068</span> pod_startup_latency.go:243<span class=o>]</span> PodStartupLatency: labelSelector<span class=o>(</span><span class=nv>group</span> <span class=o>=</span> latency<span class=o>)</span>: pod startup: too high latency 50th percentile: 6.082626218s
I1214 15:49:23.651671  <span class=m>129068</span> simple_test_executor.go:128<span class=o>]</span> Step <span class=s2>&#34;Deleting latancy pods&#34;</span> ended
I1214 15:49:24.054984  <span class=m>129068</span> wait_for_controlled_pods.go:196<span class=o>]</span> WaitForControlledPodsRunning: waiting <span class=k>for</span> controlled pods measurement...
I1214 15:49:28.720087  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>saturation-rc-0<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>1</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:28.910121  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-2<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>saturation-rc-0<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:33.720408  <span class=m>129068</span> wait_for_pods.go:141<span class=o>]</span> WaitForControlledPodsRunning: namespace<span class=o>(</span>test-tteu8b-1<span class=o>)</span>, labelSelector<span class=o>(</span><span class=nv>name</span><span class=o>=</span>saturation-rc-0<span class=o>)</span>: Pods: <span class=m>0</span> out of <span class=m>0</span> created, <span class=m>0</span> running, <span class=m>0</span> pending scheduled, <span class=m>0</span> not scheduled, <span class=m>0</span> inactive, <span class=m>0</span> terminating, <span class=m>0</span> unknown, <span class=m>0</span> runningButNotReady
I1214 15:49:33.723457  <span class=m>129068</span> wait_for_controlled_pods.go:235<span class=o>]</span> WaitForControlledPodsRunning: running 0, deleted 2, timeout: 0, unknown: <span class=m>0</span>
I1214 15:49:33.723518  <span class=m>129068</span> wait_for_controlled_pods.go:249<span class=o>]</span> WaitForControlledPodsRunning: 0/0 ReplicationControllers are running with all pods
I1214 15:49:33.723540  <span class=m>129068</span> simple_test_executor.go:128<span class=o>]</span> Step <span class=s2>&#34;Deleting saturation pods&#34;</span> ended
I1214 15:49:33.833335  <span class=m>129068</span> api_responsiveness.go:119<span class=o>]</span> APIResponsiveness: Top latency metric: <span class=o>{</span>Resource:pods Subresource: Verb:DELETE Scope:namespace Latency:<span class=o>{</span>Perc50:8.831ms Perc90:13.349ms Perc99:36.302ms<span class=o>}</span> Count:48<span class=o>}</span><span class=p>;</span> threshold: 1s
I1214 15:49:33.833401  <span class=m>129068</span> api_responsiveness.go:119<span class=o>]</span> APIResponsiveness: Top latency metric: <span class=o>{</span>Resource:pods Subresource: Verb:GET Scope:namespace Latency:<span class=o>{</span>Perc50:1.705ms Perc90:5.171ms Perc99:32.127ms<span class=o>}</span> Count:184<span class=o>}</span><span class=p>;</span> threshold: 1s
I1214 15:49:33.833407  <span class=m>129068</span> api_responsiveness.go:119<span class=o>]</span> APIResponsiveness: Top latency metric: <span class=o>{</span>Resource:pods Subresource:status Verb:PATCH Scope:namespace Latency:<span class=o>{</span>Perc50:2.893ms Perc90:8.968ms Perc99:20.499ms<span class=o>}</span> Count:105<span class=o>}</span><span class=p>;</span> threshold: 1s
I1214 15:49:33.833412  <span class=m>129068</span> api_responsiveness.go:119<span class=o>]</span> APIResponsiveness: Top latency metric: <span class=o>{</span>Resource:replicationcontrollers Subresource: Verb:DELETE Scope:namespace Latency:<span class=o>{</span>Perc50:4.333ms Perc90:10.995ms Perc99:19.334ms<span class=o>}</span> Count:22<span class=o>}</span><span class=p>;</span> threshold: 1s
I1214 15:49:33.833421  <span class=m>129068</span> api_responsiveness.go:119<span class=o>]</span> APIResponsiveness: Top latency metric: <span class=o>{</span>Resource:pods Subresource:binding Verb:POST Scope:namespace Latency:<span class=o>{</span>Perc50:2.979ms Perc90:9.545ms Perc99:18.153ms<span class=o>}</span> Count:24<span class=o>}</span><span class=p>;</span> threshold: 1s
I1214 15:49:34.572385  <span class=m>129068</span> resource_usage.go:124<span class=o>]</span> ResourceUsageSummary: gathering resource usage...
I1214 15:49:34.574852  <span class=m>129068</span> container_resource_gatherer.go:172<span class=o>]</span> Closed stop channel. Waiting <span class=k>for</span> <span class=m>1</span> workers
I1214 15:49:34.574936  <span class=m>129068</span> resource_gather_worker.go:90<span class=o>]</span> Closing worker <span class=k>for</span> node1
I1214 15:49:34.574949  <span class=m>129068</span> container_resource_gatherer.go:180<span class=o>]</span> Waitgroup finished.
I1214 15:49:34.576009  <span class=m>129068</span> system_pod_metrics.go:82<span class=o>]</span> skipping collection of system pod metrics
I1214 15:49:44.638344  <span class=m>129068</span> simple_test_executor.go:345<span class=o>]</span> Resources cleanup time: 10.059218091s
I1214 15:49:44.641394  <span class=m>129068</span> clusterloader.go:177<span class=o>]</span> --------------------------------------------------------------------------------
I1214 15:49:44.641440  <span class=m>129068</span> clusterloader.go:178<span class=o>]</span> Test Finished
I1214 15:49:44.641461  <span class=m>129068</span> clusterloader.go:179<span class=o>]</span>   Test: /home/wangb/perf-test/clusterloader2/testing/density/config2.yaml
I1214 15:49:44.641465  <span class=m>129068</span> clusterloader.go:180<span class=o>]</span>   Status: Success
I1214 15:49:44.641467  <span class=m>129068</span> clusterloader.go:184<span class=o>]</span> --------------------------------------------------------------------------------

</code></pre></td></tr></table></div></div><h5 id=4-测试报告>.4 测试报告</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=o>[</span>root@node1 clusterloader2<span class=o>]</span><span class=c1># ll reports/ -h</span>
total 260K
-rw-r--r-- <span class=m>1</span> root root 9.9K Dec <span class=m>14</span> 16:26 APIResponsiveness_density_2020-12-14T16:26:20+08:00.json
-rw-r--r-- <span class=m>1</span> root root 1.6K Dec <span class=m>14</span> 16:26 EtcdMetrics_density_2020-12-14T16:26:21+08:00.json
-rw-r--r-- <span class=m>1</span> root root  <span class=m>287</span> Dec <span class=m>14</span> 16:26 junit.xml
-rw-r--r-- <span class=m>1</span> root root 224K Dec <span class=m>14</span> 16:26 MetricsForE2E_density_2020-12-14T16:26:21+08:00.json
-rw-r--r-- <span class=m>1</span> root root 1.1K Dec <span class=m>14</span> 16:26 PodStartupLatency_SaturationPodStartupLatency_density_2020-12-14T16:25:43+08:00.json
-rw-r--r-- <span class=m>1</span> root root    <span class=m>3</span> Dec <span class=m>14</span> 16:26 ResourceUsageSummary_density_2020-12-14T16:26:21+08:00.json
-rw-r--r-- <span class=m>1</span> root root  <span class=m>400</span> Dec <span class=m>14</span> 16:26 SchedulingMetrics_density_2020-12-14T16:26:21+08:00.json
-rw-r--r-- <span class=m>1</span> root root   <span class=m>72</span> Dec <span class=m>14</span> 16:26 SchedulingThroughput_density_2020-12-14T16:25:43+08:00.json

</code></pre></td></tr></table></div></div><ul><li>测试的指标大多根据 metrics 获取</li><li>也有数据从 event 获取，比如 podStartupLatency</li></ul><h4 id=2-kubemark节点环境>.2 kubemark节点环境</h4><p>kubemark + clusterloader2方式测试</p><p>测试环境：总节点数8个：本地虚拟机2节点 + 6个kubemark节点
虚拟机内存大小为2G</p><ol><li>启动kubemark节点</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=o>[</span>root@node1 wangb<span class=o>]</span><span class=c1># kubectl get no</span>
NAME            STATUS   ROLES         AGE     VERSION
hollow-node-0   Ready    &lt;none&gt;        9s      v0.0.0-master+4d3c9e0c
hollow-node-1   Ready    &lt;none&gt;        9s      v0.0.0-master+4d3c9e0c
hollow-node-2   Ready    &lt;none&gt;        9s      v0.0.0-master+4d3c9e0c
hollow-node-3   Ready    &lt;none&gt;        9s      v0.0.0-master+4d3c9e0c
hollow-node-4   Ready    &lt;none&gt;        9s      v0.0.0-master+4d3c9e0c
hollow-node-5   Ready    &lt;none&gt;        9s      v0.0.0-master+4d3c9e0c
node1           Ready    master,node   7d22h   v1.14.8
node2           Ready    node          7d22h   v1.14.8

</code></pre></td></tr></table></div></div><ol start=2><li>clusterloader test config.yaml</li></ol><h5 id=node-pod状态>node-pod状态</h5><p>在node上运行的pod</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>test-l3zhzg-2   saturation-rc-0-gmx45             1/1     Running             <span class=m>0</span>          2m19s   10.152.121.76     hollow-node-1   &lt;none&gt;           &lt;none&gt;
test-l3zhzg-2   saturation-rc-0-grbkl             1/1     Running             <span class=m>0</span>          2m19s   10.233.90.157     node1           &lt;none&gt;           &lt;none&gt;
test-l3zhzg-2   saturation-rc-0-jtw77             1/1     Running             <span class=m>0</span>          2m17s   10.233.96.78      node2           &lt;none&gt;           &lt;none&gt;
test-l3zhzg-2   saturation-rc-0-krzkt             1/1     Running             <span class=m>0</span>          2m19s   10.88.194.43      hollow-node-0   &lt;none&gt;           &lt;none&gt;
test-l3zhzg-2   saturation-rc-0-kskvv             1/1     Running             <span class=m>0</span>          2m16s   10.177.65.132     hollow-node-4   &lt;none&gt;           &lt;none&gt;
test-l3zhzg-2   saturation-rc-0-l4zbp             1/1     Running             <span class=m>0</span>          2m19s   10.16.150.60      hollow-node-0   &lt;none&gt;           &lt;none&gt;
test-l3zhzg-2   saturation-rc-0-l89cz             1/1     Running             <span class=m>0</span>          2m13s   10.118.8.133      hollow-node-1   &lt;none&gt;           &lt;none&gt;
test-l3zhzg-2   saturation-rc-0-lp8tp             1/1     Running             <span class=m>0</span>          2m19s   10.220.39.235     hollow-node-3   &lt;none&gt;           &lt;none&gt;
test-l3zhzg-2   saturation-rc-0-ls9zw             1/1     Running             <span class=m>0</span>          2m19s   10.15.197.103     hollow-node-2   &lt;none&gt;           &lt;none&gt;
test-l3zhzg-2   saturation-rc-0-m64hg             1/1     Running             <span class=m>0</span>          2m14s   10.172.167.195    hollow-node-2   &lt;none&gt;           &lt;none&gt;
test-l3zhzg-2   saturation-rc-0-m7qct             1/1     Running             <span class=m>0</span>          2m17s   10.41.26.226      hollow-node-4   &lt;none&gt;           &lt;none&gt;
test-l3zhzg-2   saturation-rc-0-mct9d             1/1     Running             <span class=m>0</span>          2m18s   10.126.207.219    hollow-node-4   &lt;none&gt;           &lt;none&gt;
test-l3zhzg-2   saturation-rc-0-ml2fw             1/1     Running             <span class=m>0</span>          2m13s   10.245.91.90      hollow-node-2   &lt;none&gt;           &lt;none&gt;
test-l3zhzg-2   saturation-rc-0-mndt2             1/1     Running             <span class=m>0</span>          2m19s   10.177.227.228    hollow-node-3   &lt;none&gt;           &lt;none&gt;
test-l3zhzg-2   saturation-rc-0-n6tzb             1/1     Running             <span class=m>0</span>          2m13s   10.76.229.141     hollow-node-3   &lt;none&gt;           &lt;none&gt;
test-l3zhzg-2   saturation-rc-0-nfq2d             1/1     Running             <span class=m>0</span>          2m19s   10.172.121.37     hollow-node-4   &lt;none&gt;           &lt;none&gt;
test-l3zhzg-2   saturation-rc-0-nn4wn             1/1     Running             <span class=m>0</span>          2m18s   10.22.201.220     hollow-node-0   &lt;none&gt;           &lt;none&gt;
test-l3zhzg-2   saturation-rc-0-nvpz7             1/1     Running             <span class=m>0</span>          2m16s   10.3.93.180       hollow-node-5   &lt;none&gt;           &lt;none&gt;
test-l3zhzg-2   saturation-rc-0-pfw58             1/1     Running             <span class=m>0</span>          2m16s   10.144.139.248    hollow-node-1   &lt;none&gt;           &lt;none&gt;
test-l3zhzg-2   saturation-rc-0-pqbd6             1/1     Running             <span class=m>0</span>          2m17s   10.207.147.215    hollow-node-0   &lt;none&gt;           &lt;none&gt;
test-l3zhzg-2   saturation-rc-0-q9x97             1/1     Running             <span class=m>0</span>          2m14s   10.233.90.149     node1           &lt;none&gt;           &lt;none&gt;
test-l3zhzg-2   saturation-rc-0-qslqs             1/1     Running             <span class=m>0</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>I1215 13:59:14.776944   <span class=m>27607</span> wait_for_controlled_pods.go:249<span class=o>]</span> WaitForControlledPodsRunning: 2/2 ReplicationControllers are running with all pods
I1215 13:59:14.777038   <span class=m>27607</span> pod_startup_latency.go:163<span class=o>]</span> PodStartupLatency: labelSelector<span class=o>(</span><span class=nv>group</span> <span class=o>=</span> saturation<span class=o>)</span>: gathering pod startup latency measurement...
I1215 13:59:14.795377   <span class=m>27607</span> pod_startup_latency.go:312<span class=o>]</span> PodStartupLatency: labelSelector<span class=o>(</span><span class=nv>group</span> <span class=o>=</span> saturation<span class=o>)</span>: <span class=m>40</span> worst create-to-schedule latencies: <span class=o>[{</span>test-bijvxv-1/saturation-rc-0-gktmn hollow-node-1 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-1/saturation-rc-0-gv9qb hollow-node-2 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-1/saturation-rc-0-n4cm5 hollow-node-4 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-2/saturation-rc-0-bn9z4 hollow-node-4 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-2/saturation-rc-0-srlf6 hollow-node-0 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-2/saturation-rc-0-btbng hollow-node-1 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-1/saturation-rc-0-kkcr7 hollow-node-5 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-2/saturation-rc-0-dctpp hollow-node-0 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-1/saturation-rc-0-5m8b2 hollow-node-1 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-1/saturation-rc-0-fpg6d hollow-node-2 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-1/saturation-rc-0-tjkvs hollow-node-4 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-2/saturation-rc-0-z6vtd hollow-node-2 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-2/saturation-rc-0-hrpwd hollow-node-3 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-2/saturation-rc-0-hzvk9 hollow-node-1 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-1/saturation-rc-0-x9b4c hollow-node-0 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-2/saturation-rc-0-4cqkz hollow-node-0 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-2/saturation-rc-0-4nppr node2 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-1/saturation-rc-0-rz69k hollow-node-2 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-2/saturation-rc-0-btsq4 hollow-node-3 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-1/saturation-rc-0-ll8sk hollow-node-3 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-1/saturation-rc-0-zjs57 hollow-node-1 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-1/saturation-rc-0-dq7x4 hollow-node-5 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-2/saturation-rc-0-fgxjz hollow-node-4 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-1/saturation-rc-0-g2bcp node1 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-2/saturation-rc-0-qp9pg hollow-node-3 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-1/saturation-rc-0-bdqzd hollow-node-5 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-1/saturation-rc-0-j5s2q hollow-node-4 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-2/saturation-rc-0-cp2wn node1 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-2/saturation-rc-0-2z8ct node1 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-2/saturation-rc-0-q6hd5 hollow-node-1 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-2/saturation-rc-0-68wwc hollow-node-5 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-2/saturation-rc-0-5t2wb hollow-node-4 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-1/saturation-rc-0-lt8ws hollow-node-0 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-1/saturation-rc-0-dwqz4 hollow-node-3 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-1/saturation-rc-0-vj68z node2 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-2/saturation-rc-0-96l5s hollow-node-5 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-1/saturation-rc-0-v7jq6 hollow-node-3 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-2/saturation-rc-0-8g4hx hollow-node-5 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-2/saturation-rc-0-hj7c7 hollow-node-2 0s<span class=o>}</span> <span class=o>{</span>test-bijvxv-1/saturation-rc-0-gx72w hollow-node-0 0s<span class=o>}]</span>
I1215 13:59:14.795463   <span class=m>27607</span> pod_startup_latency.go:313<span class=o>]</span> PodStartupLatency: labelSelector<span class=o>(</span><span class=nv>group</span> <span class=o>=</span> saturation<span class=o>)</span>: perc50: 0s, perc90: 0s, perc99: 0s<span class=p>;</span> threshold: 3m2s

</code></pre></td></tr></table></div></div><h5 id=测试1>测试1</h5><ul><li>NODES_PER_NAMESPACE 4</li><li>PODS_PER_NODE 5</li><li>MIN_LATENCY_PODS 20</li></ul><p>首先能够看到hollow-node和真实node上(共8个节点)都运行了pod</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>I1215 14:05:35.050407   <span class=m>35029</span> wait_for_controlled_pods.go:249<span class=o>]</span> WaitForControlledPodsRunning: 0/0 ReplicationControllers are running with all pods
I1215 14:05:35.050777   <span class=m>35029</span> simple_test_executor.go:128<span class=o>]</span> Step <span class=s2>&#34;Deleting saturation pods&#34;</span> ended
I1215 14:05:35.159705   <span class=m>35029</span> api_responsiveness.go:119<span class=o>]</span> APIResponsiveness: Top latency metric: <span class=o>{</span>Resource:pods Subresource: Verb:POST Scope:namespace Latency:<span class=o>{</span>Perc50:2.613ms Perc90:11.315ms Perc99:52.045ms<span class=o>}</span> Count:180<span class=o>}</span><span class=p>;</span> threshold: 1s
I1215 14:05:35.159757   <span class=m>35029</span> api_responsiveness.go:119<span class=o>]</span> APIResponsiveness: Top latency metric: <span class=o>{</span>Resource:pods Subresource: Verb:DELETE Scope:namespace Latency:<span class=o>{</span>Perc50:5.669ms Perc90:15.912ms Perc99:36.005ms<span class=o>}</span> Count:360<span class=o>}</span><span class=p>;</span> threshold: 1s
I1215 14:05:35.159762   <span class=m>35029</span> api_responsiveness.go:119<span class=o>]</span> APIResponsiveness: Top latency metric: <span class=o>{</span>Resource:pods Subresource:binding Verb:POST Scope:namespace Latency:<span class=o>{</span>Perc50:2.547ms Perc90:14.111ms Perc99:26.474ms<span class=o>}</span> Count:180<span class=o>}</span><span class=p>;</span> threshold: 1s
I1215 14:05:35.159767   <span class=m>35029</span> api_responsiveness.go:119<span class=o>]</span> APIResponsiveness: Top latency metric: <span class=o>{</span>Resource:nodes Subresource:status Verb:PATCH Scope:cluster Latency:<span class=o>{</span>Perc50:8.703ms Perc90:20.129ms Perc99:23.056ms<span class=o>}</span> Count:14<span class=o>}</span><span class=p>;</span> threshold: 1s
I1215 14:05:35.159772   <span class=m>35029</span> api_responsiveness.go:119<span class=o>]</span> APIResponsiveness: Top latency metric: <span class=o>{</span>Resource:pods Subresource:status Verb:PATCH Scope:namespace Latency:<span class=o>{</span>Perc50:2.698ms Perc90:7.41ms Perc99:19.599ms<span class=o>}</span> Count:905<span class=o>}</span><span class=p>;</span> threshold: 1s
I1215 14:05:35.470022   <span class=m>35029</span> resource_usage.go:124<span class=o>]</span> ResourceUsageSummary: gathering resource usage...
I1215 14:05:35.470058   <span class=m>35029</span> container_resource_gatherer.go:172<span class=o>]</span> Closed stop channel. Waiting <span class=k>for</span> <span class=m>1</span> workers
I1215 14:05:35.470072   <span class=m>35029</span> resource_gather_worker.go:90<span class=o>]</span> Closing worker <span class=k>for</span> node1
I1215 14:05:35.470079   <span class=m>35029</span> container_resource_gatherer.go:180<span class=o>]</span> Waitgroup finished.
I1215 14:05:35.470202   <span class=m>35029</span> system_pod_metrics.go:82<span class=o>]</span> skipping collection of system pod metrics
I1215 14:05:45.494628   <span class=m>35029</span> simple_test_executor.go:345<span class=o>]</span> Resources cleanup time: 10.023988649s
I1215 14:05:45.494661   <span class=m>35029</span> clusterloader.go:177<span class=o>]</span> --------------------------------------------------------------------------------
I1215 14:05:45.494665   <span class=m>35029</span> clusterloader.go:178<span class=o>]</span> Test Finished
I1215 14:05:45.494669   <span class=m>35029</span> clusterloader.go:179<span class=o>]</span>   Test: /home/wangb/perf-test/clusterloader2/testing/density/config3.yaml
I1215 14:05:45.494673   <span class=m>35029</span> clusterloader.go:180<span class=o>]</span>   Status: Success
I1215 14:05:45.494677   <span class=m>35029</span> clusterloader.go:184<span class=o>]</span> --------------------------------------------------------------------------------


</code></pre></td></tr></table></div></div><h5 id=测试2>测试2</h5><ul><li>NODES_PER_NAMESPACE 4</li><li>PODS_PER_NODE 20</li><li>MIN_LATENCY_PODS 200</li></ul><p>能够看到 apiserver的响应延时比上面的用例要大</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>
I1215 14:16:30.674465   <span class=m>49564</span> api_responsiveness.go:119<span class=o>]</span> APIResponsiveness: Top latency metric: <span class=o>{</span>Resource:pods Subresource: Verb:DELETE Scope:namespace Latency:<span class=o>{</span>Perc50:6.124ms Perc90:17.215ms Perc99:36.206ms<span class=o>}</span> Count:720<span class=o>}</span><span class=p>;</span> threshold: 1s
I1215 14:16:30.674524   <span class=m>49564</span> api_responsiveness.go:119<span class=o>]</span> APIResponsiveness: Top latency metric: <span class=o>{</span>Resource:pods Subresource: Verb:POST Scope:namespace Latency:<span class=o>{</span>Perc50:2.713ms Perc90:12.849ms Perc99:35.964ms<span class=o>}</span> Count:360<span class=o>}</span><span class=p>;</span> threshold: 1s
I1215 14:16:30.674530   <span class=m>49564</span> api_responsiveness.go:119<span class=o>]</span> APIResponsiveness: Top latency metric: <span class=o>{</span>Resource:pods Subresource:binding Verb:POST Scope:namespace Latency:<span class=o>{</span>Perc50:2.481ms Perc90:11.292ms Perc99:29.995ms<span class=o>}</span> Count:360<span class=o>}</span><span class=p>;</span> threshold: 1s
I1215 14:16:30.674535   <span class=m>49564</span> api_responsiveness.go:119<span class=o>]</span> APIResponsiveness: Top latency metric: <span class=o>{</span>Resource:replicationcontrollers Subresource: Verb:DELETE Scope:namespace Latency:<span class=o>{</span>Perc50:3.972ms Perc90:8.978ms Perc99:28.475ms<span class=o>}</span> Count:202<span class=o>}</span><span class=p>;</span> threshold: 1s
I1215 14:16:30.674543   <span class=m>49564</span> api_responsiveness.go:119<span class=o>]</span> APIResponsiveness: Top latency metric: <span class=o>{</span>Resource:pods Subresource:status Verb:PATCH Scope:namespace Latency:<span class=o>{</span>Perc50:2.61ms Perc90:7.179ms Perc99:27.04ms<span class=o>}</span> Count:1891<span class=o>}</span><span class=p>;</span> threshold: 1s
I1215 14:16:31.136547   <span class=m>49564</span> resource_usage.go:124<span class=o>]</span> ResourceUsageSummary: gathering resource usage...
I1215 14:16:31.136595   <span class=m>49564</span> container_resource_gatherer.go:172<span class=o>]</span> Closed stop channel. Waiting <span class=k>for</span> <span class=m>1</span> workers
I1215 14:16:31.136612   <span class=m>49564</span> resource_gather_worker.go:90<span class=o>]</span> Closing worker <span class=k>for</span> node1
I1215 14:16:31.136619   <span class=m>49564</span> container_resource_gatherer.go:180<span class=o>]</span> Waitgroup finished.
I1215 14:16:31.136708   <span class=m>49564</span> system_pod_metrics.go:82<span class=o>]</span> skipping collection of system pod metrics
I1215 14:16:41.156280   <span class=m>49564</span> simple_test_executor.go:345<span class=o>]</span> Resources cleanup time: 10.019116668s
I1215 14:16:41.156316   <span class=m>49564</span> clusterloader.go:177<span class=o>]</span> --------------------------------------------------------------------------------
I1215 14:16:41.156321   <span class=m>49564</span> clusterloader.go:178<span class=o>]</span> Test Finished
I1215 14:16:41.156326   <span class=m>49564</span> clusterloader.go:179<span class=o>]</span>   Test: /home/wangb/perf-test/clusterloader2/testing/density/config3.yaml
I1215 14:16:41.156330   <span class=m>49564</span> clusterloader.go:180<span class=o>]</span>   Status: Success
I1215 14:16:41.156334   <span class=m>49564</span> clusterloader.go:184<span class=o>]</span> --------------------------------------------------------------------------------

</code></pre></td></tr></table></div></div><h5 id=测试3>测试3</h5><ul><li>NODES_PER_NAMESPACE 4</li><li>PODS_PER_NODE 25</li><li>MIN_LATENCY_PODS 200</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>
I1215 16:19:38.812083   <span class=m>32636</span> api_responsiveness.go:119<span class=o>]</span> APIResponsiveness: Top latency metric: <span class=o>{</span>Resource:subjectaccessreviews Subresource: Verb:POST Scope:cluster Latency:<span class=o>{</span>Perc50:396µs Perc90:14.48ms Perc99:66.33ms<span class=o>}</span> Count:37<span class=o>}</span><span class=p>;</span> threshold: 1s
I1215 16:19:38.812151   <span class=m>32636</span> api_responsiveness.go:119<span class=o>]</span> APIResponsiveness: Top latency metric: <span class=o>{</span>Resource:nodes Subresource:status Verb:PATCH Scope:cluster Latency:<span class=o>{</span>Perc50:6.048ms Perc90:32.049ms Perc99:54.374ms<span class=o>}</span> Count:24<span class=o>}</span><span class=p>;</span> threshold: 1s
I1215 16:19:38.812159   <span class=m>32636</span> api_responsiveness.go:119<span class=o>]</span> APIResponsiveness: Top latency metric: <span class=o>{</span>Resource:pods Subresource: Verb:POST Scope:namespace Latency:<span class=o>{</span>Perc50:3.118ms Perc90:12.026ms Perc99:34.693ms<span class=o>}</span> Count:400<span class=o>}</span><span class=p>;</span> threshold: 1s
I1215 16:19:38.812169   <span class=m>32636</span> api_responsiveness.go:119<span class=o>]</span> APIResponsiveness: Top latency metric: <span class=o>{</span>Resource:endpoints Subresource: Verb:PUT Scope:namespace Latency:<span class=o>{</span>Perc50:2.467ms Perc90:7.957ms Perc99:34.158ms<span class=o>}</span> Count:166<span class=o>}</span><span class=p>;</span> threshold: 1s
I1215 16:19:38.812174   <span class=m>32636</span> api_responsiveness.go:119<span class=o>]</span> APIResponsiveness: Top latency metric: <span class=o>{</span>Resource:pods Subresource: Verb:DELETE Scope:namespace Latency:<span class=o>{</span>Perc50:6.106ms Perc90:13.581ms Perc99:33.557ms<span class=o>}</span> Count:800<span class=o>}</span><span class=p>;</span> threshold: 1s
I1215 16:19:39.258943   <span class=m>32636</span> resource_usage.go:124<span class=o>]</span> ResourceUsageSummary: gathering resource usage...
I1215 16:19:39.258993   <span class=m>32636</span> container_resource_gatherer.go:172<span class=o>]</span> Closed stop channel. Waiting <span class=k>for</span> <span class=m>1</span> workers
I1215 16:19:39.259012   <span class=m>32636</span> resource_gather_worker.go:90<span class=o>]</span> Closing worker <span class=k>for</span> node1
I1215 16:19:39.259027   <span class=m>32636</span> container_resource_gatherer.go:180<span class=o>]</span> Waitgroup finished.
I1215 16:19:39.259125   <span class=m>32636</span> system_pod_metrics.go:82<span class=o>]</span> skipping collection of system pod metrics
I1215 16:19:49.287916   <span class=m>32636</span> simple_test_executor.go:345<span class=o>]</span> Resources cleanup time: 10.028043195s
I1215 16:19:49.287943   <span class=m>32636</span> clusterloader.go:177<span class=o>]</span> --------------------------------------------------------------------------------
I1215 16:19:49.287946   <span class=m>32636</span> clusterloader.go:178<span class=o>]</span> Test Finished
I1215 16:19:49.287948   <span class=m>32636</span> clusterloader.go:179<span class=o>]</span>   Test: /home/wangb/perf-test/clusterloader2/testing/density/config3.yaml
I1215 16:19:49.287951   <span class=m>32636</span> clusterloader.go:180<span class=o>]</span>   Status: Success
I1215 16:19:49.287954   <span class=m>32636</span> clusterloader.go:184<span class=o>]</span> --------------------------------------------------------------------------------

</code></pre></td></tr></table></div></div><h5 id=测试4>测试4</h5><ul><li>NODES_PER_NAMESPACE 4</li><li>PODS_PER_NODE 30</li><li>MIN_LATENCY_PODS 500</li></ul><p>API访问超时，虚拟机OOM报错，无法再运行测试用例</p><h2 id=4-问题>4 问题</h2><h3 id=1-提示-getting-master-name-error-master-node-not-found和-getting-master-internal-ip-error-didnt-find-any-internalip-master-ips>1. 提示 Getting master name error: master node not found和 Getting master internal ip error: didn&rsquo;t find any InternalIP master IPs</h3><p>mastername和 internalip 参数需要配置</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>I1211 11:10:31.302599  <span class=m>118141</span> clusterloader.go:105<span class=o>]</span> ClusterConfig.Nodes <span class=nb>set</span> to <span class=m>2</span>
E1211 11:10:31.304485  <span class=m>118141</span> clusterloader.go:113<span class=o>]</span> Getting master name error: master node not found
E1211 11:10:31.307705  <span class=m>118141</span> clusterloader.go:122<span class=o>]</span> Getting master external ip error: didn<span class=s1>&#39;t find any ExternalIP master IPs
</span><span class=s1>E1211 11:10:31.309369  118141 clusterloader.go:131] Getting master internal ip error: didn&#39;</span>t find any InternalIP master IPs
I1211 11:10:31.309388  <span class=m>118141</span> clusterloader.go:206<span class=o>]</span> Using config: <span class=o>{</span>ClusterConfig:<span class=o>{</span>KubeConfigPath:/root/.kube/config Nodes:2 Provider: MasterIPs:<span class=o>[]</span> MasterInternalIPs:<span class=o>[]</span> MasterName: KubemarkRootKubeConfigPath:<span class=o>}</span> ReportDir:./reports EnablePrometheusServer:false TearDownPrometheusServer:false TestConfigPath: TestOverridesPath:<span class=o>[]</span> PrometheusConfig:<span class=o>{</span>EnableServer:false TearDownServer:true ScrapeEtcd:false ScrapeNodeExporter:false ScrapeKubelets:false ScrapeKubeProxy:true SnapshotProject:<span class=o>}}</span>
I1211 11:10:31.311334  <span class=m>118141</span> cluster.go:56<span class=o>]</span> Listing cluster nodes:
I1211 11:10:31.311348  <span class=m>118141</span> cluster.go:68<span class=o>]</span> Name: node1, clusterIP: 192.168.182.101, externalIP: , isSchedulable: <span class=nb>true</span>
I1211 11:10:31.311354  <span class=m>118141</span> cluster.go:68<span class=o>]</span> Name: node2, clusterIP: 192.168.182.102, externalIP: , isSchedulable: <span class=nb>true</span>
I1211 11:10:31.314575  <span class=m>118141</span> clusterloader.go:167<span class=o>]</span> --------------------------------------------------------------------------------
I1211 11:10:31.314588  <span class=m>118141</span> clusterloader.go:168<span class=o>]</span> Running /home/wangb/perf-test/clusterloader2/testing/density/config.yaml
I1211 11:10:31.314591  <span class=m>118141</span> clusterloader.go:169<span class=o>]</span> --------------------------------------------------------------------------------
</code></pre></td></tr></table></div></div><h3 id=2--errors-measurement-call-testmetrics---testmetrics-error-unexpected-error-code-0-in-ssh-connection-to-master-errorserrorstringserror-getting-signer-for-provider--getsigner-not-implemented-for->2. Errors: [measurement call TestMetrics - TestMetrics error: [unexpected error (code: 0) in ssh connection to master: &errors.errorString{s:&ldquo;error getting signer for provider : &lsquo;GetSigner(&mldr;) not implemented for &lsquo;"}]</h3><p>测试配置了TestMetrics measurement，但是没有通过。</p><p>ssh问题，参数不正确，还需要自定义环境变量配置KUBE_SSH_KEY_PATH=/root/.ssh/id_rsa</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>E1211 11:34:39.085551   <span class=m>19551</span> test_metrics.go:185<span class=o>]</span> TestMetrics: <span class=o>[</span>unexpected error <span class=o>(</span>code: 0<span class=o>)</span> in ssh connection to master: <span class=p>&amp;</span>errors.errorString<span class=o>{</span>s:<span class=s2>&#34;error getting signer for provider : &#39;GetSigner(...) not implemented for &#39;&#34;</span><span class=o>}</span>
unexpected error <span class=o>(</span>code: 0<span class=o>)</span> in ssh connection to master: <span class=p>&amp;</span>errors.errorString<span class=o>{</span>s:<span class=s2>&#34;error getting signer for provider : &#39;GetSigner(...) not implemented for &#39;&#34;</span><span class=o>}]</span>
I1211 11:34:49.103215   <span class=m>19551</span> simple_test_executor.go:345<span class=o>]</span> Resources cleanup time: 10.017395168s
E1211 11:34:49.103273   <span class=m>19551</span> clusterloader.go:177<span class=o>]</span> --------------------------------------------------------------------------------
E1211 11:34:49.103291   <span class=m>19551</span> clusterloader.go:178<span class=o>]</span> Test Finished
E1211 11:34:49.103295   <span class=m>19551</span> clusterloader.go:179<span class=o>]</span>   Test: /home/wangb/perf-test/clusterloader2/testing/density/config.yaml
E1211 11:34:49.103298   <span class=m>19551</span> clusterloader.go:180<span class=o>]</span>   Status: Fail
E1211 11:34:49.103301   <span class=m>19551</span> clusterloader.go:182<span class=o>]</span>   Errors: <span class=o>[</span>measurement call TestMetrics - TestMetrics error: <span class=o>[</span>unexpected error <span class=o>(</span>code: 0<span class=o>)</span> in ssh connection to master: <span class=p>&amp;</span>errors.errorString<span class=o>{</span>s:<span class=s2>&#34;error getting signer for provider : &#39;GetSigner(...) not implemented for &#39;&#34;</span><span class=o>}]</span>
measurement call APIResponsiveness - APIResponsiveness error: top latency metric: there should be no high-latency requests, but: <span class=o>[</span>got: <span class=o>{</span>Resource:endpoints Subresource: Verb:GET Scope:namespace Latency:<span class=o>{</span>Perc50:1.046ms Perc90:4.871ms Perc99:1.588679s<span class=o>}</span> Count:33<span class=o>}</span><span class=p>;</span> expected perc99 &lt;<span class=o>=</span> 1s<span class=o>]</span>
measurement call TestMetrics - TestMetrics error: <span class=o>[</span>unexpected error <span class=o>(</span>code: 0<span class=o>)</span> in ssh connection to master: <span class=p>&amp;</span>errors.errorString<span class=o>{</span>s:<span class=s2>&#34;error getting signer for provider : &#39;GetSigner(...) not implemented for &#39;&#34;</span><span class=o>}</span>
unexpected error <span class=o>(</span>code: 0<span class=o>)</span> in ssh connection to master: <span class=p>&amp;</span>errors.errorString<span class=o>{</span>s:<span class=s2>&#34;error getting signer for provider : &#39;GetSigner(...) not implemented for &#39;&#34;</span><span class=o>}]]</span>
E1211 11:34:49.103310   <span class=m>19551</span> clusterloader.go:184<span class=o>]</span> --------------------------------------------------------------------------------
F1211 11:34:49.106925   <span class=m>19551</span> clusterloader.go:276<span class=o>]</span> <span class=m>1</span> tests have failed!
</code></pre></td></tr></table></div></div><h3 id=3-告警提示master-node-is-not-registered-grabbing-metrics-from-scheduler-controllermanager-and-clusterautoscaler-is-disabled>3. 告警提示：Master node is not registered. Grabbing metrics from Scheduler, ControllerManager and ClusterAutoscaler is disabled.</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>
W1214 10:00:44.212402   <span class=m>40729</span> metrics_grabber.go:81<span class=o>]</span> Master node is not registered. Grabbing metrics from Scheduler, ControllerManager and ClusterAutoscaler is disabled.
I1214 10:00:44.268795   <span class=m>40729</span> resource_usage.go:124<span class=o>]</span> ResourceUsageSummary: gathering resource usage...
I1214 10:00:44.268822   <span class=m>40729</span> container_resource_gatherer.go:172<span class=o>]</span> Closed stop channel. Waiting <span class=k>for</span> <span class=m>0</span> workers
I1214 10:00:44.268851   <span class=m>40729</span> container_resource_gatherer.go:180<span class=o>]</span> Waitgroup finished.
I1214 10:00:44.268935   <span class=m>40729</span> system_pod_metrics.go:82<span class=o>]</span> skipping collection of system pod metrics
E1214 10:00:44.268946   <span class=m>40729</span> test_metrics.go:185<span class=o>]</span> TestMetrics: <span class=o>[</span>text format parsing error in line 1: invalid metric name<span class=o>]</span>
I1214 10:00:54.301192   <span class=m>40729</span> simple_test_executor.go:345<span class=o>]</span> Resources cleanup time: 10.031663914s
E1214 10:00:54.301219   <span class=m>40729</span> clusterloader.go:177<span class=o>]</span> --------------------------------------------------------------------------------
E1214 10:00:54.301222   <span class=m>40729</span> clusterloader.go:178<span class=o>]</span> Test Finished
E1214 10:00:54.301225   <span class=m>40729</span> clusterloader.go:179<span class=o>]</span>   Test: /home/wangb/perf-test/clusterloader2/testing/density/config2.yaml
E1214 10:00:54.301227   <span class=m>40729</span> clusterloader.go:180<span class=o>]</span>   Status: Fail
E1214 10:00:54.301229   <span class=m>40729</span> clusterloader.go:182<span class=o>]</span>   Errors: <span class=o>[</span>measurement call TestMetrics - TestMetrics error: <span class=o>[</span>text format parsing error in line 1: invalid metric name<span class=o>]]</span>
E1214 10:00:54.301233   <span class=m>40729</span> clusterloader.go:184<span class=o>]</span> --------------------------------------------------------------------------------
F1214 10:00:54.305222   <span class=m>40729</span> clusterloader.go:276<span class=o>]</span> <span class=m>1</span> tests have failed!

</code></pre></td></tr></table></div></div><p>排查过程，结合分析源码：</p><p>如果没有注册master节点，则测试不会统计调度器和controllers等组件信息
分处理逻辑，发现clusterloader2对master节点的判断条件不符合测试集群环境，如下。需要修改下clusterloader2的代码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-golang data-lang=golang>
<span class=c1>// TODO: find a better way of figuring out if given node is a registered master.
</span><span class=c1></span><span class=kd>func</span> <span class=nf>IsMasterNode</span><span class=p>(</span><span class=nx>nodeName</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
  <span class=c1>// We are trying to capture &#34;master(-...)?$&#34; regexp.
</span><span class=c1></span>  <span class=c1>// However, using regexp.MatchString() results even in more than 35%
</span><span class=c1></span>  <span class=c1>// of all space allocations in ControllerManager spent in this function.
</span><span class=c1></span>  <span class=c1>// That&#39;s why we are trying to be a bit smarter.
</span><span class=c1></span>  <span class=k>if</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>HasSuffix</span><span class=p>(</span><span class=nx>nodeName</span><span class=p>,</span> <span class=s>&#34;master&#34;</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=kc>true</span>
  <span class=p>}</span>
  <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>nodeName</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=mi>10</span> <span class=p>{</span>
    <span class=k>return</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>HasSuffix</span><span class=p>(</span><span class=nx>nodeName</span><span class=p>[:</span><span class=nb>len</span><span class=p>(</span><span class=nx>nodeName</span><span class=p>)</span><span class=o>-</span><span class=mi>3</span><span class=p>],</span> <span class=s>&#34;master-&#34;</span><span class=p>)</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=kc>false</span>
<span class=p>}</span>

</code></pre></td></tr></table></div></div><p>原有代码程序对master节点判断逻辑为：nodename为master或者master-开头
<strong>修改代码：在system.IsMasterNode(node.Name) 引用处，新增条件： node.Labels[&ldquo;node-role.kubernetes.io/master&rdquo;] == &ldquo;true&rdquo; ，作为master节点判断</strong></p><h3 id=4-etcdmetrics信息获取不到etcdmetrics-failed-to-collect-etcd-database-size>4. EtcdMetrics信息获取不到：EtcdMetrics: failed to collect etcd database size</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>
E1214 11:06:03.936128    <span class=m>2312</span> etcd_metrics.go:121<span class=o>]</span> EtcdMetrics: failed to collect etcd database size

</code></pre></td></tr></table></div></div><p>或者上报错误：TestMetrics: [text format parsing error in line 1: invalid metric name]</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>E1211 11:42:36.545827   <span class=m>30129</span> test_metrics.go:185<span class=o>]</span> TestMetrics: <span class=o>[</span>text format parsing error in line 1: invalid metric name<span class=o>]</span>
</code></pre></td></tr></table></div></div><p><a href=https://github.com/kubernetes/perf-tests/issues/875>https://github.com/kubernetes/perf-tests/issues/875</a>
提的问题没有人解答</p><p>最初先把testMetic测试项关闭，暂时规避该问题。可能跟metric服务数据采集有关。后来排查了下日志打印信息，发现有多处报错，要逐个排查。</p><p>分析源码应该是获取不到etcd的metrics导致，修改代码如下：
measurement/common/simple/etcd_metrics</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-golang data-lang=golang><span class=kd>func</span> <span class=p>(</span><span class=nx>e</span> <span class=o>*</span><span class=nx>etcdMetricsMeasurement</span><span class=p>)</span> <span class=nf>getEtcdMetrics</span><span class=p>(</span><span class=nx>host</span><span class=p>,</span> <span class=nx>provider</span> <span class=kt>string</span><span class=p>)</span> <span class=p>([]</span><span class=o>*</span><span class=nx>model</span><span class=p>.</span><span class=nx>Sample</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// Etcd is only exposed on localhost level. We are using ssh method
</span><span class=c1></span>  <span class=k>if</span> <span class=nx>provider</span> <span class=o>==</span> <span class=s>&#34;gke&#34;</span> <span class=p>{</span>
    <span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;%s: not grabbing etcd metrics through master SSH: unsupported for gke&#34;</span><span class=p>,</span> <span class=nx>e</span><span class=p>)</span>
    <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span>
  <span class=p>}</span>

  <span class=c1>// In https://github.com/kubernetes/kubernetes/pull/74690, mTLS is enabled for etcd server
</span><span class=c1></span>  <span class=c1>// http://localhost:2382 is specified to bypass TLS credential requirement when checking
</span><span class=c1></span>  <span class=c1>// etcd /metrics and /health.
</span><span class=c1></span>  <span class=c1>//if samples, err := e.sshEtcdMetrics(&#34;curl http://localhost:2382/metrics&#34;, host, provider); err == nil {
</span><span class=c1></span>  <span class=c1>//  return samples, nil
</span><span class=c1></span>  <span class=c1>//}
</span><span class=c1></span>
  <span class=c1>// fix: 问题错误信息：EtcdMetrics: failed to collect etcd database size
</span><span class=c1></span>  <span class=c1>// 这里需要根据实际测试环境情况，进行硬编码配置。 add by wangb
</span><span class=c1></span>  <span class=c1>// 先ssh，再执行metrics的cmd
</span><span class=c1></span>  <span class=k>if</span> <span class=nx>samples</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>e</span><span class=p>.</span><span class=nf>sshEtcdMetrics</span><span class=p>(</span><span class=s>&#34;curl https://localhost:2379/metrics -k --cert /etc/ssl/etcd/ssl/ca.pem --key /etc/ssl/etcd/ssl/ca-key.pem&#34;</span><span class=p>,</span> <span class=nx>host</span><span class=p>,</span> <span class=nx>provider</span><span class=p>);</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
    <span class=k>return</span> <span class=nx>samples</span><span class=p>,</span> <span class=kc>nil</span>
  <span class=p>}</span>

  <span class=c1>// Use old endpoint if new one fails.
</span><span class=c1></span>  <span class=k>return</span> <span class=nx>e</span><span class=p>.</span><span class=nf>sshEtcdMetrics</span><span class=p>(</span><span class=s>&#34;curl http://localhost:2379/metrics&#34;</span><span class=p>,</span> <span class=nx>host</span><span class=p>,</span> <span class=nx>provider</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>按上述修改后，再重新编译，问题解决</p><h3 id=5报错找不到资源--testmetrics-the-server-could-not-find-the-requested-resource-get-pods-kube-scheduler-19216818210110251>5.报错找不到资源 TestMetrics: [the server could not find the requested resource (get pods kube-scheduler-192.168.182.101:10251)]</h3><p>分析可能是 view resource no match 查询资源版本不匹配导致？？？</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>I1214 14:14:20.039016  <span class=m>126597</span> resource_usage.go:124<span class=o>]</span> ResourceUsageSummary: gathering resource usage...
I1214 14:14:20.039058  <span class=m>126597</span> container_resource_gatherer.go:172<span class=o>]</span> Closed stop channel. Waiting <span class=k>for</span> <span class=m>1</span> workers
I1214 14:14:20.039075  <span class=m>126597</span> resource_gather_worker.go:90<span class=o>]</span> Closing worker <span class=k>for</span> node1
I1214 14:14:20.039082  <span class=m>126597</span> container_resource_gatherer.go:180<span class=o>]</span> Waitgroup finished.
I1214 14:14:20.039181  <span class=m>126597</span> system_pod_metrics.go:82<span class=o>]</span> skipping collection of system pod metrics
E1214 14:14:20.039193  <span class=m>126597</span> test_metrics.go:185<span class=o>]</span> TestMetrics: <span class=o>[</span>the server could not find the requested resource <span class=o>(</span>get pods kube-scheduler-192.168.182.101:10251<span class=o>)]</span>
I1214 14:14:30.103890  <span class=m>126597</span> simple_test_executor.go:345<span class=o>]</span> Resources cleanup time: 10.064213743s
E1214 14:14:30.104163  <span class=m>126597</span> clusterloader.go:177<span class=o>]</span> --------------------------------------------------------------------------------
E1214 14:14:30.104170  <span class=m>126597</span> clusterloader.go:178<span class=o>]</span> Test Finished
E1214 14:14:30.104173  <span class=m>126597</span> clusterloader.go:179<span class=o>]</span>   Test: /home/wangb/perf-test/clusterloader2/testing/density/config2.yaml
E1214 14:14:30.104176  <span class=m>126597</span> clusterloader.go:180<span class=o>]</span>   Status: Fail
E1214 14:14:30.104178  <span class=m>126597</span> clusterloader.go:182<span class=o>]</span>   Errors: <span class=o>[</span>measurement call TestMetrics - TestMetrics error: <span class=o>[</span>the server could not find the requested resource <span class=o>(</span>delete pods kube-scheduler-192.168.182.101:10251<span class=o>)]</span>
measurement call TestMetrics - TestMetrics error: <span class=o>[</span>the server could not find the requested resource <span class=o>(</span>get pods kube-scheduler-192.168.182.101:10251<span class=o>)]]</span>
E1214 14:14:30.104180  <span class=m>126597</span> clusterloader.go:184<span class=o>]</span> --------------------------------------------------------------------------------
F1214 14:14:30.104658  <span class=m>126597</span> clusterloader.go:276<span class=o>]</span> <span class=m>1</span> tests have failed!

</code></pre></td></tr></table></div></div><p>分析代码如下，可能是在msternode下构造request时有问题。改用crul方式直接获取调度器metrics
common/simple/scheduler_latency.go</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-golang data-lang=golang><span class=c1>// Sends request to kube scheduler metrics
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>schedulerLatencyMeasurement</span><span class=p>)</span> <span class=nf>sendRequestToScheduler</span><span class=p>(</span><span class=nx>c</span> <span class=nx>clientset</span><span class=p>.</span><span class=nx>Interface</span><span class=p>,</span> <span class=nx>op</span><span class=p>,</span> <span class=nx>host</span><span class=p>,</span> <span class=nx>provider</span><span class=p>,</span> <span class=nx>masterName</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
  <span class=nx>opUpper</span> <span class=o>:=</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>ToUpper</span><span class=p>(</span><span class=nx>op</span><span class=p>)</span>
  <span class=k>if</span> <span class=nx>opUpper</span> <span class=o>!=</span> <span class=s>&#34;GET&#34;</span> <span class=o>&amp;&amp;</span> <span class=nx>opUpper</span> <span class=o>!=</span> <span class=s>&#34;DELETE&#34;</span> <span class=p>{</span>
    <span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;unknown REST request&#34;</span><span class=p>)</span>
  <span class=p>}</span>

  <span class=nx>nodes</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>CoreV1</span><span class=p>().</span><span class=nf>Nodes</span><span class=p>().</span><span class=nf>List</span><span class=p>(</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>ListOptions</span><span class=p>{})</span>
  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
    <span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
  <span class=p>}</span>

  <span class=kd>var</span> <span class=nx>masterRegistered</span> <span class=p>=</span> <span class=kc>false</span>
  <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>node</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>nodes</span><span class=p>.</span><span class=nx>Items</span> <span class=p>{</span>
    <span class=k>if</span> <span class=nx>node</span><span class=p>.</span><span class=nx>Labels</span><span class=p>[</span><span class=s>&#34;node-role.kubernetes.io/master&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s>&#34;true&#34;</span> <span class=o>||</span> <span class=nx>system</span><span class=p>.</span><span class=nf>IsMasterNode</span><span class=p>(</span><span class=nx>node</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span> <span class=p>{</span>
      <span class=nx>masterRegistered</span> <span class=p>=</span> <span class=kc>true</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=kd>var</span> <span class=nx>responseText</span> <span class=kt>string</span>
  <span class=c1>// masterRegistered时，client接口处理有问题，统一改使用curl -X 方式处理GET和DELETE  add by wangb start
</span><span class=c1></span>  <span class=nx>_</span> <span class=p>=</span> <span class=nx>masterRegistered</span>
  <span class=c1>//if masterRegistered {
</span><span class=c1></span>  <span class=c1>//  ctx, cancel := context.WithTimeout(context.Background(), singleRestCallTimeout)
</span><span class=c1></span>  <span class=c1>//  defer cancel()
</span><span class=c1></span>  <span class=c1>//
</span><span class=c1></span>  <span class=c1>//  body, err := c.CoreV1().RESTClient().Verb(opUpper).
</span><span class=c1></span>  <span class=c1>//    Context(ctx).
</span><span class=c1></span>  <span class=c1>//    Namespace(metav1.NamespaceSystem).
</span><span class=c1></span>  <span class=c1>//    Resource(&#34;pods&#34;).
</span><span class=c1></span>  <span class=c1>//    Name(fmt.Sprintf(&#34;kube-scheduler-%v:%v&#34;, masterName, ports.InsecureSchedulerPort)).
</span><span class=c1></span>  <span class=c1>//    SubResource(&#34;proxy&#34;).
</span><span class=c1></span>  <span class=c1>//    Suffix(&#34;metrics&#34;).
</span><span class=c1></span>  <span class=c1>//    Do().Raw()
</span><span class=c1></span>  <span class=c1>//
</span><span class=c1></span>  <span class=c1>//  if err != nil {
</span><span class=c1></span>  <span class=c1>//    return &#34;&#34;, err
</span><span class=c1></span>  <span class=c1>//  }
</span><span class=c1></span>  <span class=c1>//  responseText = string(body)
</span><span class=c1></span>  <span class=c1>//} else {
</span><span class=c1></span>  <span class=c1>//  // If master is not registered fall back to old method of using SSH.
</span><span class=c1></span>  <span class=c1>//  if provider == &#34;gke&#34; {
</span><span class=c1></span>  <span class=c1>//    klog.Infof(&#34;%s: not grabbing scheduler metrics through master SSH: unsupported for gke&#34;, s)
</span><span class=c1></span>  <span class=c1>//    return &#34;&#34;, nil
</span><span class=c1></span>  <span class=c1>//  }
</span><span class=c1></span>  <span class=c1>//
</span><span class=c1></span>  <span class=c1>//  cmd := &#34;curl -X &#34; + opUpper + &#34; http://localhost:10251/metrics&#34;
</span><span class=c1></span>  <span class=c1>//  sshResult, err := measurementutil.SSH(cmd, host+&#34;:22&#34;, provider)
</span><span class=c1></span>  <span class=c1>//  if err != nil || sshResult.Code != 0 {
</span><span class=c1></span>  <span class=c1>//    return &#34;&#34;, fmt.Errorf(&#34;unexpected error (code: %d) in ssh connection to master: %#v&#34;, sshResult.Code, err)
</span><span class=c1></span>  <span class=c1>//  }
</span><span class=c1></span>  <span class=c1>//  responseText = sshResult.Stdout
</span><span class=c1></span>  <span class=c1>//}
</span><span class=c1></span>
  <span class=c1>// curl http://localhost:10251/metrics 这个命令测试可用
</span><span class=c1></span>  <span class=nx>cmd</span> <span class=o>:=</span> <span class=s>&#34;curl -X &#34;</span> <span class=o>+</span> <span class=nx>opUpper</span> <span class=o>+</span> <span class=s>&#34; http://localhost:10251/metrics&#34;</span>
  <span class=nx>sshResult</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>measurementutil</span><span class=p>.</span><span class=nf>SSH</span><span class=p>(</span><span class=nx>cmd</span><span class=p>,</span> <span class=nx>host</span><span class=o>+</span><span class=s>&#34;:22&#34;</span><span class=p>,</span> <span class=nx>provider</span><span class=p>)</span>
  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>||</span> <span class=nx>sshResult</span><span class=p>.</span><span class=nx>Code</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
    <span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;unexpected error (code: %d) in ssh connection to master: %#v&#34;</span><span class=p>,</span> <span class=nx>sshResult</span><span class=p>.</span><span class=nx>Code</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
  <span class=p>}</span>
  <span class=nx>responseText</span> <span class=p>=</span> <span class=nx>sshResult</span><span class=p>.</span><span class=nx>Stdout</span>
  <span class=c1>// masterRegistered时，client接口处理有问题，统一改使用curl -X 方式处理GET和DELETE  add by wangb end
</span><span class=c1></span>  <span class=k>return</span> <span class=nx>responseText</span><span class=p>,</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><h3 id=6-测试结果指标异常输出>6. 测试结果指标异常输出</h3><p>不是问题，这是测试工具成功生效，并返回提示断言信息</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>I1214 15:25:56.117594   <span class=m>96634</span> wait_for_controlled_pods.go:235<span class=o>]</span> WaitForControlledPodsRunning: running 0, deleted 2, timeout: 0, unknown: <span class=m>0</span>
I1214 15:25:56.117625   <span class=m>96634</span> wait_for_controlled_pods.go:249<span class=o>]</span> WaitForControlledPodsRunning: 0/0 ReplicationControllers are running with all pods
I1214 15:25:56.124212   <span class=m>96634</span> simple_test_executor.go:128<span class=o>]</span> Step <span class=s2>&#34;Deleting saturation pods&#34;</span> ended
I1214 15:25:56.245924   <span class=m>96634</span> api_responsiveness.go:119<span class=o>]</span> APIResponsiveness: WARNING Top latency metric: <span class=o>{</span>Resource:endpoints Subresource: Verb:PUT Scope:namespace Latency:<span class=o>{</span>Perc50:2.65ms Perc90:22.594ms Perc99:1.122221s<span class=o>}</span> Count:22<span class=o>}</span><span class=p>;</span> threshold: 1s
I1214 15:25:56.245949   <span class=m>96634</span> api_responsiveness.go:119<span class=o>]</span> APIResponsiveness: WARNING Top latency metric: <span class=o>{</span>Resource:namespaces Subresource: Verb:GET Scope:cluster Latency:<span class=o>{</span>Perc50:11.99ms Perc90:1.005472s Perc99:1.084129s<span class=o>}</span> Count:13<span class=o>}</span><span class=p>;</span> threshold: 1s
I1214 15:25:56.245957   <span class=m>96634</span> api_responsiveness.go:119<span class=o>]</span> APIResponsiveness: WARNING Top latency metric: <span class=o>{</span>Resource:nodes Subresource:status Verb:PATCH Scope:cluster Latency:<span class=o>{</span>Perc50:1.00345s Perc90:1.00345s Perc99:1.00345s<span class=o>}</span> Count:1<span class=o>}</span><span class=p>;</span> threshold: 1s
I1214 15:25:56.245962   <span class=m>96634</span> api_responsiveness.go:119<span class=o>]</span> APIResponsiveness: Top latency metric: <span class=o>{</span>Resource:pods Subresource:status Verb:PATCH Scope:namespace Latency:<span class=o>{</span>Perc50:3.777ms Perc90:13.656ms Perc99:173.072ms<span class=o>}</span> Count:88<span class=o>}</span><span class=p>;</span> threshold: 1s
I1214 15:25:56.245966   <span class=m>96634</span> api_responsiveness.go:119<span class=o>]</span> APIResponsiveness: Top latency metric: <span class=o>{</span>Resource:pods Subresource: Verb:GET Scope:namespace Latency:<span class=o>{</span>Perc50:1.88ms Perc90:11.522ms Perc99:87.668ms<span class=o>}</span> Count:156<span class=o>}</span><span class=p>;</span> threshold: 1s
I1214 15:25:56.821263   <span class=m>96634</span> resource_usage.go:124<span class=o>]</span> ResourceUsageSummary: gathering resource usage...
I1214 15:25:56.823909   <span class=m>96634</span> container_resource_gatherer.go:172<span class=o>]</span> Closed stop channel. Waiting <span class=k>for</span> <span class=m>1</span> workers
I1214 15:25:56.824075   <span class=m>96634</span> resource_gather_worker.go:90<span class=o>]</span> Closing worker <span class=k>for</span> node1
I1214 15:25:56.824118   <span class=m>96634</span> container_resource_gatherer.go:180<span class=o>]</span> Waitgroup finished.
I1214 15:25:56.824313   <span class=m>96634</span> system_pod_metrics.go:82<span class=o>]</span> skipping collection of system pod metrics
I1214 15:26:06.865304   <span class=m>96634</span> simple_test_executor.go:345<span class=o>]</span> Resources cleanup time: 10.040658542s
E1214 15:26:06.865325   <span class=m>96634</span> clusterloader.go:177<span class=o>]</span> --------------------------------------------------------------------------------
E1214 15:26:06.865328   <span class=m>96634</span> clusterloader.go:178<span class=o>]</span> Test Finished
E1214 15:26:06.865330   <span class=m>96634</span> clusterloader.go:179<span class=o>]</span>   Test: /home/wangb/perf-test/clusterloader2/testing/density/config2.yaml
E1214 15:26:06.865335   <span class=m>96634</span> clusterloader.go:180<span class=o>]</span>   Status: Fail
E1214 15:26:06.865338   <span class=m>96634</span> clusterloader.go:182<span class=o>]</span>   Errors: <span class=o>[</span>measurement call APIResponsiveness - APIResponsiveness error: top latency metric: there should be no high-latency requests, but: <span class=o>[</span>got: <span class=o>{</span>Resource:endpoints Subresource: Verb:PUT Scope:namespace Latency:<span class=o>{</span>Perc50:2.65ms Perc90:22.594ms Perc99:1.122221s<span class=o>}</span> Count:22<span class=o>}</span><span class=p>;</span> expected perc99 &lt;<span class=o>=</span> 1s got: <span class=o>{</span>Resource:namespaces Subresource: Verb:GET Scope:cluster Latency:<span class=o>{</span>Perc50:11.99ms Perc90:1.005472s Perc99:1.084129s<span class=o>}</span> Count:13<span class=o>}</span><span class=p>;</span> expected perc99 &lt;<span class=o>=</span> 1s got: <span class=o>{</span>Resource:nodes Subresource:status Verb:PATCH Scope:cluster Latency:<span class=o>{</span>Perc50:1.00345s Perc90:1.00345s Perc99:1.00345s<span class=o>}</span> Count:1<span class=o>}</span><span class=p>;</span> expected perc99 &lt;<span class=o>=</span> 1s<span class=o>]]</span>
E1214 15:26:06.865341   <span class=m>96634</span> clusterloader.go:184<span class=o>]</span> --------------------------------------------------------------------------------
F1214 15:26:06.866736   <span class=m>96634</span> clusterloader.go:276<span class=o>]</span> <span class=m>1</span> tests have failed!

</code></pre></td></tr></table></div></div><p>由上看出，由于时延性能指标超过门限值1s，测试工具认为测试不通过。</p><p>修改下 测试配置文件中的PODS_PER_NODE参数，由10改为2，负载变小，则测试通过</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>I1214 15:35:53.874477  <span class=m>111782</span> wait_for_controlled_pods.go:235<span class=o>]</span> WaitForControlledPodsRunning: running 0, deleted 2, timeout: 0, unknown: <span class=m>0</span>
I1214 15:35:53.874751  <span class=m>111782</span> wait_for_controlled_pods.go:249<span class=o>]</span> WaitForControlledPodsRunning: 0/0 ReplicationControllers are running with all pods
I1214 15:35:53.874765  <span class=m>111782</span> simple_test_executor.go:128<span class=o>]</span> Step <span class=s2>&#34;Deleting saturation pods&#34;</span> ended
I1214 15:35:53.956315  <span class=m>111782</span> api_responsiveness.go:119<span class=o>]</span> APIResponsiveness: Top latency metric: <span class=o>{</span>Resource:replicationcontrollers Subresource:status Verb:PUT Scope:namespace Latency:<span class=o>{</span>Perc50:3.108ms Perc90:9.428ms Perc99:11.831ms<span class=o>}</span> Count:11<span class=o>}</span><span class=p>;</span> threshold: 1s
I1214 15:35:53.956378  <span class=m>111782</span> api_responsiveness.go:119<span class=o>]</span> APIResponsiveness: Top latency metric: <span class=o>{</span>Resource:pods Subresource:status Verb:PATCH Scope:namespace Latency:<span class=o>{</span>Perc50:2.767ms Perc90:7.49ms Perc99:9.821ms<span class=o>}</span> Count:21<span class=o>}</span><span class=p>;</span> threshold: 1s
I1214 15:35:53.956384  <span class=m>111782</span> api_responsiveness.go:119<span class=o>]</span> APIResponsiveness: Top latency metric: <span class=o>{</span>Resource:pods Subresource: Verb:GET Scope:namespace Latency:<span class=o>{</span>Perc50:1.797ms Perc90:5.05ms Perc99:9.388ms<span class=o>}</span> Count:36<span class=o>}</span><span class=p>;</span> threshold: 1s
I1214 15:35:53.956388  <span class=m>111782</span> api_responsiveness.go:119<span class=o>]</span> APIResponsiveness: Top latency metric: <span class=o>{</span>Resource:pods Subresource: Verb:POST Scope:namespace Latency:<span class=o>{</span>Perc50:7.554ms Perc90:8.879ms Perc99:8.879ms<span class=o>}</span> Count:4<span class=o>}</span><span class=p>;</span> threshold: 1s
I1214 15:35:53.956392  <span class=m>111782</span> api_responsiveness.go:119<span class=o>]</span> APIResponsiveness: Top latency metric: <span class=o>{</span>Resource:services Subresource: Verb:GET Scope:namespace Latency:<span class=o>{</span>Perc50:8.757ms Perc90:8.757ms Perc99:8.757ms<span class=o>}</span> Count:1<span class=o>}</span><span class=p>;</span> threshold: 1s
I1214 15:35:54.364397  <span class=m>111782</span> resource_usage.go:124<span class=o>]</span> ResourceUsageSummary: gathering resource usage...
I1214 15:35:54.364444  <span class=m>111782</span> container_resource_gatherer.go:172<span class=o>]</span> Closed stop channel. Waiting <span class=k>for</span> <span class=m>1</span> workers
I1214 15:35:54.364648  <span class=m>111782</span> resource_gather_worker.go:90<span class=o>]</span> Closing worker <span class=k>for</span> node1
I1214 15:35:54.364655  <span class=m>111782</span> container_resource_gatherer.go:180<span class=o>]</span> Waitgroup finished.
I1214 15:35:54.366369  <span class=m>111782</span> system_pod_metrics.go:82<span class=o>]</span> skipping collection of system pod metrics
I1214 15:36:04.390697  <span class=m>111782</span> simple_test_executor.go:345<span class=o>]</span> Resources cleanup time: 10.023892674s
I1214 15:36:04.390750  <span class=m>111782</span> clusterloader.go:177<span class=o>]</span> --------------------------------------------------------------------------------
I1214 15:36:04.390753  <span class=m>111782</span> clusterloader.go:178<span class=o>]</span> Test Finished
I1214 15:36:04.390756  <span class=m>111782</span> clusterloader.go:179<span class=o>]</span>   Test: /home/wangb/perf-test/clusterloader2/testing/density/config2.yaml
I1214 15:36:04.390758  <span class=m>111782</span> clusterloader.go:180<span class=o>]</span>   Status: Success
I1214 15:36:04.390760  <span class=m>111782</span> clusterloader.go:184<span class=o>]</span> --------------------------------------------------------------------------------
</code></pre></td></tr></table></div></div><h2 id=5-总结>5 总结</h2><ol><li>perf-test clusterloader2工具主要提供了性能压测，可配置性好，方便编写测试用例，并且统计了相应的性能指标</li><li>clusterloader2内置实现了k8s指标采集处理和指标阈值定义，参考文档：<a href=https://github.com/kubernetes/community/blob/master/sig-scalability/slos/slos.md target=_blank rel="noopener noreffer">Kubernetes scalability and performance SLIs/SLOs</a></li><li>clusterloader2没有详细的使用说明文档，目前来看不是可以拿来直接运行使用。所遇到问题一般只能依靠自己解决。</li><li>由于上面第3点，所遇问题较多，一般多涉及测试工具环境配置参数，另外clusterloader2对一些参数使用的是硬编码方式，导致无法直接使用原有工具，只能修改源码进行测试适配。</li><li>测试使用clusterloader2，需要详细了解其设计方案，才能运行测试用例</li><li>进行集群测试，需要了解集群测试指标定义，再编写测试配置</li><li>测试时需要预估下测试pod数量和内存占用情况，否则会引起OOM。</li><li><strong>clusterloader2并不是一个拿来即用的测试工具，还需结合测试环境进行改造适配，更像是K8S内部使用的类似脚手架的东西</strong></li></ol><h2 id=6-附录>6 附录</h2><p>参考命令</p><p>批量删除k8s测试命名空间及其资源，这里测试数据默认使用了test-开头的命令规则</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>kubectl get ns <span class=p>|</span>grep test- <span class=p>|</span>awk <span class=s1>&#39;{print $1}&#39;</span> <span class=p>|</span>xargs kubectl delete ns --force --grace-period<span class=o>=</span><span class=m>0</span>
</code></pre></td></tr></table></div></div><p>测试中如果出现异常，系统会残留有测试使用的资源参数，这里需要对实际情况进行调整</p><p>测试完成后的测试资源清理（如果测试后有测试数据资源残留的话）：</p><ol><li>测试ns、rc、pod清理</li><li>hollow-node 桩节点清理</li></ol><h4 id=k8s的sli-服务等级指标-和-slo-服务等级目标>K8S的SLI (服务等级指标) 和 SLO (服务等级目标)</h4><p>Kubernetes 社区提供了 SLI (服务等级指标) 和 SLO (服务等级目标) 系统性能测试、分析文档 <a href=https://github.com/kubernetes/community/blob/master/sig-scalability/slos/slos.md target=_blank rel="noopener noreffer">Kubernetes scalability and performance SLIs/SLOs</a>。模拟出一个 K8s cluster（Kubemark cluster），不受资源限制。cluster 中 master 是真实的机器，所有的 nodes 是 Hollow nodes。Hollow nodes 不会调用Docker，测试一套 K8s API 调用的完整流程，不会真正创建 pod。</p><p>社区开发了 perf-test/clusterloader2，可配置性好，并且统计了相应的性能指标</p><p>kubemark 不调用 CRI 接口之外，其它行为和 kubelet 基本一致</p><h3 id=etcd监控指标>Etcd监控指标</h3><p>参考: <a href=https://github.com/coreos/etcd/blob/master/Documentation/metrics.md>https://github.com/coreos/etcd/blob/master/Documentation/metrics.md</a></p><h4 id=领导者相关>领导者相关</h4><p>etcd_server_has_leader etcd是否有leader
etcd_server_leader_changes_seen_total etcd的leader变换次数
etcd_debugging_mvcc_db_total_size_in_bytes 数据库的大小
process_resident_memory_bytes 进程驻留内存</p><h4 id=网络相关>网络相关</h4><p>grpc_server_started_total grpc(高性能、开源的通用RPC(远程过程调用)框架)服务器启动总数
etcd_network_client_grpc_received_bytes_total 接收到grpc客户端的字节总数
etcd_network_client_grpc_sent_bytes_total 发送给grpc客户端的字节总数
etcd_network_peer_received_bytes_total etcd网络对等方接收的字节总数(对等网络，即对等计算机网络，是一种在对等者（Peer）之间分配任务和工作负载的分布式应用架构，是对等计算模型在应用层形成的一种组网或网络形式)
etcd_network_peer_sent_bytes_total etcd网络对等方发送的字节总数</p><h4 id=提案相关>提案相关</h4><p>etcd_server_proposals_failed_total 目前正在处理的提案(提交会议讨论决定的建议。)数量
etcd_server_proposals_pending 失败提案总数
etcd_server_proposals_committed_total 已落实共识提案的总数。
etcd_server_proposals_applied_total 已应用的共识提案总数。</p><h4 id=这些指标描述了磁盘操作的状态>这些指标描述了磁盘操作的状态。</h4><p>etcd_disk_backend_commit_duration_seconds_sum etcd磁盘后端提交持续时间秒数总和
etcd_disk_backend_commit_duration_seconds_bucket etcd磁盘后端提交持续时间</p><h4 id=快照>快照</h4><p>etcd_debugging_snap_save_total_duration_seconds_sum etcd快照保存用时</p><h4 id=文件>文件</h4><p>process_open_fds{service=&ldquo;etcd-k8s&rdquo;} 打开文件描述符的数量
process_max_fds{service=&ldquo;etcd-k8s&rdquo;} 打开文件描述符的最大数量
etcd_disk_wal_fsync_duration_seconds_sum Wal(预写日志系统)调用的fsync(将文件数据同步到硬盘)的延迟分布
etcd_disk_wal_fsync_duration_seconds_bucket 后端调用的提交的延迟分布</p><p>参考文章</p><ul><li><p><a href=https://blog.csdn.net/qingdao666666/article/details/104625457 target=_blank rel="noopener noreffer">Kubernetes测试系列 - 性能测试</a></p></li><li><p><a href=https://juejin.cn/post/6844904142389919758 target=_blank rel="noopener noreffer">kubernetes性能指标体系：clusterloader2</a></p></li><li><p><a href=https://www.colabug.com/2020/0428/7329883/ target=_blank rel="noopener noreffer">clusterloader2的漫漫踩坑路：最详细解析与使用指南</a></p></li><li><p><a href=https://github.com/kubernetes/perf-tests/blob/master/clusterloader2/docs/design.md target=_blank rel="noopener noreffer">clusterloader2设计说明：Cluster loader vision</a></p></li><li><p><a href=https://sysdig.com/blog/monitor-etcd/ target=_blank rel="noopener noreffer">etcd指标监控，参考文章</a></p></li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2020-12-15</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/k8s/>K8S</a></section><section><span><a href=javascript:void(0); onclick=window.history.back();>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/2020-12-08-kubemark-perf-test/ class=prev rel=prev title=K8S集群性能测试-kubemark><i class="fas fa-angle-left fa-fw"></i>K8S集群性能测试-kubemark</a></div></div><div id=comments></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2016 - 2020</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=bingerambo.com target=_blank>Binge</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=http://bingerambo.com/ target=_blank>bingerambo.com</a></span></div><div class=footer-line><i class="fa fa-eye"></i>本站总访问量<span id=busuanzi_value_site_pv></span>次
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true}};</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','UA-81425808-1',{'anonymize_ip':true});</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=UA-81425808-1" async></script><script src=https://libs.baidu.com/jquery/2.1.4/jquery.min.js></script><script src=https://cdn.bootcdn.net/ajax/libs/jquery-backstretch/2.1.18/jquery.backstretch.min.js></script><script type=text/javascript src=/js/custom.js></script></body></html>